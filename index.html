<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Erik Stenman">
<title>The Erlang Runtime System</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
.admonitionblock td.icon .icon-version:before{content:"\f02c";color:#900C3F}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>The Erlang Runtime System</h1>
<div class="details">
<span id="author" class="author">Erik Stenman</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_preface">Preface</a>
<ul class="sectlevel2">
<li><a href="#who_is_this_book_for">About this book</a></li>
<li><a href="#_how_to_read_this_book">How to read this book</a></li>
<li><a href="#_erlang">Erlang</a></li>
<li><a href="#_acknowledgments">Acknowledgments</a></li>
</ul>
</li>
<li><a href="#P-ERTS">I: Understanding ERTS</a>
<ul class="sectlevel1">
<li><a href="#introduction">1. Introducing the Erlang Runtime System</a>
<ul class="sectlevel2">
<li><a href="#_erts_and_the_erlang_runtime_system">1.1. ERTS and the Erlang Runtime System</a></li>
<li><a href="#_how_to_read_this_book_2">1.2. How to read this book</a></li>
<li><a href="#ERTS">1.3. ERTS</a>
<ul class="sectlevel3">
<li><a href="#_the_erlang_node_erts">1.3.1. The Erlang Node (ERTS)</a></li>
<li><a href="#_layers_in_the_execution_environment">1.3.2. Layers in the Execution Environment</a></li>
<li><a href="#_distribution">1.3.3. Distribution</a></li>
<li><a href="#_the_erlang_compiler">1.3.4. The Erlang Compiler</a></li>
<li><a href="#_the_erlang_virtual_machine_beam">1.3.5. The Erlang Virtual Machine: BEAM</a></li>
<li><a href="#_processes">1.3.6. Processes</a></li>
<li><a href="#_scheduling">1.3.7. Scheduling</a></li>
<li><a href="#_the_erlang_tag_scheme">1.3.8. The Erlang Tag Scheme</a></li>
<li><a href="#_memory_handling">1.3.9. Memory Handling</a></li>
<li><a href="#_the_interpreter_and_the_command_line_interface">1.3.10. The Interpreter and the Command Line Interface</a></li>
</ul>
</li>
<li><a href="#Other_Erlang_Implementations">1.4. Other Erlang Implementations</a>
<ul class="sectlevel3">
<li><a href="#_erlang_on_xen">1.4.1. Erlang on Xen</a></li>
<li><a href="#_erjang">1.4.2. Erjang</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#CH-Compiler">2. The Compiler</a>
<ul class="sectlevel2">
<li><a href="#_compiling_erlang">2.1. Compiling Erlang</a></li>
<li><a href="#_generating_intermediate_output">2.2. Generating Intermediate Output</a></li>
<li><a href="#_compiler_passes">2.3. Compiler Passes</a>
<ul class="sectlevel3">
<li><a href="#_compiler_pass_the_erlang_preprocessor_epp">2.3.1. Compiler Pass: The Erlang Preprocessor (epp)</a></li>
<li><a href="#SEC-parse_transform">2.3.2. Compiler Pass: Parse Transformations</a></li>
<li><a href="#_compiler_pass_linter">2.3.3. Compiler Pass: Linter</a></li>
<li><a href="#_compiler_pass_save_ast">2.3.4. Compiler Pass: Save AST</a></li>
<li><a href="#_compiler_pass_expand">2.3.5. Compiler Pass: Expand</a></li>
<li><a href="#_compiler_pass_core_erlang">2.3.6. Compiler Pass: Core Erlang</a></li>
<li><a href="#_compiler_pass_kernel_erlang">2.3.7. Compiler Pass: Kernel Erlang</a></li>
<li><a href="#_compiler_pass_beam_code">2.3.8. Compiler Pass: BEAM Code</a></li>
<li><a href="#_compiler_pass_native_code">2.3.9. Compiler Pass: Native Code</a></li>
</ul>
</li>
<li><a href="#_other_compiler_tools">2.4. Other Compiler Tools</a>
<ul class="sectlevel3">
<li><a href="#_leex">2.4.1. Leex</a></li>
<li><a href="#_yecc">2.4.2. Yecc</a></li>
</ul>
</li>
<li><a href="#_syntax_tools_and_merl">2.5. Syntax Tools and Merl</a></li>
<li><a href="#_compiling_elixir">2.6. Compiling Elixir</a></li>
</ul>
</li>
<li><a href="#CH-Processes">3. Processes</a>
<ul class="sectlevel2">
<li><a href="#_what_is_a_process">3.1. What is a Process?</a>
<ul class="sectlevel3">
<li><a href="#_listing_processes_from_the_shell">3.1.1. Listing Processes from the Shell</a></li>
<li><a href="#_programmatic_process_probing">3.1.2. Programmatic Process Probing</a></li>
<li><a href="#_using_the_observer_to_inspect_processes">3.1.3. Using the Observer to Inspect Processes</a></li>
</ul>
</li>
<li><a href="#_processes_are_just_memory">3.2. Processes Are Just Memory</a></li>
<li><a href="#_the_pcb">3.3. The PCB</a></li>
<li><a href="#_the_garbage_collector_gc">3.4. The Garbage Collector (GC)</a></li>
<li><a href="#_mailboxes_and_message_passing">3.5. Mailboxes and Message Passing</a>
<ul class="sectlevel3">
<li><a href="#_sending_messages_in_parallel">3.5.1. Sending Messages in Parallel</a></li>
</ul>
</li>
<li><a href="#_lock_free_message_passing">3.6. Lock Free Message Passing</a>
<ul class="sectlevel3">
<li><a href="#_memory_areas_for_messages">3.6.1. Memory Areas for Messages</a></li>
<li><a href="#_inspecting_message_handling">3.6.2. Inspecting Message Handling</a></li>
<li><a href="#_the_process_of_sending_a_message_to_a_process">3.6.3. The Process of Sending a Message to a Process</a></li>
<li><a href="#_receiving_a_message">3.6.4. Receiving a Message</a></li>
<li><a href="#_tuning_message_passing">3.6.5. Tuning Message Passing</a></li>
</ul>
</li>
<li><a href="#_the_process_dictionary">3.7. The Process Dictionary</a></li>
<li><a href="#_dig_in">3.8. Dig In</a></li>
</ul>
</li>
<li><a href="#CH-TypeSystem">4. The Erlang Type System and Tags</a>
<ul class="sectlevel2">
<li><a href="#_the_erlang_type_system">4.1. The Erlang Type System</a></li>
<li><a href="#_the_tagging_scheme">4.2. The Tagging Scheme</a>
<ul class="sectlevel3">
<li><a href="#_tags_for_immediates">4.2.1. Tags for Immediates</a></li>
<li><a href="#_tags_for_boxed_terms">4.2.2. Tags for Boxed Terms</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#CH-BEAM">5. The Erlang Virtual Machine: BEAM</a>
<ul class="sectlevel2">
<li><a href="#_working_memory_a_stack_machine_it_is_not">5.1. Working Memory: A stack machine, it is not</a></li>
<li><a href="#_dispatch_directly_threaded_code">5.2. Dispatch: Directly Threaded Code</a></li>
<li><a href="#_scheduling_non_preemptive_reduction_counting">5.3. Scheduling: Non-preemptive, Reduction counting</a></li>
<li><a href="#_memory_management_garbage_collecting">5.4. Memory Management: Garbage Collecting</a></li>
<li><a href="#_beam_it_is_virtually_unreal">5.5. BEAM: it is virtually unreal</a></li>
</ul>
</li>
<li><a href="#CH-beam_modules">6. Modules and The BEAM File Format (16p)</a>
<ul class="sectlevel2">
<li><a href="#modules">6.1. Modules</a></li>
<li><a href="#BEAM_files">6.2. The BEAM File Format</a>
<ul class="sectlevel3">
<li><a href="#atom_table_chunk">6.2.1. Atom table chunk</a></li>
<li><a href="#export_table_chunk">6.2.2. Export table chunk</a></li>
<li><a href="#import_table_chunk">6.2.3. Import table chunk</a></li>
<li><a href="#code_chunk">6.2.4. Code Chunk</a></li>
<li><a href="#_string_table_chunk">6.2.5. String table chunk</a></li>
<li><a href="#_attributes_chunk">6.2.6. Attributes Chunk</a></li>
<li><a href="#_compilation_information_chunk">6.2.7. Compilation Information Chunk</a></li>
<li><a href="#_local_function_table_chunk">6.2.8. Local Function Table Chunk</a></li>
<li><a href="#_literal_table_chunk">6.2.9. Literal Table Chunk</a></li>
<li><a href="#_abstract_code_chunk">6.2.10. Abstract Code Chunk</a></li>
<li><a href="#_compression_and_encryption">6.2.11. Compression and Encryption</a></li>
<li><a href="#_function_trace_chunk_obsolete">6.2.12. Function Trace Chunk (Obsolete)</a></li>
<li><a href="#_bringing_it_all_together">6.2.13. Bringing it all Together</a></li>
<li><a href="#SEC-BeamModulesCTE">6.2.14. Compact Term Encoding</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#CH-Instructions">7. Generic BEAM Instructions (25p)</a>
<ul class="sectlevel2">
<li><a href="#_instruction_definitions">7.1. Instruction definitions</a></li>
<li><a href="#_beam_code_listings">7.2. BEAM code listings</a></li>
<li><a href="#_calls">7.3. Calls</a></li>
<li><a href="#_stack_and_heap_management">7.4. Stack (and Heap) Management</a></li>
<li><a href="#_message_passing">7.5. Message Passing</a>
<ul class="sectlevel3">
<li><a href="#_a_minimal_receive_loop">7.5.1. A Minimal Receive Loop</a></li>
<li><a href="#_a_selective_receive_loop">7.5.2. A Selective Receive Loop</a></li>
<li><a href="#_a_receive_loop_with_a_timeout">7.5.3. A Receive Loop With a Timeout</a></li>
<li><a href="#_the_synchronous_call_trick_aka_the_ref_trick">7.5.4. The Synchronous Call Trick (aka The Ref Trick)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#CH-Calls">8. Different Types of Calls, Linking and Hot Code Loading (5p)</a>
<ul class="sectlevel2">
<li><a href="#_hot_code_loading">8.1. Hot Code Loading</a></li>
<li><a href="#_code_loading">8.2. Code Loading</a></li>
</ul>
</li>
<li><a href="#CH-Beam_loader">9. The BEAM Loader</a>
<ul class="sectlevel2">
<li><a href="#_transforming_from_generic_to_specific_instructions">9.1. Transforming from Generic to Specific instructions</a></li>
<li><a href="#_understanding_ops_tab">9.2. Understanding ops.tab</a>
<ul class="sectlevel3">
<li><a href="#_transformations">9.2.1. Transformations</a></li>
<li><a href="#_specific_instruction">9.2.2. Specific instruction</a></li>
</ul>
</li>
<li><a href="#_optimizations">9.3. Optimizations</a>
<ul class="sectlevel3">
<li><a href="#_select_val_optimizations">9.3.1. select_val optimizations</a></li>
<li><a href="#_pre_hashing_of_literals">9.3.2. pre-hashing of literals</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#CH-Internal_instructions">10. BEAM Internal Instructions</a></li>
<li><a href="#CH-Scheduling">11. Scheduling</a>
<ul class="sectlevel2">
<li><a href="#_concurrency_parallelism_and_preemptive_multitasking">11.1. Concurrency, Parallelism, and Preemptive Multitasking</a></li>
<li><a href="#_preemptive_multitasking_in_erts_cooperating_in_c">11.2. Preemptive Multitasking in ERTS Cooperating in C</a></li>
<li><a href="#_reductions">11.3. Reductions</a>
<ul class="sectlevel3">
<li><a href="#_how_many_reductions_will_you_get">11.3.1. How Many Reductions Will You Get?</a></li>
<li><a href="#_what_is_a_reduction_really">11.3.2. What is a Reduction Really?</a></li>
</ul>
</li>
<li><a href="#_the_process_state_or_status">11.4. The Process State (or <em>status</em>)</a></li>
<li><a href="#_process_queues">11.5. Process Queues</a>
<ul class="sectlevel3">
<li><a href="#_the_ready_queue">11.5.1. The Ready Queue</a></li>
<li><a href="#_waiting_timeouts_and_the_timing_wheel">11.5.2. Waiting, Timeouts and the Timing Wheel</a></li>
</ul>
</li>
<li><a href="#_ports">11.6. Ports</a></li>
<li><a href="#_reductions_2">11.7. Reductions</a></li>
<li><a href="#_the_scheduler_loop">11.8. The Scheduler Loop</a></li>
<li><a href="#_load_balancing">11.9. Load Balancing</a>
<ul class="sectlevel3">
<li><a href="#_task_stealing">11.9.1. Task Stealing</a></li>
<li><a href="#_migration">11.9.2. Migration</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#CH-Memory">12. The Memory Subsystem: Stacks, Heaps and Garbage Collection</a>
<ul class="sectlevel2">
<li><a href="#_the_memory_subsystem">12.1. The memory subsystem</a></li>
<li><a href="#SS-Memory_Allocators">12.2. Different type of memory allocators</a>
<ul class="sectlevel3">
<li><a href="#_the_basic_allocator_sys_alloc">12.2.1. The basic allocator: sys_alloc</a></li>
<li><a href="#_the_memory_segment_allocator_mseg_alloc">12.2.2. The memory segment allocator: mseg_alloc</a></li>
<li><a href="#_the_memory_allocator_framework_alloc_util">12.2.3. The memory allocator framework: alloc_util</a></li>
<li><a href="#_the_temporary_allocator_temp_alloc">12.2.4. The temporary allocator: temp_alloc</a></li>
<li><a href="#_the_heap_allocator_eheap_alloc">12.2.5. The heap allocator: eheap_alloc</a></li>
<li><a href="#_the_binary_allocator_binary_alloc">12.2.6. The binary allocator: binary_alloc</a></li>
<li><a href="#_the_ets_allocator_ets_alloc">12.2.7. The ETS allocator: ets_alloc</a></li>
<li><a href="#_the_driver_allocator_driver_alloc">12.2.8. The driver allocator: driver_alloc</a></li>
<li><a href="#_the_short_lived_allocator_sl_alloc">12.2.9. The short lived allocator: sl_alloc</a></li>
<li><a href="#_the_long_lived_allocator_ll_alloc">12.2.10. The long lived allocator: ll_alloc</a></li>
<li><a href="#_the_fixed_size_allocator_fix_alloc">12.2.11. The fixed size allocator: fix_alloc</a></li>
<li><a href="#_the_standard_allocator_std_alloc">12.2.12. The standard allocator: std_alloc</a></li>
</ul>
</li>
<li><a href="#_todo_system_flags_for_memory">12.3. TODO: system flags for memory</a></li>
<li><a href="#_process_memory">12.4. Process Memory</a>
<ul class="sectlevel3">
<li><a href="#_term_sharing">12.4.1. Term sharing</a></li>
<li><a href="#_message_passing_2">12.4.2. Message passing</a></li>
<li><a href="#SS-Binaries">12.4.3. Binaries</a></li>
<li><a href="#_garbage_collection">12.4.4. Garbage Collection</a></li>
</ul>
</li>
<li><a href="#_other_interesting_memory_areas">12.5. Other interesting memory areas</a>
<ul class="sectlevel3">
<li><a href="#_the_atom_table">12.5.1. The atom table.</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#CH-DataStructures">13. Advanced data structures (ETS, DETS, Mnesia)</a></li>
<li><a href="#CH-IO">14. IO, Ports and Networking (10p)</a>
<ul class="sectlevel2">
<li><a href="#_standard_io">14.1. Standard IO</a></li>
<li><a href="#_ports_2">14.2. Ports</a>
<ul class="sectlevel3">
<li><a href="#_different_types_of_ports">14.2.1. Different types of Ports</a></li>
</ul>
</li>
<li><a href="#_distributed_erlang">14.3. Distributed Erlang</a></li>
<li><a href="#_sockets_udp_and_tcp">14.4. Sockets, UDP and TCP</a></li>
</ul>
</li>
<li><a href="#CH-Distribution">15. Distribution</a></li>
<li><a href="#CH-C">16. Interfacing C&#8201;&#8212;&#8201;BIFs NIFs and Linked in Drivers</a></li>
<li><a href="#CH-Native">17. Native Code</a></li>
</ul>
</li>
<li><a href="#P-Running">II: Running ERTS</a>
<ul class="sectlevel1">
<li><a href="#CH-Tracing">18. Tracing</a></li>
<li><a href="#CH-Debugging">19. Debugging</a>
<ul class="sectlevel2">
<li><a href="#_preliminary_outline">19.1. Preliminary Outline</a></li>
<li><a href="#_introduction">19.2. Introduction</a></li>
<li><a href="#_debugger">19.3. debugger</a></li>
<li><a href="#_dbg">19.4. dbg</a></li>
<li><a href="#_redbug">19.5. Redbug</a>
<ul class="sectlevel3">
<li><a href="#_installing_redbug">19.5.1. Installing Redbug</a></li>
<li><a href="#_using_redbug">19.5.2. Using Redbug</a></li>
</ul>
</li>
<li><a href="#_crash_dumps">19.6. Crash Dumps</a></li>
</ul>
</li>
<li><a href="#CH-Ops">20. Operation and Maintenance</a>
<ul class="sectlevel2">
<li><a href="#_connecting_to_the_system">20.1. Connecting to the System</a></li>
<li><a href="#_the_shell">20.2. The Shell</a>
<ul class="sectlevel3">
<li><a href="#_configuring_your_shell">20.2.1. Configuring Your Shell</a></li>
<li><a href="#_connecting_a_shell_to_a_node">20.2.2. Connecting a Shell to a Node</a></li>
<li><a href="#_breaking_out_or_in">20.2.3. Breaking (out or in).</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#CH-Tweak">21. Tweaking the Runtime System</a></li>
</ul>
</li>
<li><a href="#AP-BuildingERTS">Appendix A: Building the Erlang Runtime System</a>
<ul class="sectlevel2">
<li><a href="#_first_time_build">A.1. First Time Build</a>
<ul class="sectlevel3">
<li><a href="#_prerequisites">A.1.1. Prerequisites</a></li>
</ul>
</li>
<li><a href="#_getting_the_source">A.2. Getting the source</a></li>
<li><a href="#_building_with_kerl">A.3. Building with Kerl</a></li>
</ul>
</li>
<li><a href="#AP-Instructions">Appendix B: BEAM Instructions</a>
<ul class="sectlevel2">
<li><a href="#_functions_and_labels">B.1. Functions and Labels</a>
<ul class="sectlevel3">
<li><a href="#_label_lbl">B.1.1. label Lbl</a></li>
<li><a href="#_func_info_module_function_arity">B.1.2. func_info Module Function Arity</a></li>
</ul>
</li>
<li><a href="#_test_instructions">B.2. Test instructions</a>
<ul class="sectlevel3">
<li><a href="#_type_tests">B.2.1. Type tests</a></li>
<li><a href="#_comparisons">B.2.2. Comparisons</a></li>
</ul>
</li>
<li><a href="#_function_calls">B.3. Function Calls</a>
<ul class="sectlevel3">
<li><a href="#_call_arity_label">B.3.1. call Arity Label</a></li>
<li><a href="#_call_only_arity_label">B.3.2. call_only Arity Label</a></li>
<li><a href="#_call_last_arity_label_deallocate">B.3.3. call_last Arity Label Deallocate</a></li>
<li><a href="#_call_ext_arity_destination">B.3.4. call_ext Arity Destination</a></li>
<li><a href="#_call_ext_only_arity_destination">B.3.5. call_ext_only Arity Destination</a></li>
<li><a href="#_call_ext_last_arity_destination_deallocate">B.3.6. call_ext_last Arity Destination Deallocate</a></li>
<li><a href="#_bif0_bif_reg_bif12_lbl_bif_arg_reg">B.3.7. bif0 Bif Reg, bif[1,2] Lbl Bif [Arg,&#8230;&#8203;] Reg</a></li>
<li><a href="#_gc_bif1_3_lbl_live_bif_arg_reg">B.3.8. gc_bif[1-3] Lbl Live Bif [Arg, &#8230;&#8203;] Reg</a></li>
<li><a href="#_call_fun_arity">B.3.9. call_fun Arity</a></li>
<li><a href="#_apply_arity">B.3.10. apply Arity</a></li>
<li><a href="#_apply_last_arity_dealloc">B.3.11. apply_last Arity Dealloc</a></li>
</ul>
</li>
<li><a href="#_stack_and_heap_management_2">B.4. Stack (and Heap) Management</a>
<ul class="sectlevel3">
<li><a href="#_allocate_stackneed_live">B.4.1. allocate StackNeed Live</a></li>
<li><a href="#_allocate_heap_stackneed_heapneed_live">B.4.2. allocate_heap StackNeed HeapNeed Live</a></li>
<li><a href="#_allocate_zero_stackneed_live">B.4.3. allocate_zero StackNeed Live</a></li>
<li><a href="#_allocate_heap_zero_stackneed_heapneed_live">B.4.4. allocate_heap_zero StackNeed HeapNeed Live</a></li>
<li><a href="#_test_heap_heapneed_live">B.4.5. test_heap HeapNeed Live</a></li>
<li><a href="#_init_n">B.4.6. init N</a></li>
<li><a href="#_deallocate_n">B.4.7. deallocate N</a></li>
<li><a href="#_return">B.4.8. return</a></li>
<li><a href="#_trim_n_remaining">B.4.9. trim N Remaining</a></li>
</ul>
</li>
<li><a href="#_moving_extracting_modifying_data">B.5. Moving, extracting, modifying data</a>
<ul class="sectlevel3">
<li><a href="#_move_source_destination">B.5.1. move Source Destination</a></li>
<li><a href="#_get_list_source_head_tail">B.5.2. get_list Source Head Tail</a></li>
<li><a href="#_get_tuple_element_source_element_destination">B.5.3. get_tuple_element Source Element Destination</a></li>
<li><a href="#_set_tuple_element_newelement_tuple_position">B.5.4. set_tuple_element NewElement Tuple Position</a></li>
</ul>
</li>
<li><a href="#_building_terms">B.6. Building terms.</a>
<ul class="sectlevel3">
<li><a href="#_put_list_head_tail_destination">B.6.1. put_list Head Tail Destination</a></li>
<li><a href="#_put_tuple_size_destination">B.6.2. put_tuple Size Destination</a></li>
<li><a href="#_put_value">B.6.3. put Value</a></li>
<li><a href="#_make_fun2_lambdaindex">B.6.4. make_fun2 LambdaIndex</a></li>
</ul>
</li>
<li><a href="#_binary_syntax">B.7. Binary Syntax</a>
<ul class="sectlevel3">
<li><a href="#_bs_put_integer5">B.7.1. bs_put_integer/5</a></li>
<li><a href="#_bs_put_binary5">B.7.2. bs_put_binary/5</a></li>
<li><a href="#_bs_put_float5">B.7.3. bs_put_float/5</a></li>
<li><a href="#_bs_put_string2">B.7.4. bs_put_string/2</a></li>
<li><a href="#_bs_init26">B.7.5. bs_init2/6</a></li>
<li><a href="#_bs_add5">B.7.6. bs_add/5</a></li>
<li><a href="#_bs_start_match25">B.7.7. bs_start_match2/5</a></li>
<li><a href="#_bs_get_integer27">B.7.8. bs_get_integer2/7</a></li>
<li><a href="#_bs_get_float27">B.7.9. bs_get_float2/7</a></li>
<li><a href="#_bs_get_binary27">B.7.10. bs_get_binary2/7</a></li>
<li><a href="#_bs_skip_bits25">B.7.11. bs_skip_bits2/5</a></li>
<li><a href="#_bs_test_tail23">B.7.12. bs_test_tail2/3</a></li>
<li><a href="#_bs_save22">B.7.13. bs_save2/2</a></li>
<li><a href="#_bs_restore22">B.7.14. bs_restore2/2</a></li>
<li><a href="#_bs_context_to_binary1">B.7.15. bs_context_to_binary/1</a></li>
<li><a href="#_bs_test_unit3">B.7.16. bs_test_unit/3</a></li>
<li><a href="#_bs_match_string4">B.7.17. bs_match_string/4</a></li>
<li><a href="#_bs_init_writable0">B.7.18. bs_init_writable/0</a></li>
<li><a href="#_bs_append8">B.7.19. bs_append/8</a></li>
<li><a href="#_bs_private_append6">B.7.20. bs_private_append/6</a></li>
<li><a href="#_bs_init_bits6">B.7.21. bs_init_bits/6</a></li>
<li><a href="#_bs_get_utf85">B.7.22. bs_get_utf8/5</a></li>
<li><a href="#_bs_skip_utf84">B.7.23. bs_skip_utf8/4</a></li>
<li><a href="#_bs_get_utf165">B.7.24. bs_get_utf16/5</a></li>
<li><a href="#_bs_skip_utf164">B.7.25. bs_skip_utf16/4</a></li>
<li><a href="#_bs_get_utf325">B.7.26. bs_get_utf32/5</a></li>
<li><a href="#_bs_skip_utf324">B.7.27. bs_skip_utf32/4</a></li>
<li><a href="#_bs_utf8_size3">B.7.28. bs_utf8_size/3</a></li>
<li><a href="#_bs_put_utf83">B.7.29. bs_put_utf8/3</a></li>
<li><a href="#_bs_utf16_size3">B.7.30. bs_utf16_size/3</a></li>
<li><a href="#_bs_put_utf163">B.7.31. bs_put_utf16/3</a></li>
<li><a href="#_bs_put_utf323">B.7.32. bs_put_utf32/3</a></li>
</ul>
</li>
<li><a href="#_floating_point_arithmetic">B.8. Floating Point Arithmetic</a>
<ul class="sectlevel3">
<li><a href="#_fclearerror0">B.8.1. fclearerror/0</a></li>
<li><a href="#_fcheckerror1">B.8.2. fcheckerror/1</a></li>
<li><a href="#_fmove2">B.8.3. fmove/2</a></li>
<li><a href="#_fconv2">B.8.4. fconv/2</a></li>
<li><a href="#_fadd4">B.8.5. fadd/4</a></li>
<li><a href="#_fsub4">B.8.6. fsub/4</a></li>
<li><a href="#_fmul4">B.8.7. fmul/4</a></li>
<li><a href="#_fdiv4">B.8.8. fdiv/4</a></li>
<li><a href="#_fnegate3">B.8.9. fnegate/3</a></li>
</ul>
</li>
<li><a href="#_pattern_matching">B.9. Pattern Matching</a>
<ul class="sectlevel3">
<li><a href="#_select_val">B.9.1. select_val</a></li>
<li><a href="#_select_arity_val">B.9.2. select_arity_val</a></li>
<li><a href="#_jump">B.9.3. jump</a></li>
</ul>
</li>
<li><a href="#_exception_handling">B.10. Exception handling</a>
<ul class="sectlevel3">
<li><a href="#_catch2">B.10.1. catch/2</a></li>
<li><a href="#_catch_end1">B.10.2. catch_end/1</a></li>
<li><a href="#_badmatch1">B.10.3. badmatch/1</a></li>
<li><a href="#_if_end0">B.10.4. if_end/0</a></li>
<li><a href="#_case_end1">B.10.5. case_end/1</a></li>
</ul>
</li>
<li><a href="#_meta_instructions">B.11. Meta instructions</a>
<ul class="sectlevel3">
<li><a href="#_on_load">B.11.1. on_load</a></li>
<li><a href="#_line">B.11.2. line</a></li>
</ul>
</li>
<li><a href="#_generic_instructions">B.12. Generic Instructions</a></li>
<li><a href="#_specific_instructions">B.13. Specific Instructions</a>
<ul class="sectlevel3">
<li><a href="#_list_of_all_beam_instructions">B.13.1. List of all BEAM Instructions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#AP-listings">Appendix C: Full Code Listings</a></li>
<li><a href="#BIB-References">References</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_preface"><a class="link" href="#_preface">Preface</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This book is not about how to write correct and
beautiful code, I am assuming that you already know how to do
that. This book isnt really about profiling and performance tuning
either. Although, there is a chapter in this book on tracing and
profiling which can help you find bottlenecks and unnecessary usage of
resources. There also is a chapter on performance tuning.</p>
</div>
<div class="paragraph">
<p>These two chapters are the last chapters in the book, and the whole
book is building up to those chapters, but the real goal with this
book is to give you all the information, all the gory details, that
you need in order to really understand the performance of your Erlang
application.</p>
</div>
<div class="sect2">
<h3 id="who_is_this_book_for"><a class="link" href="#who_is_this_book_for">About this book</a></h3>
<div class="paragraph">
<p>For anyone who: Want to tune an Erlang installation. Want to know how
to debug VM crashes. Want to improve performance of Erlang
applications. Want to understand how Erlang really works. Want to
learn how to build your own runtime environment.</p>
</div>
<div class="paragraph">
<p>If you want to debug the VM If you want to extend the VM If you want
to do performance tweaking&#8212;&#8203;jump to the last chapter  but to really
understand that chapter you need to read the book.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_read_this_book"><a class="link" href="#_how_to_read_this_book">How to read this book</a></h3>
<div class="paragraph">
<p>The Erlang RunTime System (ERTS) is a complex system with many
interdependent components. It is written in a very portable way so
that it can run on anything from a gum-stick computer to the largest
multicore system with terabytes of memory. In order to be able to
optimize the performance of such a system for your application, you
need to not only know your application, but you also need to have a
thorough understanding of ERTS itself.</p>
</div>
<div class="paragraph">
<p>With this knowledge of how ERTS works you will be able to understand
how your application behaves when running on ERTS, and you will also
be able to find and fix problems with the performance of your application.
In the second part of this book we will go through how you successfully
run, monitor and scale your ERTS application.</p>
</div>
<div class="paragraph">
<p>You dont need to be an Erlang programmer to read this book, but you
will need some basic understanding of what Erlang is. This following
section will give you some Erlang background.</p>
</div>
</div>
<div class="sect2">
<h3 id="_erlang"><a class="link" href="#_erlang">Erlang</a></h3>
<div class="paragraph">
<p>In this section we will look at some basic Erlang concepts that
are vital to understanding the rest of the book.</p>
</div>
<div class="paragraph">
<p>Erlang has been called, especially by one of Erlang&#8217;s creators Joe
Armstrong, a concurrency oriented language. Concurrency is definitely
at the heart of Erlang, and to be able to understand how an Erlang
system works you need to understand the concurrency model of Erlang.</p>
</div>
<div class="paragraph">
<p>First of all we need to make a distinction between <em>concurrency</em> and
<em>parallelism</em>. In this book <em>concurrency</em> is the concept of having
two or more processes that <strong>can</strong> execute independently of each other,
this can be done by first executing one process then the other or by
interleaving the execution, or by executing the processes in
parallel. With <em>parallel</em> executions we mean that the processes
actually execute at the exact same time by using several physical
execution units. Parallelism can be achieved on different levels.
Through multiple execution units in the execution pipeline in one core,
in several cores on one CPU, by several CPUs in one machine or through
several machines.</p>
</div>
<div class="paragraph">
<p>Erlang uses processes to achieve concurrency. Conceptually Erlang
processes are similar to most OS processes, they execute in parallel
and can communicate through signals. In practice there is a huge
difference in that Erlang processes are much more lightweight than
most OS processes. Many other concurrent programming languages call
their equivalent to Erlang processes <em>agents</em>.</p>
</div>
<div class="paragraph">
<p>Erlang achieves concurrency by interleaving the execution of processes
on the Erlang virtual machine, the BEAM. On a multi-core processor the
BEAM can also achieve parallelism by running one scheduler per core and
executing one Erlang process per scheduler. The designer of an Erlang
system can achieve further parallelism by distributing the system on
several computers.</p>
</div>
<div class="paragraph">
<p>A typical Erlang system (a server or service built in Erlang) consists
of a number of Erlang <em>applications</em>, corresponding to a directory on disk.
Each application is made up of several Erlang <em>modules</em> corresponding to
files in the directory. Each module contains a number of <em>functions</em> and
each function is made up of <em>expressions</em>.</p>
</div>
<div class="paragraph">
<p>Since Erlang is a functional language it has no statements,
only expressions. Erlang expressions can be combined into an Erlang
function. A function takes a number of arguments and returns a
value. In <a href="#erlang_code_examples">Erlang Code Examples</a> we can see some examples of
Erlang expressions and functions.</p>
</div>
<div id="erlang_code_examples" class="listingblock">
<div class="title">Erlang Code Examples</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="c">%% Some Erlang expressions:
</span>
<span class="n">true</span><span class="p">.</span>
<span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">.</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">X</span> <span class="o">&gt;</span> <span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">X</span><span class="p">;</span> <span class="n">true</span> <span class="o">-&gt;</span> <span class="nv">Y</span> <span class="k">end</span><span class="p">.</span>

<span class="c">%% An Erlang function:
</span>
<span class="nf">max</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">X</span> <span class="o">&gt;</span> <span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">X</span><span class="p">;</span>
     <span class="n">true</span>    <span class="o">-&gt;</span> <span class="nv">Y</span>
  <span class="k">end</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Erlang has a number of <em>built in functions</em> (or <em>BIFs</em>) which are
implemented by the VM. This is either for efficiency reasons, like the
implementation of lists:append (which could be implemented in
Erlang). It could also be to provide some low level functionality
which would be hard or impossible to implement in Erlang itself, like
list_to_atom.</p>
</div>
<div class="paragraph">
<p>Since Erlang/OTP R13B03 you can also provide your own functions
implemented in C by using the <em>Native Implemented Functions</em> (<em>NIF</em>)
interface.</p>
</div>
</div>
<div class="sect2">
<h3 id="_acknowledgments"><a class="link" href="#_acknowledgments">Acknowledgments</a></h3>
<div class="paragraph">
<p>First of all I want to thank the whole OTP team at Ericsson both for maintaining Erlang
and the Erlang runtime system, and also for patiently answering all my questions.
In particular I want to thank Kenneth Lundin, Bjrn Gustavsson, Lukas Larsson, Rickard Green
and Raimo Niskanen.</p>
</div>
<div class="paragraph">
<p>I would also like to thank Yoshihiro Tanaka, Roberto Aloi and Dmytro Lytovchenko for
major contributions to the book, and HappiHacking and TubiTV for sponsoring work on
the book.</p>
</div>
<div class="paragraph">
<p>Finally, a big thank you to everyone who has contributed with edits and fixes:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Yoshihiro Tanaka
Dmytro Lytovchenko
Trevor Brown
Erick Dennis
Buddhika Chathuranga
Ramkumar Rajagopalan
Kim Shrier
Antonio Nikishaev
fred
yoshi</pre>
</div>
</div>
</div>
</div>
</div>
<h1 id="P-ERTS" class="sect0"><a class="link" href="#P-ERTS">I: Understanding ERTS</a></h1>
<div class="sect1">
<h2 id="introduction"><a class="link" href="#introduction">1. Introducing the Erlang Runtime System</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Erlang RunTime System (ERTS)  is a complex system with many interdependent
components. It is written in a very portable way so that it can run on
anything from a gum stick computer to the largest multicore system
with terabytes of memory. In order to be able to optimize the
performance of such a system for your application, you need to not
only know your application, but you also need to have a thorough
understanding of ERTS itself.</p>
</div>
<div class="sect2">
<h3 id="_erts_and_the_erlang_runtime_system"><a class="link" href="#_erts_and_the_erlang_runtime_system">1.1. ERTS and the Erlang Runtime System</a></h3>
<div class="paragraph">
<p>There is a difference between any Erlang Runtime System  and a specific implementation of an Erlang Runtime
System. "Erlang/OTP" by Ericsson is the de facto standard
implementation of Erlang and the Erlang Runtime System. In this book I
will refer to this implementation as <em>ERTS</em> or spelled out <em>Erlang
RunTime System</em> with a capital T. (See <a href="#ERTS">Section 1.3</a> for a definition of
OTP).</p>
</div>
<div class="paragraph">
<p>There is no official definition of what an Erlang Runtime System is,
or what an Erlang Virtual Machine is. You could sort of imagine what
such an ideal Platonic system would look like by taking ERTS and
removing all the implementation specific details. This is
unfortunately a circular definition, since you need to know the
general definition to be able to identify an implementation specific
detail. In the Erlang world we are usually too pragmatic to worry about
this.</p>
</div>
<div class="paragraph">
<p>We will try to use the term <em>Erlang Runtime System</em> to refer to the
general idea of any Erlang Runtime System as opposed to the specific
implementation by Ericsson which we call the Erlang RunTime System
or usually just ERTS.</p>
</div>
<div class="paragraph">
<p><strong>Note</strong> This book is mostly a book about ERTS in particular and only to
a small extent about any general Erlang Runtime System. If you assume
that we talk about the Ericsson implementation unless it is clearly
stated that we are talking about a general principle you will probably
be right.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_read_this_book_2"><a class="link" href="#_how_to_read_this_book_2">1.2. How to read this book</a></h3>
<div class="paragraph">
<p>In <a href="#P-Running">Part II</a> of this book we will look at how to tune the
runtime system for your application and how to profile and debug
your application and the runtime system. In order to really know
how to tune the system you also need to know the system. In
<a href="#P-ERTS">Part I</a> of this book you will get a deep understanding of
how the runtime system works.</p>
</div>
<div class="paragraph">
<p>The following chapters of <a href="#P-ERTS">Part I</a> will go over each
component of the system by itself.
You should be able to read any one of these
chapters without having a full understanding of how the other
components are implemented, but you will need a basic understanding of
what each component is. The rest of this introductory chapter should
give you enough basic understanding and vocabulary to be able to jump
between the rest of the chapters in part one in any order you like.</p>
</div>
<div class="paragraph">
<p>However, if you have the time,
read the book in
order the first time. Words that are specific to Erlang and ERTS or
used in a specific way in this book are usually explained at their
first occurrence. Then, when you know the vocabulary, you can come
back and use Part I as a reference whenever you have a problem with a
particular component.</p>
</div>
</div>
<div class="sect2">
<h3 id="ERTS"><a class="link" href="#ERTS">1.3. ERTS</a></h3>
<div class="paragraph">
<p>In this there is a basic overview of the main components of
ERTS  and some vocabulary needed to understand the more
detailed descriptions of each component in the following chapters.</p>
</div>
<div class="sect3">
<h4 id="_the_erlang_node_erts"><a class="link" href="#_the_erlang_node_erts">1.3.1. The Erlang Node (ERTS)</a></h4>
<div class="paragraph">
<p>When you start an Elixir or Erlang application or system, what you
really start is an Erlang node. The node runs the Erlang
RunTime System and the virtual machine BEAM.  (or possibly another
implementation of Erlang (see <a href="#Other_Erlang_Implementations">Section 1.4</a>)).</p>
</div>
<div class="paragraph">
<p>Your application code will run in an Erlang node, and all the layers
of the node will affect the performance of your application. We will
look at the stack of layers that makes up a node. This will help you
understand your options for running your system in different
environments.</p>
</div>
<div class="paragraph">
<p>In OO terminology one could say that an Erlang node is an object of
the Erlang Runtime System class. The equivalent in the Java world is a
JVM instance.</p>
</div>
<div class="paragraph">
<p>All execution of Elixir/Erlang code is done within a node. An Erlang node
runs in one OS process, and you can have several Erlang nodes
running on one machine.</p>
</div>
<div class="paragraph">
<p>To be completely correct according to the Erlang OTP documentation a
node is actually an executing runtime system that has been given a
name. That is, if you start Elixir without giving a name through one
of the command line switches <code>--name NAME@HOST</code> or <code>--sname NAME</code> (or
<code>-name</code> and <code>-sname</code> for an Erlang runtime.)  you will have a runtime
but not a node. In such a system the function <code>Node.alive?</code>
(or in Erlang <code>is_alive()</code>) returns false.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ iex
Erlang/OTP 19 [erts-8.1] [source-0567896] [64-bit] [smp:4:4]
              [async-threads:10] [hipe] [kernel-poll:false]

Interactive Elixir (1.4.0) - press Ctrl+C to exit (type h() ENTER for help)
iex(1)&gt; Node.alive?
false
iex(2)&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The runtime system itself is not that strict in its use
of the terminology. You can ask for the name of the node even
if you didn&#8217;t give it a name. In Elixir you use the function
<code>Node.list</code> with the argument <code>:this</code>, and in Erlang you
call <code>nodes(this).</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>iex(2)&gt; Node.list :this
[:nonode@nohost]
iex(3)&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>In this book we will use the term node for any running instance
of the runtime whether it is given a name or not.</p>
</div>
</div>
<div class="sect3">
<h4 id="_layers_in_the_execution_environment"><a class="link" href="#_layers_in_the_execution_environment">1.3.2. Layers in the Execution Environment</a></h4>
<div class="paragraph">
<p>Your program (application) will run in one or more nodes, and the
performance of your program will depend not only on your application
code but also on all the layers below your code in the <em>ERTS
stack</em>. In <a href="#the_erts_stack">Figure 1</a> you can see the ERTS Stack
illustrated with two Erlang nodes running on one machine.</p>
</div>
<div id="the_erts_stack" class="imageblock">
<div class="content">
<img src="images/diag-6a067f2ebb144870270f290b686a6c1f.png" alt="diag 6a067f2ebb144870270f290b686a6c1f" width="230" height="280">
</div>
<div class="title">Figure 1. ERTS Stack</div>
</div>
<div class="paragraph">
<p>If you are using Elixir there is yet another layer to the stack.</p>
</div>
<div id="the_elixir_stack" class="imageblock">
<div class="content">
<img src="images/diag-d7dd193026732576b5a0226e7d68a173.png" alt="diag d7dd193026732576b5a0226e7d68a173" width="230" height="308">
</div>
<div class="title">Figure 2. Elixir Stack</div>
</div>
<div class="paragraph">
<p>Let&#8217;s look at each layer of the stack and see how you can tune them
to your application&#8217;s need.</p>
</div>
<div class="paragraph">
<p>At the bottom of the stack there is the hardware you are running
on. The easiest way to improve the performance of your app is probably
to run it on better hardware. You might need to start exploring higher
levels of the stack if economical or physical constraints or
environmental concerns won&#8217;t let you upgrade your hardware.</p>
</div>
<div class="paragraph">
<p>The two most important choices for your hardware
is whether it is multicore and whether it is 32-bit or 64-bit. You
need different builds of ERTS depending on whether you want to use
multicore or not and whether you want to use 32-bit or 64-bit.</p>
</div>
<div class="paragraph">
<p>The second layer in the stack is the OS level. ERTS runs on most
versions of Windows and most POSIX "compliant" operating systems,
including Linux, VxWorks, FreeBSD, Solaris, and Mac OS X. Today most of
the development of ERTS is done on Linux and OS X, and you can expect
the best performance on these platforms. However, Ericsson has been
using Solaris internally in many projects and ERTS has been tuned for
Solaris for many years.  Depending on your use case you might actually
get the best performance on a Solaris system. The OS choice is usually
not based on performance requirements, but is restricted by other
factors. If you are building an embedded application you might be
restricted to Raspbian or VxWork, and if you for some reason are
building an end user or client application you might have to use
Windows. The Windows port of ERTS has so far not had the highest
priority and might not be the best choice from a performance or
maintenance perspective. If you want to use a 64-bit ERTS you of
course need to have both a 64-bit machine and a 64-bit OS. We will not
cover many OS specific questions in this book, and most examples will
be assuming that you run on Linux.</p>
</div>
<div class="paragraph">
<p>The third layer in the stack is the Erlang Runtime System. In our case
this will be ERTS. This and the fourth layer, the Erlang Virtual Machine
(BEAM), is what this book is all about.</p>
</div>
<div class="paragraph">
<p>The fifth layer, OTP, supplies the Erlang standard libraries. OTP
originally stood for "Open Telecom Platform" and was a number of
Erlang libraries supplying building blocks (such as <code>supervisor</code>,
<code>gen_server</code> and <code>gen_tcp</code>) for building robust applications (such as
telephony exchanges).  Early on, the libraries and the meaning of OTP
got intermingled with all the other standard libraries shipped with
ERTS. Nowadays most people use OTP together with Erlang in
"Erlang/OTP" as the name for ERTS and all Erlang libraries shipped by
Ericsson. Knowing these standard libraries and how and when to use
them can greatly improve the performance of your application. This
book will not go into any details of the standard libraries and
OTP, there are many other books that cover these aspects.</p>
</div>
<div class="paragraph">
<p>If you are running an Elixir program the sixth layer provides
the Elixir environment and the Elixir libraries.</p>
</div>
<div class="paragraph">
<p>Finally, the seventh layer (APP) is your application, and
any third party libraries you use. The application can use all
the functionality provided by the underlying layers. Apart from
upgrading your hardware this is probably the place where you most
easily can improve your application&#8217;s performance. In
<a href="#CH-Tracing">Chapter 18</a> there are some hints and some tools that can
help you profile and optimize your application. In
<a href="#CH-Debugging">Chapter 19</a> we will look at how to find the cause
of crashing applications and how to find bugs in your application.</p>
</div>
<div class="paragraph">
<p>For information on how to build and run an Erlang node
see <a href="#AP-BuildingERTS">Appendix A</a>, and read the rest of the book to
learn all about the components of an Erlang node.</p>
</div>
</div>
<div class="sect3">
<h4 id="_distribution"><a class="link" href="#_distribution">1.3.3. Distribution</a></h4>
<div class="paragraph">
<p>One of the key insights by the Erlang language designers was that in
order to build a system that works 24/7 you need to be able to handle
hardware failure. Therefore you need to distribute your system over at
least two physical machines. You do this by starting a node on
each machine and then you can connect the nodes to each other so
that processes can communicate with each other across the nodes
just as if they were running in the same node.</p>
</div>
<div id="a_distributed_application" class="imageblock">
<div class="content">
<img src="images/diag-d5aefbd8e9c51e41ab81fdff190e7432.png" alt="diag d5aefbd8e9c51e41ab81fdff190e7432" width="440" height="350">
</div>
<div class="title">Figure 3. Distributed Applications</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_erlang_compiler"><a class="link" href="#_the_erlang_compiler">1.3.4. The Erlang Compiler</a></h4>
<div class="paragraph">
<p>The Erlang Compiler is responsible for compiling Erlang source code,
from .erl files into virtual machine code for BEAM (the virtual
machine). The compiler itself is written in Erlang and compiled by
itself to BEAM code and usually available in a running Erlang node.
To bootstrap the runtime system there are a number of precompiled
BEAM files, including the compiler, in the bootstrap directory.</p>
</div>
<div class="paragraph">
<p>For more information about the compiler see <a href="#CH-Compiler">Chapter 2</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_erlang_virtual_machine_beam"><a class="link" href="#_the_erlang_virtual_machine_beam">1.3.5. The Erlang Virtual Machine: BEAM</a></h4>
<div class="paragraph">
<p>BEAM is the Erlang virtual machine used for executing Erlang code,
just like the JVM is used for executing Java code. BEAM runs in an
Erlang Node.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>BEAM:</strong> The name BEAM originally stood for Bogdan&#8217;s Erlang Abstract
 Machine, but nowadays most people refer to it as Bjrns
Erlang Abstract Machine, after the current maintainer.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Just as ERTS is an implementation of a more general concept of a Erlang
Runtime System so is BEAM an implementation of a more general Erlang Virtual
Machine (EVM).
There is no definition of what constitutes an EVM but BEAM actually has two
levels of instructions <em>Generic Instructions</em> and <em>Specific Instructions</em>.
The generic instruction set could be seen as a blueprint for an EVM.</p>
</div>
<div class="paragraph">
<p>For a full description of BEAM see <a href="#CH-BEAM">Chapter 5</a>, <a href="#CH-beam_modules">Chapter 6</a>
and <a href="#CH-Instructions">Chapter 7</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_processes"><a class="link" href="#_processes">1.3.6. Processes</a></h4>
<div class="paragraph">
<p>An Erlang process basically works like an OS process. Each process has
its own memory (a mailbox, a heap and a stack) and a process control
block (PCB) with information about the process.</p>
</div>
<div class="paragraph">
<p>All Erlang code execution is done within the context of a process. One
Erlang node can have many processes, which can communicate through
message passing and signals. Erlang processes can also communicate with
processes on other Erlang nodes as long as the nodes are connected.</p>
</div>
<div class="paragraph">
<p>To learn more about processes and the PCB see <a href="#CH-Processes">Chapter 3</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_scheduling"><a class="link" href="#_scheduling">1.3.7. Scheduling</a></h4>
<div class="paragraph">
<p>The Scheduler is responsible for choosing the Erlang process to execute.
Basically the scheduler keeps two queues, a <em>ready queue</em> of processes
ready to run, and a <em>waiting queue</em> of processes waiting to receive a
message. When a process in the waiting queue receives a message or gets
a time out it is moved to the ready queue.</p>
</div>
<div class="paragraph">
<p>The scheduler picks the first process from the ready queue and hands it
to BEAM for execution of one <em>time slice</em>. BEAM preempts the running
process when the time slice is used up and adds the process to the
end of the ready queue. If the process is blocked in a receive before
the time slice is used up, it gets added to the waiting queue instead.</p>
</div>
<div class="paragraph">
<p>Erlang is concurrent by nature, that is, each process is conceptually
running at the same time as all other processes, but in reality there
is just one process running in the VM. On a multicore machine Erlang
actually runs more than one scheduler, usually one per physical core,
each having their own queues. This way Erlang achieves true
parallelism. To utilize more than one core ERTS has to be built (see
<a href="#AP-BuildingERTS">Appendix A</a>) in <em>SMP</em> mode. SMP stands for
<em>Symmetric MultiProcessing</em>, that is, the ability to execute a
processes on any one of multiple CPUs.</p>
</div>
<div class="paragraph">
<p>In reality the picture is more complicated with priorities among
processes and the waiting queue is implemented through a timing wheel.
All this and more is described in detail in <a href="#CH-Scheduling">Chapter 11</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_erlang_tag_scheme"><a class="link" href="#_the_erlang_tag_scheme">1.3.8. The Erlang Tag Scheme</a></h4>
<div class="paragraph">
<p>Erlang is a dynamically typed language, and the runtime system needs a
way to keep track of the type of each data object. This is done with a
tagging scheme. Each data object or pointer to a data object also has
a tag with information about the data type of the object.</p>
</div>
<div class="paragraph">
<p>Basically some bits of a pointer are reserved for the tag, and the
emulator can then determine the type of the object by looking at the
bit pattern of the tag.</p>
</div>
<div class="paragraph">
<p>These tags are used for pattern matching and for type test and for
primitive operations as well as by the garbage collector.</p>
</div>
<div class="paragraph">
<p>The complete tagging scheme is described in <a href="#CH-TypeSystem">Chapter 4</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_memory_handling"><a class="link" href="#_memory_handling">1.3.9. Memory Handling</a></h4>
<div class="paragraph">
<p>Erlang uses automatic memory management and the programmer does not
have to worry about memory allocation and deallocation. Each process
has a heap and a stack which both can grow, and shrink, as needed.</p>
</div>
<div class="paragraph">
<p>When a process runs out of heap space, the VM will first try to
reclaim free heap space through garbage collection. The garbage collector
will then go through the process stack and heap and copy live data
to a new heap while throwing away all the data that is dead. If there
still isn&#8217;t enough heap space, a new larger heap will be allocated and
the live data is moved there.</p>
</div>
<div class="paragraph">
<p>The details of the current generational copying garbage collector, including
the handling of reference counted binaries can be found in <a href="#CH-Memory">Chapter 12</a>.</p>
</div>
<div class="paragraph">
<p>In a system which uses HiPE compiled native code, each process actually has
two stacks, a BEAM stack and a native stack, the details can be found in
<a href="#CH-Native">Chapter 17</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_interpreter_and_the_command_line_interface"><a class="link" href="#_the_interpreter_and_the_command_line_interface">1.3.10. The Interpreter and the Command Line Interface</a></h4>
<div class="paragraph">
<p>When you start an Erlang node with erl you get a command prompt.
This is the <em>Erlang read eval print loop</em> (REPL) or the <em>command line
interface</em> (CLI) or simply the <em>Erlang shell</em>.</p>
</div>
<div class="paragraph">
<p>You can actually type in Erlang code and execute it directly from the
shell. In this case the code is not compiled to BEAM code and executed by
the BEAM, instead the code is parsed and interpreted by the Erlang
interpreter. In general the interpreted code behaves exactly as compiled
code, but there are a few subtle differences, these differences and all
other aspects of the shell are explained in <a href="#CH-Ops">Chapter 20</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Other_Erlang_Implementations"><a class="link" href="#Other_Erlang_Implementations">1.4. Other Erlang Implementations</a></h3>
<div class="paragraph">
<p>This book is mainly concerned with the "standard" Erlang
implementation by Ericsson/OTP called ERTS, but there are a few other
implementations available and in this section we will look at some of
them briefly.</p>
</div>
<div class="sect3">
<h4 id="_erlang_on_xen"><a class="link" href="#_erlang_on_xen">1.4.1. Erlang on Xen</a></h4>
<div class="paragraph">
<p>Erlang on Xen (<a href="http://erlangonxen.org" class="bare">http://erlangonxen.org</a>) is an Erlang implementation
running directly on server hardware with no OS layer in between, only
a thin Xen client.</p>
</div>
<div class="paragraph">
<p>Ling, the virtual machine of Erlang on Xen is almost 100% binary compatible
with BEAM. In xref:the_eox_stack you can see how the Erlang on Xen implementation
of the Erlang Solution Stack differs from the ERTS Stack. The thing to note here
is that there is no operating system in the Erlang on Xen stack.</p>
</div>
<div class="paragraph">
<p>Since Ling implements the generic instruction set of BEAM, it can reuse
the BEAM compiler from the OTP layer to compile Erlang to Ling.</p>
</div>
<div id="erlang_on_xen" class="imageblock">
<div class="content">
<img src="images/diag-10cfcd7afbcda4e740301b5eb4991532.png" alt="diag 10cfcd7afbcda4e740301b5eb4991532" width="440" height="266">
</div>
<div class="title">Figure 4. Erlang On Xen</div>
</div>
</div>
<div class="sect3">
<h4 id="_erjang"><a class="link" href="#_erjang">1.4.2. Erjang</a></h4>
<div class="paragraph">
<p>Erjang (<a href="http://www.erjang.org" class="bare">http://www.erjang.org</a>) is an Erlang implementation which runs
on the JVM. It loads .beam files and recompiles the code to Java .class
files. Erjang is almost 100% binary compatible with (generic) BEAM.</p>
</div>
<div class="paragraph">
<p>In xref:the_erjang_stack you can see how the Erjang implementation
of the Erlang Solution Stack differs from the ERTS Stack. The thing
to note here is that JVM has replaced BEAM as the virtual machine
and that Erjang provides the services of ERTS by implementing them
in Java on top of the VM.</p>
</div>
<div id="erlang_on_jvm" class="imageblock">
<div class="content">
<img src="images/diag-87fa075788f52f3ca9f1081807e7f5c6.png" alt="diag 87fa075788f52f3ca9f1081807e7f5c6" width="440" height="266">
</div>
<div class="title">Figure 5. Erlang on the JVM</div>
</div>
<div class="paragraph">
<p>Now that you have a basic understanding of all the major pieces of
ERTS, and the necessary vocabulary you can dive into the details of
each component. If you are eager to understand a certain component,
you can jump directly to that chapter. Or if you are really eager to
find a solution to a specific problem you could jump to the right
chapter in <a href="#P-Running">Part II</a>, and try the different methods to tune,
tweak, or debug your system.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Compiler"><a class="link" href="#CH-Compiler">2. The Compiler</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This book will not cover the programming language Erlang, but since
the goal of the ERTS is to run Erlang code you will need to know how
to compile Erlang code. In this chapter we will cover the compiler
options needed to generate readable beam code and how to add debug
information to the generated beam file. At the end of the chapter
there is also a section on the Elixir compiler.</p>
</div>
<div class="paragraph">
<p>For those readers interested in compiling their own favorite language
to ERTS this chapter will also contain detailed information about the
different intermediate formats in the compiler and how to plug your
compiler into the beam compiler backend. I will also present parse
transforms and give examples of how to use them to tweak the Erlang
language.</p>
</div>
<div class="sect2">
<h3 id="_compiling_erlang"><a class="link" href="#_compiling_erlang">2.1. Compiling Erlang</a></h3>
<div class="paragraph">
<p>Erlang is compiled from source code modules in .erl files
to fat binary .beam files.</p>
</div>
<div class="paragraph">
<p>The compiler can be run from the OS shell with the erlc command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> erlc foo.erl</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively the compiler can be invoked from the Erlang shell with
the default shell command c or by calling compile:file/{1,2}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nf">c</span><span class="p">(</span><span class="n">foo</span><span class="p">).</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">compile</span><span class="p">:</span><span class="nf">file</span><span class="p">(</span><span class="n">foo</span><span class="p">).</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The optional second argument to compile:file is a list of compiler
options. A full list of the options can be found in the documentation
of the compile module: see <a href="http://www.erlang.org/doc/man/compile.html" class="bare">http://www.erlang.org/doc/man/compile.html</a>.</p>
</div>
<div class="paragraph">
<p>Normally the compiler will compile Erlang source code from a .erl
file and write the resulting binary beam code to a .beam file. You
can also get the resulting binary back as an Erlang term
by giving the option binary to the compiler. This
option has then been overloaded to mean return any intermediate format
as a term instead of writing to a file. If you for example want the
compiler to return Core Erlang code you can give the options [core,
 binary].</p>
</div>
<div class="paragraph">
<p>The compiler is made up of a number of passes as illustrated in
<a href="#fig_compiler_passes">Figure 6</a>.</p>
</div>
<div id="fig_compiler_passes" class="imageblock">
<div class="content">
<img src="images/diag-248d8eb7547b927ef6dca3df5c44169a.png" alt="diag 248d8eb7547b927ef6dca3df5c44169a" width="1220" height="1512">
</div>
<div class="title">Figure 6. Compiler Passes</div>
</div>
<div class="paragraph">
<p>If you want to see a complete and up to date list of compiler passes
you can run the function compile:options/0 in an Erlang shell.
The definitive source for information about the compiler is of course
the source:
  <a href="https://github.com/erlang/otp/blob/maint/lib/compiler/src/compile.erl">compile.erl</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_generating_intermediate_output"><a class="link" href="#_generating_intermediate_output">2.2. Generating Intermediate Output</a></h3>
<div class="paragraph">
<p>Looking at the code produced by the compiler is a great help in trying
to understand how the virtual machine works. Fortunately, the compiler
can show us the intermediate code after each compiler pass and the
final beam code.</p>
</div>
<div class="paragraph">
<p>Let us try out our newfound knowledge to look at the generated code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"> <span class="mi">1</span><span class="o">&gt;</span> <span class="nn">compile</span><span class="p">:</span><span class="nf">options</span><span class="p">().</span>
 <span class="n">dpp</span> <span class="o">-</span> <span class="nv">Generate</span> <span class="p">.</span><span class="n">pp</span> <span class="n">file</span>
 <span class="n">'P'</span> <span class="o">-</span> <span class="nv">Generate</span> <span class="p">.</span><span class="nv">P</span> <span class="n">source</span> <span class="n">listing</span> <span class="n">file</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>...</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre> 'E' - Generate .E source listing file</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>...</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre> 'S' - Generate .S file</pre>
</div>
</div>
<div class="paragraph">
<p>Let us try with a small example program "world.erl":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">world</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">hello</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">include</span><span class="p">(</span><span class="s">"world.hrl"</span><span class="p">).</span>

<span class="nf">hello</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="o">?</span><span class="nv">GREETING</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And the include file "world.hrl"</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">GREETING</span><span class="p">,</span> <span class="s">"hello world"</span><span class="p">).</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you now compile this with the 'P' option to get the parsed file you
get a file "world.P":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">2</span><span class="o">&gt;</span> <span class="nf">c</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="p">[</span><span class="n">'P'</span><span class="p">]).</span>
<span class="o">**</span> <span class="nv">Warning</span><span class="p">:</span> <span class="nv">No</span> <span class="n">object</span> <span class="n">file</span> <span class="n">created</span> <span class="o">-</span> <span class="n">nothing</span> <span class="n">loaded</span> <span class="o">**</span>
<span class="n">ok</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the resulting .P file you can see a pretty printed version of
the code after the preprocessor (and parse transformation) has been
applied:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">file</span><span class="p">(</span><span class="s">"world.erl"</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span>

<span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">world</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">hello</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">file</span><span class="p">(</span><span class="s">"world.hrl"</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span>

<span class="p">-</span><span class="ni">file</span><span class="p">(</span><span class="s">"world.erl"</span><span class="p">,</span> <span class="mi">4</span><span class="p">).</span>

<span class="nf">hello</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="s">"hello world"</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To see how the code looks after all source code transformations are
done, you can compile the code with the 'E'-flag.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">3</span><span class="o">&gt;</span> <span class="nf">c</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="p">[</span><span class="n">'E'</span><span class="p">]).</span>
<span class="o">**</span> <span class="nv">Warning</span><span class="p">:</span> <span class="nv">No</span> <span class="n">object</span> <span class="n">file</span> <span class="n">created</span> <span class="o">-</span> <span class="n">nothing</span> <span class="n">loaded</span> <span class="o">**</span>
<span class="n">ok</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This gives us an .E file, in this case all compiler directives have
been removed and the built in functions module_info/{1,2} have been
added to the source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">vsn</span><span class="p">(</span><span class="s">"</span><span class="se">\002</span><span class="s">"</span><span class="p">).</span>

<span class="p">-</span><span class="ni">file</span><span class="p">(</span><span class="s">"world.erl"</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span>

<span class="p">-</span><span class="ni">file</span><span class="p">(</span><span class="s">"world.hrl"</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span>

<span class="p">-</span><span class="ni">file</span><span class="p">(</span><span class="s">"world.erl"</span><span class="p">,</span> <span class="mi">5</span><span class="p">).</span>

<span class="nf">hello</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="s">"hello world"</span><span class="p">.</span>

<span class="nf">module_info</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nn">erlang</span><span class="p">:</span><span class="nf">get_module_info</span><span class="p">(</span><span class="n">world</span><span class="p">).</span>

<span class="nf">module_info</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">erlang</span><span class="p">:</span><span class="nf">get_module_info</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="nv">X</span><span class="p">).</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will make use of the 'P' and 'E' options when we look at parse
transforms in <a href="#SEC-parse_transform">Section 2.3.2</a>, but first we will take a
look at an "assembler" view of generated BEAM code. By giving the
option 'S' to the compiler you get a .S file with Erlang terms
for each BEAM instruction in the code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">3</span><span class="o">&gt;</span> <span class="nf">c</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="p">[</span><span class="n">'S'</span><span class="p">]).</span>
<span class="o">**</span> <span class="nv">Warning</span><span class="p">:</span> <span class="nv">No</span> <span class="n">object</span> <span class="n">file</span> <span class="n">created</span> <span class="o">-</span> <span class="n">nothing</span> <span class="n">loaded</span> <span class="o">**</span>
<span class="n">ok</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The file world.S should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">{</span><span class="n">module</span><span class="p">,</span> <span class="n">world</span><span class="p">}.</span>  <span class="c">%% version = 0
</span>
<span class="p">{</span><span class="n">exports</span><span class="p">,</span> <span class="p">[{</span><span class="n">hello</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">module_info</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">module_info</span><span class="p">,</span><span class="mi">1</span><span class="p">}]}.</span>

<span class="p">{</span><span class="n">attributes</span><span class="p">,</span> <span class="p">[]}.</span>

<span class="p">{</span><span class="n">labels</span><span class="p">,</span> <span class="mi">7</span><span class="p">}.</span>


<span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">hello</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[{</span><span class="n">location</span><span class="p">,</span><span class="s">"world.erl"</span><span class="p">,</span><span class="mi">6</span><span class="p">}]}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">world</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">hello</span><span class="p">},</span><span class="mi">0</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">literal</span><span class="p">,</span><span class="s">"hello world"</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="n">return</span><span class="p">.</span>


<span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">module_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">3</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[]}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">world</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">module_info</span><span class="p">},</span><span class="mi">0</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">4</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">world</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[]}.</span>
    <span class="p">{</span><span class="n">call_ext_only</span><span class="p">,</span><span class="mi">1</span><span class="p">,{</span><span class="n">extfunc</span><span class="p">,</span><span class="n">erlang</span><span class="p">,</span><span class="n">get_module_info</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>


<span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">module_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">5</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[]}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">world</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">module_info</span><span class="p">},</span><span class="mi">1</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">6</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">world</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[]}.</span>
    <span class="p">{</span><span class="n">call_ext_only</span><span class="p">,</span><span class="mi">2</span><span class="p">,{</span><span class="n">extfunc</span><span class="p">,</span><span class="n">erlang</span><span class="p">,</span><span class="n">get_module_info</span><span class="p">,</span><span class="mi">2</span><span class="p">}}.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since this is a file with dot ("<em>.</em>") separated Erlang terms, you can
read the file back into the Erlang shell with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{ok, BEAM_Code} = file:consult("world.S").</pre>
</div>
</div>
<div class="paragraph">
<p>The assembler code mostly follows the layout of the original source
code.</p>
</div>
<div class="paragraph">
<p>The first instruction defines the module name of the code. The version
mentioned in the comment (%% version = 0) is the version of the beam
opcode format (as given by beam_opcodes:format_number/0).</p>
</div>
<div class="paragraph">
<p>Then comes a list of exports and any compiler attributes (none in this
example) much like in any Erlang source module.</p>
</div>
<div class="paragraph">
<p>The first real beam-like instruction is {labels, 7} which tells the
VM the number of labels in the code to make it possible to allocate
room for all labels in one pass over the code.</p>
</div>
<div class="paragraph">
<p>After that there is the actual code for each function. The first
instruction gives us the function name, the arity and the entry point
as a label number.</p>
</div>
<div class="paragraph">
<p>You can use the 'S' option with great effect to help you understand
how the BEAM works, and we will use it like that in later chapters. It
is also invaluable if you develop your own language that you compile
to the BEAM through Core Erlang, to see the generated code.</p>
</div>
</div>
<div class="sect2">
<h3 id="_compiler_passes"><a class="link" href="#_compiler_passes">2.3. Compiler Passes</a></h3>
<div class="paragraph">
<p>In the following sections we will go through most of the compiler
passes shown in <a href="#fig_compiler_passes">Figure 6</a>. For a language designer
targeting the BEAM this is interesting since it will show you what you
can accomplish with the different approaches: macros, parse
transforms, core erlang, and BEAM code, and how they depend on each
other.</p>
</div>
<div class="paragraph">
<p>When tuning Erlang code, it is good to know what optimizations are
applied when, and how you can look at generated code before and
after optimizations.</p>
</div>
<div class="sect3">
<h4 id="_compiler_pass_the_erlang_preprocessor_epp"><a class="link" href="#_compiler_pass_the_erlang_preprocessor_epp">2.3.1. Compiler Pass: The Erlang Preprocessor (epp)</a></h4>
<div class="paragraph">
<p>The compilation starts with a combined tokenizer (or scanner) and
preprocessor. That is, the preprosessor drives the tokenizer.
This means that macros are expanded as tokens, so
it is not a pure string replacement (as for example m4 or cpp).
You can not use Erlang macros to define your own syntax, a macro
will expand as a separate token from its surrounding characters.
You can not concatenate a macro and a character to a token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">plus</span><span class="p">,</span><span class="o">+</span><span class="p">).</span>
<span class="nf">t</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">A</span><span class="o">?</span><span class="n">plus</span><span class="o">+</span><span class="nv">B</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will expand to</p>
</div>
<div class="listingblock">
<div class="content">
<pre>t(A,B) -&gt; A + + B.</pre>
</div>
</div>
<div class="paragraph">
<p>and not</p>
</div>
<div class="listingblock">
<div class="content">
<pre>t(A,B) -&gt; A ++ B.</pre>
</div>
</div>
<div class="paragraph">
<p>On the other hand since macro expansion is done on the token
level, you do not need to have a valid Erlang term in the
right hand side of the macro, as long as you use it in a way
that gives you a valid term. E.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-define(p,o, o]).
 t() -&gt; [f,?p.</pre>
</div>
</div>
<div class="paragraph">
<p>There are few real usages for this other than to win the
obfuscated Erlang code contest. The main point to remember is that
you can not really use the Erlang preprocessor to define a language
with a syntax that differs from Erlang. Fortunately there are
other ways to do this, as you shall see later.</p>
</div>
</div>
<div class="sect3">
<h4 id="SEC-parse_transform"><a class="link" href="#SEC-parse_transform">2.3.2. Compiler Pass: Parse Transformations</a></h4>
<div class="paragraph">
<p>The easiest way to tweak the Erlang language is through Parse
Transformations (or parse transforms). Parse Transformations come
with all sorts of warnings, like this note in the OTP documentation:</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Programmers are strongly advised not to engage in parse
transformations and no support is offered for problems encountered.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When you use a parse transform you are basically writing an extra pass
in the compiler and that can if you are not careful lead to very
unexpected results. But to use a parse transform you have to declare
the usage in the module using it, and it will be local to that module,
so as far as compiler tweaks goes this one is quite safe.</p>
</div>
<div class="paragraph">
<p>The biggest problem with parse transforms as I see it is that you
are inventing your own syntax, and it will make it more difficult
for anyone else reading your code. At least until your parse transform
has become as popular and widely used as e.g. QLC.</p>
</div>
<div class="paragraph">
<p>OK, so you know you shouldn&#8217;t use it, but if you have to, here is what
you need to know. A parse transforms is a function that works on the
abstract syntax tree (AST) (see
<a href="http://www.erlang.org/doc/apps/erts/absform.html" class="bare">http://www.erlang.org/doc/apps/erts/absform.html</a> ). The compiler
does preprocessing, tokenization and parsing and then it will call the
parse transform function with the AST and expects to get back a
new AST.</p>
</div>
<div class="paragraph">
<p>This means that you can&#8217;t change the Erlang syntax fundamentally, but
you can change the semantics. Lets say for example that you for some
reason would like to write json code directly in your Erlang code,
then you are in luck since the tokens of json and of Erlang are
basically the same. Also, since the Erlang compiler does most of
its sanity checks in the linter pass which follows the parse transform
pass, you can allow an AST which does not represent valid Erlang.</p>
</div>
<div class="paragraph">
<p>To write a parse transform you need to write an Erlang module (lets
call it <em>p</em>) which exports the function parse_transform/2. This
function is called by the compiler during the parse transform pass if
the module being compiled (lets call it <em>m</em>) contains the compiler
option {parse_transform, p}. The arguments to the function is the
AST of the module m and the compiler options given to the call to the
compiler.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Note that you will not get any compiler options given in the file, this
is a bit of a nuisance since you can&#8217;t give options to the parse transform
from the code.</p>
</div>
<div class="paragraph">
<p>The compiler does not expand compiler options until the <em>expand</em> pass
which occurs after the parse transform pass.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The documentation of the abstract format is somewhat dense and it is
quite hard to get a grip on the abstract format by reading the
documentation. I encourage you to use the <em>syntax_tools</em> and
especially erl_syntax_lib for any serious work on the AST.</p>
</div>
<div class="paragraph">
<p>Here we will develop a simple parse transform just to get an
understanding of the AST. Therefore we will work directly on the AST
and use the old reliable io:format approach instead of syntax_tools.</p>
</div>
<div class="paragraph">
<p>First we create an example of what we would like to be able to compile
json_test.erl:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">json_test</span><span class="p">).</span>
<span class="p">-</span><span class="ni">compile</span><span class="p">({</span><span class="n">parse_transform</span><span class="p">,</span> <span class="n">json_parser</span><span class="p">}).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">test</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="nf">test</span><span class="p">(</span><span class="nv">V</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="p">{{</span>
      <span class="s">"name"</span>  <span class="p">:</span> <span class="s">"Jack (</span><span class="se">\"</span><span class="s">Bee</span><span class="se">\"</span><span class="s">) Nimble"</span><span class="p">,</span>
      <span class="s">"format"</span><span class="p">:</span> <span class="p">{</span>
                 <span class="s">"type"</span>      <span class="p">:</span> <span class="s">"rect"</span><span class="p">,</span>
                 <span class="s">"widths"</span>     <span class="p">:</span> <span class="p">[</span><span class="mi">1920</span><span class="p">,</span><span class="mi">1600</span><span class="p">],</span>
                 <span class="s">"height"</span>    <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1080</span><span class="p">),</span>
                 <span class="s">"interlace"</span> <span class="p">:</span> <span class="n">false</span><span class="p">,</span>
                 <span class="s">"frame rate"</span><span class="p">:</span> <span class="nv">V</span>
                <span class="p">}</span>
      <span class="p">}}</span><span class="o">&gt;&gt;</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we create a minimal parse transform module json_parser.erl:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">json_parser</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">parse_transform</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>

<span class="nf">parse_transform</span><span class="p">(</span><span class="nv">AST</span><span class="p">,</span> <span class="p">_</span><span class="nv">Options</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">"</span><span class="si">~p~n</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="nv">AST</span><span class="p">]),</span>
  <span class="nv">AST</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This identity parse transform returns an unchanged AST but it also prints
it out so that you can see what an AST looks like.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; c(json_parser).
{ok,json_parser}
2&gt; c(json_test).
[{attribute,1,file,{"./json_test.erl",1}},
 {attribute,1,module,json_test},
 {attribute,3,export,[{test,1}]},
 {function,5,test,1,
  [{clause,5,
    [{var,5,'V'}],
    [],
    [{bin,6,
      [{bin_element,6,
        {tuple,6,
         [{tuple,6,
           [{remote,7,{string,7,"name"},{string,7,"Jack (\"Bee\") Nimble"}},
            {remote,8,
             {string,8,"format"},
             {tuple,8,
              [{remote,9,{string,9,"type"},{string,9,"rect"}},
               {remote,10,
                {string,10,"widths"},
                {cons,10,
                 {integer,10,1920},
                 {cons,10,{integer,10,1600},{nil,10}}}},
               {remote,11,{string,11,"height"},{op,11,'-',{integer,11,1080}}},
               {remote,12,{string,12,"interlace"},{atom,12,false}},
               {remote,13,{string,13,"frame rate"},{var,13,'V'}}]}}]}]},
        default,default}]}]}]},
 {eof,16}]
./json_test.erl:7: illegal expression
./json_test.erl:8: illegal expression
./json_test.erl:5: Warning: variable 'V' is unused
error</pre>
</div>
</div>
<div class="paragraph">
<p>The compilation of json_test fails since the module contains invalid
Erlang syntax, but you get to see what the AST looks like. Now we can
just write some functions to traverse the AST and rewrite the json
code into Erlang code.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">json_parser</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">parse_transform</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>

<span class="nf">parse_transform</span><span class="p">(</span><span class="nv">AST</span><span class="p">,</span> <span class="p">_</span><span class="nv">Options</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">json</span><span class="p">(</span><span class="nv">AST</span><span class="p">,</span> <span class="p">[]).</span>

<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">FUNCTION</span><span class="p">(</span><span class="nv">Clauses</span><span class="p">),</span> <span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="nv">Label</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">Arity</span><span class="p">,</span> <span class="nv">Clauses</span><span class="p">}).</span>

<span class="c">%% We are only interested in code inside functions.
</span><span class="nf">json</span><span class="p">([</span><span class="o">?</span><span class="nv">FUNCTION</span><span class="p">(</span><span class="nv">Clauses</span><span class="p">)</span> <span class="p">|</span> <span class="nv">Elements</span><span class="p">],</span> <span class="nv">Res</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">json</span><span class="p">(</span><span class="nv">Elements</span><span class="p">,</span> <span class="p">[</span><span class="o">?</span><span class="nv">FUNCTION</span><span class="p">(</span><span class="nf">json_clauses</span><span class="p">(</span><span class="nv">Clauses</span><span class="p">))</span> <span class="p">|</span> <span class="nv">Res</span><span class="p">]);</span>
<span class="nf">json</span><span class="p">([</span><span class="nv">Other</span><span class="p">|</span><span class="nv">Elements</span><span class="p">],</span> <span class="nv">Res</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nf">json</span><span class="p">(</span><span class="nv">Elements</span><span class="p">,</span> <span class="p">[</span><span class="nv">Other</span> <span class="p">|</span> <span class="nv">Res</span><span class="p">]);</span>
<span class="nf">json</span><span class="p">([],</span> <span class="nv">Res</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">reverse</span><span class="p">(</span><span class="nv">Res</span><span class="p">).</span>

<span class="c">%% We are interested in the code in the body of a function.
</span><span class="nf">json_clauses</span><span class="p">([{</span><span class="n">clause</span><span class="p">,</span> <span class="nv">CLine</span><span class="p">,</span> <span class="nv">A1</span><span class="p">,</span> <span class="nv">A2</span><span class="p">,</span> <span class="nv">Code</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Clauses</span><span class="p">])</span> <span class="o">-&gt;</span>
    <span class="p">[{</span><span class="n">clause</span><span class="p">,</span> <span class="nv">CLine</span><span class="p">,</span> <span class="nv">A1</span><span class="p">,</span> <span class="nv">A2</span><span class="p">,</span> <span class="nf">json_code</span><span class="p">(</span><span class="nv">Code</span><span class="p">)}</span> <span class="p">|</span> <span class="nf">json_clauses</span><span class="p">(</span><span class="nv">Clauses</span><span class="p">)];</span>
<span class="nf">json_clauses</span><span class="p">([])</span> <span class="o">-&gt;</span> <span class="p">[].</span>


<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">JSON</span><span class="p">(</span><span class="nv">Json</span><span class="p">),</span> <span class="p">{</span><span class="n">bin</span><span class="p">,</span> <span class="p">_,</span> <span class="p">[{</span><span class="n">bin_element</span>
                                         <span class="p">,</span> <span class="p">_</span>
                                         <span class="p">,</span> <span class="p">{</span><span class="n">tuple</span><span class="p">,</span> <span class="p">_,</span> <span class="p">[</span><span class="nv">Json</span><span class="p">]}</span>
                                         <span class="p">,</span> <span class="p">_</span>
                                         <span class="p">,</span> <span class="p">_}]}).</span>

<span class="c">%% We look for: &lt;&lt;"json"&gt;&gt; = Json-Term
</span><span class="nf">json_code</span><span class="p">([])</span>                     <span class="o">-&gt;</span> <span class="p">[];</span>
<span class="nf">json_code</span><span class="p">([</span><span class="o">?</span><span class="nv">JSON</span><span class="p">(</span><span class="nv">Json</span><span class="p">)|</span><span class="nv">MoreCode</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nf">parse_json</span><span class="p">(</span><span class="nv">Json</span><span class="p">)</span> <span class="p">|</span> <span class="nf">json_code</span><span class="p">(</span><span class="nv">MoreCode</span><span class="p">)];</span>
<span class="nf">json_code</span><span class="p">(</span><span class="nv">Code</span><span class="p">)</span>                   <span class="o">-&gt;</span> <span class="nv">Code</span><span class="p">.</span>

<span class="c">%% Json Object -&gt; [{}] | [{Label, Term}]
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">tuple</span><span class="p">,</span><span class="nv">Line</span><span class="p">,[]})</span>            <span class="o">-&gt;</span> <span class="p">{</span><span class="n">cons</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="p">{</span><span class="n">tuple</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="p">[]}};</span>
<span class="nf">parse_json</span><span class="p">({</span><span class="n">tuple</span><span class="p">,</span><span class="nv">Line</span><span class="p">,</span><span class="nv">Fields</span><span class="p">})</span>        <span class="o">-&gt;</span> <span class="nf">parse_json_fields</span><span class="p">(</span><span class="nv">Fields</span><span class="p">,</span><span class="nv">Line</span><span class="p">);</span>
<span class="c">%% Json Array -&gt; List
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">cons</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Head</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">})</span>   <span class="o">-&gt;</span> <span class="p">{</span><span class="n">cons</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nf">parse_json</span><span class="p">(</span><span class="nv">Head</span><span class="p">),</span>
                                                       <span class="nf">parse_json</span><span class="p">(</span><span class="nv">Tail</span><span class="p">)};</span>
<span class="nf">parse_json</span><span class="p">({</span><span class="n">nil</span><span class="p">,</span> <span class="nv">Line</span><span class="p">})</span>                <span class="o">-&gt;</span> <span class="p">{</span><span class="n">nil</span><span class="p">,</span> <span class="nv">Line</span><span class="p">};</span>
<span class="c">%% Json String -&gt; &lt;&lt;String&gt;&gt;
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">string</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">String</span><span class="p">})</span>     <span class="o">-&gt;</span> <span class="nf">str_to_bin</span><span class="p">(</span><span class="nv">String</span><span class="p">,</span> <span class="nv">Line</span><span class="p">);</span>
<span class="c">%% Json Integer -&gt; Intger
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Integer</span><span class="p">})</span>   <span class="o">-&gt;</span> <span class="p">{</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Integer</span><span class="p">};</span>
<span class="c">%% Json Float -&gt; Float
</span><span class="nf">parse_json</span><span class="p">({</span><span class="nb">float</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Float</span><span class="p">})</span>       <span class="o">-&gt;</span> <span class="p">{</span><span class="nb">float</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Float</span><span class="p">};</span>
<span class="c">%% Json Constant -&gt; true | false | null
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">true</span><span class="p">})</span>         <span class="o">-&gt;</span> <span class="p">{</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">true</span><span class="p">};</span>
<span class="nf">parse_json</span><span class="p">({</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">false</span><span class="p">})</span>        <span class="o">-&gt;</span> <span class="p">{</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">false</span><span class="p">};</span>
<span class="nf">parse_json</span><span class="p">({</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">null</span><span class="p">})</span>         <span class="o">-&gt;</span> <span class="p">{</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">null</span><span class="p">};</span>

<span class="c">%% Variables, should contain Erlang encoded Json
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Var</span><span class="p">})</span>         <span class="o">-&gt;</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Var</span><span class="p">};</span>
<span class="c">%% Json Negative Integer or Float
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">op</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">'-'</span><span class="p">,</span> <span class="p">{</span><span class="nv">Type</span><span class="p">,</span> <span class="p">_,</span> <span class="nv">N</span><span class="p">}})</span> <span class="k">when</span> <span class="nv">Type</span> <span class="o">=:=</span> <span class="n">integer</span>
                                             <span class="p">;</span> <span class="nv">Type</span> <span class="o">=:=</span> <span class="nb">float</span> <span class="o">-&gt;</span>
                                          <span class="p">{</span><span class="nv">Type</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="o">-</span><span class="nv">N</span><span class="p">}.</span>
<span class="c">%% parse_json(Code)                  -&gt; io:format("Code: ~p~n",[Code]), Code.
</span>
<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">FIELD</span><span class="p">(</span><span class="nv">Label</span><span class="p">,</span> <span class="nv">Code</span><span class="p">),</span> <span class="p">{</span><span class="n">remote</span><span class="p">,</span> <span class="nv">L</span><span class="p">,</span> <span class="p">{</span><span class="n">string</span><span class="p">,</span> <span class="p">_,</span> <span class="nv">Label</span><span class="p">},</span> <span class="nv">Code</span><span class="p">}).</span>

<span class="nf">parse_json_fields</span><span class="p">([],</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">nil</span><span class="p">,</span> <span class="nv">L</span><span class="p">};</span>
<span class="c">%% Label : Json-Term  --&gt; [{&lt;&lt;Label&gt;&gt;, Term} | Rest]
</span><span class="nf">parse_json_fields</span><span class="p">([</span><span class="o">?</span><span class="nv">FIELD</span><span class="p">(</span><span class="nv">Label</span><span class="p">,</span> <span class="nv">Code</span><span class="p">)</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="p">_)</span> <span class="o">-&gt;</span>
    <span class="nf">cons</span><span class="p">(</span><span class="nf">tuple</span><span class="p">(</span><span class="nf">str_to_bin</span><span class="p">(</span><span class="nv">Label</span><span class="p">,</span> <span class="nv">L</span><span class="p">),</span> <span class="nf">parse_json</span><span class="p">(</span><span class="nv">Code</span><span class="p">),</span> <span class="nv">L</span><span class="p">)</span>
         <span class="p">,</span> <span class="nf">parse_json_fields</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span>
         <span class="p">,</span> <span class="nv">L</span><span class="p">).</span>


<span class="nf">tuple</span><span class="p">(</span><span class="nv">E1</span><span class="p">,</span> <span class="nv">E2</span><span class="p">,</span> <span class="nv">Line</span><span class="p">)</span>    <span class="o">-&gt;</span> <span class="p">{</span><span class="n">tuple</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="p">[</span><span class="nv">E1</span><span class="p">,</span> <span class="nv">E2</span><span class="p">]}.</span>
<span class="nf">cons</span><span class="p">(</span><span class="nv">Head</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">,</span> <span class="nv">Line</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">cons</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Head</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">}.</span>

<span class="nf">str_to_bin</span><span class="p">(</span><span class="nv">String</span><span class="p">,</span> <span class="nv">Line</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">bin</span>
     <span class="p">,</span> <span class="nv">Line</span>
     <span class="p">,</span> <span class="p">[{</span><span class="n">bin_element</span>
         <span class="p">,</span> <span class="nv">Line</span>
         <span class="p">,</span> <span class="p">{</span><span class="n">string</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">String</span><span class="p">}</span>
         <span class="p">,</span> <span class="n">default</span>
         <span class="p">,</span> <span class="n">default</span>
        <span class="p">}</span>
       <span class="p">]</span>
    <span class="p">}.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now we can compile json_test without errors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nf">c</span><span class="p">(</span><span class="n">json_parser</span><span class="p">).</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="n">json_parser</span><span class="p">}</span>
<span class="mi">2</span><span class="o">&gt;</span> <span class="nf">c</span><span class="p">(</span><span class="n">json_test</span><span class="p">).</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="n">json_test</span><span class="p">}</span>
<span class="mi">3</span><span class="o">&gt;</span> <span class="nn">json_test</span><span class="p">:</span><span class="nf">test</span><span class="p">(</span><span class="mi">42</span><span class="p">).</span>
<span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">"name"</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">"Jack (</span><span class="se">\"</span><span class="s">Bee</span><span class="se">\"</span><span class="s">) Nimble"</span><span class="o">&gt;&gt;</span><span class="p">},</span>
<span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"format"</span><span class="o">&gt;&gt;</span><span class="p">,</span>
  <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">"type"</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">"rect"</span><span class="o">&gt;&gt;</span><span class="p">},</span>
   <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"widths"</span><span class="o">&gt;&gt;</span><span class="p">,[</span><span class="mi">1920</span><span class="p">,</span><span class="mi">1600</span><span class="p">]},</span>
   <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"height"</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">-</span><span class="mi">1080</span><span class="p">},</span>
   <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"interlace"</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="n">false</span><span class="p">},</span>
   <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"frame rate"</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="mi">42</span><span class="p">}]}]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The AST generated by parse_transform/2 must correspond to valid
Erlang code unless you apply several parse transforms, which is
possible. The validity of the code is checked by the following
compiler pass.</p>
</div>
</div>
<div class="sect3">
<h4 id="_compiler_pass_linter"><a class="link" href="#_compiler_pass_linter">2.3.3. Compiler Pass: Linter</a></h4>
<div class="paragraph">
<p>The linter (erl_lint.erl) generates warnings for syntactically
correct but otherwise bad code, like "export_all flag enabled".</p>
</div>
</div>
<div class="sect3">
<h4 id="_compiler_pass_save_ast"><a class="link" href="#_compiler_pass_save_ast">2.3.4. Compiler Pass: Save AST</a></h4>
<div class="paragraph">
<p>In order to enable debugging of a module, you can "debug compile" the
module, that is to pass the option debug_info to the compiler. The
abstract syntax tree will then be saved by the "Save AST" until the
end of the compilation, where it will be written to the .beam file.</p>
</div>
<div class="paragraph">
<p>It is important to note that the code is saved before any
optimisations are applied, so if there is a bug in an optimisation
pass in the compiler and you run code in the debugger you will get a
diffferent behavior. If you are implementing your own compiler
optimisations this can trick you up badly.</p>
</div>
</div>
<div class="sect3">
<h4 id="_compiler_pass_expand"><a class="link" href="#_compiler_pass_expand">2.3.5. Compiler Pass: Expand</a></h4>
<div class="paragraph">
<p>In the expand phase source erlang constructs, such as records, are
expanded to lower level erlang constructs. Compiler options,
"-compile(...)", are also <em>expanded</em> to meta data.</p>
</div>
</div>
<div class="sect3">
<h4 id="_compiler_pass_core_erlang"><a class="link" href="#_compiler_pass_core_erlang">2.3.6. Compiler Pass: Core Erlang</a></h4>
<div class="paragraph">
<p>Core Erlang is a strict functional language suitable for compiler
optimizations. It makes code transformations easier by reducing the
number of ways to express the same operation. One way it does this is
by introducing <em>let</em> and <em>letrec</em> expressions to make scoping more
explicit.</p>
</div>
<div class="paragraph">
<p>Core Erlang is the best target for a language you want to run in
ERTS. It changes very seldom and it contains all aspects of Erlang in
a clean way. If you target the beam instruction set directly you will
have to deal with much more details, and that instruction set usually
changes slightly between each major release of ERTS. If you on the other
hand target Erlang directly you will be more restricted in what you
can describe, and you will also have to deal with more details, since
 Core Erlang is a cleaner language.</p>
</div>
<div class="paragraph">
<p>To compile an Erlang file to core you can give the option "to_core",
note though that this writes the Erlang core program to a file with
the ".core" extension. To compile an Erlang core program from a ".core"
file you can give the option "from_core" to the compiler.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1&gt; c(world, to_core).
** Warning: No object file created - nothing loaded **
ok
2&gt; c(world, from_core).
{ok,world}</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the .core files are text files written in the human
readable core format. To get the core program as an Erlang term
you can add the binary option to the compilation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_compiler_pass_kernel_erlang"><a class="link" href="#_compiler_pass_kernel_erlang">2.3.7. Compiler Pass: Kernel Erlang</a></h4>
<div class="paragraph">
<p>Kernel Erlang is a flat version of Core Erlang with a few differences.
For example, each variable is unique and the scope is a whole function.
Pattern matching is compiled to more primitive operations.</p>
</div>
</div>
<div class="sect3">
<h4 id="_compiler_pass_beam_code"><a class="link" href="#_compiler_pass_beam_code">2.3.8. Compiler Pass: BEAM Code</a></h4>
<div class="paragraph">
<p>The last step of a normal compilation is the external beam code
format. Some low level optimizations such as dead code elimination and
peep hole optimisations are done on this level.</p>
</div>
<div class="paragraph">
<p>The BEAM code is described in detail in
<a href="#CH-Instructions">Chapter 7</a> and <a href="#AP-Instructions">Appendix B</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_compiler_pass_native_code"><a class="link" href="#_compiler_pass_native_code">2.3.9. Compiler Pass: Native Code</a></h4>
<div class="paragraph">
<p>If you add the flag native to the compilation, and you have a HiPE
enabled runtime system, then the compiler will generate native code
for your module and store the native code along with the beam code
in the .beam. file.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_other_compiler_tools"><a class="link" href="#_other_compiler_tools">2.4. Other Compiler Tools</a></h3>
<div class="paragraph">
<p>There are a number of tools available to help you work with code
generation and code manipulation. These tools are written in Erlang
and not really part of the runtime system but they are very nice to
know about if you are implementing another language on top of the
BEAM.</p>
</div>
<div class="paragraph">
<p>In this section we will cover three of the most useful code tools:
the lexer&#8201;&#8212;&#8201;Leex, the parser generator&#8201;&#8212;&#8201;Yecc, and a general set
of functions to manipulate abstract forms&#8201;&#8212;&#8201;Syntax Tools.</p>
</div>
<div class="sect3">
<h4 id="_leex"><a class="link" href="#_leex">2.4.1. Leex</a></h4>
<div class="paragraph">
<p>Leex is the Erlang lexer generator.
The lexer generator takes a description of a DFA from a definitions
file xrl and produces an Erlang
program that matches tokens described by the DFA.</p>
</div>
<div class="paragraph">
<p>The details of how to write a DFA definition for a tokenizer
is beyond the scope of this book. For a thorough explanation
I recommend the "Dragon book" (Compiler &#8230;&#8203; by Aho, Sethi and Ullman).
Other good resources are the man and info entry for "flex" the lexer program
that inspired leex, and the leex documentation itself.
If you have info and flex installed you can read the full manual by typing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; info flex</pre>
</div>
</div>
<div class="paragraph">
<p>The online Erlang documentation also has the leex manual
(see <a href="http://erlang.org/doc/man/yecc.html">yecc.html</a>).</p>
</div>
<div class="paragraph">
<p>We can use the lexer generator to create an Erlang program which
recognizes JSON tokens. By looking at the JSON definition
<a href="http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf" class="bare">http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf</a>
we can see that there are only a handful of tokens that we need to handle.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">Definitions</span><span class="p">.</span>

<span class="nv">Digit</span>         <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>
<span class="nv">Digit1to9</span>     <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>
<span class="nv">HexDigit</span>      <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="n">a</span><span class="o">-</span><span class="n">f</span><span class="p">]</span>
<span class="nv">UnescapedChar</span> <span class="o">=</span> <span class="p">[</span><span class="err">^\</span><span class="s">"</span><span class="se">\\</span><span class="s">]
EscapedChar   = (</span><span class="se">\\\\</span><span class="s">)|(</span><span class="se">\\\"</span><span class="s">)|(</span><span class="se">\\</span><span class="s">b)|(</span><span class="se">\\</span><span class="s">f)|(</span><span class="se">\\</span><span class="s">n)|(</span><span class="se">\\</span><span class="s">r)|(</span><span class="se">\\</span><span class="s">t)|(</span><span class="se">\\</span><span class="s">/)
Unicode       = (</span><span class="se">\\</span><span class="s">u{HexDigit}{HexDigit}{HexDigit}{HexDigit})
Quote         = [</span><span class="se">\"</span><span class="s">]
Delim         = [</span><span class="err">\</span><span class="s">[</span><span class="err">\</span><span class="s">]:,{}]
Space         = [</span><span class="se">\n\s\t\r</span><span class="s">]

Rules.

{Quote}{Quote} : {token, {string, TokenLine, ""}}.
{Quote}({EscapedChar}|({UnescapedChar})|({Unicode}))+{Quote} :
  {token, {string, TokenLine, drop_quotes(TokenChars)}}.

null  : {token, {null,  TokenLine}}.
true  : {token, {true,  TokenLine}}.
false : {token, {false, TokenLine}}.

{Delim} : {token, {list_to_atom(TokenChars), TokenLine}}.

{Space} : skip_token.

-?{Digit1to9}+{Digit}*</span><span class="err">\</span><span class="s">.{Digit}+((E|e)(</span><span class="err">\</span><span class="s">+|</span><span class="err">\</span><span class="s">-)?{Digit}+)? :
  {token, {number, TokenLine, list_to_float(TokenChars)}}.
-?{Digit1to9}+{Digit}* :
  {token, {number, TokenLine, list_to_integer(TokenChars)+0.0}}.

Erlang code.
-export([t/0]).

drop_quotes([$"</span> <span class="p">|</span> <span class="nv">QuotedString</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nf">literal</span><span class="p">(</span><span class="nn">lists</span><span class="p">:</span><span class="nf">droplast</span><span class="p">(</span><span class="nv">QuotedString</span><span class="p">)).</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$"</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="sc">$"</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$\\</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="sc">$\\</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$/</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="sc">$/</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$b</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="sc">$\b</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$f</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="sc">$\f</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$n</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="sc">$\n</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$r</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="sc">$\r</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$t</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="sc">$\t</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$u</span><span class="p">,</span><span class="nv">D0</span><span class="p">,</span><span class="nv">D1</span><span class="p">,</span><span class="nv">D2</span><span class="p">,</span><span class="nv">D3</span><span class="p">|</span><span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="nv">Char</span> <span class="o">=</span> <span class="nb">list_to_integer</span><span class="p">([</span><span class="nv">D0</span><span class="p">,</span><span class="nv">D1</span><span class="p">,</span><span class="nv">D2</span><span class="p">,</span><span class="nv">D3</span><span class="p">],</span><span class="mi">16</span><span class="p">),</span>
  <span class="p">[</span><span class="nv">Char</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="nv">C</span><span class="p">|</span><span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="nv">C</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([])</span> <span class="o">-&gt;</span><span class="p">[].</span>

<span class="nf">t</span><span class="p">()</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="n">ok</span><span class="p">,</span>
   <span class="p">[{</span><span class="n">'{'</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span>
    <span class="p">{</span><span class="n">string</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s">"no"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">':'</span><span class="p">,</span><span class="mi">2</span><span class="p">},</span>
    <span class="p">{</span><span class="n">number</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">},</span>
    <span class="p">{</span><span class="n">'}'</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span>
   <span class="p">],</span>
   <span class="mi">4</span><span class="p">}.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By using the Leex compiler we can compile this DFA to Erlang code,
and by giving the option dfa_graph we also produce a dot-file
which can be viewed with e.g. Graphviz.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">leex</span><span class="p">:</span><span class="nf">file</span><span class="p">(</span><span class="n">json_tokens</span><span class="p">,</span> <span class="p">[</span><span class="n">dfa_graph</span><span class="p">]).</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="s">"./json_tokens.erl"</span><span class="p">}</span>
<span class="mi">2</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can view the DFA graph using for example dotty.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="o">&gt;</span> dotty json_tokens.dot</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="code/compiler_chapter/json_tokens.png" alt="json tokens">
</div>
</div>
<div class="paragraph">
<p>We can try our tokenizer on an example json file (test.json).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
    "no" : 1,
    "name"  : "Jack \"Bee\" Nimble",
    "escapes" : "\b\n\r\t\f\//\\",
    "format": {
        "type"      : "rect",
        "widths"    : [1920,1600],
        "height"    : -1080,
        "interlace" : false,
        "unicode"   : "\u002f",
        "frame rate": 4.5
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>First we need to compile our tokenizer, then we read the file
and convert it to a string. Finally we can use
the string/1 function that leex generates to tokenize the test file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">2</span><span class="o">&gt;</span> <span class="nf">c</span><span class="p">(</span><span class="n">json_tokens</span><span class="p">).</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="n">json_tokens</span><span class="p">}.</span>
<span class="mi">3</span><span class="o">&gt;</span> <span class="nf">f</span><span class="p">(</span><span class="nv">File</span><span class="p">),</span> <span class="nf">f</span><span class="p">(</span><span class="nv">L</span><span class="p">),</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">File</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p">(</span><span class="s">"test.json"</span><span class="p">),</span> <span class="nv">L</span> <span class="o">=</span> <span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">File</span><span class="p">),</span> <span class="n">ok</span><span class="p">.</span>
<span class="n">ok</span>
<span class="mi">4</span><span class="o">&gt;</span> <span class="nf">f</span><span class="p">(</span><span class="nv">Tokens</span><span class="p">),</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Tokens</span><span class="p">,_}</span> <span class="o">=</span> <span class="nn">json_tokens</span><span class="p">:</span><span class="nf">string</span><span class="p">(</span><span class="nv">L</span><span class="p">),</span> <span class="nb">hd</span><span class="p">(</span><span class="nv">Tokens</span><span class="p">).</span>
<span class="p">{</span><span class="n">'{'</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span>
<span class="mi">5</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The shell function f/1 tells the shell to forget a variable
binding. This is useful if you want to try a command that binds a
variable multiple times, for example as you are writing the lexer and
want to try it out after each rewrite. We will look at the shell
commands in detail in the later chapter.</p>
</div>
<div class="paragraph">
<p>Armed with a tokenizer for JSON we can now write a json parser
using the parser generator Yecc.</p>
</div>
</div>
<div class="sect3">
<h4 id="_yecc"><a class="link" href="#_yecc">2.4.2. Yecc</a></h4>
<div class="paragraph">
<p>Yecc is a parser generator for Erlang. The name comes from Yacc
(Yet another compiler compiler) the canonical parser generator for C.</p>
</div>
<div class="paragraph">
<p>Now that we have a lexer for JSON terms we can write a parser using
yecc.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">Nonterminals</span> <span class="n">value</span> <span class="n">values</span> <span class="n">object</span> <span class="n">array</span> <span class="n">pair</span> <span class="n">pairs</span><span class="p">.</span>

<span class="nv">Terminals</span> <span class="n">number</span> <span class="n">string</span> <span class="n">true</span> <span class="n">false</span> <span class="n">null</span> <span class="n">'['</span> <span class="n">']'</span> <span class="n">'{'</span> <span class="n">'}'</span> <span class="n">','</span> <span class="n">':'</span><span class="p">.</span>

<span class="nv">Rootsymbol</span> <span class="n">value</span><span class="p">.</span>

<span class="n">value</span> <span class="o">-&gt;</span> <span class="n">object</span>  <span class="p">:</span>  <span class="n">'$1'</span><span class="p">.</span>
<span class="n">value</span> <span class="o">-&gt;</span> <span class="n">array</span>   <span class="p">:</span>  <span class="n">'$1'</span><span class="p">.</span>
<span class="n">value</span> <span class="o">-&gt;</span> <span class="n">number</span>  <span class="p">:</span>  <span class="nf">get_val</span><span class="p">(</span><span class="n">'$1'</span><span class="p">).</span>
<span class="n">value</span> <span class="o">-&gt;</span> <span class="n">string</span>  <span class="p">:</span>  <span class="nf">get_val</span><span class="p">(</span><span class="n">'$1'</span><span class="p">).</span>
<span class="n">value</span> <span class="o">-&gt;</span> <span class="n">'true'</span>  <span class="p">:</span>  <span class="nf">get_val</span><span class="p">(</span><span class="n">'$1'</span><span class="p">).</span>
<span class="n">value</span> <span class="o">-&gt;</span> <span class="n">'null'</span>  <span class="p">:</span>  <span class="nf">get_val</span><span class="p">(</span><span class="n">'$1'</span><span class="p">).</span>
<span class="n">value</span> <span class="o">-&gt;</span> <span class="n">'false'</span> <span class="p">:</span>  <span class="nf">get_val</span><span class="p">(</span><span class="n">'$1'</span><span class="p">).</span>

<span class="n">object</span> <span class="o">-&gt;</span> <span class="n">'{'</span> <span class="n">'}'</span> <span class="p">:</span> <span class="err">#</span><span class="p">{}.</span>
<span class="n">object</span> <span class="o">-&gt;</span> <span class="n">'{'</span> <span class="n">pairs</span> <span class="n">'}'</span> <span class="p">:</span> <span class="n">'$2'</span><span class="p">.</span>

<span class="n">pairs</span> <span class="o">-&gt;</span> <span class="n">pair</span> <span class="p">:</span> <span class="n">'$1'</span><span class="p">.</span>
<span class="n">pairs</span> <span class="o">-&gt;</span> <span class="n">pair</span> <span class="n">','</span> <span class="n">pairs</span> <span class="p">:</span> <span class="nn">maps</span><span class="p">:</span><span class="nf">merge</span><span class="p">(</span><span class="n">'$1'</span><span class="p">,</span> <span class="n">'$3'</span><span class="p">).</span>

<span class="n">pair</span> <span class="o">-&gt;</span> <span class="n">string</span> <span class="n">':'</span> <span class="n">value</span> <span class="p">:</span> <span class="err">#</span><span class="p">{</span> <span class="nf">get_val</span><span class="p">(</span><span class="n">'$1'</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">'$3'</span> <span class="p">}.</span>

<span class="n">array</span> <span class="o">-&gt;</span> <span class="n">'['</span> <span class="n">']'</span> <span class="p">:</span> <span class="p">{}.</span>
<span class="n">array</span> <span class="o">-&gt;</span> <span class="n">'['</span> <span class="n">values</span> <span class="n">']'</span> <span class="p">:</span> <span class="nb">list_to_tuple</span><span class="p">(</span><span class="n">'$2'</span><span class="p">).</span>

<span class="n">values</span> <span class="o">-&gt;</span> <span class="n">value</span> <span class="p">:</span> <span class="p">[</span> <span class="n">'$1'</span> <span class="p">].</span>
<span class="n">values</span> <span class="o">-&gt;</span> <span class="n">value</span> <span class="n">','</span> <span class="n">values</span> <span class="p">:</span> <span class="p">[</span> <span class="n">'$1'</span> <span class="p">|</span> <span class="n">'$3'</span> <span class="p">].</span>



<span class="nv">Erlang</span> <span class="n">code</span><span class="p">.</span>

<span class="nf">get_val</span><span class="p">({_,_,</span><span class="nv">Val</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="nv">Val</span><span class="p">;</span>
<span class="nf">get_val</span><span class="p">({</span><span class="nv">Val</span><span class="p">,</span> <span class="p">_})</span> <span class="o">-&gt;</span> <span class="nv">Val</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we can use yecc to generate an Erlang program that implements
the parser, and call the parse/1 function provided with the tokens
generated by the tokenizer as an argument.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">5</span><span class="o">&gt;</span> <span class="nn">yecc</span><span class="p">:</span><span class="nf">file</span><span class="p">(</span><span class="n">yecc_json_parser</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="n">yecc_json_parser</span><span class="p">).</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="n">yexx_json_parser</span><span class="p">}</span>
<span class="mi">6</span><span class="o">&gt;</span> <span class="nf">f</span><span class="p">(</span><span class="nv">Json</span><span class="p">),</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Json</span><span class="p">}</span> <span class="o">=</span> <span class="nn">yecc_json_parser</span><span class="p">:</span><span class="nf">parse</span><span class="p">(</span><span class="nv">Tokens</span><span class="p">).</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="err">#</span><span class="p">{</span><span class="s">"escapes"</span> <span class="o">=&gt;</span> <span class="s">"</span><span class="se">\b\n\r\t\f</span><span class="s">////"</span><span class="p">,</span>
      <span class="s">"format"</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span><span class="s">"frame rate"</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span>
        <span class="s">"height"</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1080</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span>
        <span class="s">"interlace"</span> <span class="o">=&gt;</span> <span class="n">false</span><span class="p">,</span>
        <span class="s">"type"</span> <span class="o">=&gt;</span> <span class="s">"rect"</span><span class="p">,</span>
        <span class="s">"unicode"</span> <span class="o">=&gt;</span> <span class="s">"/"</span><span class="p">,</span>
        <span class="s">"widths"</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="mi">1920</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">.</span><span class="mi">6</span><span class="n">e3</span><span class="p">}},</span>
       <span class="s">"name"</span> <span class="o">=&gt;</span> <span class="s">"Jack </span><span class="se">\"</span><span class="s">Bee</span><span class="se">\"</span><span class="s"> Nimble"</span><span class="p">,</span>
       <span class="s">"no"</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The tools Leex and Yecc are nice when you want to compile your own
complete language to the Erlang virtual machine.
By combining them with Syntax tools and specifically Merl you can
manipulate the Erlang Abstract Syntax tree, either to generate
Erlang code or to change the behaviour of Erlang code.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_syntax_tools_and_merl"><a class="link" href="#_syntax_tools_and_merl">2.5. Syntax Tools and Merl</a></h3>
<div class="paragraph">
<p>Syntax Tools is a set of libraries for manipulating the
internal representation of Erlang&#8217;s Abstract Syntax Trees (ASTs).</p>
</div>
<div class="paragraph">
<p>The syntax tools applications also includes the tool Merl since Erlang 18.0.
With Merl you can very easily manipulate the syntax tree and write
parse stransforms in Erlang code.</p>
</div>
<div class="paragraph">
<p>You can find the documentation for Syntax Tools on the
Erlang.org site: <a href="http://erlang.org/doc/apps/syntax_tools/chapter.html">http://erlang.org/doc/apps/syntax_tools/chapter.html</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_compiling_elixir"><a class="link" href="#_compiling_elixir">2.6. Compiling Elixir</a></h3>
<div class="paragraph">
<p>Another approach to writing your own language on top of the Beam is to use
the meta programming tools in Elixir. Elixir compiles to Beam code through
the Erlang abstraxt syntax tree.</p>
</div>
<div class="paragraph">
<p>With Elixir&#8217;s defmacro you can define your own Domain Specific Language,
directly in Elixir.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Processes"><a class="link" href="#CH-Processes">3. Processes</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The concept of lightweight processes is the essence of Erlang and the
BEAM; they are what makes BEAM stand out from other virtual machines.
In order to understand how the BEAM (and Erlang and Elixir) works you
need to know the details of how processes work, which will help you
understand the central concept of the BEAM, including what is easy and
cheap for a process and what is hard and expensive.</p>
</div>
<div class="paragraph">
<p>Almost everything in the BEAM is connected to the concept
of processes and in this chapter we will learn more about these
connections. We will expand on what we learned in the introduction and
take a deeper look at concepts such as memory management, message
passing, and in particular scheduling.</p>
</div>
<div class="paragraph">
<p>An Erlang process is very similar to an OS process. It has its own
address space, it can communicate with other processes through signals
and messages, and the execution is controlled by a preemptive
scheduler.</p>
</div>
<div class="paragraph">
<p>When you have a performance problem in an Erlang or Elixir system the
problem is very often stemming from a problem within a particular
process or from an imbalance between processes. There are of course
other common problems such as bad algorithms or memory problems which
we will look at in other chapters. Still, being able to pinpoint the
process which is causing the problem is always important, therefore we
will look at the tools available in the Erlang RunTime System for
process inspection.</p>
</div>
<div class="paragraph">
<p>We will introduce the tools throughout the chapter as we go through
how a process and the scheduler works, and then we will bring all
tools together for an exercise at the end.</p>
</div>
<div class="sect2">
<h3 id="_what_is_a_process"><a class="link" href="#_what_is_a_process">3.1. What is a Process?</a></h3>
<div class="paragraph">
<p>A process is an isolated entity where code execution occurs.
A process protects your system from errors in your code by
isolating the effect of the error to the process executing
the faulty code.</p>
</div>
<div class="paragraph">
<p>The runtime comes with a number of tools for inspecting processes to
help us find bottlenecks, problems and overuse of resources. These
tools will help you identify and inspect problematic processes.</p>
</div>
<div class="sect3">
<h4 id="_listing_processes_from_the_shell"><a class="link" href="#_listing_processes_from_the_shell">3.1.1. Listing Processes from the Shell</a></h4>
<div class="paragraph">
<p>Let us dive right in and look at which processes we have
in a running system. The easiest way to do that is to
just start an Erlang shell and issue the shell command <code>i().</code>
In Elixir you can call the function in the <code>shell_default</code> module as
<code>:shell_default.i</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>erl
Erlang/OTP 19 <span class="o">[</span>erts-8.1] <span class="o">[</span><span class="nb">source</span><span class="o">]</span> <span class="o">[</span>64-bit] <span class="o">[</span>smp:4:4] <span class="o">[</span>async-threads:10]
              <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

Eshell V8.1  <span class="o">(</span>abort with ^G<span class="o">)</span>
1&gt; i<span class="o">()</span><span class="nb">.</span>
Pid                   Initial Call                     Heap     Reds Msgs
Registered            Current Function                 Stack
&lt;0.0.0&gt;               otp_ring0:start/2                 376      579    0
init                  init:loop/1                         2
&lt;0.1.0&gt;               erts_code_purger:start/0          233        4    0
erts_code_purger      erts_code_purger:loop/0             3
&lt;0.4.0&gt;               erlang:apply/2                    987   100084    0
erl_prim_loader       erl_prim_loader:loop/3              5
&lt;0.30.0&gt;              gen_event:init_it/6               610      226    0
error_logger          gen_event:fetch_msg/5               8
&lt;0.31.0&gt;              erlang:apply/2                   1598      416    0
application_controlle gen_server:loop/6                   7
&lt;0.33.0&gt;              application_master:init/4         233       64    0
                      application_master:main_loop/2      6
&lt;0.34.0&gt;              application_master:start_it/4     233       59    0
                      application_master:loop_it/4        5
&lt;0.35.0&gt;              supervisor:kernel/1               610     1767    0
kernel_sup            gen_server:loop/6                   9
&lt;0.36.0&gt;              erlang:apply/2                   6772    73914    0
code_server           code_server:loop/1                  3
&lt;0.38.0&gt;              rpc:init/1                        233       21    0
rex                   gen_server:loop/6                   9
&lt;0.39.0&gt;              global:init/1                     233       44    0
global_name_server    gen_server:loop/6                   9
&lt;0.40.0&gt;              erlang:apply/2                    233       21    0
                      global:loop_the_locker/1            5
&lt;0.41.0&gt;              erlang:apply/2                    233        3    0
                      global:loop_the_registrar/0         2
&lt;0.42.0&gt;              inet_db:init/1                    233      209    0
inet_db               gen_server:loop/6                   9
&lt;0.44.0&gt;              global_group:init/1               233       55    0
global_group          gen_server:loop/6                   9
&lt;0.45.0&gt;              file_server:init/1                233       79    0
file_server_2         gen_server:loop/6                   9
&lt;0.46.0&gt;              supervisor_bridge:standard_error/ 233       34    0
standard_error_sup    gen_server:loop/6                   9
&lt;0.47.0&gt;              erlang:apply/2                    233       10    0
standard_error        standard_error:server_loop/1        2
&lt;0.48.0&gt;              supervisor_bridge:user_sup/1      233       54    0
                      gen_server:loop/6                   9
&lt;0.49.0&gt;              user_drv:server/2                 987     1975    0
user_drv              user_drv:server_loop/6              9
&lt;0.50.0&gt;              group:server/3                    233       40    0
user                  group:server_loop/3                 4
&lt;0.51.0&gt;              group:server/3                    987    12508    0
                      group:server_loop/3                 4
&lt;0.52.0&gt;              erlang:apply/2                   4185     9537    0
                      shell:shell_rep/4                  17
&lt;0.53.0&gt;              kernel_config:init/1              233      255    0
                      gen_server:loop/6                   9
&lt;0.54.0&gt;              supervisor:kernel/1               233       56    0
kernel_safe_sup       gen_server:loop/6                   9
&lt;0.58.0&gt;              erlang:apply/2                   2586    18849    0
                      c:pinfo/1                          50
Total                                                 23426   220863    0
                                                        222
ok</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>i/0</code> function prints out a list of all processes in the system.
Each process gets two lines of information. The first two lines
of the printout are the headers telling you what the information
means. As you can see you get the Process ID (Pid) and the name of the
process if any, as well as information about the code the process
is started with and is executing. You also get information about the
heap and stack size and the number of reductions and messages in
the process. In the rest of this chapter we will learn in detail
what a stack, a heap, a reduction and a message are. For now we
can just assume that if there is a large number for the heap size,
then the process uses a lot of memory and if there is a large number
for the reductions then the process has executed a lot of code.</p>
</div>
<div class="paragraph">
<p>We can further examine a process with the <code>i/3</code> function. Let
us take a look at the <code>code_server</code> process. We can see in the
previous list that the process identifier (pid) of the <code>code_server</code>
is <code>&lt;0.36.0&gt;</code>. By calling <code>i/3</code> with the three numbers of
the pid we get this information:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">2</span><span class="o">&gt;</span> <span class="nf">i</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">0</span><span class="p">).</span>
<span class="p">[{</span><span class="n">registered_name</span><span class="p">,</span><span class="n">code_server</span><span class="p">},</span>
 <span class="p">{</span><span class="n">current_function</span><span class="p">,{</span><span class="n">code_server</span><span class="p">,</span><span class="n">loop</span><span class="p">,</span><span class="mi">1</span><span class="p">}},</span>
 <span class="p">{</span><span class="n">initial_call</span><span class="p">,{</span><span class="n">erlang</span><span class="p">,</span><span class="nb">apply</span><span class="p">,</span><span class="mi">2</span><span class="p">}},</span>
 <span class="p">{</span><span class="n">status</span><span class="p">,</span><span class="n">waiting</span><span class="p">},</span>
 <span class="p">{</span><span class="n">message_queue_len</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
 <span class="p">{</span><span class="n">messages</span><span class="p">,[]},</span>
 <span class="p">{</span><span class="n">links</span><span class="p">,[</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">35</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]},</span>
 <span class="p">{</span><span class="n">dictionary</span><span class="p">,[]},</span>
 <span class="p">{</span><span class="n">trap_exit</span><span class="p">,</span><span class="n">true</span><span class="p">},</span>
 <span class="p">{</span><span class="n">error_handler</span><span class="p">,</span><span class="n">error_handler</span><span class="p">},</span>
 <span class="p">{</span><span class="n">priority</span><span class="p">,</span><span class="n">normal</span><span class="p">},</span>
 <span class="p">{</span><span class="nb">group_leader</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">33</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">},</span>
 <span class="p">{</span><span class="n">total_heap_size</span><span class="p">,</span><span class="mi">46422</span><span class="p">},</span>
 <span class="p">{</span><span class="n">heap_size</span><span class="p">,</span><span class="mi">46422</span><span class="p">},</span>
 <span class="p">{</span><span class="n">stack_size</span><span class="p">,</span><span class="mi">3</span><span class="p">},</span>
 <span class="p">{</span><span class="n">reductions</span><span class="p">,</span><span class="mi">93418</span><span class="p">},</span>
 <span class="p">{</span><span class="n">garbage_collection</span><span class="p">,[{</span><span class="n">max_heap_size</span><span class="p">,</span><span class="err">#</span><span class="p">{</span><span class="n">error_logger</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span>
                                       <span class="n">kill</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span>
                                       <span class="nb">size</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">}},</span>
                      <span class="p">{</span><span class="n">min_bin_vheap_size</span><span class="p">,</span><span class="mi">46422</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">min_heap_size</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">fullsweep_after</span><span class="p">,</span><span class="mi">65535</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">minor_gcs</span><span class="p">,</span><span class="mi">0</span><span class="p">}]},</span>
 <span class="p">{</span><span class="n">suspending</span><span class="p">,[]}]</span>
<span class="mi">3</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We got a lot of information from this call and in the rest of this
chapter we will learn in detail what most of these items mean. The
first line tells us that the process has been given a name
<code>code_server</code>. Next we can see which function the process is
currently executing or suspended in (<code>current_function</code>)
and the name of the function that the process started executing in
(<code>initial_call</code>).</p>
</div>
<div class="paragraph">
<p>We can also see that the process is suspended waiting for messages
(<code>{status,waiting}</code>) and that there are no messages in the
mailbox  (<code>{message_queue_len,0}</code>, <code>{messages,[]}</code>). We will look
closer at how message passing works later in this chapter.</p>
</div>
<div class="paragraph">
<p>The fields <code>priority</code>, <code>suspending</code>, <code>reductions</code>, <code>links</code>,
<code>trap_exit</code>, <code>error_handler</code>, and <code>group_leader</code> control the process
execution, error handling, and IO. We will look into this a bit more
when we introduce the <em>Observer</em>.</p>
</div>
<div class="paragraph">
<p>The last few fields (<code>dictionary</code>, <code>total_heap_size</code>, <code>heap_size</code>,
<code>stack_size</code>, and <code>garbage_collection</code>) give us information about the
process memory usage. We will look at the process memory areas in
detail in chapter <a href="#CH-Memory">Chapter 12</a>.</p>
</div>
<div class="paragraph">
<p>Another, even more intrusive way of getting information
about processes is to use the process information given
by the <code>BREAK</code> menu: <code>ctrl+c p [enter]</code>. Note that while
you are in the <code>BREAK</code> state the whole node freezes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_programmatic_process_probing"><a class="link" href="#_programmatic_process_probing">3.1.2. Programmatic Process Probing</a></h4>
<div class="paragraph">
<p>The shell functions just print the information about the
process but you can actually get this information as data,
so you can write your own tools for inspecting processes.
You can get a list of all processes with <code>erlang:processes/0</code>,
and more information about a process with
<code>erlang:process_info/1</code>. We can also use the function
<code>whereis/1</code> to get a pid from a name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nv">Ps</span> <span class="o">=</span> <span class="nn">erlang</span><span class="p">:</span><span class="nf">processes</span><span class="p">().</span>
<span class="p">[</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">30</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">31</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">33</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">34</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">35</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">36</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">38</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">39</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">40</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">41</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">42</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">44</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">45</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">46</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">47</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">48</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">49</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">50</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">51</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">52</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">53</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">54</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">60</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span>
<span class="mi">2</span><span class="o">&gt;</span> <span class="nv">CodeServerPid</span> <span class="o">=</span> <span class="nb">whereis</span><span class="p">(</span><span class="n">code_server</span><span class="p">).</span>
<span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">36</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
<span class="mi">3</span><span class="o">&gt;</span> <span class="nn">erlang</span><span class="p">:</span><span class="nb">process_info</span><span class="p">(</span><span class="nv">CodeServerPid</span><span class="p">).</span>
<span class="p">[{</span><span class="n">registered_name</span><span class="p">,</span><span class="n">code_server</span><span class="p">},</span>
 <span class="p">{</span><span class="n">current_function</span><span class="p">,{</span><span class="n">code_server</span><span class="p">,</span><span class="n">loop</span><span class="p">,</span><span class="mi">1</span><span class="p">}},</span>
 <span class="p">{</span><span class="n">initial_call</span><span class="p">,{</span><span class="n">erlang</span><span class="p">,</span><span class="nb">apply</span><span class="p">,</span><span class="mi">2</span><span class="p">}},</span>
 <span class="p">{</span><span class="n">status</span><span class="p">,</span><span class="n">waiting</span><span class="p">},</span>
 <span class="p">{</span><span class="n">message_queue_len</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
 <span class="p">{</span><span class="n">messages</span><span class="p">,[]},</span>
 <span class="p">{</span><span class="n">links</span><span class="p">,[</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">35</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]},</span>
 <span class="p">{</span><span class="n">dictionary</span><span class="p">,[]},</span>
 <span class="p">{</span><span class="n">trap_exit</span><span class="p">,</span><span class="n">true</span><span class="p">},</span>
 <span class="p">{</span><span class="n">error_handler</span><span class="p">,</span><span class="n">error_handler</span><span class="p">},</span>
 <span class="p">{</span><span class="n">priority</span><span class="p">,</span><span class="n">normal</span><span class="p">},</span>
 <span class="p">{</span><span class="nb">group_leader</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">33</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">},</span>
 <span class="p">{</span><span class="n">total_heap_size</span><span class="p">,</span><span class="mi">24503</span><span class="p">},</span>
 <span class="p">{</span><span class="n">heap_size</span><span class="p">,</span><span class="mi">6772</span><span class="p">},</span>
 <span class="p">{</span><span class="n">stack_size</span><span class="p">,</span><span class="mi">3</span><span class="p">},</span>
 <span class="p">{</span><span class="n">reductions</span><span class="p">,</span><span class="mi">74260</span><span class="p">},</span>
 <span class="p">{</span><span class="n">garbage_collection</span><span class="p">,[{</span><span class="n">max_heap_size</span><span class="p">,</span><span class="err">#</span><span class="p">{</span><span class="n">error_logger</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span>
                                       <span class="n">kill</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span>
                                       <span class="nb">size</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">}},</span>
                      <span class="p">{</span><span class="n">min_bin_vheap_size</span><span class="p">,</span><span class="mi">46422</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">min_heap_size</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">fullsweep_after</span><span class="p">,</span><span class="mi">65535</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">minor_gcs</span><span class="p">,</span><span class="mi">33</span><span class="p">}]},</span>
 <span class="p">{</span><span class="n">suspending</span><span class="p">,[]}]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By getting process information as data we can write code
to analyze or sort the data as we please. If we grab all
processes in the system (with <code>erlang:processes/0</code>) and
then get information about the heap size of each process
(with <code>erlang:process_info(P,total_heap_size)</code>) we can
then construct a list with pid and heap size and sort
it on heap size:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">reverse</span><span class="p">(</span><span class="nn">lists</span><span class="p">:</span><span class="nf">keysort</span><span class="p">(</span><span class="mi">2</span><span class="p">,[{</span><span class="nv">P</span><span class="p">,</span><span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
    <span class="nn">erlang</span><span class="p">:</span><span class="nb">process_info</span><span class="p">(</span><span class="nv">P</span><span class="p">,</span><span class="n">total_heap_size</span><span class="p">))}</span>
    <span class="p">||</span> <span class="nv">P</span> <span class="o">&lt;-</span> <span class="nn">erlang</span><span class="p">:</span><span class="nf">processes</span><span class="p">()])).</span>
<span class="p">[{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">36</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">24503</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">52</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">21916</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">12556</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">58</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">4184</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">51</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">4184</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">31</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">3196</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">49</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">2586</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">35</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">1597</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">30</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">986</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">752</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">33</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">609</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">54</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">53</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">50</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">48</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">47</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">46</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">45</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">44</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">42</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">41</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">40</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">39</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">38</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">34</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">}]</span>
<span class="mi">2</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You might notice that many processes have a heap size of
233, that is because it is the default starting heap size
of a process.</p>
</div>
<div class="paragraph">
<p>See the documentation of the module <code>erlang</code> for a full description of
the information available with <a href="http://erlang.org/doc/man/erlang.html#process_info-1"><code>process_info</code></a>.
Notice how the <code>process_info/1</code> function only returns a subset of all
the information available for the process and how the <code>process_info/2</code>
function can be used to fetch extra information. As an example, to
extract the <code>backtrace</code> for the <code>code_server</code> process above, we could
run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">3</span><span class="o">&gt;</span> <span class="nb">process_info</span><span class="p">(</span><span class="nb">whereis</span><span class="p">(</span><span class="n">code_server</span><span class="p">),</span> <span class="n">backtrace</span><span class="p">).</span>
<span class="p">{</span><span class="n">backtrace</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">"Program counter: 0x00000000161de900 (code_server:loop/1 + 152)</span><span class="se">\n</span><span class="s">CP: 0x0000000000000000 (invalid)</span><span class="se">\n</span><span class="s">arity = 0</span><span class="se">\n\n</span><span class="s">0"</span><span class="p">...</span><span class="o">&gt;&gt;</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See the three dots at the end of the binary above? That means that the
output has been truncated. A useful trick to see the whole value is to
wrap the above function call using the <code>rp/1</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">4</span><span class="o">&gt;</span> <span class="nf">rp</span><span class="p">(</span><span class="nb">process_info</span><span class="p">(</span><span class="nb">whereis</span><span class="p">(</span><span class="n">code_server</span><span class="p">),</span> <span class="n">backtrace</span><span class="p">)).</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An alternative is to use the <code>io:put_chars/1</code> function, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">5</span><span class="o">&gt;</span> <span class="p">{</span><span class="n">backtrace</span><span class="p">,</span> <span class="nv">Backtrace</span><span class="p">}</span> <span class="o">=</span> <span class="nb">process_info</span><span class="p">(</span><span class="nb">whereis</span><span class="p">(</span><span class="n">code_server</span><span class="p">),</span> <span class="n">backtrace</span><span class="p">).</span>
<span class="p">{</span><span class="n">backtrace</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">"Program counter: 0x00000000161de900 (code_server:loop/1 + 152)</span><span class="se">\n</span><span class="s">CP: 0x0000000000000000 (invalid)</span><span class="se">\n</span><span class="s">arity = 0</span><span class="se">\n\n</span><span class="s">0"</span><span class="p">...</span><span class="o">&gt;&gt;</span><span class="p">}</span>
<span class="mi">6</span><span class="o">&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">put_chars</span><span class="p">(</span><span class="nv">Backtrace</span><span class="p">).</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Due to its verbosity, the output for commands <code>4&gt;</code> and <code>6&gt;</code> has not
been included here, but feel free to try the above commands in your
Erlang shell.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_observer_to_inspect_processes"><a class="link" href="#_using_the_observer_to_inspect_processes">3.1.3. Using the Observer to Inspect Processes</a></h4>
<div class="paragraph">
<p>A third way of examining processes is with the
<a href="http://erlang.org/doc/apps/observer/observer_ug.html"><em>Observer</em></a>.
The Observer is an extensive graphical interface for inspecting
the Erlang RunTime System. We will use the Observer throughout
this book to examine different aspects of the system.</p>
</div>
<div class="paragraph">
<p>The Observer can either be started from the OS shell and attach itself
to an node or directly from an Elixir or Erlang shell. For now we will
just start the Observer from the Elixir shell with <code>:observer.start</code>
or from the Erlang shell with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">7</span><span class="o">&gt;</span> <span class="nn">observer</span><span class="p">:</span><span class="nf">start</span><span class="p">().</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the Observer is started it will show you a system overview,
see the following screen shot:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/observer_system.png" alt="observer system">
</div>
</div>
<div class="paragraph">
<p>We will go over some of this information in detail later in
this and the next chapter. For now we will just use the Observer to look
at the running processes. First we take a look at the
<code>Applications</code> tab which shows the supervision
tree of the running system:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/observer_applications.png" alt="observer applications">
</div>
</div>
<div class="paragraph">
<p>Here we get a graphical view of how the processes are linked. This is
a very nice way to get an overview of how a system is structured.
You also get a nice feeling of processes as isolated entities
floating in space connected to each other through links.</p>
</div>
<div class="paragraph">
<p>To actually get some useful information about the processes
we switch to the <code>Processes</code> tab:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/observer_processes.png" alt="observer processes">
</div>
</div>
<div class="paragraph">
<p>In this view we get basically the same information as with
<code>i/0</code> in the shell. We see the pid, the registered name,
number of reductions, memory usage and number of messages
and the current function.</p>
</div>
<div class="paragraph">
<p>We can also look into a process by double clicking on its
row, for example on the code server, to get the kind of
information you can get with <code>process_info/2</code>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/observer_code_server.png" alt="observer code server">
</div>
</div>
<div class="paragraph">
<p>We will not go through what all this information means
right now, but if you keep on reading all will eventually
be revealed.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Enabling the Observer</div>
<div class="paragraph">
<p>If you are building your application with erlang.mk or
rebar and you want to include the Observer application
in your build you might need to add the applications
<code>runtime_tools</code>, <code>wx</code>, and <code>observer</code> to your list
of applications in yourapp.app.src.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Now that we have a basic understanding of what a process is
and some tools to find and inspect processes in a system we
are ready to dive deeper to learn how a process is implemented.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_processes_are_just_memory"><a class="link" href="#_processes_are_just_memory">3.2. Processes Are Just Memory</a></h3>
<div class="paragraph">
<p>A process is basically four blocks of memory: a <em>stack</em>, a <em>heap</em>,
a <em>message area</em>, and the <em>Process Control Block</em> (<em>the PCB</em>).</p>
</div>
<div class="paragraph">
<p>The stack is used for keeping track of program execution by storing
return addresses, for passing arguments to functions, and for keeping
local variables. Larger structures, such as lists and tuples are
stored on the heap.</p>
</div>
<div class="paragraph">
<p>The <em>message area</em>, also called <em>the mailbox</em>, is used
to store messages sent to the process from other processes.
The process control block is used to keep track of the state
of the process.</p>
</div>
<div class="paragraph">
<p>See the following figure for an illustration of a process as memory:</p>
</div>
<div id="erlang_process_memory_1" class="imageblock">
<div class="content">
<img src="images/diag-690edb4f2c624766a74945b2abfb9e53.png" alt="diag 690edb4f2c624766a74945b2abfb9e53" width="260" height="154">
</div>
<div class="title">Figure 7. Erlang Process Memory : Basic</div>
</div>
<div class="paragraph">
<p>This picture of a process is very much simplified, and we will go
through a number of iterations of more refined versions to get to a
more accurate picture.</p>
</div>
<div class="paragraph">
<p>The stack, the heap, and the mailbox are all dynamically allocated and
can grow and shrink as needed. We will see exactly how this works in
later chapters. The PCB on the other hand is statically allocated and
contains a number of fields that controls the process.</p>
</div>
<div class="paragraph">
<p>We can actually inspect some of these memory areas by using <em>HiPE&#8217;s
Built In Functions</em> (HiPE BIFs) for introspection. With these BIFs we
can print out the memory content of stacks, heaps, and the PCB. The
raw data is printed and in most cases a human readable version is
pretty printed alongside the data. To really understand everything
that we see when we inspect the memory we will need to know more about
the Erlang tagging scheme (which we will go through in <a href="#CH-TypeSystem">Chapter 4</a>
and about the execution model and error handling
which we will go through in <a href="#CH-BEAM">Chapter 5</a>, but using these
tools will give us a nice view of how a process really is just memory.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">HiPE&#8217;s Built In Functions (HiPE BIFs)</div>
<div class="paragraph">
<p>The HiPE BIFs are not an official part of Erlang/OTP.
They are not supported by the OTP team.
They might be removed or changed at any time, so
don&#8217;t base your mission critical services on them.</p>
</div>
<div class="paragraph">
<p>These BIFs examine the internals of ERTS in a way that
might not be safe. The BIFs for introspection often just
print to standard out and you might be surprised where that
output ends up.</p>
</div>
<div class="paragraph">
<p>These BIFs can lock up a scheduler thread for a long time
without using any reductions (we will look at what that
means in the next chapter). Printing the heap of a
very large process for example can take a long time.</p>
</div>
<div class="paragraph">
<p>These BIFs are only meant to be used for debugging
and you use them at your own risk. You should probably
not run them on a live system.</p>
</div>
<div class="paragraph">
<p>Many of the HiPE BIFs where written by the author in
the mid nineties (before 64 bit Erlang existed) and
the printouts on a 64 bit machine might be a bit off.
There are new versions of these BIFs that do a better
job, hopefully they will be included in ERTS at the
time of the printing of this book. Otherwise you
can build your own version with the patch provided
in the code section and the instructions in <a href="#AP-BuildingERTS">Appendix A</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>We can see the context of the stack of a process with <code>hipe_bifs:show_estack/1</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">hipe_bifs</span><span class="p">:</span><span class="nf">show_estack</span><span class="p">(</span><span class="nf">self</span><span class="p">()).</span>
 <span class="p">|</span>                <span class="nv">BEAM</span>  <span class="nv">STACK</span>              <span class="p">|</span>
 <span class="p">|</span>            <span class="nv">Address</span> <span class="p">|</span>           <span class="nv">Contents</span> <span class="p">|</span>
 <span class="p">|</span><span class="o">--------------------</span><span class="p">|</span><span class="o">--------------------</span><span class="p">|</span> <span class="nv">BEAM</span> <span class="nv">ACTIVATION</span> <span class="nv">RECORD</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238310</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc2ea6fe8</span> <span class="p">|</span> <span class="nv">BEAM</span> <span class="nv">PC</span> <span class="nn">shell</span><span class="p">:</span><span class="n">exprs</span><span class="o">/</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">0</span><span class="n">x4e</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238318</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238320</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000000644b</span> <span class="p">|</span> <span class="n">none</span>
 <span class="p">|</span><span class="o">--------------------</span><span class="p">|</span><span class="o">--------------------</span><span class="p">|</span> <span class="nv">BEAM</span> <span class="nv">ACTIVATION</span> <span class="nv">RECORD</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238328</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc2ea6708</span> <span class="p">|</span> <span class="nv">BEAM</span> <span class="nv">PC</span> <span class="nn">shell</span><span class="p">:</span><span class="n">eval_exprs</span><span class="o">/</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">0</span><span class="n">xf</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238330</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238338</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238340</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000004f3cb</span> <span class="p">|</span> <span class="n">cmd</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238348</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238350</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3237102</span> <span class="p">|</span> <span class="p">{</span><span class="n">value</span><span class="p">,</span><span class="err">#</span><span class="nv">Fun</span><span class="o">&lt;</span><span class="n">shell</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">104321512</span><span class="o">&gt;</span><span class="p">}</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238358</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc323711a</span> <span class="p">|</span> <span class="p">{</span><span class="n">eval</span><span class="p">,</span><span class="err">#</span><span class="nv">Fun</span><span class="o">&lt;</span><span class="n">shell</span><span class="p">.</span><span class="mi">21</span><span class="p">.</span><span class="mi">104321512</span><span class="o">&gt;</span><span class="p">}</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238360</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00000000000200ff</span> <span class="p">|</span> <span class="mi">8207</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238368</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238370</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238378</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span><span class="o">--------------------</span><span class="p">|</span><span class="o">--------------------</span><span class="p">|</span> <span class="nv">BEAM</span> <span class="nv">ACTIVATION</span> <span class="nv">RECORD</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238380</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc2ea6300</span> <span class="p">|</span> <span class="nv">BEAM</span> <span class="nv">PC</span> <span class="nn">shell</span><span class="p">:</span><span class="n">eval_loop</span><span class="o">/</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">0</span><span class="n">x47</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238388</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238390</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238398</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc32383a0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc32383a8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000001a000000343</span> <span class="p">|</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">52</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
 <span class="p">|....................|....................|</span> <span class="nv">BEAM</span> <span class="nv">CATCH</span> <span class="nv">FRAME</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc32383b0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000005a9b</span> <span class="p">|</span> <span class="nv">CATCH</span> <span class="mi">0</span><span class="n">x00007f9cc2ea67d8</span>
 <span class="p">|</span>                    <span class="p">|</span>                    <span class="p">|</span>  <span class="p">(</span><span class="nv">BEAM</span> <span class="nn">shell</span><span class="p">:</span><span class="n">eval_exprs</span><span class="o">/</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">0</span><span class="n">x29</span><span class="p">)</span>
 <span class="p">|</span><span class="o">********************</span><span class="p">|</span><span class="o">********************</span><span class="p">|</span>
 <span class="p">|</span><span class="o">--------------------</span><span class="p">|</span><span class="o">--------------------</span><span class="p">|</span> <span class="nv">BEAM</span> <span class="nv">ACTIVATION</span> <span class="nv">RECORD</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc32383b8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000093aeb8</span> <span class="p">|</span> <span class="nv">BEAM</span> <span class="nv">PC</span> <span class="n">normal</span><span class="o">-</span><span class="n">process</span><span class="o">-</span><span class="nb">exit</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc32383c0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00000000000200ff</span> <span class="p">|</span> <span class="mi">8207</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc32383c8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000001a000000343</span> <span class="p">|</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">52</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
 <span class="p">|</span><span class="o">--------------------</span><span class="p">|</span><span class="o">--------------------</span><span class="p">|</span>
<span class="n">true</span>
<span class="mi">2</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will look closer at the values on the stack and the
heap in <a href="#CH-TypeSystem">Chapter 4</a>.
The content of the heap is printed by <code>hipe_bifs:show_heap/1</code>.
Since we do not want to list a large heap here we&#8217;ll just
spawn a new process that does nothing and show that heap:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">2</span><span class="o">&gt;</span> <span class="nn">hipe_bifs</span><span class="p">:</span><span class="nf">show_heap</span><span class="p">(</span><span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ok</span> <span class="k">end</span><span class="p">)).</span>
<span class="nv">From</span><span class="p">:</span> <span class="mi">0</span><span class="n">x00007f7f33ec9588</span> <span class="n">to</span> <span class="mi">0</span><span class="n">x00007f7f33ec9848</span>
 <span class="p">|</span>                 <span class="nv">H</span> <span class="nv">E</span> <span class="nv">A</span> <span class="nv">P</span>                 <span class="p">|</span>
 <span class="p">|</span>            <span class="nv">Address</span> <span class="p">|</span>           <span class="nv">Contents</span> <span class="p">|</span>
 <span class="p">|</span><span class="o">--------------------</span><span class="p">|</span><span class="o">--------------------</span><span class="p">|</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9588</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec959a</span> <span class="p">|</span> <span class="err">#</span><span class="nv">Fun</span><span class="o">&lt;</span><span class="n">erl_eval</span><span class="p">.</span><span class="mi">20</span><span class="p">.</span><span class="mi">52032458</span><span class="o">&gt;</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9590</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9839</span> <span class="p">|</span> <span class="p">[[]]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9598</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000154</span> <span class="p">|</span> <span class="nv">Thing</span> <span class="nv">Arity</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="nv">Tag</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95a0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f3d3833d0</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95a8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95b0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000600324</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95b8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95c0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000001</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95c8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000001d0000003a3</span> <span class="p">|</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">58</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95d0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95da</span> <span class="p">|</span> <span class="p">{[],{</span><span class="n">eval</span><span class="p">...</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95d8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000100</span> <span class="p">|</span> <span class="nv">Arity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95e0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95e8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9602</span> <span class="p">|</span> <span class="p">{</span><span class="n">eval</span><span class="p">,</span><span class="err">#</span><span class="nv">Fun</span><span class="o">&lt;</span><span class="n">shell</span><span class="p">.</span><span class="mi">21</span><span class="p">.</span><span class="mi">104321512</span><span class="o">&gt;</span><span class="p">}</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95f0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec961a</span> <span class="p">|</span> <span class="p">{</span><span class="n">value</span><span class="p">,</span><span class="err">#</span><span class="nv">Fun</span><span class="o">&lt;</span><span class="n">shell</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">104321512</span><span class="o">&gt;</span><span class="p">}...</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95f8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9631</span> <span class="p">|</span> <span class="p">[{</span><span class="n">clause</span><span class="p">...</span>

 <span class="p">...</span>

 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec97d0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec97fa</span> <span class="p">|</span> <span class="err">#</span><span class="nv">Fun</span><span class="o">&lt;</span><span class="n">shell</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">104321512</span><span class="o">&gt;</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec97d8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00000000000000c0</span> <span class="p">|</span> <span class="nv">Arity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec97e0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000e4b</span> <span class="p">|</span> <span class="n">atom</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec97e8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000000001f</span> <span class="p">|</span> <span class="mi">1</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec97f0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000006d0b</span> <span class="p">|</span> <span class="n">ok</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec97f8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000154</span> <span class="p">|</span> <span class="nv">Thing</span> <span class="nv">Arity</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="nv">Tag</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9800</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33bde0c8</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9808</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9780</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9810</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000060030c</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9818</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000002</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9820</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000001</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9828</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000001d0000003a3</span> <span class="p">|</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">58</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9830</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000001a000000343</span> <span class="p">|</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">52</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9838</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9840</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span><span class="o">--------------------</span><span class="p">|</span><span class="o">--------------------</span><span class="p">|</span>
<span class="n">true</span>
<span class="mi">3</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also print the content of some of the fields in
the PCB with <code>hipe_bifs:show_pcb/1</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">3</span><span class="o">&gt;</span> <span class="nn">hipe_bifs</span><span class="p">:</span><span class="nf">show_pcb</span><span class="p">(</span><span class="nf">self</span><span class="p">()).</span>
 <span class="nv">P</span><span class="p">:</span> <span class="mi">0</span><span class="n">x00007f7f3cbc0400</span>
 <span class="o">---------------------------------------------------------------</span>
 <span class="nv">Offset</span><span class="p">|</span> <span class="nv">Name</span>        <span class="p">|</span> <span class="nv">Value</span>              <span class="p">|</span> <span class="o">*</span><span class="nv">Value</span>             <span class="p">|</span>
     <span class="mi">0</span> <span class="p">|</span> <span class="n">id</span>          <span class="p">|</span> <span class="mi">0</span><span class="n">x000001d0000003a3</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">72</span> <span class="p">|</span> <span class="n">htop</span>        <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33f15298</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">96</span> <span class="p">|</span> <span class="n">hend</span>        <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33f16540</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">88</span> <span class="p">|</span> <span class="n">heap</span>        <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33f11470</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">104</span> <span class="p">|</span> <span class="n">heap_sz</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000a1a</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">80</span> <span class="p">|</span> <span class="n">stop</span>        <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33f16480</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">592</span> <span class="p">|</span> <span class="n">gen_gcs</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000012</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">594</span> <span class="p">|</span> <span class="n">max_gen_gcs</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000000ffff</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">552</span> <span class="p">|</span> <span class="n">high_water</span>  <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33f11c50</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">560</span> <span class="p">|</span> <span class="n">old_hend</span>    <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33e90648</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">568</span> <span class="p">|</span> <span class="n">old_htop</span>    <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33e8f8e8</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">576</span> <span class="p">|</span> <span class="n">old_head</span>    <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33e8e770</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">112</span> <span class="p">|</span> <span class="n">min_heap_</span><span class="p">..</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00000000000000e9</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">328</span> <span class="p">|</span> <span class="n">rcount</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">336</span> <span class="p">|</span> <span class="n">reds</span>        <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000002270</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">16</span> <span class="p">|</span> <span class="n">tracer</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">24</span> <span class="p">|</span> <span class="n">trace_fla</span><span class="p">..</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">344</span> <span class="p">|</span> <span class="n">group_lea</span><span class="p">..</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000019800000333</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">352</span> <span class="p">|</span> <span class="n">flags</span>       <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000002000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">360</span> <span class="p">|</span> <span class="n">fvalue</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">368</span> <span class="p">|</span> <span class="n">freason</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">320</span> <span class="p">|</span> <span class="n">fcalls</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x00000000000005a2</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">384</span> <span class="p">|</span> <span class="n">next</span>        <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">48</span> <span class="p">|</span> <span class="n">reg</span>         <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">56</span> <span class="p">|</span> <span class="n">nlinks</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f3cbc0750</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">616</span> <span class="p">|</span> <span class="n">mbuf</span>        <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">640</span> <span class="p">|</span> <span class="n">mbuf_sz</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">464</span> <span class="p">|</span> <span class="n">dictionary</span>  <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">472</span> <span class="p">|</span> <span class="n">seq</span><span class="p">..</span><span class="n">clock</span>  <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">480</span> <span class="p">|</span> <span class="n">seq</span><span class="p">..</span><span class="n">astcnt</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">488</span> <span class="p">|</span> <span class="n">seq</span><span class="p">..</span><span class="n">token</span>  <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">496</span> <span class="p">|</span> <span class="n">intial</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000000320b</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">504</span> <span class="p">|</span> <span class="n">intial</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000c8b</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">512</span> <span class="p">|</span> <span class="n">intial</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>   <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000002</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">520</span> <span class="p">|</span> <span class="n">current</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f3be87c20</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000000ed8b</span> <span class="p">|</span>
   <span class="mi">296</span> <span class="p">|</span> <span class="n">cp</span>          <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f3d3a5100</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000440848</span> <span class="p">|</span>
   <span class="mi">304</span> <span class="p">|</span> <span class="n">i</span>           <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f3be87c38</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000044353a</span> <span class="p">|</span>
   <span class="mi">312</span> <span class="p">|</span> <span class="n">catches</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000001</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">224</span> <span class="p">|</span> <span class="n">arity</span>       <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">232</span> <span class="p">|</span> <span class="n">arg_reg</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f3cbc04f8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000000320b</span> <span class="p">|</span>
   <span class="mi">240</span> <span class="p">|</span> <span class="n">max_arg_reg</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000006</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">248</span> <span class="p">|</span> <span class="n">def</span><span class="p">..</span><span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000000320b</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">256</span> <span class="p">|</span> <span class="n">def</span><span class="p">..</span><span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000c8b</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">264</span> <span class="p">|</span> <span class="n">def</span><span class="p">..</span><span class="n">reg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9589</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">272</span> <span class="p">|</span> <span class="n">def</span><span class="p">..</span><span class="n">reg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">280</span> <span class="p">|</span> <span class="n">def</span><span class="p">..</span><span class="n">reg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">288</span> <span class="p">|</span> <span class="n">def</span><span class="p">..</span><span class="n">reg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00000000000007d0</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">136</span> <span class="p">|</span> <span class="n">nsp</span>         <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">144</span> <span class="p">|</span> <span class="n">nstack</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">152</span> <span class="p">|</span> <span class="n">nstend</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">160</span> <span class="p">|</span> <span class="n">ncallee</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">56</span> <span class="p">|</span> <span class="n">ncsp</span>        <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">64</span> <span class="p">|</span> <span class="n">narity</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
 <span class="o">---------------------------------------------------------------</span>

<span class="n">true</span>
<span class="mi">4</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now armed with these inspection tools we are ready to look
at what these fields in the PCB mean.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_pcb"><a class="link" href="#_the_pcb">3.3. The PCB</a></h3>
<div class="paragraph">
<p>The Process Control Block contains all the fields that control the
behaviour and current state of a process. In this section and the rest
of the chapter we will go through the most important fields. We will
leave out some fields that have to do with execution and tracing from
this chapter, instead we will cover those in <a href="#CH-BEAM">Chapter 5</a>.</p>
</div>
<div class="paragraph">
<p>If you want to dig even deeper than we will go in this chapter you can
look at the C source code. The PCB is implemented as a C struct called <code>process</code> in the file
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/erl_process.h"><code>erl_process.h</code></a>.</p>
</div>
<div class="paragraph">
<p>The field <code>id</code> contains the process ID (or PID).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    0 | id          | 0x000001d0000003a3 |                    |</pre>
</div>
</div>
<div class="paragraph">
<p>The process ID is an Erlang term and hence tagged (See <a href="#CH-TypeSystem">Chapter 4</a>). This means
that the 4 least significant bits are a tag (0011). In the
code section there is a module for inspecting Erlang terms
(see <a href="#listing-show">show.erl</a>) which we will cover in
the chapter on types. We can use it now to to examine the
type of a tagged word though.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">4</span><span class="o">&gt;</span> <span class="nn">show</span><span class="p">:</span><span class="nf">tag_to_type</span><span class="p">(</span><span class="mi">16#0000001d0000003a3</span><span class="p">).</span>
<span class="n">pid</span>
<span class="mi">5</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The fields <code>htop</code> and <code>stop</code> are pointers to the top of the heap and
the stack, that is, they are pointing to the next free slots on the heap
or stack. The fields <code>heap</code> (start) and <code>hend</code> points to the start and
the stop of the whole heap, and <code>heap_sz</code> gives the size of the heap
in words. That is <code>hend - heap = heap_sz * 8</code> on a 64 bit machine and
<code>hend - heap = heap_sz * 4</code> on a 32 bit machine.</p>
</div>
<div class="paragraph">
<p>The field <code>min_heap_size</code> is the size, in words, that the heap starts
with and which it will not shrink smaller than, the default value is
233.</p>
</div>
<div class="paragraph">
<p>We can now refine the picture of the process heap with the
fields from the PCB that controls the shape of the heap:</p>
</div>
<div id="erlang_process_heap" class="imageblock">
<div class="content">
<img src="images/diag-747437c03ff760529a2705c17867771c.png" alt="diag 747437c03ff760529a2705c17867771c" width="540" height="182">
</div>
<div class="title">Figure 8. Erlang Process Heap</div>
</div>
<div class="paragraph">
<p>But wait, how come we have a heap start and a heap end, but no start
and stop for the stack? That is because the BEAM uses a trick to save
space and pointers by allocating the heap and the stack together. It
is time for our first revision of our process as memory picture. The
heap and the stack are actually just one memory area:</p>
</div>
<div id="erlang_process_memory_2" class="imageblock">
<div class="content">
<img src="images/diag-446dad4784c07b107fc8d46847230b05.png" alt="diag 446dad4784c07b107fc8d46847230b05" width="250" height="154">
</div>
<div class="title">Figure 9. Erlang Process Memory : Heap + Stack</div>
</div>
<div class="paragraph">
<p>The stack grows towards lower memory addresses and the heap towards
higher memory, so we can also refine the picture of the heap
by adding the stack top pointer to the picture:</p>
</div>
<div id="erlang_process_heap_and_stack" class="imageblock">
<div class="content">
<img src="images/diag-953367d138be0e3e6b02b407f453e350.png" alt="diag 953367d138be0e3e6b02b407f453e350" width="540" height="196">
</div>
<div class="title">Figure 10. Erlang Process Heap and Stack</div>
</div>
<div class="paragraph">
<p>If the pointers <code>htop</code> and <code>stop</code> were to meet, the
process would run out of free memory and would have to do a garbage
collection to free up memory.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_garbage_collector_gc"><a class="link" href="#_the_garbage_collector_gc">3.4. The Garbage Collector (GC)</a></h3>
<div class="paragraph">
<p>The heap memory management schema is to use a per process copying
generational garbage collector. When there is no more
space on the heap (or the stack, since they share the allocated memory
block), the garbage collector kicks in to free up memory.</p>
</div>
<div class="paragraph">
<p>The GC allocates a new memory area called the <em>to space</em>.
Then it goes through the stack to find all live roots and
follows each root and copies the data on the heap to the new
heap. Finally it also copies the stack to the new heap and frees up
the old memory area.</p>
</div>
<div class="paragraph">
<p>The GC is controlled by these fields in the PCB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c">    <span class="n">Eterm</span> <span class="o">*</span><span class="n">high_water</span><span class="p">;</span>
    <span class="n">Eterm</span> <span class="o">*</span><span class="n">old_hend</span><span class="p">;</span>    <span class="cm">/* Heap pointers for generational GC. */</span>
    <span class="n">Eterm</span> <span class="o">*</span><span class="n">old_htop</span><span class="p">;</span>
    <span class="n">Eterm</span> <span class="o">*</span><span class="n">old_heap</span><span class="p">;</span>
    <span class="n">Uint</span> <span class="n">max_heap_size</span><span class="p">;</span> <span class="cm">/* Maximum size of heap (in words). */</span>
    <span class="n">Uint16</span> <span class="n">gen_gcs</span><span class="p">;</span>	<span class="cm">/* Number of (minor) generational GCs. */</span>
    <span class="n">Uint16</span> <span class="n">max_gen_gcs</span><span class="p">;</span>	<span class="cm">/* Max minor gen GCs before fullsweep. */</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the garbage collector is generational it will use a heuristic to just look at
new data most of the time. That is, in what is called a <em>minor
collection</em>, the GC
only looks at the top part of the stack and moves new data to the new
heap. Old data, that is data allocated below the <code>high_water</code> mark
(see the figure below) on the heap, is moved to a special area called the old
heap.</p>
</div>
<div class="paragraph">
<p>Most of the time, then, there is
another heap area for
each process: the old heap, handled by the fields <code>old_heap</code>,
<code>old_htop</code> and <code>old_hend</code> in the PCB. This almost brings us back to
our original picture of a process as four memory areas:</p>
</div>
<div id="erlang_process_memory_3" class="imageblock">
<div class="content">
<img src="images/diag-0efc2bda6e20ffb0888fb6b0d986e5e1.png" alt="diag 0efc2bda6e20ffb0888fb6b0d986e5e1" width="620" height="168">
</div>
<div class="title">Figure 11. Erlang Process Memory : GC</div>
</div>
<div class="paragraph">
<p>When a process starts there is no old heap, but as soon as young data
has matured to old data and there is a garbage collection, the old
heap is allocated. The old heap is garbage collected when there
is a <em>major collection</em>, also called a <em>full sweep</em>.
See <a href="#CH-Memory">Chapter 12</a> for more
details of how garbage collection works. In that chapter we will
also look at how to track down and fix memory related problems.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mailboxes_and_message_passing"><a class="link" href="#_mailboxes_and_message_passing">3.5. Mailboxes and Message Passing</a></h3>
<div class="paragraph">
<p>Process communication is done through message passing. A process
send is implemented so that a sending process copies the message
from its own heap to the mailbox of the receiving process.</p>
</div>
<div class="paragraph">
<p>In the early days of Erlang concurrency was implemented through
multitasking in the scheduler. We will talk more about concurrency
in the section about the scheduler later in this chapter, for
now it is worth noting that in the first version of Erlang there
was no parallelism and there could only be one process
running at the time. In that version the sending process could
write data directly on the receiving process' heap.</p>
</div>
<div class="sect3">
<h4 id="_sending_messages_in_parallel"><a class="link" href="#_sending_messages_in_parallel">3.5.1. Sending Messages in Parallel</a></h4>
<div class="paragraph">
<p>When multicore systems were introduced and the Erlang implementation
was extended with several schedulers running processes in parallel it
was no longer safe to write directly on another process' heap without
taking the <code>main lock</code> of the receiver. At this time the concept of
<code>m-bufs</code> was introduced (also called <code>heap fragments</code>). An <code>m-buf</code> is
a memory area
outside of a process heap where other processes can
safely write data. If a sending process can not get the lock it would
write to the <code>m-buf</code> instead. When all data of a message has been
copied to the <code>m-buf</code> the message is linked to the process through the
mailbox. The linking (<em>LINK_MESSAGE</em> in
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/erl_message.h">erl_message.h</a>)
 appends the message to the receiver&#8217;s
message queue.</p>
</div>
<div class="paragraph">
<p>The garbage collector would then copy the messages onto the process'
heap. To reduce the pressure on the GC the mailbox is divided into
two lists, one containing seen messages and one containing new messages.
The GC does not have to look at the new messages since we know they will
survive (they are still in the mailbox) and that way we can avoid some
copying.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lock_free_message_passing"><a class="link" href="#_lock_free_message_passing">3.6. Lock Free Message Passing</a></h3>
<div class="paragraph">
<p>In Erlang 19 a new per process setting was introduced, <em>message_queue_data</em>,
which can take the values <em>on_heap</em> or <em>off_heap</em>. When set to <em>on_heap</em>
the sending process will first try to take the <code>main lock</code> of the
receiver and if it succeeds the message will be copied directly
onto the receiver&#8217;s heap. This can only be done if the receiver is
suspended and if no other process has grabbed the lock to send to
the same process. If the sender can not obtain the lock it will
allocate a heap fragment and copy the message there instead.</p>
</div>
<div class="paragraph">
<p>If the flag is set to <em>off_heap</em> the sender will not try to get the
lock and instead write directly to a heap fragment. This will reduce
lock contention but allocating a heap fragment is more expensive than
writing directly to the already allocated process heap and it can
lead to larger memory usage. There might be a large empty heap allocated
and still new messages are written to new fragments.</p>
</div>
<div class="paragraph">
<p>With <em>on_heap</em> allocation all the messages, both directly allocated on
the heap and messages in heap fragments, will be copied by the GC. If
the message queue is large and many messages are not handled and
therefore still are live, they will be promoted to the old heap and
the size of the process heap will increase, leading to higher
memory usage.</p>
</div>
<div class="paragraph">
<p>All messages are added to a linked list (the mailbox) when the
message has been copied to the receiving process. If the message
is copied to the heap of the receiving process the message is
linked in to the <code>internal message queue</code> (or <code>seen</code> messages)
and examined by the GC.
In the <em>off_heap</em> allocation scheme new messages are placed in
the "external" <code>message in queue</code> and ignored by the GC.</p>
</div>
<div class="sect3">
<h4 id="_memory_areas_for_messages"><a class="link" href="#_memory_areas_for_messages">3.6.1. Memory Areas for Messages</a></h4>
<div class="paragraph">
<p>We can now revise our picture of the process as four memory areas
once more. Now the process is made up of five memory areas (two
mailboxes) and a varying number of heap fragments (<code>m-bufs</code>):</p>
</div>
<div id="erlang_process_memory_4" class="imageblock">
<div class="content">
<img src="images/diag-a15dbcf644ab53c36596f9735da396c8.png" alt="diag a15dbcf644ab53c36596f9735da396c8" width="470" height="238">
</div>
<div class="title">Figure 12. Erlang Process Memory : Messages</div>
</div>
<div class="paragraph">
<p>Each mailbox consists of a length and two pointers, stored in the fields
<code>msg.len</code>, <code>msg.first</code>, <code>msg.last</code> for the internal queue and <code>msg_inq.len</code>,
<code>msg_inq.first</code>, and <code>msg_inq.last</code> for the external in queue. There is
also a pointer to the next message to look at (<code>msg.save</code>) to implement
selective receive.</p>
</div>
</div>
<div class="sect3">
<h4 id="_inspecting_message_handling"><a class="link" href="#_inspecting_message_handling">3.6.2. Inspecting Message Handling</a></h4>
<div class="paragraph">
<p>Let us use our introspection tools to see how this works in more
detail. We start by setting up a process with a message in the mailbox
and then take a look at the PCB.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">4</span><span class="o">&gt;</span> <span class="nv">P</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="k">receive</span> <span class="n">stop</span> <span class="o">-&gt;</span> <span class="n">ok</span> <span class="k">end</span> <span class="k">end</span><span class="p">).</span>
<span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">63</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
<span class="mi">5</span><span class="o">&gt;</span> <span class="nv">P</span> <span class="o">!</span> <span class="n">start</span><span class="p">.</span>
<span class="n">start</span>
<span class="mi">6</span><span class="o">&gt;</span> <span class="nn">hipe_bifs</span><span class="p">:</span><span class="nf">show_pcb</span><span class="p">(</span><span class="nv">P</span><span class="p">).</span>

<span class="p">...</span>
  <span class="mi">408</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">first</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd40962d880</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">416</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">last</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd40962d880</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">424</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">save</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd40962d880</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">432</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">len</span>       <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000001</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">696</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">first</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">704</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">last</span>  <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd40a306238</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">712</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">len</span>   <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">616</span> <span class="p">|</span> <span class="n">mbuf</span>          <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">640</span> <span class="p">|</span> <span class="n">mbuf_sz</span>       <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
<span class="p">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>From this we can see that there is one message in the message queue and
the <code>first</code>, <code>last</code> and <code>save</code> pointers all point to this message.</p>
</div>
<div class="paragraph">
<p>As mentioned we can force the message to end up in the in queue by
setting the flag <em>message_queue_data</em>. We can try this with the following
 program:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">msg</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">send_on_heap</span><span class="o">/</span><span class="mi">0</span>
        <span class="p">,</span><span class="n">send_off_heap</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">send_on_heap</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">send</span><span class="p">(</span><span class="n">on_heap</span><span class="p">).</span>
<span class="nf">send_off_heap</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">send</span><span class="p">(</span><span class="n">off_heap</span><span class="p">).</span>

<span class="nb">send</span><span class="p">(</span><span class="nv">How</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="c">%% Spawn a function that loops for a while
</span>  <span class="nv">P2</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="nf">receiver</span><span class="p">(</span><span class="nv">How</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
  <span class="c">%% spawn a sending process
</span>  <span class="nv">P1</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="nf">sender</span><span class="p">(</span><span class="nv">P2</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
  <span class="nv">P1</span><span class="p">.</span>

<span class="nf">sender</span><span class="p">(</span><span class="nv">P2</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="c">%% Send a message that ends up on the heap
</span>  <span class="c">%%  {_,S} = erlang:process_info(P2, heap_size),
</span>  <span class="nv">M</span> <span class="o">=</span> <span class="nf">loop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
  <span class="nv">P2</span> <span class="o">!</span> <span class="nf">self</span><span class="p">(),</span>
  <span class="k">receive</span> <span class="n">ready</span> <span class="o">-&gt;</span> <span class="n">ok</span> <span class="k">end</span><span class="p">,</span>
  <span class="nv">P2</span> <span class="o">!</span> <span class="nv">M</span><span class="p">,</span>
  <span class="c">%% Print the PCB of P2
</span>  <span class="nn">hipe_bifs</span><span class="p">:</span><span class="nf">show_pcb</span><span class="p">(</span><span class="nv">P2</span><span class="p">),</span>
  <span class="n">ok</span><span class="p">.</span>

<span class="nf">receiver</span><span class="p">(</span><span class="nv">How</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nn">erlang</span><span class="p">:</span><span class="nb">process_flag</span><span class="p">(</span><span class="n">message_queue_data</span><span class="p">,</span><span class="nv">How</span><span class="p">),</span>
  <span class="k">receive</span> <span class="nv">P</span> <span class="o">-&gt;</span> <span class="nv">P</span> <span class="o">!</span> <span class="n">ready</span> <span class="k">end</span><span class="p">,</span>
  <span class="c">%%  loop(100000),
</span>  <span class="k">receive</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">ok</span> <span class="k">end</span><span class="p">,</span>
  <span class="nv">P</span><span class="p">.</span>


<span class="nf">loop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">done</span><span class="p">];</span>
<span class="nf">loop</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nf">loop</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)].</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With this program we can try sending a message on heap and off heap and
look at the PCB after each send. With on heap we get the same result
as when just sending a message before:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">5</span><span class="o">&gt;</span> <span class="nn">msg</span><span class="p">:</span><span class="nf">send_on_heap</span><span class="p">().</span>

<span class="p">...</span>

  <span class="mi">408</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">first</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd4096283c0</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">416</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">last</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd4096283c0</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">424</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">save</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd40a3c1048</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">432</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">len</span>       <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000001</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">696</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">first</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">704</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">last</span>  <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd40a3c1168</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">712</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">len</span>   <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">616</span> <span class="p">|</span> <span class="n">mbuf</span>          <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">640</span> <span class="p">|</span> <span class="n">mbuf_sz</span>       <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>

<span class="p">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we try sending to a process with the flag set to <em>off_heap</em>
the message ends up in the in queue instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">6</span><span class="o">&gt;</span> <span class="nn">msg</span><span class="p">:</span><span class="nf">send_off_heap</span><span class="p">().</span>

<span class="p">...</span>

  <span class="mi">408</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">first</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">416</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">last</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd40a3c0618</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">424</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">save</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd40a3c0618</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">432</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">len</span>       <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">696</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">first</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd3b19f1830</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">704</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">last</span>  <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd3b19f1830</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">712</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">len</span>   <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000001</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">616</span> <span class="p">|</span> <span class="n">mbuf</span>          <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">640</span> <span class="p">|</span> <span class="n">mbuf_sz</span>       <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>

<span class="p">...</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_process_of_sending_a_message_to_a_process"><a class="link" href="#_the_process_of_sending_a_message_to_a_process">3.6.3. The Process of Sending a Message to a Process</a></h4>
<div class="paragraph">
<p>We will ignore the distribution case for now, that is we will not
consider messages sent between Erlang nodes. Imagine two processes
<code>P1</code> and <code>P2</code>. Process <code>P1</code> wants to send a message (<em>Msg</em>) to process
<code>P2</code>, as illustrated by this figure:</p>
</div>
<div id="erlang_message_passing_1" class="imageblock">
<div class="content">
<img src="images/diag-689c2ddb9e5d769519a29b8388727c41.png" alt="diag 689c2ddb9e5d769519a29b8388727c41" width="400" height="462">
</div>
<div class="title">Figure 13. Erlang Message Passing Step 1</div>
</div>
<div class="paragraph">
<p>Process <code>P1</code> will then take the following steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Calculate the size of <em>Msg</em>.</p>
</li>
<li>
<p>Allocate space for the message (on or off <code>P2</code> 's heap as described before).</p>
</li>
<li>
<p>Copy <em>Msg</em> from <code>P1</code> 's heap to the allocated space.</p>
</li>
<li>
<p>Allocate and fill in an <em>ErlMessage</em> struct wrapping up the message.</p>
</li>
<li>
<p>Link in the <em>ErlMessage</em> either in the <em>ErlMsgQueue</em> or in the <em>ErlMsgInQueue</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If process <code>P2</code> is suspended and no other process is trying to
send a message to <code>P2</code> and there is space on the heap and the
allocation strategy is <em>on_heap</em> the message will directly end up
on the heap:</p>
</div>
<div id="erlang_message_passing_2" class="imageblock">
<div class="content">
<img src="images/diag-e5ece349805e519b5dbb5bcc3e53ff8d.png" alt="diag e5ece349805e519b5dbb5bcc3e53ff8d" width="400" height="588">
</div>
<div class="title">Figure 14. Erlang Message Passing Step 2</div>
</div>
<div class="paragraph">
<p>If <code>P1</code> can not get the <code>main lock</code> of P2 or there is not enough space
on <code>P2</code> 's heap and the allocation strategy is <em>on_heap</em> the message
will end up in an <code>m-buf</code> but linked from the internal mailbox:</p>
</div>
<div id="erlang_message_passing_3" class="imageblock">
<div class="content">
<img src="images/diag-aec5a0cee7e074ccac65f614094ddc71.png" alt="diag aec5a0cee7e074ccac65f614094ddc71" width="400" height="588">
</div>
<div class="title">Figure 15. Erlang Message Passing Step 3</div>
</div>
<div class="paragraph">
<p>After a GC the message will be moved into
the heap.</p>
</div>
<div class="paragraph">
<p>If the allocation strategy is <em>off_heap</em> the message
will end up in an <code>m-buf</code> and linked from the external mailbox:</p>
</div>
<div id="erlang_message_passing_4" class="imageblock">
<div class="content">
<img src="images/diag-ac3757fc9ea8e009a9693e51428cd1d1.png" alt="diag ac3757fc9ea8e009a9693e51428cd1d1" width="400" height="588">
</div>
<div class="title">Figure 16. Erlang Message Passing Step 4</div>
</div>
<div class="paragraph">
<p>After a GC the message will still be in the <code>m-buf</code>. Not until
the message is received and reachable from some other object on
the heap or from the stack will the message be copied to the process
heap during a GC.</p>
</div>
</div>
<div class="sect3">
<h4 id="_receiving_a_message"><a class="link" href="#_receiving_a_message">3.6.4. Receiving a Message</a></h4>
<div class="paragraph">
<p>Erlang supports selective receive, which means that a message that
doesn&#8217;t match can be left in the mailbox for a later receive. And the
processes can be suspended with messages in the mailbox when no
message matches. The <code>msg.save</code> field contains a pointer to a pointer
to the next message to look at.</p>
</div>
<div class="paragraph">
<p>In later chapters we will cover the details of <code>m-bufs</code> and how the
garbage collector handles mailboxes. We will also go through the
details of how receive is implemented in the BEAM
in later chapters.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tuning_message_passing"><a class="link" href="#_tuning_message_passing">3.6.5. Tuning Message Passing</a></h4>
<div class="paragraph">
<p>With the new <em>message_queue_data</em> flag introduced in Erlang 19 you
can trade memory for execution time in a new way. If the receiving
process is overloaded and holding on to the <code>main lock</code>, it might be
a good strategy to use the <em>off_heap</em> allocation in order to let the
sending process quickly dump the message in an <code>m-buf</code>.</p>
</div>
<div class="paragraph">
<p>If two processes have a nicely balanced producer consumer behavior
where there is no real contention for the process lock then allocation
directly on the receivers heap will be faster and use less memory.</p>
</div>
<div class="paragraph">
<p>If the receiver is backed up and is receiving more messages than it
has time to handle, it might actually start using more memory as
messages are copied to the heap, and migrated to the old heap. Since
unseen messages are considered live, the heap will need to grow and use
more memory.</p>
</div>
<div class="paragraph">
<p>In order to find out which allocation strategy is best for your system
you will need to benchmark and measure the behavior. The first and easiest
test to do is probably to change the default allocation strategy at
the start of the system. The ERTS flag <em>hmqd</em> sets the default strategy to
either <em>off_heap</em> or <em>on_heap</em>.
If you start Erlang without this flag the default will be <em>on_heap</em>.
By setting up your benchmark so that Erlang is started with
<em>+hmqd off_heap</em> you can test whether the system behaves better or
worse if all processes use off heap allocation.
Then you might want to find bottle neck processes and test switching
allocation strategies for those processes only.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_process_dictionary"><a class="link" href="#_the_process_dictionary">3.7. The Process Dictionary</a></h3>
<div class="paragraph">
<p>There is actually one more memory area in a process where
Erlang terms can be stored, the <em>Process Dictionary</em>.</p>
</div>
<div class="paragraph">
<p>The <em>Process Dictionary</em> (PD) is a process local key-value store. One
advantage with this is that all keys and values are stored on the heap
and there is no copying as with send or an ETS table.</p>
</div>
<div class="paragraph">
<p>We can now update our view of a process with yet another
memory area, PD, the process dictionary:</p>
</div>
<div id="erlang_process_memory_5" class="imageblock">
<div class="content">
<img src="images/diag-50a01d121905e2c4425c5476298083bc.png" alt="diag 50a01d121905e2c4425c5476298083bc" width="470" height="238">
</div>
<div class="title">Figure 17. Erlang Process Memory : Process Dictionary</div>
</div>
<div class="paragraph">
<p>With such a small array you are bound to get some collisions before the
area grows. Each hash value points to a bucket with key value pairs.
The bucket is actually an Erlang list on the heap. Each entry in the
list is a two tuple (<em>{key, Value}</em>) also stored on the heap.</p>
</div>
<div class="paragraph">
<p>Putting an element in the PD is not completely free, it will result in
an extra tuple and a cons, and
might cause garbage collection to be triggered. Updating a key in the
dictionary, which is in a bucket, causes the whole bucket (the whole
list) to be reallocated to make sure we don&#8217;t get pointers from the
old heap to the new heap. (In <a href="#CH-Memory">Chapter 12</a> we will
see the details of how garbage collection works.)</p>
</div>
</div>
<div class="sect2">
<h3 id="_dig_in"><a class="link" href="#_dig_in">3.8. Dig In</a></h3>
<div class="paragraph">
<p>In this chapter we have looked at how a process is implemented. In
particular we looked at how the memory of a process is organized, how
message passing works and the information in the PCB. We also looked
at a number of tools for inspecting processes introspection, such as
<em>erlang:process_info</em>, and the <em>hipe:show</em>*_ bifs.</p>
</div>
<div class="paragraph">
<p>Use the functions <code>erlang:processes/0</code> and <code>erlang:process_info/1,2</code>
to inspect the processes in the system. Here are
some functions to try:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nv">Ps</span> <span class="o">=</span> <span class="nn">erlang</span><span class="p">:</span><span class="nf">processes</span><span class="p">().</span>
<span class="p">[</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">7</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">9</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">11</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">12</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">13</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">14</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">15</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">16</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">17</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">19</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">20</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">21</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">22</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">23</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">24</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">25</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">26</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">27</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">28</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">33</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span>
<span class="mi">2</span><span class="o">&gt;</span> <span class="nv">P</span> <span class="o">=</span> <span class="nf">self</span><span class="p">().</span>
<span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">33</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
<span class="mi">3</span><span class="o">&gt;</span> <span class="nn">erlang</span><span class="p">:</span><span class="nb">process_info</span><span class="p">(</span><span class="nv">P</span><span class="p">).</span>
<span class="p">[{</span><span class="n">current_function</span><span class="p">,{</span><span class="n">erl_eval</span><span class="p">,</span><span class="n">do_apply</span><span class="p">,</span><span class="mi">6</span><span class="p">}},</span>
 <span class="p">{</span><span class="n">initial_call</span><span class="p">,{</span><span class="n">erlang</span><span class="p">,</span><span class="nb">apply</span><span class="p">,</span><span class="mi">2</span><span class="p">}},</span>
 <span class="p">{</span><span class="n">status</span><span class="p">,</span><span class="n">running</span><span class="p">},</span>
 <span class="p">{</span><span class="n">message_queue_len</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
 <span class="p">{</span><span class="n">messages</span><span class="p">,[]},</span>
 <span class="p">{</span><span class="n">links</span><span class="p">,[</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">27</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]},</span>
 <span class="p">{</span><span class="n">dictionary</span><span class="p">,[]},</span>
 <span class="p">{</span><span class="n">trap_exit</span><span class="p">,</span><span class="n">false</span><span class="p">},</span>
 <span class="p">{</span><span class="n">error_handler</span><span class="p">,</span><span class="n">error_handler</span><span class="p">},</span>
 <span class="p">{</span><span class="n">priority</span><span class="p">,</span><span class="n">normal</span><span class="p">},</span>
 <span class="p">{</span><span class="nb">group_leader</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">26</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">},</span>
 <span class="p">{</span><span class="n">total_heap_size</span><span class="p">,</span><span class="mi">17730</span><span class="p">},</span>
 <span class="p">{</span><span class="n">heap_size</span><span class="p">,</span><span class="mi">6772</span><span class="p">},</span>
 <span class="p">{</span><span class="n">stack_size</span><span class="p">,</span><span class="mi">24</span><span class="p">},</span>
 <span class="p">{</span><span class="n">reductions</span><span class="p">,</span><span class="mi">25944</span><span class="p">},</span>
 <span class="p">{</span><span class="n">garbage_collection</span><span class="p">,[{</span><span class="n">min_bin_vheap_size</span><span class="p">,</span><span class="mi">46422</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">min_heap_size</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">fullsweep_after</span><span class="p">,</span><span class="mi">65535</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">minor_gcs</span><span class="p">,</span><span class="mi">1</span><span class="p">}]},</span>
 <span class="p">{</span><span class="n">suspending</span><span class="p">,[]}]</span>
 <span class="mi">4</span><span class="o">&gt;</span>  <span class="nn">lists</span><span class="p">:</span><span class="nf">keysort</span><span class="p">(</span><span class="mi">2</span><span class="p">,[{</span><span class="nv">P</span><span class="p">,</span><span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nn">erlang</span><span class="p">:</span><span class="nb">process_info</span><span class="p">(</span><span class="nv">P</span><span class="p">,</span>
     <span class="n">total_heap_size</span><span class="p">))}</span> <span class="p">||</span> <span class="nv">P</span> <span class="o">&lt;-</span> <span class="nv">Ps</span><span class="p">]).</span>
<span class="p">[{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">13</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">14</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">15</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">16</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">17</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">19</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">20</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">21</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">22</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">23</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">25</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">28</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">752</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">9</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">752</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">11</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">1363</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">7</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">1597</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">1974</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">24</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">2585</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">26</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">6771</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">12</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">13544</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">33</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">13544</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">15143</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">27</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">32875</span><span class="p">}]</span>
<span class="mi">9</span><span class="o">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-TypeSystem"><a class="link" href="#CH-TypeSystem">4. The Erlang Type System and Tags</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the most important aspects of ERTS to understand is how ERTS
stores data, that is, how Erlang terms are stored in memory. This
gives you the basis for understanding how garbage collection works,
how message passing works, and gives you an insight into how much
memory is needed.</p>
</div>
<div class="paragraph">
<p>In this chapter you will learn the basic data types of Erlang and
how they are implemented in ERTS. This knowledge will be essential
in understanding the chapter on memory allocation and garbage
collection, see <a href="#CH-Memory">Chapter 12</a>.</p>
</div>
<div class="sect2">
<h3 id="_the_erlang_type_system"><a class="link" href="#_the_erlang_type_system">4.1. The Erlang Type System</a></h3>
<div class="paragraph">
<p>Erlang is <em>strongly typed</em>. That is, there is no way to coerce one
type into another type, you can only convert from one type to another.
Compare this to e.g. C where you can coerce a <em>char</em> to an <em>int</em> or
any type pointed to by a pointer to (<em>void *</em>).</p>
</div>
<div class="paragraph">
<p>The Erlang type lattice is quite flat, there are only a few real sub
types, numbers have the sub types integer and float, and list has the
subtypes nil and cons. (One could also argue that tuple has one
subtype for each size.)</p>
</div>
<div class="paragraph">
<p>The Erlang Type Lattice</p>
</div>
<div id="erlang_type_lattice" class="imageblock">
<div class="content">
<img src="images/diag-e747b66f467748295246928a85ad8566.png" alt="diag e747b66f467748295246928a85ad8566" width="2349" height="347">
</div>
<div class="title">Figure 18. Erlang Type Lattice</div>
</div>
<div class="paragraph">
<p>There is a partial order (&lt; and &gt;) on all terms in Erlang where the
types are ordered from left to right in the above lattice.</p>
</div>
<div class="paragraph">
<p>The order is partial and not total since integers and floats
are converted before comparison. Both (1 &lt; 1.0) and (1.0 &lt; 1) are
false, and (1 =&lt; 1.0 and 1 &gt;= 1.0) and (1 =/= 1.0). The number with
the lesser precision is converted to the number with higher precision.
Usually integers are converted to floats. For very large or small
floats the float is converted to an integer. This happens if all
significant digits are to the left of the decimal point.</p>
</div>
<div class="paragraph">
<p>Since Erlang 18, when two maps are compared for order they are
compared as follows: If one map has fewer elements than the other it
is considered smaller. Otherwise the keys are compared in term order,
where all integers are considered smaller than all floats. If all the
keys are the same then each value pair (in key order) is compared
arithmetically, i.e. by first converting them to the same precision.</p>
</div>
<div class="paragraph">
<p>The same is true when comparing for equality, thus #{1 =&gt; 1.0} == #{1 =&gt; 1} but #{1.0 =&gt; 1} /= #{1 =&gt; 1}.</p>
</div>
<div class="paragraph">
<p>In Erlang versions prior to 18 keys were also compared
arithmetically.</p>
</div>
<div class="paragraph">
<p>Erlang is dynamically typed. That is, types will be checked at
runtime and if a type error occurs an exception is thrown. The
compiler does not check the types at compile time, unlike in a
statically typed language like C or Java where you can get a
type error during compilation.</p>
</div>
<div class="paragraph">
<p>These aspects of the Erlang type system, strongly dynamically typed
with an order on the types puts some constraints on the implementation
of the language. In order to be able to check and compare types at
runtime each Erlang term has to carry its type with it.</p>
</div>
<div class="paragraph">
<p>This is solved by <em>tagging</em> the terms.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_tagging_scheme"><a class="link" href="#_the_tagging_scheme">4.2. The Tagging Scheme</a></h3>
<div class="paragraph">
<p>In the memory representation of an Erlang term a few bits are reserved
for a type tag. For performance reasons the terms are divided into
<em>immediates</em> and <em>boxed</em> terms. An immediate term can fit into a
machine word, that is, in a register or on a stack slot. A boxed term
consists of two parts: a tagged pointer and a number of words stored
on the process heap. The <em>boxes</em> stored on the heap have a header and
a body, unless it is a list.</p>
</div>
<div class="paragraph">
<p>Currently ERTS uses a staged tag scheme, the history and reasoning
behind the this scheme is explained in a technical report from the
HiPE group. (See
<a href="http://www.it.uu.se/research/publications/reports/2000-029/" class="bare">http://www.it.uu.se/research/publications/reports/2000-029/</a>)
The tagging scheme is implemented in
<a href="https://github.com/erlang/otp/blob/OTP-23.0/erts/emulator/beam/erl_term.h">erl_term.h</a>.</p>
</div>
<div class="paragraph">
<p>The basic idea is to use the least significant bits for tags. Since
most modern CPU architectures aligns 32- and 64-bit words, there are at
least two bits that are "unused" for pointers. These bits can be
used as tags instead. Unfortunately those two bits are not enough
for all the types in Erlang, more bits are therefore used as needed.</p>
</div>
<div class="sect3">
<h4 id="_tags_for_immediates"><a class="link" href="#_tags_for_immediates">4.2.1. Tags for Immediates</a></h4>
<div class="paragraph">
<p>The first two bits (the primary tag) are used as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  00 Header (on heap) CP (on stack)
  01 List (cons)
  10 Boxed
  11 Immediate</pre>
</div>
</div>
<div class="paragraph">
<p>The header tag is only used on the heap for header words, more on that later.
On the stack 00 indicates a return address.
The list tag is used for cons cells, and the boxed tag is used for all other
pointers to the heap. The immediate tag is used further divided like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> 00 11 Pid
 01 11 Port
 10 11 Immediate 2
 11 11 Small integer</pre>
</div>
</div>
<div class="paragraph">
<p>Pid and ports are immediates and can be compared for equality
efficiently. They are of course in reality just references, a pid
is a process identifier and it points to a process. The process does
not reside on the heap of any process but is handled by the PCB.
A port works in much the same way.</p>
</div>
<div class="paragraph">
<p>There are two types of integers in ERTS, small integers and
bignums. Small integers fits in one machine word minus four tag bits,
i.e. in 28 or 60 bits for 32 and 64 bits system respectively. Bignums
on the other hand can be as large as needed (only limited by the heap
space) and are stored on the heap, as boxed objects.</p>
</div>
<div class="paragraph">
<p>By having all four tag bits as ones for small integers the emulator
can make an efficient test when doing integer arithmetic to see if
both arguments are immediates. (is_both_small(x,y) is defined as
(x &amp; y &amp; 1111) == 1111).</p>
</div>
<div class="paragraph">
<p>The Immediate 2 tag is further divided like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> 00 10 11 Atom
 01 10 11 Catch
 10 10 11   [UNUSED]
 11 10 11 Nil</pre>
</div>
</div>
<div class="paragraph">
<p>Atoms are made up of an index in the <em>atom table</em> and the atom tag.
Two atom immediates can be compared for equality by just comparing
their immediate representation.</p>
</div>
<div class="paragraph">
<p>In the atom table atoms are stored as C structs like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>typedef struct atom {
    IndexSlot slot;  /* MUST BE LOCATED AT TOP OF STRUCT!!! */
    int len;         /* length of atom name */
    int ord0;        /* ordinal value of first 3 bytes + 7 bits */
    byte* name;      /* name of atom */
} Atom;</pre>
</div>
</div>
<div class="paragraph">
<p>Thanks to the len and the ord0 fields the order of two atoms can
be compared efficiently as long as they don&#8217;t start with the same four
letters.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you for some reason generate atoms with a pattern like name
followed by a number and then store them in an ordered list or ordered
tree the atom comparison will be more expensive if they all have the
same first letters (e.g. foo_1, foo_2, etc.).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Not that you should ever generate atom names, since the atom table is
limited. I&#8217;m just saying, there is an evil micro optimization to be
found here.</p>
</div>
<div class="paragraph">
<p>You would of course never do this, but if you find code that generates
atom with a number followed by a postfix name, now you know what the
author of that code might have been thinking.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The Catch immediate is only used on the stack. It contains an indirect
pointer to the continuation point in the code where execution should
continue after an exception. More on this in <a href="#CH-Calls">Chapter 8</a>.</p>
</div>
<div class="paragraph">
<p>The Nil tag is used for the empty list (nil or []). The rest of the
word is filled with ones.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tags_for_boxed_terms"><a class="link" href="#_tags_for_boxed_terms">4.2.2. Tags for Boxed Terms</a></h4>
<div class="paragraph">
<p>Erlang terms stored on the heap use several machine words. Lists, or
cons cells, are just two consecutive words on the heap: the head and
the tail (or car and cdr as they are called in lisp and some places in
the ERTS code).</p>
</div>
<div class="paragraph">
<p>A string in Erlang is just a list of integers representing
characters. In releases prior to Erlang OTP R14 strings have been
encoded as ISO-latin-1 (ISO8859-1). Since R14 strings are encoded as
lists of Unicode code points. For strings in latin-1 there is no
difference since latin-1 is a subset of Unicode.</p>
</div>
<div class="paragraph">
<p>The string "hello" might look like this in memory:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-cc0e476a060b1c65681492c7e1a20adb.png" alt="diag cc0e476a060b1c65681492c7e1a20adb" width="1010" height="336">
</div>
<div class="title">Figure 19. Representation of the string "hello" on a 32 bit machine.</div>
</div>
<div class="paragraph">
<p>All other boxed terms start with a header word. The header word uses a
four bit header tag and the primary header tag (00), it also has an
arity which says how many words the boxed term uses. On a 32-bit
machine it looks like this: aaaaaaaaaaaaaaaaaaaaaaaaaatttt00.</p>
</div>
<div class="paragraph">
<p>The tags are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> 0000	ARITYVAL (Tuples)
 0001   BINARY_AGGREGATE                |
 001s	BIGNUM with sign bit            |
 0100	REF                             |
 0101	FUN                             | THINGS
 0110	FLONUM                          |
 0111   EXPORT                          |
 1000	REFC_BINARY     |               |
 1001	HEAP_BINARY     | BINARIES      |
 1010	SUB_BINARY      |               |
 1011     [UNUSED]
 1100   EXTERNAL_PID  |                 |
 1101   EXTERNAL_PORT | EXTERNAL THINGS |
 1110   EXTERNAL_REF  |                 |
 1111   MAP</pre>
</div>
</div>
<div class="paragraph">
<p>Tuples are stored on the heap with just the arity and then each
element in the following words. The empty tuple {} is stored just as
the word 0 (header tag 0, tuple tag 0000, and arity 0).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-53a505049808bc12945ce495f11073c1.png" alt="diag 53a505049808bc12945ce495f11073c1" width="870" height="280">
</div>
<div class="title">Figure 20. Representation of the tuple {104,101,108,108,111} on a 32 bit machine.</div>
</div>
<div class="paragraph">
<p>A <em>binary</em> is an immutable array of bytes. There are four types of
internal representations of <em>binaries</em>. The two types <em>heap binaries</em>
and <em>refc binaries</em> contains binary data. The other two types, <em>sub
binaries</em> and <em>match contexts</em> (the BINARY_AGGREGATE tag) are smaller
references into one of the other two types.</p>
</div>
<div class="paragraph">
<p>Binaries that are 64 bytes or less can be stored directly on the
process heap as <em>heap binaries</em>. Larger binaries are reference
counted and the payload is stored outside of the process heap, a
reference to the payload is stored on the process heap in an object
called a <em>ProcBin</em>.</p>
</div>
<div class="paragraph">
<p>We will talk more about binaries in the <a href="#CH-Memory">Chapter 12</a>.</p>
</div>
<div class="paragraph">
<p>Integers that do not fit in a small integer (word size - 4 bits) are
stored on the heap as "bignums" (or arbitrary precision integers). A
bignum has a header word followed by a number of words encoding the
bignum. The sign part of the bignum tag (<code>s</code>) in the header encodes the
sign of the number (s=0 for positive numbers, and s=1 for negative
numbers).</p>
</div>
<div class="paragraph">
<p>TODO: Describe bignum encoding. (And arithmetic ?)</p>
</div>
<div class="paragraph">
<p>A reference is a <em>"unique"</em> term often used to tag messages in order
to basically implement a channel over a process mailbox. A reference
is implemented as an 82 bit counter. After 9671406556917033397649407
calls to make_ref/0 the counter will wrap and start over with ref 0
again. You need a really fast machine to do that many calls to
make_ref within your lifetime. Unless you restart the node, in which
case it also will start from 0 again, but then all the old local refs
are gone. If you send the pid to another node it becomes an external
ref, see below.</p>
</div>
<div class="paragraph">
<p>On a 32-bit system a local ref takes up four 32-bit words on the
heap. On a 64-bit system a ref takes up three 64-bit words on the
heap.</p>
</div>
<div class="listingblock">
<div class="title">Representation of a ref in a 32-bit (or half-word) system.</div>
<div class="content">
<pre>    |00000000 00000000 00000000 11010000| Arity 3 + ref tag
    |00000000 000000rr rrrrrrrr rrrrrrrr| Data0
    |rrrrrrrr rrrrrrrr rrrrrrrr rrrrrrrr| Data1
    |rrrrrrrr rrrrrrrr rrrrrrrr rrrrrrrr| Data2</pre>
</div>
</div>
<div class="paragraph">
<p>The reference number is (Data2 bsl 50) + (Data1 bsl 18) + Data0.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Outline</div>
<div class="paragraph">
<p><strong>TODO</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre>The implementation of floats,  ports, pids. Strings as lists, IO lists,
lists on 64-bit machines. Binaries, sub binaries, and copying. Records.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Possibly: The half-word machine. Sharing and deep copy. (or this will be in GC)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Outro/conclusion</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-BEAM"><a class="link" href="#CH-BEAM">5. The Erlang Virtual Machine: BEAM</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>BEAM (Bogumil&#8217;s/Bjrns Abstract Machine) is the machine that executes
the code in the Erlang Runtime System. It is a garbage collecting,
reduction counting, virtual, non-preemptive, directly threaded,
register machine. If that doesn&#8217;t tell you much, don&#8217;t worry, in the
following sections we will go through what each of those words means
in this context.</p>
</div>
<div class="paragraph">
<p>The virtual machine, BEAM, is at the heart of the Erlang node.
It is the BEAM that executes the Erlang code. That is, it is
BEAM that executes your application code. Understanding how BEAM
executes the code is vital to be able to profile and tune your
code.</p>
</div>
<div class="paragraph">
<p>The BEAM design influences large parts of the rest of ERTS. The
primitives for scheduling influences the Scheduler
(<a href="#CH-Scheduling">Chapter 11</a>), the representation of Erlang terms and the
interaction with the memory influences the Garbage Collector
(<a href="#CH-Memory">Chapter 12</a>). By understanding the basic design of BEAM you
will more easily understand the implementations of these other
components.</p>
</div>
<div class="sect2">
<h3 id="_working_memory_a_stack_machine_it_is_not"><a class="link" href="#_working_memory_a_stack_machine_it_is_not">5.1. Working Memory: A stack machine, it is not</a></h3>
<div class="paragraph">
<p>As opposed to its predecessor JAM (Joe&#8217;s Abstract Machine) which was a
stack machine, the BEAM is a register machine loosely based on WAM
 <a href="#warren">[warren]</a>. In a stack machine each operand to an instruction is
first pushed to the working stack, then the instruction pops its
arguments and then it pushes the result on the stack.</p>
</div>
<div class="paragraph">
<p>Stack machines are quite popular among virtual machine and
programming language implementers since they are quite easy to
generate code for, and the code becomes very compact. The compiler
does not need to do any register allocation, and most operations do
not need any arguments (in the instruction stream).</p>
</div>
<div class="paragraph">
<p>Compiling the expression "8 + 17 * 2." to a stack machine
could yield code like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>push 8
push 17
push 2
multiply
add</pre>
</div>
</div>
<div class="paragraph">
<p>This code can be generated directly from the parse tree of
the expression. By using Erlang expression and the modules
<a href="https://erlang.org/doc/man/erl_scan.html">erl_scan</a> and
<a href="https://erlang.org/doc/man/erl_parse.html">erl_parse</a> we
can build the world&#8217;s most simplistic compiler.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">compile</span><span class="p">(</span><span class="nv">String</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nv">ParseTree</span><span class="p">]</span> <span class="o">=</span> <span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
			  <span class="nn">erl_parse</span><span class="p">:</span><span class="nf">parse_exprs</span><span class="p">(</span>
			    <span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				    <span class="nn">erl_scan</span><span class="p">:</span><span class="nf">string</span><span class="p">(</span><span class="nv">String</span><span class="p">)))),</span>
    <span class="nf">generate_code</span><span class="p">(</span><span class="nv">ParseTree</span><span class="p">).</span>

<span class="nf">generate_code</span><span class="p">({</span><span class="n">op</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="n">'+'</span><span class="p">,</span> <span class="nv">Arg1</span><span class="p">,</span> <span class="nv">Arg2</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg1</span><span class="p">)</span> <span class="o">++</span> <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg2</span><span class="p">)</span> <span class="o">++</span> <span class="p">[</span><span class="n">add</span><span class="p">];</span>
<span class="nf">generate_code</span><span class="p">({</span><span class="n">op</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="n">'*'</span><span class="p">,</span> <span class="nv">Arg1</span><span class="p">,</span> <span class="nv">Arg2</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg1</span><span class="p">)</span> <span class="o">++</span> <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg2</span><span class="p">)</span> <span class="o">++</span> <span class="p">[</span><span class="n">multiply</span><span class="p">];</span>
<span class="nf">generate_code</span><span class="p">({</span><span class="n">integer</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="nv">I</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">push</span><span class="p">,</span> <span class="nv">I</span><span class="p">].</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And an even more simplistic virtual stack machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">interpret</span><span class="p">(</span><span class="nv">Code</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nf">interpret</span><span class="p">(</span><span class="nv">Code</span><span class="p">,</span> <span class="p">[]).</span>

<span class="nf">interpret</span><span class="p">([</span><span class="n">push</span><span class="p">,</span> <span class="nv">I</span> <span class="p">|</span><span class="nv">Rest</span><span class="p">],</span> <span class="nv">Stack</span><span class="p">)</span>              <span class="o">-&gt;</span> <span class="nf">interpret</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="p">[</span><span class="nv">I</span><span class="p">|</span><span class="nv">Stack</span><span class="p">]);</span>
<span class="nf">interpret</span><span class="p">([</span><span class="n">add</span>     <span class="p">|</span><span class="nv">Rest</span><span class="p">],</span> <span class="p">[</span><span class="nv">Arg2</span><span class="p">,</span> <span class="nv">Arg1</span><span class="p">|</span><span class="nv">Stack</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nf">interpret</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="p">[</span><span class="nv">Arg1</span><span class="o">+</span><span class="nv">Arg2</span><span class="p">|</span><span class="nv">Stack</span><span class="p">]);</span>
<span class="nf">interpret</span><span class="p">([</span><span class="n">multiply</span><span class="p">|</span><span class="nv">Rest</span><span class="p">],</span> <span class="p">[</span><span class="nv">Arg2</span><span class="p">,</span> <span class="nv">Arg1</span><span class="p">|</span><span class="nv">Stack</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nf">interpret</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="p">[</span><span class="nv">Arg1</span><span class="o">*</span><span class="nv">Arg2</span><span class="p">|</span><span class="nv">Stack</span><span class="p">]);</span>
<span class="nf">interpret</span><span class="p">([],</span>              <span class="p">[</span><span class="nv">Res</span><span class="p">|_])</span>            <span class="o">-&gt;</span> <span class="nv">Res</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And a quick test run gives us the answer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">stack_machine</span><span class="p">:</span><span class="nf">interpret</span><span class="p">(</span><span class="nn">stack_machine</span><span class="p">:</span><span class="nf">compile</span><span class="p">(</span><span class="s">"8 + 17 * 2."</span><span class="p">)).</span>
<span class="mi">42</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Great, you have built your first virtual machine! Handling
subtraction, division and the rest of the Erlang language is left as
an exercise for the reader.</p>
</div>
<div class="paragraph">
<p>Anyway, the BEAM is <strong>not</strong> a stack machine, it is a <em>register machine</em>.
In a register machine instruction operands are stored in registers
instead of the stack, and the result of an operation usually ends up
in a specific register.</p>
</div>
<div class="paragraph">
<p>Most register machines do still have a stack used for passing arguments
to functions and saving return addresses. BEAM has both a stack and
registers, but just as in WAM the stack slots are accessible through
registers called Y-registers. BEAM also has a number of X-registers,
and a special register X0 (sometimes also called R0) which works as
an accumulator where results are stored.</p>
</div>
<div class="paragraph">
<p>The X registers are used as argument registers for function calls
and register X0 is used for the return value.</p>
</div>
<div class="paragraph">
<p>The X registers are stored in a C-array in the BEAM emulator and they
are globally accessible from all functions. The X0 register is cached
in a local variable mapped to a physical machine register in the native
machine on most architectures.</p>
</div>
<div class="paragraph">
<p>The Y registers are stored in the stack frame of the caller and only
accessible by the calling functions. To save a value across a function
call BEAM allocates a stack slot for it in the current stack frame and
then moves the value to a Y register.</p>
</div>
<div id="x_and_y_regs_in_memory" class="imageblock">
<div class="content">
<img src="images/diag-1a0b1af2abc4ed3b7be30554b3ccc244.png" alt="diag 1a0b1af2abc4ed3b7be30554b3ccc244" width="260" height="350">
</div>
<div class="title">Figure 21. X and Y Registers in Memory</div>
</div>
<div class="paragraph">
<p>Let us compile the following program with the <em>'S'</em> flag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">add</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">add</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>

<span class="nf">add</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">)</span> <span class="o">-&gt;</span>  <span class="nf">id</span><span class="p">(</span><span class="nv">A</span><span class="p">)</span> <span class="o">+</span> <span class="nf">id</span><span class="p">(</span><span class="nv">B</span><span class="p">).</span>

<span class="nf">id</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">I</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we get the following code for the add function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">add</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">add</span><span class="p">},</span><span class="mi">2</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">allocate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">y</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">call</span><span class="p">,</span><span class="mi">1</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">4</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">y</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">y</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">call</span><span class="p">,</span><span class="mi">1</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">4</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">gc_bif</span><span class="p">,</span><span class="n">'+'</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span><span class="mi">1</span><span class="p">,[{</span><span class="n">y</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}],{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">deallocate</span><span class="p">,</span><span class="mi">1</span><span class="p">}.</span>
    <span class="n">return</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we can see that the code (starting at label 2) first allocates a
stack slot, to get space to save the argument <code>B</code> over the function
call <code>id(A)</code>. The value is then saved by the instruction
<code>{move,{x,1},{y,0}}</code> (read as move <code>x1</code> to <code>y0</code> or in imperative style: <code>y0
:= x1</code>).</p>
</div>
<div class="paragraph">
<p>The id function (at label f4) is then called by
<code>{call,1,{f,4}}</code>. (We will come back to what the argument "1" stands for later.)
Then the result of the call (now in <code>X0</code>)
needs to be saved on the stack (<code>Y0</code>), but the argument <code>B</code>
is saved in <code>Y0</code> so the BEAM does a bit of shuffling:</p>
</div>
<div class="paragraph">
<p>Except for the x and y registers, there are a number of special
purpose registers:</p>
</div>
<div class="ulist">
<div class="title">Special Purpose Registers</div>
<ul>
<li>
<p>Htop - The top of the heap.</p>
</li>
<li>
<p>E - The top of the stack.</p>
</li>
<li>
<p>CP - Continuation Pointer, i.e. function return address</p>
</li>
<li>
<p>I - instruction pointer</p>
</li>
<li>
<p>fcalls - reduction counter</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These registers are cached versions of the corresponding
fields in the PCB.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    {move,{x,0},{x,1}}. % x1 := x0 (id(A))
    {move,{y,0},{x,0}}. % x0 := y0 (B)
    {move,{x,1},{y,0}}. % y0 := x1 (id(A))</pre>
</div>
</div>
<div class="paragraph">
<p>Now we have the second argument <code>B</code> in <code>x0</code> (the first
argument register) and we can call the <code>id</code> function
again <code>{call,1,{f,4}}</code>.</p>
</div>
<div class="paragraph">
<p>After the call x0 contains <code>id(B)</code> and <code>y0</code> contains <code>id(A)</code>,
now we can do the addition: <code>{gc_bif,'+',{f,0},1,[{y,0},{x,0}],{x,0}}</code>.
(We will go into the details of BIF calls and GC later.)</p>
</div>
</div>
<div class="sect2">
<h3 id="_dispatch_directly_threaded_code"><a class="link" href="#_dispatch_directly_threaded_code">5.2. Dispatch: Directly Threaded Code</a></h3>
<div class="paragraph">
<p>The instruction decoder in BEAM is implemented with a technique called
<em>directly threaded</em> code. In this context the word <em>threaded</em> has
nothing to do with OS threads, concurrency or parallelism. It is the
execution path which is threaded through the virtual machine itself.</p>
</div>
<div class="paragraph">
<p>If we take a look at our naive stack machine for arithmetic expressions
we see that we use Erlang atoms and pattern matching to decode which
instruction to execute. This is a very heavy machinery to just decode
machine instructions. In a real machine we would code each instruction
as a "machine word" integer.</p>
</div>
<div class="paragraph">
<p>We can rewrite our stack machine to be a <em>byte code</em> machine
implemented in C. First we rewrite the compiler so that it produces
byte codes. This is pretty straight forward, just replace each
instruction encoded as an atom with a byte representing the
instruction. To be able to handle integers larger than 255 we encode
integers with a size byte followed by the integer encoded in bytes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">compile</span><span class="p">(</span><span class="nv">Expression</span><span class="p">,</span> <span class="nv">FileName</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nv">ParseTree</span><span class="p">]</span> <span class="o">=</span> <span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
			  <span class="nn">erl_parse</span><span class="p">:</span><span class="nf">parse_exprs</span><span class="p">(</span>
			    <span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				    <span class="nn">erl_scan</span><span class="p">:</span><span class="nf">string</span><span class="p">(</span><span class="nv">Expression</span><span class="p">)))),</span>
    <span class="nn">file</span><span class="p">:</span><span class="nf">write_file</span><span class="p">(</span><span class="nv">FileName</span><span class="p">,</span> <span class="nf">generate_code</span><span class="p">(</span><span class="nv">ParseTree</span><span class="p">)</span> <span class="o">++</span> <span class="p">[</span><span class="nf">stop</span><span class="p">()]).</span>

<span class="nf">generate_code</span><span class="p">({</span><span class="n">op</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="n">'+'</span><span class="p">,</span> <span class="nv">Arg1</span><span class="p">,</span> <span class="nv">Arg2</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg1</span><span class="p">)</span> <span class="o">++</span> <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg2</span><span class="p">)</span> <span class="o">++</span> <span class="p">[</span><span class="nf">add</span><span class="p">()];</span>
<span class="nf">generate_code</span><span class="p">({</span><span class="n">op</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="n">'*'</span><span class="p">,</span> <span class="nv">Arg1</span><span class="p">,</span> <span class="nv">Arg2</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg1</span><span class="p">)</span> <span class="o">++</span> <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg2</span><span class="p">)</span> <span class="o">++</span> <span class="p">[</span><span class="nf">multiply</span><span class="p">()];</span>
<span class="nf">generate_code</span><span class="p">({</span><span class="n">integer</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="nv">I</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nf">push</span><span class="p">(),</span> <span class="nf">integer</span><span class="p">(</span><span class="nv">I</span><span class="p">)].</span>

<span class="nf">stop</span><span class="p">()</span>     <span class="o">-&gt;</span> <span class="mi">0</span><span class="p">.</span>
<span class="nf">add</span><span class="p">()</span>      <span class="o">-&gt;</span> <span class="mi">1</span><span class="p">.</span>
<span class="nf">multiply</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="p">.</span>
<span class="nf">push</span><span class="p">()</span>     <span class="o">-&gt;</span> <span class="mi">3</span><span class="p">.</span>
<span class="nf">integer</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">L</span> <span class="o">=</span> <span class="nb">binary_to_list</span><span class="p">(</span><span class="nn">binary</span><span class="p">:</span><span class="nf">encode_unsigned</span><span class="p">(</span><span class="nv">I</span><span class="p">)),</span>
    <span class="p">[</span><span class="nb">length</span><span class="p">(</span><span class="nv">L</span><span class="p">)</span> <span class="p">|</span> <span class="nv">L</span><span class="p">].</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now lets write a simple virtual machine in C. The full code can
be found in <a href="#AP-listings">Appendix C</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">#define STOP 0
#define ADD  1
#define MUL  2
#define PUSH 3

#define pop()   (stack[--sp])
#define push(X) (stack[sp++] = X)

int run(char *code) {
  int stack[1000];
  int sp = 0, size = 0, val = 0;
  char *ip = code;

  while (*ip != STOP) {
    switch (*ip++) {
    case ADD: push(pop() + pop()); break;
    case MUL: push(pop() * pop()); break;
    case PUSH:
      size = *ip++;
      val = 0;
      while (size--) { val = val * 256 + *ip++; }
      push(val);
      break;
    }
  }
  return pop();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You see, a virtual machine written in C does not need to
be very complicated. This machine is just a loop checking
the byte code at each instruction by looking at the value
pointed to by the <em>instruction pointer</em> (<code>ip</code>).</p>
</div>
<div class="paragraph">
<p>For each byte code instruction it will switch on the instruction byte
code and jump to the case which executes the instruction. This
requires a decoding of the instruction and then a jump to the correct
code. If we look at the assembly for vsm.c (gcc -S vsm.c) we see
the inner loop of the decoder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>L11:
        movl    -16(%ebp), %eax
        movzbl  (%eax), %eax
        movsbl  %al, %eax
        addl    $1, -16(%ebp)
        cmpl    $2, %eax
        je      L7
        cmpl    $3, %eax
        je      L8
        cmpl    $1, %eax
        jne     L5</pre>
</div>
</div>
<div class="paragraph">
<p>It has to compare the byte code with each instruction code and
then do a conditional jump. In a real machine with many instructions
this can become quite expensive.</p>
</div>
<div class="paragraph">
<p>A better solution would be to have a table with the address of
the code then we could just use an index into the table
to load the address and jump without
the need to do a compare. This technique is sometimes called
<em>token threaded code</em>. Taking this a step further we can
actually store the address of the function implementing the
instruction in the code memory. This is called
<em>subroutine threaded code</em>.</p>
</div>
<div class="paragraph">
<p>This approach will make the decoding simpler at runtime, but it makes
the whole VM more complicated by requiring a loader. The loader
replaces the byte code instructions with addresses to
functions implementing the instructions.</p>
</div>
<div class="paragraph">
<p>A loader might look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">typedef void (*instructionp_t)(void);

instructionp_t *read_file(char *name) {
  FILE *file;
  instructionp_t *code;
  instructionp_t *cp;
  long  size;
  char ch;
  unsigned int val;

  file = fopen(name, "r");

  if(file == NULL) exit(1);

  fseek(file, 0L, SEEK_END);
  size = ftell(file);
  code = calloc(size, sizeof(instructionp_t));
  if(code == NULL) exit(1);
  cp = code;

  fseek(file, 0L, SEEK_SET);
  while ( ( ch = fgetc(file) ) != EOF )
    {
      switch (ch) {
      case ADD: *cp++ = &amp;add; break;
      case MUL: *cp++ = &amp;mul; break;
      case PUSH:
	*cp++ = &amp;pushi;
	ch = fgetc(file);
	val = 0;
	while (ch--) { val = val * 256 + fgetc(file); }
	*cp++ = (instructionp_t) val;
	break;
      }
    }
  *cp = &amp;stop;

  fclose(file);
  return code;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we can see, we do more work at load time here, including the
decoding of integers larger than 255. (Yes, I know, the code
is not safe for very large integers.)</p>
</div>
<div class="paragraph">
<p>The decode and dispatch loop of the VM becomes quite simple though:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">int run() {
  sp = 0;
  running = 1;

  while (running) (*ip++)();

  return pop();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we just need to implement the instructions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">void add()  { int x,y; x = pop(); y = pop(); push(x + y); }
void mul()  { int x,y; x = pop(); y = pop(); push(x * y); }
void pushi(){ int x;   x = (int)*ip++;       push(x); }
void stop() { running = 0; }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In BEAM this concept is taken one step further, and BEAM uses
<em>directly threaded code</em> (sometimes called only <em>thread code</em>). In
directly threaded code the call and return sequence is replaced by
direct jumps to the implementation of the next instruction. In order
to implement this in C, BEAM uses the GCC extension "labels as
values".</p>
</div>
<div class="paragraph">
<p>We will look closer at the BEAM emulator later but we will take a
quick look at how the add instruction is implemented. The code is
somewhat hard to follow due to the heavy usage of macros. The
<code>STORE_ARITH_RESULT</code> macro actually hides the dispatch function which
looks something like: <code>I += 4; Goto(*I);</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">#define OpCase(OpCode)    lb_##OpCode
#define Goto(Rel) goto *(Rel)

...

 OpCase(i_plus_jId):
 {
     Eterm result;

     if (is_both_small(tmp_arg1, tmp_arg2)) {
	 Sint i = signed_val(tmp_arg1) + signed_val(tmp_arg2);
	 ASSERT(MY_IS_SSMALL(i) == IS_SSMALL(i));
	 if (MY_IS_SSMALL(i)) {
	     result = make_small(i);
	     STORE_ARITH_RESULT(result);
	 }

     }
     arith_func = ARITH_FUNC(mixed_plus);
     goto do_big_arith2;
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make it a little easier to understand how the BEAM dispatcher is
implemented let us take a somewhat imagenary example. We will start
with some real external BEAM code but then I will invent some internal
BEAM instructions and implement them in C.</p>
</div>
<div class="paragraph">
<p>If we start with a simple add function in Erlang:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="Erlang">add(A,B) -&gt; id(A) + id(B).</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compiled to BEAM code this will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="Erlang">{function, add, 2, 2}.
  {label,1}.
    {func_info,{atom,add},{atom,add},2}.
  {label,2}.
    {allocate,1,2}.
    {move,{x,1},{y,0}}.
    {call,1,{f,4}}.
    {move,{x,0},{x,1}}.
    {move,{y,0},{x,0}}.
    {move,{x,1},{y,0}}.
    {call,1,{f,4}}.
    {gc_bif,'+',{f,0},1,[{y,0},{x,0}],{x,0}}.
    {deallocate,1}.
    return.</code></pre>
</div>
</div>
<div class="paragraph">
<p>(See add.erl and add.S in <a href="#AP-listings">Appendix C</a> for the full code.)</p>
</div>
<div class="paragraph">
<p>Now if we zoom in on the three instructions betwen the function calls
in this code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="Erlang">    {move,{x,0},{x,1}}.
    {move,{y,0},{x,0}}.
    {move,{x,1},{y,0}}.</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code first saves the return value of the function call (<code>x0</code>) in a
new register (<code>x1</code>). Then it moves the caller saves register (<code>y0</code>) to
the first argument register (<code>x0</code>). Finally it moves the saved value in
x1 to the caller save register (<code>y0</code>) so that it will survive the next
function call.</p>
</div>
<div class="paragraph">
<p>Imagine that we would implement three instruction in BEAM called
move_xx, move_yx, and move_xy (These instructions does not exist
in the BEAM we just use them to illustrate this example):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">#define OpCase(OpCode)    lb_##OpCode
#define Goto(Rel) goto *((void *)Rel)
#define Arg(N) (Eterm *) I[(N)+1]


  OpCase(move_xx):
  {
     x(Arg(1)) = x(Arg(0));
     I += 3;
     Goto(*I);
  }

  OpCase(move_yx): {
    x(Arg(1)) = y(Arg(0));
    I += 3;
    Goto(*I);
  }


  OpCase(move_xy): {
    y(Arg(1)) = x(Arg(0));
    I += 3;
    Goto(*I);
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the star in <code>goto *</code> does not mean dereference, the
expression means jump to an address pointer, we should really write it
as <code>goto*</code>.</p>
</div>
<div class="paragraph">
<p>Now imagine that the compiled C code for these instructions end up at
memory addresses 0x3000, 0x3100, and 0x3200. When the BEAM code is
loaded the three move instructions in the code will be replaced by the
memory addresses of the implementation of the instructions. Imagine
that the code (<code>{move,{x,0},{x,1}}, {move,{y,0},{x,0}},
{move,{x,1},{y,0}}</code>) is loaded at address 0x1000:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>                     /  0x1000: 0x3000 -&gt; 0x3000: OpCase(move_xx): x(Arg(1)) = x(Arg(0))
{move,{x,0},{x,1}}  {   0x1004: 0x0                                I += 3;
                     \  0x1008: 0x1                                Goto(*I);
                     /  0x100c: 0x3100
{move,{y,0},{x,0}}  {   0x1010: 0x0
                     \  0x1014: 0x0
                     /  0x1018: 0x3200
{move,{x,1},{y,0}}  {   0x101c: 0x1
                     \  0x1020: 0x0</pre>
</div>
</div>
<div class="paragraph">
<p>The word at address 0x1000 points to the implementation of
the move_xx instruction. If the register <code>I</code> contains the instruction
pointer, pointing to 0x1000 then the dispatch will be to fetch <code>*I</code>
(i.e. 0x3000) and jump to that address. (<code>goto* *I</code>)</p>
</div>
<div class="paragraph">
<p>In <a href="#CH-Instructions">Chapter 7</a> we will look more closely at some real
BEAM instructions and how they are implemented.</p>
</div>
</div>
<div class="sect2">
<h3 id="_scheduling_non_preemptive_reduction_counting"><a class="link" href="#_scheduling_non_preemptive_reduction_counting">5.3. Scheduling: Non-preemptive, Reduction counting</a></h3>
<div class="paragraph">
<p>Most modern multi-threading operating systems use preemptive scheduling.
This means that the operating system decides when to switch from one
process to another, regardless of what the process is doing. This protects
the other processes from a process misbehaving by not yielding in time.</p>
</div>
<div class="paragraph">
<p>In cooperative multitasking which uses a non-preemptive scheduler the
running process decides when to yield. This has the advantage that the
yielding process can do so in a known state.</p>
</div>
<div class="paragraph">
<p>For example in a language such as Erlang with dynamic memory
management and tagged values, an implementation may be designed such
that a process only yields when there are no untagged values in
working memory.</p>
</div>
<div class="paragraph">
<p>Take the add instruction as an example, to add two Erlang integers,
the emulator first has to untag the integers, then add them together
and then tag the result as an integer. If a fully preemptive scheduler
is used there would be no guarantee that the process isn&#8217;t suspended
while the integers are untagged. Or the process could be suspended
while it is creating a tuple on the heap, leaving us with half a
tuple. This would make it very hard to traverse a suspended process
stack and heap.</p>
</div>
<div class="paragraph">
<p>On the language level all processes are running concurrently and the
programmer should not have to deal with explicit yields. BEAM solves
this by keeping track of how long a process has been running. This is
done by counting <em>reductions</em>. The term originally comes from the
mathematical term beta-reduction used in lambda calculus.</p>
</div>
<div class="paragraph">
<p>The definition of a reduction in BEAM is not very specific, but we can
see it as a small piece of work, which shouldn&#8217;t take <em>too long</em>.
Each function call is counted as a reduction. BEAM does a test
upon entry to each function to check whether the process has used up all its
reductions or not. If there are reductions left the function is executed
otherwise the process is suspended.</p>
</div>
<div class="paragraph">
<p>Since there are no loops in Erlang, only tail-recursive function
calls, it is very hard to write a program that does any significant
amount of work without using up its reductions.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There are some BIFs that can run for a long time only using 1
reduction, like term_to_binary and binary_to_term. Try to make
sure that you only call these BIFs with small terms or binaries, or
you might lock up the scheduler for a very long time.</p>
</div>
<div class="paragraph">
<p>Also, if you write your own NIFs, make sure they can yield and that
they bump the reduction counter by an amount proportional to their
run time.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We will go through the details of how the scheduler works in
<a href="#CH-Scheduling">Chapter 11</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_memory_management_garbage_collecting"><a class="link" href="#_memory_management_garbage_collecting">5.4. Memory Management: Garbage Collecting</a></h3>
<div class="paragraph">
<p>Erlang supports garbage collection; as an Erlang progammer you do not
need to do explicit memory management. On the BEAM level, though, the
code is responsible for checking for stack and heap overrun, and for
allocating enough space on the stack and the heap.</p>
</div>
<div class="paragraph">
<p>The BEAM instruction <a href="https://github.com/erlang/otp/blob/OTP-23.0/lib/compiler/src/genop.tab#L118">test_heap</a>
will ensure that there is as much
space on the heap as requested. If needed the instruction will call
the garbage collector to reclaim space on the heap. The garbage
collector in turn will call the lower levels of the memory subsystem
to allocate or free memory as needed. We will look at the details
of memory management and garbage collection in <a href="#CH-Memory">Chapter 12</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_beam_it_is_virtually_unreal"><a class="link" href="#_beam_it_is_virtually_unreal">5.5. BEAM: it is virtually unreal</a></h3>
<div class="paragraph">
<p>The BEAM is a virtual machine, by that we mean that it is implemented
in software instead of in hardware. There has been projects to
implement the BEAM by FPGA, and there is nothing stopping anyone from
implementing the BEAM in hardware. A better description might be to
call the BEAM an Abstract machine, and see it as blueprint for a
machine which can execute BEAM code. And, in fact, the "am" in BEAM
stands for "Abstract Machine".</p>
</div>
<div class="paragraph">
<p>In this book we will make no distinction between abstract machines,
and virtual machines or their implementation. In a more formal setting
an abstract machine is a theoretical model of a computer, and a
virtual machine is either a software implementation of an abstract
machine or a software emulator of a real physical machine.</p>
</div>
<div class="paragraph">
<p>Unfortunately there exist no official specification of the BEAM, it is
currently only defined by the implementation in Erlang/OTP.
If you want to implement your own BEAM you would have to try to mimic
the current implementation not knowing which parts are essential and
which parts are accidental. You would have to mimic every observable
behavior to be sure that you have a valid BEAM interpreter.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>TODO:</strong> Conclusion and handover to the chapters on instructions.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-beam_modules"><a class="link" href="#CH-beam_modules">6. Modules and The BEAM File Format (16p)</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="modules"><a class="link" href="#modules">6.1. Modules</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">%% TODO</div>
What is a module. How is code loaded. How does hot code loading work. How does the purging work. How does the code server work. How does dynamic code loading work, the code search path. Handling code in a distributed system. (Overlap with chapter 10, have to see what goes where.) Parameterized modules. How p-mods are implemented. The trick with p-mod calls. Here follows an excerpt from the current draft:
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="BEAM_files"><a class="link" href="#BEAM_files">6.2. The BEAM File Format</a></h3>
<div class="paragraph">
<p>The definite source of information about the beam file format is obviously the source code of beam_lib.erl (see <a href="https://github.com/erlang/otp/blob/maint/lib/stdlib/src/beam_lib.erl" class="bare">https://github.com/erlang/otp/blob/maint/lib/stdlib/src/beam_lib.erl</a>). There is actually also a more readable but slightly dated description of the format written by the main developer and maintainer of Beam (see <a href="http://www.erlang.se/~bjorn/beam_file_format.html" class="bare">http://www.erlang.se/~bjorn/beam_file_format.html</a>).</p>
</div>
<div class="paragraph">
<p>The beam file format is based on the interchange file format (EA IFF)#, with two small changes. We will get to those shortly. An IFF file starts with a header followed by a number of chunks. There are a number of standard chunk types in the IFF specification dealing mainly with images and music. But the IFF standard also lets you specify your own named chunks, and this is what BEAM does.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Beam files differ from standard IFF files, in that each chunk is aligned on 4-byte boundary (i.e. 32 bit word) instead of on a 2-byte boundary as in the IFF standard. To indicate that this is not a standard IFF file the IFF header is tagged with FOR1 instead of FOR. The IFF specification suggests this tag for future extensions.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Beam uses form type BEAM. A beam file header has the following layout:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">BEAMHeader</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">IffHeader</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"FOR1"</span><span class="p">,</span>
  <span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>                  <span class="o">//</span> <span class="n">big</span> <span class="n">endian</span><span class="p">,</span> <span class="n">how</span> <span class="n">many</span> <span class="n">more</span> <span class="n">bytes</span> <span class="n">are</span> <span class="n">there</span>
  <span class="nv">FormType</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"BEAM"</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After the header multiple chunks can be found. Size of each chunk is aligned to the multiple of 4 and each chunk has its own header (below).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The alignment is important for some platforms, where unaligned memory byte access would create a hardware exception (named SIGBUS in Linux). This can turn out to be a performance hit or the exception could crash the VM.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">BEAMChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>           <span class="o">//</span> <span class="s">"Code"</span><span class="p">,</span> <span class="s">"Atom"</span><span class="p">,</span> <span class="s">"StrT"</span><span class="p">,</span> <span class="s">"LitT"</span><span class="p">,</span> <span class="p">...</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">ChunkData</span><span class="p">:</span><span class="nv">ChunkSize</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>   <span class="o">//</span> <span class="n">data</span> <span class="n">format</span> <span class="n">is</span> <span class="n">defined</span> <span class="n">by</span> <span class="nv">ChunkName</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This file format prepends all areas with the size of the following area making it easy to parse the file directly while reading it from disk. To illustrate the structure and content of beam files, we will write a small program that extract all the chunks from a beam file. To make this program as simple and readable as possible we will not parse the file while reading, instead we load the whole file in memory as a binary, and then parse each chunk. The first step is to get a list of all chunks:</p>
</div>
<!-- While this is reasonably simple code, is it going to be obvious to readers what's going on here? It may require a bit of explanation as to how this code works. - bmacdonald -->
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">beamfile</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">read</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="nf">read</span><span class="p">(</span><span class="nv">Filename</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">File</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p">(</span><span class="nv">Filename</span><span class="p">),</span>
   <span class="o">&lt;&lt;</span><span class="s">"FOR1"</span><span class="p">,</span>
     <span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
     <span class="s">"BEAM"</span><span class="p">,</span>
     <span class="nv">Chunks</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">File</span><span class="p">,</span>
   <span class="p">{</span><span class="nv">Size</span><span class="p">,</span> <span class="nf">read_chunks</span><span class="p">(</span><span class="nv">Chunks</span><span class="p">,</span> <span class="p">[])}.</span>

<span class="nf">read_chunks</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">N</span><span class="p">,</span><span class="nv">A</span><span class="p">,</span><span class="nv">M</span><span class="p">,</span><span class="nv">E</span><span class="p">,</span> <span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Tail</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="c">%% Align each chunk on even 4 bytes
</span>   <span class="nv">ChunkLength</span> <span class="o">=</span> <span class="nf">align_by_four</span><span class="p">(</span><span class="nv">Size</span><span class="p">),</span>
   <span class="o">&lt;&lt;</span><span class="nv">Chunk</span><span class="p">:</span><span class="nv">ChunkLength</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Tail</span><span class="p">,</span>
   <span class="nf">read_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="p">[{[</span><span class="nv">N</span><span class="p">,</span><span class="nv">A</span><span class="p">,</span><span class="nv">M</span><span class="p">,</span><span class="nv">E</span><span class="p">],</span> <span class="nv">Size</span><span class="p">,</span> <span class="nv">Chunk</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">read_chunks</span><span class="p">(</span><span class="o">&lt;&lt;&gt;&gt;</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">reverse</span><span class="p">(</span><span class="nv">Acc</span><span class="p">).</span>

<span class="nf">align_by_four</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">((</span><span class="nv">N</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="ow">div</span> <span class="mi">4</span><span class="p">)).</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A sample run might look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; beamfile:read("beamfile.beam").
{848,
[{"Atom",103,
  &lt;&lt;0,0,0,14,4,102,111,114,49,4,114,101,97,100,4,102,105,
    108,101,9,114,101,97,...&gt;&gt;},
 {"Code",341,
  &lt;&lt;0,0,0,16,0,0,0,0,0,0,0,132,0,0,0,14,0,0,0,4,1,16,...&gt;&gt;},
 {"StrT",8,&lt;&lt;"FOR1BEAM"&gt;&gt;},
 {"ImpT",88,&lt;&lt;0,0,0,7,0,0,0,3,0,0,0,4,0,0,0,1,0,0,0,7,...&gt;&gt;},
 {"ExpT",40,&lt;&lt;0,0,0,3,0,0,0,13,0,0,0,1,0,0,0,13,0,0,0,...&gt;&gt;},
 {"LocT",16,&lt;&lt;0,0,0,1,0,0,0,6,0,0,0,2,0,0,0,6&gt;&gt;},
 {"Attr",40,
  &lt;&lt;131,108,0,0,0,1,104,2,100,0,3,118,115,110,108,0,0,...&gt;&gt;},
 {"CInf",130,
  &lt;&lt;131,108,0,0,0,4,104,2,100,0,7,111,112,116,105,111,...&gt;&gt;},
 {"Abst",0,&lt;&lt;&gt;&gt;}]}</pre>
</div>
</div>
<div class="paragraph">
<p>Here we can see the chunk names that beam uses.</p>
</div>
<div class="sect3">
<h4 id="atom_table_chunk"><a class="link" href="#atom_table_chunk">6.2.1. Atom table chunk</a></h4>
<div class="paragraph">
<p>Either the chunk named <code>Atom</code> or the chunk named <code>AtU8</code> is mandatory. It contains all atoms referred to by the module. For source files with <code>latin1</code> encoding, the chunk named <code>Atom</code> is used. For <code>utf8</code> encoded modules, the chunk is named <code>AtU8</code>. The format of the atom chunk is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">AtomChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"Atom"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">NumberOfAtoms</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="p">[</span><span class="o">&lt;&lt;</span><span class="nv">AtomLength</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span> <span class="nv">AtomName</span><span class="p">:</span><span class="nv">AtomLength</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span><span class="o">&gt;&gt;</span> <span class="p">||</span> <span class="n">repeat</span> <span class="nv">NumberOfAtoms</span><span class="p">],</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The format of the AtU8 chunk is the same as above, except that the name of the chunk is <code>AtU8</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Module name is always stored as the first atom in the table (atom index 0).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let us add a decoder for the atom chunk to our Beam file reader:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">beamfile</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">read</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="nf">read</span><span class="p">(</span><span class="nv">Filename</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">File</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p">(</span><span class="nv">Filename</span><span class="p">),</span>
   <span class="o">&lt;&lt;</span><span class="s">"FOR1"</span><span class="p">,</span>
     <span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
     <span class="s">"BEAM"</span><span class="p">,</span>
     <span class="nv">Chunks</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">File</span><span class="p">,</span>
   <span class="p">{</span><span class="nv">Size</span><span class="p">,</span> <span class="nf">parse_chunks</span><span class="p">(</span><span class="nf">read_chunks</span><span class="p">(</span><span class="nv">Chunks</span><span class="p">,</span> <span class="p">[]),[])}.</span>

<span class="nf">read_chunks</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">N</span><span class="p">,</span><span class="nv">A</span><span class="p">,</span><span class="nv">M</span><span class="p">,</span><span class="nv">E</span><span class="p">,</span> <span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Tail</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="c">%% Align each chunk on even 4 bytes
</span>   <span class="nv">ChunkLength</span> <span class="o">=</span> <span class="nf">align_by_four</span><span class="p">(</span><span class="nv">Size</span><span class="p">),</span>
   <span class="o">&lt;&lt;</span><span class="nv">Chunk</span><span class="p">:</span><span class="nv">ChunkLength</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Tail</span><span class="p">,</span>
   <span class="nf">read_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="p">[{[</span><span class="nv">N</span><span class="p">,</span><span class="nv">A</span><span class="p">,</span><span class="nv">M</span><span class="p">,</span><span class="nv">E</span><span class="p">],</span> <span class="nv">Size</span><span class="p">,</span> <span class="nv">Chunk</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">read_chunks</span><span class="p">(</span><span class="o">&lt;&lt;&gt;&gt;</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">reverse</span><span class="p">(</span><span class="nv">Acc</span><span class="p">).</span>

<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Atom"</span><span class="p">,</span> <span class="p">_</span><span class="nv">Size</span><span class="p">,</span>
             <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">Numberofatoms</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Atoms</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span>
            <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">atoms</span><span class="p">,</span><span class="nf">parse_atoms</span><span class="p">(</span><span class="nv">Atoms</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([</span><span class="nv">Chunk</span><span class="p">|</span><span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c">%% Not yet implemented chunk
</span>   <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="p">[</span><span class="nv">Chunk</span><span class="p">|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([],</span><span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Acc</span><span class="p">.</span>

<span class="nf">parse_atoms</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Atomlength</span><span class="p">,</span> <span class="nv">Atom</span><span class="p">:</span><span class="nv">Atomlength</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="k">when</span> <span class="nv">Atomlength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">-&gt;</span>
   <span class="p">[</span><span class="nb">list_to_atom</span><span class="p">(</span><span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">Atom</span><span class="p">))</span> <span class="p">|</span> <span class="nf">parse_atoms</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">parse_atoms</span><span class="p">(_</span><span class="nv">Alignment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[].</span>

<span class="nf">align_by_four</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">((</span><span class="nv">N</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="ow">div</span> <span class="mi">4</span><span class="p">)).</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="export_table_chunk"><a class="link" href="#export_table_chunk">6.2.2. Export table chunk</a></h4>
<div class="paragraph">
<p>The chunk named <code>ExpT</code> (for EXPort Table) is mandatory and contains information about which functions are exported.</p>
</div>
<div class="paragraph">
<p>The format of the export chunk is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">ExportChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"ExpT"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">ExportCount</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="p">[</span> <span class="o">&lt;&lt;</span> <span class="nv">FunctionName</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
       <span class="nv">Arity</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
       <span class="nv">Label</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span>
    <span class="o">&gt;&gt;</span> <span class="p">||</span> <span class="n">repeat</span> <span class="nv">ExportCount</span> <span class="p">],</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>FunctionName</code> is the index in the atom table.</p>
</div>
<div class="paragraph">
<p>We can extend our parse_chunk function by adding the following clause after the atom handling clause:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"ExpT"</span><span class="p">,</span> <span class="p">_</span><span class="nv">Size</span><span class="p">,</span>
             <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">Numberofentries</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Exports</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span>
            <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">exports</span><span class="p">,</span><span class="nf">parse_exports</span><span class="p">(</span><span class="nv">Exports</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span>

<span class="err"></span>

<span class="nf">parse_exports</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Function</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
               <span class="nv">Arity</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
               <span class="nv">Label</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
               <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="p">[{</span><span class="nv">Function</span><span class="p">,</span> <span class="nv">Arity</span><span class="p">,</span> <span class="nv">Label</span><span class="p">}</span> <span class="p">|</span> <span class="nf">parse_exports</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">parse_exports</span><span class="p">(</span><span class="o">&lt;&lt;&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[].</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="import_table_chunk"><a class="link" href="#import_table_chunk">6.2.3. Import table chunk</a></h4>
<div class="paragraph">
<p>The chunk named <code>ImpT</code> (for IMPort Table) is mandatory and contains information about which functions are imported.</p>
</div>
<div class="paragraph">
<p>The format of the chunk is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">ImportChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"ImpT"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">ImportCount</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="p">[</span> <span class="o">&lt;&lt;</span> <span class="nv">ModuleName</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
       <span class="nv">FunctionName</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
       <span class="nv">Arity</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span>
    <span class="o">&gt;&gt;</span> <span class="p">||</span> <span class="n">repeat</span> <span class="nv">ImportCount</span> <span class="p">],</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here <code>ModuleName</code> and <code>FunctionName</code> are indexes in the atom table.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The code for parsing the import table is similar to that which parses the export table, but not exactly: both are triplets of 32-bit integers, just their meaning is different. See the full code at the end of the chapter.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="code_chunk"><a class="link" href="#code_chunk">6.2.4. Code Chunk</a></h4>
<div class="paragraph">
<p>The chunk named <code>Code</code> contains the beam code for the module and is mandatory. The format of the chunk is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">ImportChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"Code"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">SubSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">InstructionSet</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>        <span class="c">% Must match code version in the emulator
</span>  <span class="nv">OpcodeMax</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">LabelCount</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">FunctionCount</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">Code</span><span class="p">:(</span><span class="nv">ChunkSize</span><span class="o">-</span><span class="nv">SubSize</span><span class="p">)</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span>  <span class="c">% all remaining data
</span>  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The field <code>SubSize</code> stores the number of words before the code starts. This makes it possible to add new information fields in the code chunk without breaking older loaders.</p>
</div>
<div class="paragraph">
<p>The <code>InstructionSet</code> field indicates which version of the instruction set the file uses. The version number is increased if any instruction is changed in an incompatible way.</p>
</div>
<div class="paragraph">
<p>The <code>OpcodeMax</code> field indicates the highest number of any opcode used in the code. New instructions can be added to the system in a way such that older loaders still can load a newer file as long as the instructions used in the file are within the range the loader knows about.</p>
</div>
<div class="paragraph">
<p>The field <code>LabelCount</code> contains the number of labels so that a loader can preallocate a label table of the right size in one call. The field <code>FunctionCount</code> contains the number of functions so that the functions table could also be preallocated efficiently.</p>
</div>
<div class="paragraph">
<p>The <code>Code</code> field contains instructions, chained together, where each instruction has the following format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">Instruction</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">InstructionCode</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
  <span class="p">[</span><span class="nn">beam_asm</span><span class="p">:</span><span class="nf">encode</span><span class="p">(</span><span class="nv">Argument</span><span class="p">)</span> <span class="p">||</span> <span class="n">repeat</span> <span class="nv">Arity</span><span class="p">]</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here <code>Arity</code> is hardcoded in the table, which is generated from ops.tab by genop script when the emulator is built from source.</p>
</div>
<div class="paragraph">
<p>The encoding produced by <code>beam_asm:encode</code> is explained below in the  <a href="#SEC-BeamModulesCTE">Compact Term Encoding</a> section.</p>
</div>
<div class="paragraph">
<p>We can parse out the code chunk by adding the following code to our program:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Code"</span><span class="p">,</span> <span class="nv">Size</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">SubSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span><span class="nv">Chunk</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span>
              <span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="o">&lt;&lt;</span><span class="nv">Info</span><span class="p">:</span><span class="nv">SubSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="nv">Code</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Chunk</span><span class="p">,</span>
   <span class="c">%% 8 is size of CunkSize &amp; SubSize
</span>   <span class="nv">OpcodeSize</span> <span class="o">=</span> <span class="nv">Size</span> <span class="o">-</span> <span class="nv">SubSize</span> <span class="o">-</span> <span class="mi">8</span><span class="p">,</span>
   <span class="o">&lt;&lt;</span><span class="nv">OpCodes</span><span class="p">:</span><span class="nv">OpcodeSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="p">_</span><span class="nv">Align</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Code</span><span class="p">,</span>
   <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">code</span><span class="p">,</span><span class="nf">parse_code_info</span><span class="p">(</span><span class="nv">Info</span><span class="p">),</span> <span class="nv">OpCodes</span><span class="p">}</span>
                      <span class="p">|</span> <span class="nv">Acc</span><span class="p">]);</span>

<span class="p">..</span>

<span class="nf">parse_code_info</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Instructionset</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
		  <span class="nv">OpcodeMax</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
		  <span class="nv">NumberOfLabels</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
		  <span class="nv">NumberOfFunctions</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
		  <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="p">[{</span><span class="n">instructionset</span><span class="p">,</span> <span class="nv">Instructionset</span><span class="p">},</span>
    <span class="p">{</span><span class="n">opcodemax</span><span class="p">,</span> <span class="nv">OpcodeMax</span><span class="p">},</span>
    <span class="p">{</span><span class="n">numberoflabels</span><span class="p">,</span> <span class="nv">NumberOfLabels</span><span class="p">},</span>
    <span class="p">{</span><span class="n">numberofFunctions</span><span class="p">,</span> <span class="nv">NumberOfFunctions</span><span class="p">}</span> <span class="p">|</span>
    <span class="k">case</span> <span class="nv">Rest</span> <span class="k">of</span>
	 <span class="o">&lt;&lt;&gt;&gt;</span> <span class="o">-&gt;</span> <span class="p">[];</span>
	 <span class="p">_</span> <span class="o">-&gt;</span> <span class="p">[{</span><span class="n">newinfo</span><span class="p">,</span> <span class="nv">Rest</span><span class="p">}]</span>
    <span class="k">end</span><span class="p">].</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will learn how to decode the beam instructions in a later chapter, aptly named BEAM Instructions.</p>
</div>
</div>
<div class="sect3">
<h4 id="_string_table_chunk"><a class="link" href="#_string_table_chunk">6.2.5. String table chunk</a></h4>
<div class="paragraph">
<p>The chunk named <code>StrT</code> is mandatory and contains all constant string literals in the module as one long string. If there are no string literals the chunks should still be present but empty and of size 0.</p>
</div>
<div class="paragraph">
<p>The format of the chunk is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">StringChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"StrT"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">Data</span><span class="p">:</span><span class="nv">ChunkSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The string chunk can be parsed easily by just turning the string of bytes into a binary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>parse_chunks([{"StrT", _Size, &lt;&lt;Strings/binary&gt;&gt;} | Rest], Acc) -&gt;
    parse_chunks(Rest,[{strings,binary_to_list(Strings)}|Acc]);</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_attributes_chunk"><a class="link" href="#_attributes_chunk">6.2.6. Attributes Chunk</a></h4>
<div class="paragraph">
<p>The chunk named <code>Attr</code> is optional, but some OTP tools expect the attributes to be present. The release handler expects the "vsn" attribute to be present. You can get the version attribute from a file with: beam_lib:version(Filename), this function assumes that there is an attribute chunk with a "vsn" attribute present.</p>
</div>
<div class="paragraph">
<p>The format of the chunk is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">AttributesChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"Attr"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">Attributes</span><span class="p">:</span><span class="nv">ChunkSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can parse the attribute chunk like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Attr"</span><span class="p">,</span> <span class="nv">Size</span><span class="p">,</span> <span class="nv">Chunk</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="nv">Bin</span><span class="p">:</span><span class="nv">Size</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="p">_</span><span class="nv">Pad</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Chunk</span><span class="p">,</span>
    <span class="nv">Attribs</span> <span class="o">=</span> <span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Bin</span><span class="p">),</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">attributes</span><span class="p">,</span><span class="nv">Attribs</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compilation_information_chunk"><a class="link" href="#_compilation_information_chunk">6.2.7. Compilation Information Chunk</a></h4>
<div class="paragraph">
<p>The chunk named <code>CInf</code> is optional, but some OTP tools expect the information to be present.</p>
</div>
<div class="paragraph">
<p>The format of the chunk is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">CompilationInfoChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"CInf"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">Data</span><span class="p">:</span><span class="nv">ChunkSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can parse the compilation information chunk like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"CInf"</span><span class="p">,</span> <span class="nv">Size</span><span class="p">,</span> <span class="nv">Chunk</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="nv">Bin</span><span class="p">:</span><span class="nv">Size</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="p">_</span><span class="nv">Pad</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Chunk</span><span class="p">,</span>
    <span class="nv">CInfo</span> <span class="o">=</span> <span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Bin</span><span class="p">),</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">compile_info</span><span class="p">,</span><span class="nv">CInfo</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_local_function_table_chunk"><a class="link" href="#_local_function_table_chunk">6.2.8. Local Function Table Chunk</a></h4>
<div class="paragraph">
<p>The chunk named <code>LocT</code> is optional and intended for cross reference tools.</p>
</div>
<div class="paragraph">
<p>The format is the same as that of the export table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">LocalFunTableChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"LocT"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">FunctionCount</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="p">[</span> <span class="o">&lt;&lt;</span> <span class="nv">FunctionName</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
       <span class="nv">Arity</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
       <span class="nv">Label</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span>
    <span class="o">&gt;&gt;</span> <span class="p">||</span> <span class="n">repeat</span> <span class="nv">FunctionCount</span> <span class="p">],</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The code for parsing the local function table is basically the same as that for parsing the export and the import table, and we can actually use the same function to parse entries in all tables. See the full code at the end of the chapter.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_literal_table_chunk"><a class="link" href="#_literal_table_chunk">6.2.9. Literal Table Chunk</a></h4>
<div class="paragraph">
<p>The chunk named <code>LitT</code> is optional and contains all literal values from the module source in compressed form, which are not immediate values. The format of the chunk is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">LiteralTableChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"LitT"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">UncompressedSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>      <span class="c">% It is nice to know the size to allocate some memory
</span>  <span class="nv">CompressedLiterals</span><span class="p">:</span><span class="nv">ChunkSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Where the <code>CompressedLiterals</code> must have exactly <code>UncompressedSize</code> bytes. Each literal in the table is encoded with the External Term Format (<code>erlang:term_to_binary</code>). The format of <code>CompressedLiterals</code> is the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CompressedLiterals = &lt;&lt;
  Count:32/big,
  [ &lt;&lt;Size:32/big, Literal:binary&gt;&gt;  || repeat Count ]
&gt;&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The whole table is compressed with <code>zlib:compress/1</code> (deflate algorithm), and can be uncompressed with <code>zlib:uncompress/1</code> (inflate algorithm).</p>
</div>
<div class="paragraph">
<p>We can parse the chunk like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"LitT"</span><span class="p">,</span> <span class="p">_</span><span class="nv">ChunkSize</span><span class="p">,</span>
              <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">CompressedTableSize</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span> <span class="nv">Compressed</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span>
             <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">NumLiterals</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nv">Table</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nn">zlib</span><span class="p">:</span><span class="nf">uncompress</span><span class="p">(</span><span class="nv">Compressed</span><span class="p">),</span>
    <span class="nv">Literals</span> <span class="o">=</span> <span class="nf">parse_literals</span><span class="p">(</span><span class="nv">Table</span><span class="p">),</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">literals</span><span class="p">,</span><span class="nv">Literals</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">parse_literals</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nv">Literal</span><span class="p">:</span><span class="nv">Size</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span><span class="nv">Tail</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Literal</span><span class="p">)</span> <span class="p">|</span> <span class="nf">parse_literals</span><span class="p">(</span><span class="nv">Tail</span><span class="p">)];</span>
<span class="nf">parse_literals</span><span class="p">(</span><span class="o">&lt;&lt;&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[].</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_abstract_code_chunk"><a class="link" href="#_abstract_code_chunk">6.2.10. Abstract Code Chunk</a></h4>
<div class="paragraph">
<p>The chunk named <code>Abst</code> is optional and may contain the code in abstract form. If you give the flag <code>debug_info</code> to the compiler it will store the abstract syntax tree for the module in this chunk. OTP tools like the debugger and Xref need the abstract form. The format of the chunk is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">AbstractCodeChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"Abst"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">AbstractCode</span><span class="p">:</span><span class="nv">ChunkSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can parse the chunk like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Abst"</span><span class="p">,</span> <span class="p">_</span><span class="nv">ChunkSize</span><span class="p">,</span> <span class="o">&lt;&lt;&gt;&gt;</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span><span class="nv">Acc</span><span class="p">);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Abst"</span><span class="p">,</span> <span class="p">_</span><span class="nv">ChunkSize</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">AbstractCode</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">abstract_code</span><span class="p">,</span><span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">AbstractCode</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compression_and_encryption"><a class="link" href="#_compression_and_encryption">6.2.11. Compression and Encryption</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_function_trace_chunk_obsolete"><a class="link" href="#_function_trace_chunk_obsolete">6.2.12. Function Trace Chunk (Obsolete)</a></h4>
<div class="paragraph">
<p>This chunk type is now obsolete.</p>
</div>
</div>
<div class="sect3">
<h4 id="_bringing_it_all_together"><a class="link" href="#_bringing_it_all_together">6.2.13. Bringing it all Together</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="SEC-BeamModulesCTE"><a class="link" href="#SEC-BeamModulesCTE">6.2.14. Compact Term Encoding</a></h4>
<div class="paragraph">
<p>Let&#8217;s look at the algorithm, used by <code>beam_asm:encode</code>. BEAM files use a special encoding to store simple terms in BEAM file in a space-efficient way. It is different from memory term layout, used by the VM.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>Beam_asm</code> is a module in the <code>compiler</code> application, part of the Erlang distribution, it is used to assemble binary content of beam modules.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The reason behind this complicated design is to try and fit as much type and value data into the first byte as possible to make the code section more compact. After decoding, all encoded values become full size machine words or terms.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-9e1cde7f700a2684d2a101cefd9a008d.png" alt="diag 9e1cde7f700a2684d2a101cefd9a008d" width="670" height="252">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Since OTP 20 this tag format has been changed and the <code>Extended - Float</code> is gone. All following tag values are shifted down by 1: List is 2#10111, fpreg is 2#100111, alloc list is 2#110111 and literal is 2#1010111. Floating point values now go straight to literal area of the BEAM file.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It uses the first 3 bits of a first byte to store the tag which defines the type of the following value. If the bits were all 1 (special value 7 or ?tag_z from <code>beam_opcodes.hrl</code>), then a few more bits are used.</p>
</div>
<div class="paragraph">
<p>For values under 16, the value is placed entirely into bits 4-5-6-7 having bit 3 set to 0:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-55f343a661e93a4930ebcc5b443329f0.png" alt="diag 55f343a661e93a4930ebcc5b443329f0" width="230" height="98">
</div>
</div>
<div class="paragraph">
<p>For values under 2048 (16#800) bit 3 is set to 1, marks that 1 continuation byte will be used and 3 most significant bits of the value will extend into this bytes bits 5-6-7:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-4ee0460fd12699d47b52eda824c70951.png" alt="diag 4ee0460fd12699d47b52eda824c70951" width="230" height="98">
</div>
</div>
<div class="paragraph">
<p>Larger and negative values are first converted to bytes. Then if the value takes 2..8 bytes, bits 3-4 will be set to 1, and bits 5-6-7 will contain the (Bytes-2) size for the value, which follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-a2d7b973829977fa30dc5bfdf8c49eb6.png" alt="diag a2d7b973829977fa30dc5bfdf8c49eb6" width="250" height="98">
</div>
</div>
<div class="paragraph">
<p>If the following value is greater than 8 bytes, then all bits 3-4-5-6-7 will be set to 1, followed by a nested encoded unsigned literal (macro <code>?tag_u</code> in <code>beam_opcodes.hrl</code>) value of (Bytes-9):8, and then the data:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-cc59f55a3d9d233741eafded03c1c098.png" alt="diag cc59f55a3d9d233741eafded03c1c098" width="630" height="98">
</div>
</div>
<div class="sect4">
<h5 id="_tag_types"><a class="link" href="#_tag_types">Tag Types</a></h5>
<div class="paragraph">
<p>When reading compact term format, the resulting integer may be interpreted differently based on what is the value of <code>Tag</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For literals the value is index into the literal table.</p>
</li>
<li>
<p>For atoms, the value is atom index MINUS one. If the value is 0, it means <code>NIL</code> (empty list) instead.</p>
</li>
<li>
<p>For labels 0 means invalid value.</p>
</li>
<li>
<p>If tag is character, the value is unsigned unicode codepoint.</p>
</li>
<li>
<p>Tag Extended List contains pairs of terms. Read <code>Size</code>, create tuple of <code>Size</code> and then read <code>Size/2</code> pairs into it. Each pair is <code>Value</code> and <code>Label</code>. <code>Value</code> is a term to compare against and <code>Label</code> is where to jump on match. This is used in <code>select_val</code> instruction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Refer to <code>beam_asm:encode/2</code> in the compiler application for details about how this is encoded. Tag values are presented in this section, but also can be found in <code>compiler/src/beam_opcodes.hrl</code>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Instructions"><a class="link" href="#CH-Instructions">7. Generic BEAM Instructions (25p)</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Beam has two different instructions sets, an internal instructions
set, called <em>specific</em>, and an external instruction set, called
<em>generic</em>.</p>
</div>
<div class="paragraph">
<p>The generic instruction set is what could be called the official
instruction set, this is the set of instructions used by both the
compiler and the Beam interpreter. If there was an official Erlang
Virtual Machine specification it would specify this
instruction set. If you want to write your own compiler to the Beam,
this is the instruction set you should target. If you want to write
your own EVM this is the instruction set you should handle.</p>
</div>
<div class="paragraph">
<p>The external instruction set is quite stable, but it does change
between Erlang versions, especially between major versions.</p>
</div>
<div class="paragraph">
<p>This is the instruction set which we will cover in this chapter.</p>
</div>
<div class="paragraph">
<p>The other instruction set, the specific, is an optimized instruction
set used by the Beam to implement the external instruction set. To
give you an understanding of how the Beam works we will cover this
instruction set in <a href="#CH-Internal_instructions">Chapter 10</a>. The internal
instruction set can change without warning between minor version or
even in patch releases. Basing any tool on the internal instruction
set is risky.</p>
</div>
<div class="paragraph">
<p>In this chapter I will go through the general syntax for the
instructions and some instruction groups in detail, a complete list of
instructions with short descriptions can be found in
<a href="#AP-Instructions">Appendix B</a>.</p>
</div>
<div class="sect2">
<h3 id="_instruction_definitions"><a class="link" href="#_instruction_definitions">7.1. Instruction definitions</a></h3>
<div class="paragraph">
<p>The names and opcodes of the generic instructions are defined
in lib/compiler/src/genop.tab.</p>
</div>
<div class="paragraph">
<p>The file contains a version number for the Beam instruction format, which
also is written to .beam files. This number has so far never changed
and is still at version 0. If the external format would be changed in a
non backwards compatible way this number would be changed.</p>
</div>
<div class="paragraph">
<p>The file genop.tab is used as input by beam_makeops which is a perl script
which generate code from the ops tabs. The generator is used both to generate
Erlang code for the compiler (beam_opcodes.hrl and beam_opcodes.erl) and to
generate C code for the emulator ( TODO: Filenames).</p>
</div>
<div class="paragraph">
<p>Any line in the file starting with "#" is a comment and ignored by
beam_makeops. The file can contain definitions, which turns into a
binding in the perl script, of the form:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>NAME=EXPR</pre>
</div>
</div>
<div class="paragraph">
<p>Like, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>BEAM_FORMAT_NUMBER=0</pre>
</div>
</div>
<div class="paragraph">
<p>The Beam format number is the same as the instructionset field in
the external beam format. It is only bumped when a backwards
incompatible change to the instruction set is made.</p>
</div>
<div class="paragraph">
<p>The main content of the file are the opcode definitions of the form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OPNUM: [-]NAME/ARITY</pre>
</div>
</div>
<div class="paragraph">
<p>Where OPNUM and ARITY are integers, NAME is an identifier starting
with a lowercase letter (a-z), and <em>:</em>, <em>-</em>, and <em>/</em> are literals.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1: label/1</pre>
</div>
</div>
<div class="paragraph">
<p>The minus sign (-) indicates a deprecated function. A deprecated
function keeps its opcode in order for the loader to be sort of
backwards compatible (it will recognize deprecated instructions and
refuse to load the code).</p>
</div>
<div class="paragraph">
<p>In the rest of this Chapter we will go through some BEAM instructions
in detail. For a full list with brief descriptions see:
<a href="#AP-Instructions">Appendix B</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_beam_code_listings"><a class="link" href="#_beam_code_listings">7.2. BEAM code listings</a></h3>
<div class="paragraph">
<p>As we saw in <a href="#CH-Compiler">Chapter 2</a> we can give the option 'S' to the
Erlang compiler to get a .S file with the BEAM code for the module
in a human and machine readable format (actually as Erlang terms).</p>
</div>
<div class="paragraph">
<p>Given the file beamexample1.erl:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">beamexample1</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">id</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="nf">id</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">I</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When compiled with erlc -S beamexample.erl we get the following
beamexmaple.S file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">{</span><span class="n">module</span><span class="p">,</span> <span class="n">beamexample1</span><span class="p">}.</span>  <span class="c">%% version = 0
</span>
<span class="p">{</span><span class="n">exports</span><span class="p">,</span> <span class="p">[{</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">module_info</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">module_info</span><span class="p">,</span><span class="mi">1</span><span class="p">}]}.</span>

<span class="p">{</span><span class="n">attributes</span><span class="p">,</span> <span class="p">[]}.</span>

<span class="p">{</span><span class="n">labels</span><span class="p">,</span> <span class="mi">7</span><span class="p">}.</span>


<span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[{</span><span class="n">location</span><span class="p">,</span><span class="s">"beamexample1.erl"</span><span class="p">,</span><span class="mi">5</span><span class="p">}]}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">beamexample1</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">id</span><span class="p">},</span><span class="mi">1</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">test</span><span class="p">,</span><span class="nb">is_integer</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">},[{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}.</span>
    <span class="n">return</span><span class="p">.</span>


<span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">module_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">3</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[]}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">beamexample1</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">module_info</span><span class="p">},</span><span class="mi">0</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">4</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">beamexample1</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[]}.</span>
    <span class="p">{</span><span class="n">call_ext_only</span><span class="p">,</span><span class="mi">1</span><span class="p">,{</span><span class="n">extfunc</span><span class="p">,</span><span class="n">erlang</span><span class="p">,</span><span class="n">get_module_info</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>


<span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">module_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">5</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[]}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">beamexample1</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">module_info</span><span class="p">},</span><span class="mi">1</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">6</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">beamexample1</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[]}.</span>
    <span class="p">{</span><span class="n">call_ext_only</span><span class="p">,</span><span class="mi">2</span><span class="p">,{</span><span class="n">extfunc</span><span class="p">,</span><span class="n">erlang</span><span class="p">,</span><span class="n">get_module_info</span><span class="p">,</span><span class="mi">2</span><span class="p">}}.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to the actual beam code for the integer identity
function we also get some meta instructions.</p>
</div>
<div class="paragraph">
<p>The first line {module, beamexample1}. %% version = 0 tells
us the module name "beamexample1" and the version number for
the instruction set "0".</p>
</div>
<div class="paragraph">
<p>Then we get a list of exported functions "id/1, module_info/0,
module_info/1". As we can see the compiler has added two auto
generated functions to the code. These two functions are just
dispatchers to the generic module info BIFs (erlang:module_info/1 and
erlang:module_info/2) with the name of the module added as the first
argument.</p>
</div>
<div class="paragraph">
<p>The line {attributes, []} list all defined compiler attributes, none in
our case.</p>
</div>
<div class="paragraph">
<p>Then we get to know that there are less than 7 labels in the module,
{labels, 7}, which makes it easy to do code loading in one pass.</p>
</div>
<div class="paragraph">
<p>The last type of meta instruction is the function instruction on
the format {function, Name, Arity, StartLabel}. As we can see with
the id function the start label is actually the second label in the
code of the function.</p>
</div>
<div class="paragraph">
<p>The instruction {label, N} is not really an instruction, it does not
take up any space in memory when loaded. It is just to give a local
name (or number) to a position in the code. Each label potentially
marks the beginning of a basic block since it is a potential
destination of a jump.</p>
</div>
<div class="paragraph">
<p>The first two instructions following the first label ({label,1})
are actually error generating code which adds the line number and
module, function and arity information and throws an exception.
That are the instructions line and func_info.</p>
</div>
<div class="paragraph">
<p>The meat of the function is after {label,2}, the instruction
{test,is_integer,{f,1},[{x,0}]}. The test instruction tests if its
arguments (in the list at the end, that is variable {x,0} in this
case) fulfills the test, in this case is an integer (is_integer).
If the test succeeds the next instruction (return) is executed.
Otherwise the functions fails to label 1 ({f,1}), that is,
execution continues at label one where a function clause exception
is thrown.</p>
</div>
<div class="paragraph">
<p>The other two functions in the file are auto generated. If we look at
the second function the instruction {move,{x,0},{x,1}} moves the
argument in register x0 to the second argument register x1. Then the
instruction {move,{atom,beamexample1},{x,0}} moves the module name
atom to the first argument register x0. Finally a tail call is made to
erlang:get_module_info/2
({call_ext_only,2,{extfunc,erlang,get_module_info,2}}). As we will
see in the next section there are several different call instructions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_calls"><a class="link" href="#_calls">7.3. Calls</a></h3>
<div class="paragraph">
<p>As we have seen in <a href="#CH-Calls">Chapter 8</a> there are several different types
of calls in Erlang. To distinguish between local and remote calls
in the instruction set, remote calls have _ext in their instruction
names. Local calls just have a label in the code of the module, while
remote calls takes a destination of the form {extfunc, Module, Function,
Arity}.</p>
</div>
<div class="paragraph">
<p>To distinguish between ordinary (stack building) calls and
tail-recursive calls, the latter have either _only or _last in
their name. The variant with _last will also deallocate as many
stack slot as given by the last argument.</p>
</div>
<div class="paragraph">
<p>There is also a call_fun Arity instruction that calls the closure
stored in register {x, Arity}. The arguments are stored in x0 to {x,
Arity-1}.</p>
</div>
<div class="paragraph">
<p>For a full listing of all types of call instructions see
<a href="#AP-Instructions">Appendix B</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_stack_and_heap_management"><a class="link" href="#_stack_and_heap_management">7.4. Stack (and Heap) Management</a></h3>
<div class="paragraph">
<p>The stack and the heap of an Erlang process on Beam share the same memory
area see <a href="#CH-Processes">Chapter 3</a> and <a href="#CH-Memory">Chapter 12</a> for a full discussion.
The stack grows toward lower addresses and the heap toward higher addresses.
Beam will do a garbage collection if more space than what is available is
needed on either the stack or the heap.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>A leaf function</strong></dt>
<dd>
<p>A leaf function is a function which doesn&#8217;t call
any other function.</p>
</dd>
<dt class="hdlist1"><strong>A non leaf function</strong></dt>
<dd>
<p>A non leaf function is a function which may call
another function.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>On entry to a non leaf function the <em>continuation pointer</em> (CP) is saved on
the stack, and on exit it is read back from the stack. This is done by the
allocate and deallocate instructions, which are used for setting up
and tearing down the stack frame for the current instruction.</p>
</div>
<div class="paragraph">
<p>A function skeleton for a leaf function looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">Arity</span><span class="p">,</span> <span class="nv">StartLabel</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="nv">L1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="nv">Module</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="nv">Name</span><span class="p">},</span><span class="nv">Arity</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="nv">L2</span><span class="p">}.</span>
    <span class="p">...</span>
    <span class="n">return</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A function skeleton for a non leaf function looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">Arity</span><span class="p">,</span> <span class="nv">StartLabel</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="nv">L1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="nv">Module</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="nv">Name</span><span class="p">},</span><span class="nv">Arity</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="nv">L2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">allocate</span><span class="p">,</span><span class="nv">Need</span><span class="p">,</span><span class="nv">Live</span><span class="p">}.</span>

    <span class="p">...</span>
    <span class="n">call</span> <span class="p">...</span>
    <span class="p">...</span>

    <span class="p">{</span><span class="n">deallocate</span><span class="p">,</span><span class="nv">Need</span><span class="p">}.</span>
    <span class="n">return</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The instruction allocate StackNeed Live saves the continuation
pointer (CP) and allocate space for StackNeed extra words on the
stack. If a GC is needed during allocation save Live number of X
registers. E.g. if Live is 2 then registers X0 and X1 are saved.</p>
</div>
<div class="paragraph">
<p>When allocating on the stack, the stack pointer (E) is decreased.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-ed26d9c6608593ca5cd641598288a41f.png" alt="diag ed26d9c6608593ca5cd641598288a41f" width="560" height="168">
</div>
<div class="title">Figure 22. Allocate 1 0</div>
</div>
<div class="paragraph">
<p>For a full listing of all types of allocate and deallocate
instructions see <a href="#AP-Instructions">Appendix B</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_message_passing"><a class="link" href="#_message_passing">7.5. Message Passing</a></h3>
<div class="paragraph">
<p>Sending a message is straight forward in beam code. You just use the
send instruction. Note though that the send instruction does not
take any arguments, it is more like a function call. It assumes that
the arguments (the destination and the message) are in the argument
registers X0 and X1. The message is also copied from X1 to X0.</p>
</div>
<div class="paragraph">
<p>Receiving a message  is a bit more complicated since  it involves both
selective receive with pattern  matching and introduces a yield/resume
point within  a function  body. (There  is also  a special  feature to
minimize message queue scanning using refs, more on that later.)</p>
</div>
<div class="sect3">
<h4 id="_a_minimal_receive_loop"><a class="link" href="#_a_minimal_receive_loop">7.5.1. A Minimal Receive Loop</a></h4>
<div class="paragraph">
<p>A minimal receive loop, which accepts any message and has no timeout
(e.g. receive _ -&gt; ok end) looks like this in BEAM code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang">  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">wait</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">loop_rec</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">2</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="n">remove_message</span><span class="p">.</span>
    <span class="p">{</span><span class="n">jump</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">wait</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">3</span><span class="p">}.</span>
     <span class="p">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The loop_rec L2 x0 instruction first checks if there is any message
in the message queue. If there are no messages execution jumps to L2,
where the process will be suspended waiting for a message to arrive.</p>
</div>
<div class="paragraph">
<p>If there is a message in the message queue the loop_rec instruction
also moves the message from the <em>m-buf</em> to the process heap. See
<a href="#CH-Memory">Chapter 12</a> and <a href="#CH-Processes">Chapter 3</a> for details of the m-buf
handling.</p>
</div>
<div class="paragraph">
<p>For code like receive _ -&gt; ok end, where we accept any messages,
there is no pattern matching needed, we just do a remove_message
which unlinks the next message from the message queue. (It also
removes any timeout, more on this soon.)</p>
</div>
</div>
<div class="sect3">
<h4 id="_a_selective_receive_loop"><a class="link" href="#_a_selective_receive_loop">7.5.2. A Selective Receive Loop</a></h4>
<div class="paragraph">
<p>For a selective receive like e.g. receive [] -&gt; ok end we will
loop over the message queue to check if any message in the queue
matches.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang">  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">loop_rec</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">test</span><span class="p">,</span><span class="n">is_nil</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">2</span><span class="p">},[{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}.</span>
    <span class="n">remove_message</span><span class="p">.</span>
    <span class="p">{</span><span class="n">jump</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">4</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">loop_rec_end</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">3</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">wait</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">4</span><span class="p">}.</span>
    <span class="p">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case we do a pattern match for Nil after the loop_rec
instruction if there was a message in the mailbox. If the message
doesn&#8217;t match we end up at L3 where the instruction loop_rec_end
advances the save pointer to the next message (p-&gt;msg.save =
&amp;(*p-&gt;msg.save)-&gt;next) and jumps back to L2.</p>
</div>
<div class="paragraph">
<p>If there are no more messages in the message queue the process is
suspended by the wait instruction at L4 with the save pointer pointing
to the end of the message queue. When the processes is rescheduled
it will only look at new messages in the message queue (after the save
point).</p>
</div>
</div>
<div class="sect3">
<h4 id="_a_receive_loop_with_a_timeout"><a class="link" href="#_a_receive_loop_with_a_timeout">7.5.3. A Receive Loop With a Timeout</a></h4>
<div class="paragraph">
<p>If we add a timeout to our selective receive the wait instruction is
replaced by a wait_timeout instruction followed by a timeout
instruction and the code following the timeout.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang">  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">loop_rec</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">test</span><span class="p">,</span><span class="n">is_nil</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">2</span><span class="p">},[{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}.</span>
    <span class="n">remove_message</span><span class="p">.</span>
    <span class="p">{</span><span class="n">jump</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">4</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">loop_rec_end</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">3</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">wait_timeout</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">integer</span><span class="p">,</span><span class="mi">1000</span><span class="p">}}.</span>
    <span class="n">timeout</span><span class="p">.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">4</span><span class="p">}.</span>
    <span class="p">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The wait_timeout instructions sets up a timeout timer with the given
time (1000 ms in our example) and it also saves the address of the
next instruction (the timeout) in p-&gt;def_arg_reg[0] and then
when the timer is set,  p-&gt;i is set to point to def_arg_reg.</p>
</div>
<div class="paragraph">
<p>This means that if no matching message arrives while the process is
suspended a timeout will be triggered after 1 second and execution for
the process will continue at the timeout instruction.</p>
</div>
<div class="paragraph">
<p>Note that if a message that doesn&#8217;t match arrives in the mailbox, the
process is scheduled for execution and will run the pattern matching
code in the receive loop, but the timeout will not be canceled. It is
the remove_message code which also removes any timeout timer.</p>
</div>
<div class="paragraph">
<p>The timeout instruction resets the save point of the mailbox to the
first element in the queue, and clears the timeout flag (F_TIMO) from
the PCB.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_synchronous_call_trick_aka_the_ref_trick"><a class="link" href="#_the_synchronous_call_trick_aka_the_ref_trick">7.5.4. The Synchronous Call Trick (aka The Ref Trick)</a></h4>
<div class="paragraph">
<p>We have now come to the last version of our receive loop, where we
use the ref trick alluded to earlier to avoid a long message box scan.</p>
</div>
<div class="paragraph">
<p>A common pattern in Erlang code is to implement a type of "remote
call" with send and a receive between two processes. This is for
example used by gen_server. This code is often hidden behind a library
of ordinary function calls. E.g., you call the function
counter:increment(Counter) and behind the scene this turns into
something like Counter ! {self(), inc}, receive {Counter, Count} -&gt;
Count end.</p>
</div>
<div class="paragraph">
<p>This is usually a nice abstraction to encapsulate state in a
process. There is a slight problem though when the mailbox of the
calling process has many messages in it. In this case the receive will
have to check each message in the mailbox to find out that no message
except the last matches the return message.</p>
</div>
<div class="paragraph">
<p>This can quite often happen if you have a server that receives many
messages and for each message does a number of such remote calls, if
there is no back throttle in place the servers message queue will
fill up.</p>
</div>
<div class="paragraph">
<p>To remedy this there is a hack in ERTS to recognize this pattern and
avoid scanning the whole message queue for the return message.</p>
</div>
<div class="paragraph">
<p>The compiler recognizes code that uses a newly created reference (ref)
in a receive (see <a href="#ref_trick_code">[ref_trick_code]</a>), and emits code to avoid the
long inbox scan since the new ref can not already be in the inbox.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang">  <span class="nv">Ref</span> <span class="o">=</span> <span class="nf">make_ref</span><span class="p">(),</span>
  <span class="nv">Counter</span> <span class="o">!</span> <span class="p">{</span><span class="nf">self</span><span class="p">(),</span> <span class="n">inc</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">},</span>
  <span class="k">receive</span>
    <span class="p">{</span><span class="nv">Ref</span><span class="p">,</span> <span class="nv">Count</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nv">Count</span>
  <span class="k">end</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This gives us the following skeleton for a complete receive, see
<a href="#ref_receive">[ref_receive]</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang">    <span class="p">{</span><span class="n">recv_mark</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">call_ext</span><span class="p">,</span><span class="mi">0</span><span class="p">,{</span><span class="n">extfunc</span><span class="p">,</span><span class="n">erlang</span><span class="p">,</span><span class="n">make_ref</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">...</span>
    <span class="nb">send</span><span class="p">.</span>
    <span class="p">{</span><span class="n">recv_set</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">3</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">loop_rec</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">5</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">test</span><span class="p">,</span><span class="nb">is_tuple</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">4</span><span class="p">},[{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}.</span>
    <span class="p">...</span>
    <span class="p">{</span><span class="n">test</span><span class="p">,</span><span class="n">is_eq_exact</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">4</span><span class="p">},[{</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">y</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}.</span>
    <span class="p">...</span>
    <span class="n">remove_message</span><span class="p">.</span>
    <span class="p">...</span>
    <span class="p">{</span><span class="n">jump</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">6</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">4</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">loop_rec_end</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">5</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">wait</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">6</span><span class="p">}.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The recv_mark instruction saves the current position (the end
msg.last) in msg.saved_last and the address of the label
in msg.mark</p>
</div>
<div class="paragraph">
<p>The recv_set instruction checks that msg.mark points to the next
instruction and in that case moves the save point (msg.save) to the
last message received before the creation of the ref
(msg.saved_last). If the mark is invalid ( i.e. not equal to
msg.save) the instruction does nothing.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Calls"><a class="link" href="#CH-Calls">8. Different Types of Calls, Linking and Hot Code Loading (5p)</a></h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Local calls, remote calls, closure calls, tuple calls, p-mod
calls. The code server. Linking. Hot code loading, purging. (Overlap
with Chapter 4, have to see what goes where.) Higher order functions,
Implementation of higher order functions. Higher order functions and
hot code loading. Higher order functions in a distributed system.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hot_code_loading"><a class="link" href="#_hot_code_loading">8.1. Hot Code Loading</a></h3>
<div class="paragraph">
<p>In Erlang there is a semantic difference between a local function call
and a remote function call. A remote call, that is a call to a
function in a named module, is guaranteed to go to the latest loaded
version of that module. A local call, an unqualified call to a function
within the same module, is guaranteed to go to the same version
of the code as the caller.</p>
</div>
<div class="paragraph">
<p>A call to a local function can be turned into a remote call by
specifying the module name at the call site. This is usually
done with the ?MODULE macro as in ?MODULE:foo().
A remote call to a non local module can not be turned into
a local call, i.e. there is no way to guarantee the version
of the callee in the caller.</p>
</div>
<div class="paragraph">
<p>This is an important feature of Erlang which makes <em>hot code loading</em>
or <em>hot upgrades</em> possible. Just make sure you have a remote
call somewhere in your server loop and you can then load new code
into the system while it is running; when execution reaches the
remote call it will switch to executing the new code.</p>
</div>
<div class="paragraph">
<p>A common way of writing server loops is to have a local call
for the main loop and a code upgrade handler which does
a remote call and possibly a state upgrade:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">loop</span><span class="p">(</span><span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">receive</span>
    <span class="n">upgrade</span> <span class="o">-&gt;</span>
       <span class="nv">NewState</span> <span class="o">=</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">:</span><span class="nf">code_upgrade</span><span class="p">(</span><span class="nv">State</span><span class="p">),</span>
       <span class="o">?</span><span class="nv">MODULE</span><span class="p">:</span><span class="nf">loop</span><span class="p">(</span><span class="nv">NewState</span><span class="p">);</span>
     <span class="nv">Msg</span> <span class="o">-&gt;</span>
       <span class="nv">NewState</span> <span class="o">=</span> <span class="nf">handle_msg</span><span class="p">(</span><span class="nv">Msg</span><span class="p">,</span> <span class="nv">State</span><span class="p">),</span>
       <span class="nf">loop</span><span class="p">(</span><span class="nv">NewState</span><span class="p">)</span>
   <span class="k">end</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With this construct, which is basically what <code>gen_server</code> uses,
the programmer has control over when and how a code upgrade is done.</p>
</div>
<div class="paragraph">
<p>The hot code upgrade is one of the most important features of Erlang
which makes it possible to write servers that operates 24/7 year out
and year in. It is also one of the main reasons why Erlang is
dynamically typed. It is very hard in a statically typed language to
give type for the <code>code_upgrade</code> function. (It is also hard to give the
type of the loop function). These types will change in the future as
the type of State changes to handle new features.</p>
</div>
<div class="paragraph">
<p>For a language implementer concerned with performance, the hot code
loading functionality is a burden though. Since each call to or from a
remote module can change to new code in the future it is very hard to
do whole program optimization across module boundaries. (Hard but not
impossible, there are solutions but so far I have not seen one fully
implemented).</p>
</div>
</div>
<div class="sect2">
<h3 id="_code_loading"><a class="link" href="#_code_loading">8.2. Code Loading</a></h3>
<!--
Shouldn't Code Loading come before Hot Code Loading? Or are the two topics not related in that way? - bmacdonald
-->
<div class="paragraph">
<p>In the Erlang Runtime System the code loading is handled by the
code server. The code server will call the lower level BIFs in the
erlang module for the actual loading. But the code server also
determines the purging policy.</p>
</div>
<div class="paragraph">
<p>The runtime system can keep two versions of each module, a <em>current</em>
version and an <em>old</em> version. All fully qualified (remote) calls go
to the current version. Local calls in the old version and return
addresses on the stack can still go to the old version.</p>
</div>
<div class="paragraph">
<p>If a third version of a module is loaded and there are still processes
running (have pointers on the stack to) the code server
will kill those processes and purge the old code. Then the current
version will become old and the third version will be loaded as the
current version.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Beam_loader"><a class="link" href="#CH-Beam_loader">9. The BEAM Loader</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_transforming_from_generic_to_specific_instructions"><a class="link" href="#_transforming_from_generic_to_specific_instructions">9.1. Transforming from Generic to Specific instructions</a></h3>
<div class="paragraph">
<p>The BEAM loader does not just take the external beam format and writes
it to memory. It also does a number of transformations on the code
and translates from the external (generic) format to the internal
(specific) format.</p>
</div>
<div class="paragraph">
<p>The code for the loader can be found in beam_load.c (in
erts/emulator/beam) but most of the logic for the translations are in
the file ops.tab (in the same directory).</p>
</div>
<div class="paragraph">
<p>The first step of the loader is to parse beam file, basically the same
work as we did in Erlang in <a href="#CH-beam_modules">Chapter 6</a> but written in C.</p>
</div>
<div class="paragraph">
<p>Then the rules in ops.tab are applied to instructions in the code
chunk to translate the generic instruction to one or more specific
instructions.</p>
</div>
<div class="paragraph">
<p>The translation table works through pattern matching. Each line in the
file defines a pattern of one or more generic instructions with
arguments and optionally an arrow followed by one or more instructions
to translate to.</p>
</div>
<div class="paragraph">
<p>The transformations in ops tab tries to handle patterns of
instructions generated by the compiler and peephole optimize them to
fewer specific instructions. The ops tab transformations tries to
generate jump tables for patterns of selects.</p>
</div>
<div class="paragraph">
<p>The file ops.tab is not parsed at runtime, instead a pattern matching
program is generated from ops.tab and stored in an array in a
generated C file. The perl script beam_makeops (in
erts/emulator/utils) generates a target specific set of opcodes and
translation programs in the files beam_opcodes.h and
beam_opcodes.c (these files end up in the given target directory
e.g. erts/emulator/x86_64-unknown-linux-gnu/opt/smp/).</p>
</div>
<div class="paragraph">
<p>The same program (beam_makeops) also generates the Erlang code for the
compiler back end beam_opcodes.erl.</p>
</div>
</div>
<div class="sect2">
<h3 id="_understanding_ops_tab"><a class="link" href="#_understanding_ops_tab">9.2. Understanding ops.tab</a></h3>
<div class="paragraph">
<p>The transformations in
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/ops.tab"><code>ops.tab</code></a>
are executed in the order that they are written in the file. So just like in
Erlang pattern matching, the different rules are triggered from top to bottom.</p>
</div>
<div class="paragraph">
<p>The types that <code>ops.tab</code> uses for arguments in instructions can be found in
<a href="#AP-Instructions">Appendix B</a>.</p>
</div>
<div class="sect3">
<h4 id="_transformations"><a class="link" href="#_transformations">9.2.1. Transformations</a></h4>
<div class="paragraph">
<p>Most of the rules in <code>ops.tab</code> are transformations between different
instructions. A simple transformation looks like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>move S x==0 | return =&gt; move_return S</pre>
</div>
</div>
<div class="paragraph">
<p>This combines a <code>move</code> from any location to <code>x(0)</code> and return into a single
instruction called <code>move_return</code>. Let&#8217;s break the tranformation apart to
see what the different parts do.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">move</dt>
<dd>
<p>is the instruction that the pattern first has to match. This can be either
a generic instruction that the compiler has emitted, or a temporary instruction
that <code>ops.tab</code> has emitted to help with transformations.</p>
</dd>
<dt class="hdlist1">S</dt>
<dd>
<p>is a variable binding any type of value. Any value in the pattern (left hand side or <code>&#8658;</code>)
that is used in the generator (right hand side of <code>&#8658;</code>) has to be bound to a variable.</p>
</dd>
<dt class="hdlist1">x==0</dt>
<dd>
<p>is a guard that says that we only apply the transformation if the target
location is an <code>x</code> register with the value <code>0</code>. It is possible to chain multiple
types and also bind a variable here. For instance <code>D=xy==0</code> would allow both
<code>x</code> and <code>y</code> registers with a value of <code>0</code> and also bind the argument to the variable <code>D</code>.</p>
</dd>
<dt class="hdlist1">|</dt>
<dd>
<p>signifies the end of this instruction and the beginning of another instruction
that is part of the same pattern.</p>
</dd>
<dt class="hdlist1">return</dt>
<dd>
<p>is the second instruction to match in this pattern.</p>
</dd>
<dt class="hdlist1"><code>&#8658;</code></dt>
<dd>
<p>signifies the end of the pattern and the start of the code that is to be
generated.</p>
</dd>
<dt class="hdlist1">move_return S</dt>
<dd>
<p>is the name of the generated instruction together with the name of
the variable on the lhs. It is possible to generate
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/ops.tab#L625">multiple instructions</a>
as part of a transformation by using the <code>|</code> symbol.</p>
</dd>
</dl>
</div>
<div id="complex_example" class="paragraph">
<div class="title">A more complex example</div>
<p>More complex translations can be done in <code>ops.tab</code>. For instance take the
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/ops.tab#L127-L182"><code>select_val</code></a>
instruction. It will be translated by the loader into either a jump table, a linear
search array or a binary search array depending on the input values.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>is_integer Fail=f S | select_val S=s Fail=f Size=u Rest=* | \
  use_jump_tab(Size, Rest) =&gt; gen_jump_tab(S, Fail, Size, Rest)</pre>
</div>
</div>
<div class="paragraph">
<p>The above transformation creates a jump table if possible of the <code>select_val</code>.
There are a bunch of new techniques used in the transformations.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">S</dt>
<dd>
<p>is used in both <code>is_integer</code> and <code>select_val</code>. This means that both the
values have to be of the same type and have the same value. Furthermore the <code>S=s</code> guard
limits the type to a be a source register.</p>
</dd>
<dt class="hdlist1">Rest=*</dt>
<dd>
<p>allows a variable number of arguments in the instruction and binds them to
variable <code>Rest</code>.</p>
</dd>
<dt class="hdlist1">use_jump_tab(Size, Rest)</dt>
<dd>
<p>calls the
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/beam_load.c#L2707">use_jump_tab</a>
C function in <code>beam_load.c</code> that decides whether the arguments in the <code>select_val</code>
can be transformed into a jump table.</p>
</dd>
<dt class="hdlist1">\</dt>
<dd>
<p>signifies that the transformation rule continues on the next line.</p>
</dd>
<dt class="hdlist1">gen_jump_tab(S, Fail, Size, Rest)</dt>
<dd>
<p>calls the
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/beam_load.c#L3692">gen_jump_tab</a>
C function in <code>beam_load.c</code> that takes care of generating the appropriate instruction.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_specific_instruction"><a class="link" href="#_specific_instruction">9.2.2. Specific instruction</a></h4>
<div class="paragraph">
<p>When all transformations are done, we have to decide how the specifc instruction should
look like. Let&#8217;s continue to look at <code>move_return</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>%macro: move_return MoveReturn -nonext
move_return x
move_return c
move_return n</pre>
</div>
</div>
<div class="paragraph">
<p>This will generate three different instructions that will use the
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/beam_emu.c#L636"><code>MoveReturn</code></a>
macro in <code>beam_emu.c</code> to do the work.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">%macro: move_return</dt>
<dd>
<p>this tells <code>ops.tab</code> to generate the code for <code>move_return</code>. If there
is no <code>%macro</code> line, the instruction has to be implemented by hand in beam_emu.c. The code
for the instruction will be places in <code>beam_hot.h</code> or <code>beam_cold.h</code> depending on if the
<code>%hot</code> or <code>%cold</code> directive is active.</p>
</dd>
<dt class="hdlist1">MoveReturn</dt>
<dd>
<p>tells the code generator to that the name of the c-macro in beam_emu.c to use
is MoveReturn. This macro has to be implemented manually.</p>
</dd>
<dt class="hdlist1">-nonext</dt>
<dd>
<p>tells the code generator that it should not generate a dispatch to the next
instruction, the <code>MoveReturn</code> macro will take care of that.</p>
</dd>
<dt class="hdlist1">move_return x</dt>
<dd>
<p>tells the code generator to generate a specific instruction for when the
instruction argument is an x register. <code>c</code> for when it is a constant, <code>n</code> when it is <code>NIL</code>.
No instructions are in this case generated for when the argument is a y register as the
compiler will never generate such code.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The resulting code in <code>beam_hot.h</code> will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">OpCase(move_return_c):
    {
    MoveReturn(Arg(0));
    }

OpCase(move_return_n):
    {
    MoveReturn(NIL);
    }

OpCase(move_return_x):
    {
    MoveReturn(xb(Arg(0)));
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>All the implementor has to do is to define the <code>MoveReturn</code> macro in <code>beam_emu.c</code> and
the instruction is complete.</p>
</div>
<div id="macro_arguments" class="paragraph">
<div class="title">Macro flags</div>
<p>The <code>%macro</code> rules can take multiple different flags to modify the code that
gets generated.</p>
</div>
<div class="paragraph">
<p>The examples below assume that there is a specific instructions looking like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>%macro move_call MoveCall
move_call x f</pre>
</div>
</div>
<div class="paragraph">
<p>without any flags to the <code>%macro</code> we the following code will be generated:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">BeamInstr* next;
PreFetch(2, next);
MoveCall(Arg(0));
NextPF(2, next);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/beam_emu.c#L519-L523">PreFetch and NextPF</a>
macros make sure to load the address to jump to next before the instruction is executed.
This trick increases performance on all architectures by a variying amount depending on
cache architecture and super scalar properties of the CPU.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-nonext</dt>
<dd>
<p>Don&#8217;t emit a dispatch for this instructions. This is used for instructions
that are known to not continue with the next instructions, i.e. return, call, jump.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><code>%macro move_call MoveCall -nonext</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">MoveCall(xb(Arg(0)));</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-arg_*</dt>
<dd>
<p>Include the arguments of type * as arguments to the c-macro. Not all argument
types are included by default in the c-macro. For instance the type <code>f</code> used for fail
labels and local function calls is not included. So giving the option <code>-arg_f</code> will
include that as an argument to the c-macro.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><code>%macro move_call MoveCall -arg_f</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">MoveCall(xb(Arg(0)), Arg(1));</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-size</dt>
<dd>
<p>Include the size of the instruction as an argument to the c-macro.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><code>%macro move_call MoveCall -size</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">MoveCall(xb(Arg(0)), 2);</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-pack</dt>
<dd>
<p>Pack any arguments if possible. This places multiple register arguments in
the same word if possible. As register arguments can only be 0-1024, we only need
10 bits to store them + 2 for tagging. So on a 32-bit system we can put 2 registers
in one word, while on a 64-bit we can put 4 registers in one word. Packing instruction
can greatly decrease the memory used for a single instruction. However there is
also a small cost to unpack the instruction, which is why it is not enabled
for all instructions.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The example with the call cannot do any packing as <code>f</code> cannot be packed and only one
other argument exists. So let&#8217;s look at the
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/ops.tab#L539">put_list</a>
instruction as an example instead.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>%macro:put_list PutList -pack
put_list x x x</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">BeamInstr tmp_packed1;
BeamInstr* next;
PreFetch(1, next);
tmp_packed1 = Arg(0);
PutList(xb(tmp_packed1&amp;BEAM_TIGHT_MASK),
        xb((tmp_packed1&gt;&gt;BEAM_TIGHT_SHIFT)&amp;BEAM_TIGHT_MASK),
        xb((tmp_packed1&gt;&gt;(2*BEAM_TIGHT_SHIFT))));
NextPF(1, next);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This packs the 3 arguments into 1 machine word, which halves the required memory
for this instruction.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-fail_action</dt>
<dd>
<p>Include a fail action as an argument to the c-macro. Note that the
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/beam_emu.c#L2996-L2998"><code>ClauseFail()</code></a>
macro assumes the fail label is in the first argument of the instructions,
so in order to use this in the above example we should transform
the <code>move_call x f</code> to <code>move_call f x</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><code>%macro move_call MoveCall -fail_action</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">MoveCall(xb(Arg(0)), ClauseFail());</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-gen_dest</dt>
<dd>
<p>Include a
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/beam_emu.c#L166-L174">store function</a>
as an argument to the c-macro.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><code>%macro move_call MoveCall -gen_dest</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">MoveCall(xb(Arg(0)), StoreSimpleDest);</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-goto</dt>
<dd>
<p>Replace the normal next dispatch with a jump to a c-label inside beam_emu.c</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><code>%macro move_call MoveCall -goto:do_call</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">MoveCall(xb(Arg(0)));
goto do_call;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_optimizations"><a class="link" href="#_optimizations">9.3. Optimizations</a></h3>
<div class="paragraph">
<p>The loader performs many peephole optimizations when loading the code. The most important
ones are instruction combining and instruction specialization.</p>
</div>
<div class="paragraph">
<p>Instruction combining is the joining of two or more smaller instructions into one larger
instruction. This can lead to a large speed up of the code if the instructions are known
to follow each other most of the time. The speed up is achieved because there is no longer
any need to do a dispatch inbetween the instructions, and also the C compiler gets more
information to work with when it is optimizing that instruction. When to do instruction
combining is a trade-off where one has to consider the impact the increased size of the
main emulator loop has vs the gain when the instruction is executed.</p>
</div>
<div class="paragraph">
<p>Instruction specialization removes the need to decode the arguments in an instruction.
So instead of having one <code>move_sd</code> instruction, <code>move_xx</code>, <code>move_xy</code> etc are generated
with the arguments already decoded. This reduces the decode cost of the instructions,
but again it is a tradeoff vs emulator code size.</p>
</div>
<div class="sect3">
<h4 id="_select_val_optimizations"><a class="link" href="#_select_val_optimizations">9.3.1. select_val optimizations</a></h4>
<div class="paragraph">
<p>The <code>select_val</code> instruction is emitted by the compiler to do control flow handling
of many functions or case clauses. For instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">select</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">3</span><span class="p">;</span>
<span class="nf">select</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">3</span><span class="p">;</span>
<span class="nf">select</span><span class="p">(_)</span> <span class="o">-&gt;</span> <span class="n">error</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>compiles to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[{</span><span class="n">location</span><span class="p">,</span><span class="s">"select.erl"</span><span class="p">,</span><span class="mi">5</span><span class="p">}]}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">select</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">select</span><span class="p">},</span><span class="mi">1</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">test</span><span class="p">,</span><span class="nb">is_integer</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">4</span><span class="p">},[{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}.</span>
    <span class="p">{</span><span class="n">select_val</span><span class="p">,{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">f</span><span class="p">,</span><span class="mi">4</span><span class="p">},{</span><span class="n">list</span><span class="p">,[{</span><span class="n">integer</span><span class="p">,</span><span class="mi">2</span><span class="p">},{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">},{</span><span class="n">integer</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">}]}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">3</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">integer</span><span class="p">,</span><span class="mi">3</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="n">return</span><span class="p">.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">4</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">error</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="n">return</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The values in the condition are only allowed to be either integers
or atoms. If the value is of any other type the compiler will not emit a
<code>select_val</code> instruction. The loader uses a couple of hearistics to figure
out what type algorithm to use when doing the <code>select_val</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">jump_on_val</dt>
<dd>
<p>Create a jump table and use the value as the index. This if very
efficient and happens when a group of close together integers are used as the
value to select on. If not all values are present, the jump table is padded with
extra fail label slots.</p>
</dd>
<dt class="hdlist1">select_val2</dt>
<dd>
<p>Used when only two values are to be selected upon and they to not
fit in a jump table.</p>
</dd>
<dt class="hdlist1">select_val_lins</dt>
<dd>
<p>Do a linear search of the sorted atoms or integers. This is
used when a small amount of atoms or integers are to be selected from.</p>
</dd>
<dt class="hdlist1">select_val_bins</dt>
<dd>
<p>Do a binary search of the sorted atoms or integers.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_pre_hashing_of_literals"><a class="link" href="#_pre_hashing_of_literals">9.3.2. pre-hashing of literals</a></h4>
<div class="paragraph">
<p>When a literal is loaded and used as an argument to any of the bifs or instructions
that need a hashed value of the literal, instead of hashing the literal value
every time, the hash is created by the loader and used by the instructions.</p>
</div>
<div class="paragraph">
<p>Examples of code using this technique is maps instructions and also the process
dictionary bifs.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Internal_instructions"><a class="link" href="#CH-Internal_instructions">10. BEAM Internal Instructions</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="CH-Scheduling"><a class="link" href="#CH-Scheduling">11. Scheduling</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To fully understand where time in an ERTS system is spent you need
to understand how the system decides which Erlang code to run
and when to run it. These decisions are made by the Scheduler.</p>
</div>
<div class="paragraph">
<p>The scheduler is responsible for the real-time guarantees of the
system. In a strict Computer Science definition of the word
real-time, a real-time system has to be able to guarantee a response
within a specified time. That is, there are real deadlines
and each task has to complete before its deadline. In Erlang there are
no such guarantees, a <em>timeout</em> in Erlang is only guaranteed to <strong>not</strong>
trigger <strong>before</strong> the given deadline.</p>
</div>
<div class="paragraph">
<p>In a general system like Erlang where we want to be able to handle all
sorts of programs and loads, the scheduler will have to make some
compromises. There will always be corner cases where a generic
scheduler will behave badly. After reading this chapter
you will have a deeper understanding of how
the Erlang scheduler works and especially when it might not work
optimally. You should be able to design your system to avoid the corner
cases and you should also be able to analyze a misbehaving system.</p>
</div>
<div class="sect2">
<h3 id="_concurrency_parallelism_and_preemptive_multitasking"><a class="link" href="#_concurrency_parallelism_and_preemptive_multitasking">11.1. Concurrency, Parallelism, and Preemptive Multitasking</a></h3>
<div class="paragraph">
<p>Erlang is a concurrent language. When we say that processes run
concurrently we mean that for an outside observer it looks like two
processes are executing at the same time. In a single core system this
is achieved by preemptive multitasking. This means that one process
will run for a while, and then the scheduler of the virtual machine
will suspend it and let another process run.</p>
</div>
<div class="paragraph">
<p>In a multicore or a distributed system we can achieve true
parallelism, that is, two or more processes actually executing at the
exact same time. In an SMP enabled emulator the system uses several
OS threads to indirectly execute Erlang processes by running one
scheduler and emulator per thread. In a system using the default
settings for ERTS there will be one thread per enabled core (physical
or hyper threaded).</p>
</div>
<div class="paragraph">
<p>We can check that we have a system capable of parallel execution,
by checking if SMP support is enabled:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>iex(1)&gt; :erlang.system_info :smp_support
true</pre>
</div>
</div>
<div class="paragraph">
<p>We can also check how many schedulers we have running in the
system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>iex(2)&gt; :erlang.system_info :schedulers_online
4</pre>
</div>
</div>
<div class="paragraph">
<p>We can see this information in the Observer as shown
in the figure below.</p>
</div>
<div class="paragraph">
<p>If we spawn more processes than schedulers we have and
let them do some busy work we can see that there are a number
of processes <em>running</em> in parallel and some processes that
are <em>runnable</em> but not currently running. We can see this
with the function <code>erlang:process_info/2</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1&gt; Loop = fun (0, _) -&gt; ok; (N, F) -&gt; F(N-1, F) end,
   BusyFun = fun() -&gt; spawn(fun () -&gt; Loop(1000000, Loop) end) end,
   SpawnThem = fun(N) -&gt; [ BusyFun() || _ &lt;- lists:seq(1, N)] end,
   GetStatus = fun() -&gt; lists:sort([{erlang:process_info(P, [status]), P}
                        || P &lt;- erlang:processes()]) end,
   RunThem = fun (N) -&gt; SpawnThem(N), GetStatus() end,
   RunThem(8).

[{[{status,garbage_collecting}],&lt;0.62.0&gt;},
 {[{status,garbage_collecting}],&lt;0.66.0&gt;},
 {[{status,runnable}],&lt;0.60.0&gt;},
 {[{status,runnable}],&lt;0.61.0&gt;},
 {[{status,runnable}],&lt;0.63.0&gt;},
 {[{status,runnable}],&lt;0.65.0&gt;},
 {[{status,runnable}],&lt;0.67.0&gt;},
 {[{status,running}],&lt;0.58.0&gt;},
 {[{status,running}],&lt;0.64.0&gt;},
 {[{status,waiting}],&lt;0.0.0&gt;},
 {[{status,waiting}],&lt;0.1.0&gt;},

...</pre>
</div>
</div>
<div class="paragraph">
<p>We will look closer at the different statuses that a process
can have later in this chapter, but for now all we need
to know is that a process that is <em>running</em> or <em>garbage_collecting</em>
is actually running in on a scheduler.
Since the machine in the example has four cores and four schedulers
there are four process running in parallel (the shell process and
three of the <em>busy processes</em>). There are also five busy processes
waiting to run in the state <em>runnable</em>.</p>
</div>
<div class="paragraph">
<p>By using the <em>Load Charts</em> tab in the Observer we can see that all
four schedulers are fully loaded while the busy processes execute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>observer:start().
ok
3&gt; RunThem(8).</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/observer_load.jpg" alt="Observer">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_preemptive_multitasking_in_erts_cooperating_in_c"><a class="link" href="#_preemptive_multitasking_in_erts_cooperating_in_c">11.2. Preemptive Multitasking in ERTS Cooperating in C</a></h3>
<div class="paragraph">
<p>The preemptive multitasking on the Erlang level is achieved by
cooperative multitasking on the C level. The Erlang language, the
compiler and the virtual machine works together to ensure that the
execution of an Erlang process will yield within a limited time and
let the next process run. The technique used to measure and limit the
allowed execution time is called reduction counting, we will look at
all the details of reduction counting soon.</p>
</div>
</div>
<div class="sect2">
<h3 id="_reductions"><a class="link" href="#_reductions">11.3. Reductions</a></h3>
<div class="paragraph">
<p>One can describe the scheduling in BEAM as preemptive scheduling on top
of cooperative scheduling.
A process can only be suspended at certain
points of the execution, such as at a receive or a function call. In
that way the scheduling is cooperative---a process has to execute code
which allows for suspension. The nature of Erlang code makes it
almost impossible for a process to run for a long time without doing a
function call. There are a few Built In Functions (BIFs) that still
can take too long without yielding. Also, if you call C code in a
badly implemented Native Implemented Function (NIF) you might block
one scheduler for a long time.
We will look at how to write well behaved NIFs in <a href="#CH-C">Chapter 16</a>.</p>
</div>
<div class="paragraph">
<p>Since there are no other loop constructs than recursion and
list comprehensions,
there is no way to loop forever without doing a function call.
Each function call is counted as a <code>reduction</code>; when the reduction
limit for the process is reached it is suspended.</p>
</div>
<div class="admonitionblock version">
<table>
<tr>
<td class="icon">
<i class="fa icon-version" title=""></i>
</td>
<td class="content">
<div class="title">Version Info</div>
<div class="paragraph">
<p>Prior to OTP-20.0, the value of <code>CONTEXT_REDS</code> was 2000.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Reductions</div>
<div class="paragraph">
<p>The term reduction comes from the Prolog ancestry of Erlang.
In Prolog each execution step is a goal-reduction, where each
step reduces a logic problem into its constituent parts, and
then tries to solve each part.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_how_many_reductions_will_you_get"><a class="link" href="#_how_many_reductions_will_you_get">11.3.1. How Many Reductions Will You Get?</a></h4>
<div class="paragraph">
<p>When a process is scheduled it will get a number of reductions defined
by <code>CONTEXT_REDS</code> (defined in
<a href="https://github.com/erlang/otp/blob/OTP-20.0/erts/emulator/beam/erl_vm.h">erl_vm.h</a>,
currently as 4000). After using up its reductions or when doing a
receive without a matching message in the inbox, the process will be
suspended and a new processes will be scheduled.</p>
</div>
<div class="paragraph">
<p>If the VM has executed as many reductions as defined by
<code>INPUT_REDUCTIONS</code> (currently <code>2*CONTEXT_REDS</code>, also defined in
erl_vm.h) or if there is no process ready to run
the scheduler will do system-level activities. That is, basically,
check for IO; we will cover the details soon.</p>
</div>
</div>
<div class="sect3">
<h4 id="_what_is_a_reduction_really"><a class="link" href="#_what_is_a_reduction_really">11.3.2. What is a Reduction Really?</a></h4>
<div class="paragraph">
<p>It is not completely defined what a reduction is, but at least each
function call should be counted as a reduction. Things get a bit more
complicated when talking about BIFs and NIFs. A process should not be
able to run for "a long time" without using a reduction and yielding.
A function written in C can not yield in the middle, it has to make
sure it is in a clean state and return. In order to be re-entrant it
has to save its internal state somehow before it returns and then set
up the state again on re-entry. This can be very costly, especially
for a function that sometimes only does little work and sometimes lot.
The reason for writing a function in C instead of Erlang is usually to
achieve performance and to not do unnecessary book keeping work.
Since there is no clear definition of what one reduction is, other
than a function call on the Erlang level, there is a risk that a
function implemented in C takes many more clock cycles per reduction
than a normal Erlang function. This can lead to an imbalance in
the scheduler, and even starvation.</p>
</div>
<div class="paragraph">
<p>For example in Erlang versions prior to R16, the BIFs
<code>binary_to_term/1</code> and <code>term_to_binary/1</code> were non yielding and only
counted as one reduction. This meant that a process calling these
functions on large terms could starve other processes. This can even
happen in a SMP system because of the way processes are balanced
between schedulers, which we will get to soon.</p>
</div>
<div class="paragraph">
<p>While a process is running the emulator keeps the number of reductions
left to execute in the (register mapped) variable <code>FCALLS</code> (see
beam_emu.c).</p>
</div>
<div class="paragraph">
<p>We can examine this value with <code>hipe_bifs:show_pcb/1</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>iex(13)&gt; :hipe_bifs.show_pcb self
 P: 0x00007efd7c2c0400
 -----------------------------------------------------------------
 Offset| Name          |              Value |             *Value |
     0 | id            | 0x00000270000004e3 |                    |

 ...

   328 | rcount        | 0x0000000000000000 |                    |
   336 | reds          | 0x000000000000a528 |                    |

 ...

   320 | fcalls        | 0x00000000000004a3 |                    |</pre>
</div>
</div>
<div class="paragraph">
<p>The field <code>reds</code> keep track of the total number of reductions a
process has done up until it was last suspended. By monitoring this
number you can see which processes do the most work.</p>
</div>
<div class="paragraph">
<p>You can see the total number of reductions for a process (the reds
field) by calling <code>erlang:process_info/2</code> with the atom <code>reductions</code>
as the second argument. You can also see this number in the process
tab in the observer or with the i/0 command in the Erlang shell.</p>
</div>
<div class="paragraph">
<p>As noted earlier, each time a process starts the field <code>fcalls</code> is set to
the value of <code>CONTEXT_REDS</code> and for each function call the
process executes <code>fcalls</code> is reduced by 1. When the process is
suspended the field reds is increased by the number of executed
reductions. In some C like code something like:
 <code>p&#8594;reds += (CONTEXT_REDS - p&#8594;fcalls)</code>.</p>
</div>
<div class="paragraph">
<p>Normally a process would do all its allotted reductions and <code>fcalls</code>
would be 0 at this point, but if the process suspends in a receive
waiting for a message it will have some reductions left.</p>
</div>
<div class="paragraph">
<p>When a process uses up all its reductions it will yield to
let another process run, it will go from the process state
<em>running</em> to the state <em>runnable</em>, if it yields in a receive
it will instead go into the state <em>waiting</em> (for a message).
In the next section we will take a look at all the different
states a process can be in.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_process_state_or_status"><a class="link" href="#_the_process_state_or_status">11.4. The Process State (or <em>status</em>)</a></h3>
<div class="paragraph">
<p>The field <code>status</code> in the PCB contains the process state. It can be one
of <em>free</em>, <em>runnable</em>, <em>waiting</em>, <em>running</em>, <em>exiting</em>, <em>garbing</em>,
and <em>suspended</em>. When a process exits it is marked as
free---you should never be able to see a process in this state,
it is a short lived state where the process no longer exist as
far as the rest of the system is concerned but there is still
some clean up to be done (freeing memory and other resources).</p>
</div>
<div class="paragraph">
<p>Each process status represents a state in the Process State
Machine. Events such as a timeout or a delivered
message triggers transitions along the edges in the state machine.
The <em>Process State Machine</em> looks like this:</p>
</div>
<div id="process_state_machine" class="imageblock">
<div class="content">
<img src="images/diag-d9990d3386e3968f85e983a5ff027c71.png" alt="diag d9990d3386e3968f85e983a5ff027c71" width="670" height="462">
</div>
<div class="title">Figure 23. Process State Machine</div>
</div>
<div class="paragraph">
<p>The normal states for a process are <em>runnable</em>, <em>waiting</em>, and <em>running</em>.
A running process is currently executing code in one of the schedulers.
When a process enters a receive and there is no matching message in
the message queue, the process will become waiting until a message
arrives or a timeout occurs. If a process uses up all its reductions,
it will become runnable and wait for a scheduler to pick it up again.
A waiting process receiving a message or a timeout will become
runnable.</p>
</div>
<div class="paragraph">
<p>Whenever a process needs to do garbage collection, it will go into
the <em>garbing</em>
state until the GC is done. While it is doing GC
it saves the old state in the field <code>gcstatus</code> and when it is done
it sets the state back to the old state using <code>gcstatus</code>.</p>
</div>
<div class="paragraph">
<p>The suspended state is only supposed to be used for debugging
purposes. You can call <code>erlang:suspend_process/2</code> on another process
to force it into the suspended state. Each time a process calls
<code>suspend_process</code> on another process, the <em>suspend count</em> is increased.
This is recorded in the field <code>rcount</code>.
A call to (<code>erlang:resume_process/1</code>) by the suspending process will
decrease the suspend count. A process in the suspend state will not
leave the suspend state until the suspend count reaches zero.</p>
</div>
<div class="paragraph">
<p>The field <code>rstatus</code> (resume status) is used to keep track of the
state the process was in before a suspend. If it was <em>running</em>
or <em>runnable</em> it will start up as <em>runnable</em>, and if it was <em>waiting</em>
it will go back to the wait queue. If a suspended waiting process
receives a timeout <code>rstatus</code> is set to <em>runnable</em> so it will resume
as <em>runnable</em>.</p>
</div>
<div class="paragraph">
<p>To keep track of which process to run next the scheduler keeps
the processes in a queue.</p>
</div>
</div>
<div class="sect2">
<h3 id="_process_queues"><a class="link" href="#_process_queues">11.5. Process Queues</a></h3>
<div class="paragraph">
<p>The main job of the scheduler is to keep track of work queues,
that is, queues of processes and ports.</p>
</div>
<div class="paragraph">
<p>There are two process states that the scheduler has to handle,
<em>runnable</em>, and <em>waiting</em>.
Processes waiting to receive a message are in
the waiting state. When a waiting process receives a message the send
operations triggers a move of the receiving process into the runnable
state. If the receive statement has a timeout the scheduler has to
trigger the state transition to runnable when the timeout triggers.
We will cover this mechanism later in this chapter.</p>
</div>
<div class="sect3">
<h4 id="_the_ready_queue"><a class="link" href="#_the_ready_queue">11.5.1. The Ready Queue</a></h4>
<div class="paragraph">
<p>Processes in the runnable state are placed in a FIFO (first in first
out) queue handled by the scheduler, called the <em>ready queue</em>. The
queue is implemented by a first and a last pointer and by the next
pointer in the PCB of each participating process.
When a new process is added to the queue the
<em>last</em> pointer is followed and the process is added to the end of the
queue in an O(1) operation. When a new process is scheduled it is
just popped from the head (the <em>first</em> pointer) of the queue.</p>
</div>
<div id="the_ready_queue" class="listingblock">
<div class="content">
<pre> The Ready Queue

 First: --&gt;  P5       +---&gt; P3       +-+-&gt; P17
             next: ---+     next: ---+ |  next: NULL
                                       |
 Last: --------------------------------+</pre>
</div>
</div>
<div class="paragraph">
<p>In a SMP system, where you have several scheduler threads,
there is one queue per scheduler.</p>
</div>
<div id="the_smp_ready_queues" class="listingblock">
<div class="content">
<pre> Scheduler 1       Scheduler 2      Scheduler 3      Scheduler 4

 Ready: P5         Ready: P1        Ready: P7        Ready: P9
        P3                P4               P12
        P17                                P10</pre>
</div>
</div>
<div class="paragraph">
<p>The reality is slightly more complicated since Erlang processes have
priorities. Each scheduler actually has three queues. One queue for
<em>max priority</em> tasks, one for <em>high priority</em> tasks and one queue
containing both <em>normal</em> and <em>low priority</em> tasks.</p>
</div>
<div id="priority_ready_queues" class="listingblock">
<div class="content">
<pre> Scheduler 1       Scheduler 2      Scheduler 3      Scheduler 4

 Max:    P5        Max:             Max:             Max:
 High:             High:  P1        High:            High:
 Normal: P3        Ready: P4        Ready: P7        Ready: P9
         P17                               P12
                                           P10</pre>
</div>
</div>
<div class="paragraph">
<p>If there are any processes in the max queue the scheduler will
pick these processes for execution. If there are no processes
in the max queue but there are processes in the high priority
queue the scheduler will pick those processes. Only if there
are no processes in the max and the high priority queues will
the scheduler pick the first process from the normal and low
queue.</p>
</div>
<div class="paragraph">
<p>When a normal process is inserted into the queue it gets a <em>schedule
count</em> of 1 and a low priority process gets a schedule count of 8.
When a process is picked from the front of the
queue its schedule count is reduced by one, if the count reaches zero
the process is scheduled, otherwise it is inserted at the end of the
queue. This means that low priority processes will go through the
queue seven times before they are scheduled.</p>
</div>
</div>
<div class="sect3">
<h4 id="_waiting_timeouts_and_the_timing_wheel"><a class="link" href="#_waiting_timeouts_and_the_timing_wheel">11.5.2. Waiting, Timeouts and the Timing Wheel</a></h4>
<div class="paragraph">
<p>A processs trying to do a receive on an empty mailbox or on
a mailbox with no matching messages will yield and go into the
waiting state.</p>
</div>
<div class="paragraph">
<p>When a message is delivered to an inbox the sending process will check
whether the receiver is <em>sleeping</em> in the waiting state, and in that
case it will <em>wake</em> the process, change its state to runable, and put
it at the end of the appropriate ready queue.</p>
</div>
<div class="paragraph">
<p>If the receive statement has a timeout clause a timer will be
created for the process which will trigger after the specified timeout
time. The only guarantee the runtime system gives on a timeout is that
it will not trigger before the set time, it might be some time after
the intended time before the process is scheduled and gets to execute.</p>
</div>
<div class="paragraph">
<p>Timers are handled in the VM by a <em>timing wheel</em>. That is, an array of
time slots which wraps around. Prior to Erlang 18 the timing wheel was
a global resource and there could be some contention for the write
lock if you had many processes inserting timers into the wheel. Make
sure you are using a later version of Erlang if you use many timers.</p>
</div>
<div class="paragraph">
<p>The default size (TIW_SIZE) of the timing wheel is 65536 slots (or
8192 slots if you have built the system for a small memory
footprint). The current time is indicated by an index into the array
(tiw_pos). When a timer is inserted into the wheel with a timeout of
T the timer is inserted into the slot at (tiw_pos+T)%TIW_SIZE.</p>
</div>
<div id="the_timing_wheel" class="listingblock">
<div class="content">
<pre>   0 1                                      65535
  +-+-+- ... +-+-+-+-+-+-+-+-+-+-+-+ ... +-+-----+
  | | |      | | | | | | |t| | | | |     | |     |
  +-+-+- ... +-+-+-+-+-+-+-+-+-+-+-+ ... +-+-----+
              ^           ^                       ^
              |           |                       |
           tiw_pos     tiw_pos+T               TIW_SIZE</pre>
</div>
</div>
<div class="paragraph">
<p>The timer stored in the timing wheel is a pointer to an ErlTimer
struct. See <a href="https://github.com/erlang/otp/blob/OTP-19.1/erts/emulator/beam/erl_time.h">erl_time.h</a>. If several timers are
inserted into the same slot they are linked together in a linked list
by the prev and next fields. The count field is set to
T/TIW_SIZE</p>
</div>
<div id="ErlTimer" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cm">/*
** Timer entry:
*/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">erl_timer</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">erl_timer</span><span class="o">*</span> <span class="n">next</span><span class="p">;</span>	<span class="cm">/* next entry tiw slot or chain */</span>
    <span class="k">struct</span> <span class="n">erl_timer</span><span class="o">*</span> <span class="n">prev</span><span class="p">;</span>	<span class="cm">/* prev entry tiw slot or chain */</span>
    <span class="n">Uint</span> <span class="n">slot</span><span class="p">;</span>			<span class="cm">/* slot in timer wheel */</span>
    <span class="n">Uint</span> <span class="n">count</span><span class="p">;</span>			<span class="cm">/* number of loops remaining */</span>
    <span class="kt">int</span>    <span class="n">active</span><span class="p">;</span>		<span class="cm">/* 1=activated, 0=deactivated */</span>
    <span class="cm">/* called when timeout */</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">timeout</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">);</span>
    <span class="cm">/* called when cancel (may be NULL) */</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cancel</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">);</span>
    <span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">;</span>        <span class="cm">/* argument to timeout/cancel procs */</span>
<span class="p">}</span> <span class="n">ErlTimer</span><span class="p">;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ports"><a class="link" href="#_ports">11.6. Ports</a></h3>
<div class="paragraph">
<p>A port is an Erlang abstraction for a communication point with the
world outside of the Erlang VM. Communications with sockets, pipes,
and file IO are all done through ports on the Erlang side.</p>
</div>
<div class="paragraph">
<p>A port, like a process, is created on the same scheduler as the
creating process. Also like processes ports use reductions to decide
when to yield, and they also get to run for 4000 reductions. But
since ports don&#8217;t run Erlang code there are no Erlang function calls
to count as reductions, instead each <em>port task</em> is counted as a
number of reductions. Currently a task uses a little more than 200
reductions per task, and a number of reductions relative to one
thousands of the size of transmitted data.</p>
</div>
<div class="paragraph">
<p>A port task is one operation on a port, like opening, closing, sending
a number of bytes or receiving data. In order to execute a port task
the executing thread takes a lock on the port.</p>
</div>
<div class="paragraph">
<p>Port tasks are scheduled and executed in each iteration in the
scheduler loop (see below) before a new process is selected for
execution.</p>
</div>
</div>
<div class="sect2">
<h3 id="_reductions_2"><a class="link" href="#_reductions_2">11.7. Reductions</a></h3>
<div class="paragraph">
<p>When a process is scheduled it will get a number of reductions defined
by <code>CONTEXT_REDS</code> (defined in
<a href="https://github.com/erlang/otp/blob/OTP-20.0/erts/emulator/beam/erl_vm.h">erl_vm.h</a>,
currently as 4000). After using up its reductions or when doing a
up its reductions or when doing a receive without a matching message
in the inbox, the process will be suspended and a new processes will
be scheduled.</p>
</div>
<div class="paragraph">
<p>If the VM has executed as many reductions as defined by
<code>INPUT_REDUCTIONS</code> (currently <code>2*CONTEXT_REDS</code>, also defined in
erl_vm.h) or if there is no process ready to run the scheduler will
do system-level activities. That is, basically, check for IO; we will
cover the details soon.</p>
</div>
<div class="paragraph">
<p>It is not completely defined what a reduction is, but at least each
function call should be counted as a reduction. Things get a bit more
complicated when talking about BIFs and NIFs. A process should not be
able to run for "a long time" without using a reduction and yielding.
A function written in C can usually not yield at any time, and the
reason for writing it in C is usually to achieve performance. In such
functions a reduction might take longer which can lead to imbalance in
the scheduler.</p>
</div>
<div class="paragraph">
<p>For example in Erlang versions prior to R16 the BIFs
binary_to_term/1 and term_to_binary/1 where non yielding and only
counted as one reduction. This meant that a process calling theses
functions on large terms could starve other processes. This can even
happen in a SMP system because of the way processes are balanced
between schedulers, which we will get to soon.</p>
</div>
<div class="paragraph">
<p>While a process is running the emulator keeps the number of reductions
left to execute in the (register mapped) variable FCALLS (see
beam_emu.c).</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_scheduler_loop"><a class="link" href="#_the_scheduler_loop">11.8. The Scheduler Loop</a></h3>
<div class="paragraph">
<p>Conceptually you can look at the scheduler as the driver of program
execution in the Erlang VM. In reality, that is, the way the C code
is structured, it is the emulator (process_main in beam_emu.c) that
drives the execution and it calls the scheduler as a subroutine to find
the next process to execute.</p>
</div>
<div class="paragraph">
<p>Still, we will pretend that it is the other way around, since it makes
a nice conceptual model for the scheduler loop. That is, we see it
as the scheduler picking a process to execute and then handing over
the execution to the emulator.</p>
</div>
<div class="paragraph">
<p>Looking at it that way, the scheduler loop looks like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Update reduction counters.</p>
</li>
<li>
<p>Check timers</p>
</li>
<li>
<p>If needed check balance</p>
</li>
<li>
<p>If needed migrate processes and ports</p>
</li>
<li>
<p>Do auxiliary scheduler work</p>
</li>
<li>
<p>If needed check IO and update time</p>
</li>
<li>
<p>While needed pick a port task to execute</p>
</li>
<li>
<p>Pick a process to execute</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_load_balancing"><a class="link" href="#_load_balancing">11.9. Load Balancing</a></h3>
<div class="paragraph">
<p>The current strategy of the load balancer is to use as few schedulers
as possible without overloading any CPU. The idea is that you will get
better performance through better memory locality when processes share
the same CPU.</p>
</div>
<div class="paragraph">
<p>One thing to note though is that the load balancing done in the
scheduler is between scheduler threads and not necessarily between
CPUs or cores. When you start the runtime system you can specify how
schedulers should be allocated to cores. The default behaviour is that
it is up to the OS to allocated scheduler threads to cores, but you
can also choose to bind schedulers to cores.</p>
</div>
<div class="paragraph">
<p>The load balancer assumes that there is one scheduler running on each
core so that moving a process from a overloaded scheduler to an under
utilized scheduler will give you more parallel processing power. If
you have changed how schedulers are allocated to cores, or if your OS
is overloaded or bad at assigning threads to cores, the load balancing
might actually work against you.</p>
</div>
<div class="paragraph">
<p>The load balancer uses two techniques to balance the load, <em>task
stealing</em> and <em>migration</em>. Task stealing is used every time a
scheduler runs out of work, this technique will result in the work
becoming more spread out between schedulers. Migration is more
complicated and tries to compact the load to the right number of
schedulers.</p>
</div>
<div class="sect3">
<h4 id="_task_stealing"><a class="link" href="#_task_stealing">11.9.1. Task Stealing</a></h4>
<div class="paragraph">
<p>If a scheduler run queue is empty when it should pick a new process
to schedule the scheduler will try to steal work from another
scheduler.</p>
</div>
<div class="paragraph">
<p>First the scheduler takes a lock on itself to prevent other schedulers
to try to steal work from the current scheduler. Then it checks if
there are any inactive schedulers that it can steal a task from. If
there are no inactive schedulers with stealable tasks then it will
look at active schedulers, starting with schedulers having a higher id
than itself, trying to find a stealable task.</p>
</div>
<div class="paragraph">
<p>The task stealing will look at one scheduler at a time and try to
steal the highest priority task of that scheduler. Since this is done
per scheduler there might actually be higher priority tasks that are
stealable on another scheduler which will not be taken.</p>
</div>
<div class="paragraph">
<p>The task stealing tries to move tasks towards schedulers with lower
numbers by trying to steal from schedulers with higher numbers,
but since the stealing also will wrap around and steal from schedulers
with lower numbers the result is that processes are spread out on all
active schedulers.</p>
</div>
<div class="paragraph">
<p>Task stealing is quite fast and can be done on every iteration of
the scheduler loop when a scheduler has run out of tasks.</p>
</div>
</div>
<div class="sect3">
<h4 id="_migration"><a class="link" href="#_migration">11.9.2. Migration</a></h4>
<div class="paragraph">
<p>To really utilize the schedulers optimally a more elaborate migration
strategy is used. The current strategy is to compact the load to as
few schedulers as possible, while at the same time spread it out so
that no scheduler is overloaded.</p>
</div>
<div class="paragraph">
<p>This is done by the function <em>check_balance</em> in <em>erl_process.c</em>.</p>
</div>
<div class="paragraph">
<p>The migration is done by first setting up a migration plan and then
letting schedulers execute on that plan until a new plan is set up.
Every 2000*CONTEXT_REDS reductions a scheduler calculates
a migration path per priority per scheduler by looking at the workload
of all schedulers. The migration path can have three different types of
values: 1) cleared 2) migrate to scheduler # 3) immigrate from
scheduler #</p>
</div>
<div class="paragraph">
<p>When a process becomes ready (for example by receiving a message or
triggering a timeout) it will normally be scheduled on the last
scheduler it ran on (S1). That is, if the migration path of that
scheduler (S1), at that priority, is cleared. If the migration path of
the scheduler is set to emigrate (to S2) the process will be handed over
to that scheduler if both S1 and S2 have unbalanced run-queues. We will
get back to what that means.</p>
</div>
<div class="paragraph">
<p>When a scheduler (S1) is to pick a new process to execute it checks to
see if it has an immigration path from (S2) set. If the two involved
schedulers have unbalanced run-queues S1 will steal a process from S2.</p>
</div>
<div class="paragraph">
<p>The migration path is calculated by comparing the maximum run-queues
for each scheduler for a certain priority. Each scheduler will update
a counter in each iteration of its scheduler loop keeping track of
the maximal queue length. This information is then used to calculate
an average (max) queue length (<em>AMQL</em>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre> Max
 Run Q
 Length
    5         o
              o
           o  o
Avg: 2.5 --------------
           o  o     o
    1      o  o     o

scheduler S1 S2 S3 S4</pre>
</div>
</div>
<div class="paragraph">
<p>Then the schedulers are sorted on their max queue lengths.</p>
</div>
<div class="listingblock">
<div class="content">
<pre> Max
 Run Q
 Length
    5               o
                    o
                 o  o
Avg: 2.5 --------------
              o  o  o
    1         o  o  o

scheduler S3 S4 S1 S2

           ^        ^
           |        |
          tix      fix</pre>
</div>
</div>
<div class="paragraph">
<p>Any scheduler with a longer run queue than average (S1, S2) will be
marked for emigration and any scheduler with a shorter max run queue
than average (S3, S4) will be targeted for immigration.</p>
</div>
<div class="paragraph">
<p>This is done by looping over the ordered set of schedulers with two
indices (immigrate from (fix)) and (emigrate to (tix)). In each
iteration of the a loop the immigration path of S[tix] is set to S[fix]
and the emigration path of S[fix] is set to S[tix]. Then tix is increased
and fix decreased till they both pass the balance point. If one index
reaches the balance point first it wraps.</p>
</div>
<div class="paragraph">
<p>In the example:
 * Iteration 1: S2.emigrate_to = S3 and S3.immigrate_from = S2
 * Iteration 2: S1.emigrate_to = S4 and S4.immigrate_from = S1</p>
</div>
<div class="paragraph">
<p>Then we are done.</p>
</div>
<div class="paragraph">
<p>In reality things are a bit more complicated since schedulers can be
taken offline. The migration planning is only done for online
schedulers. Also, as mentioned before, this is done per priority
level.</p>
</div>
<div class="paragraph">
<p>When a process is to be inserted into a ready queue and there is a
migration path set from S1 to S2 the scheduler first checks that the
run queue of S1 is larger than AMQL and that the run queue of S2 is
smaller than the average. This way the migration is only allowed if
both queues are still unbalanced.</p>
</div>
<div class="paragraph">
<p>There are two exceptions though where a migration is forced even
when the queues are balanced or even imbalanced in the wrong way.
In both these cases a special evacuation flag is set which overrides
the balance test.</p>
</div>
<div class="paragraph">
<p>The evacuation flag is set when a scheduler is taken offline to
ensure that no new processes are scheduled on an offline scheduler.
The flag is also set when the scheduler detects that no progress is
made on some priority. That is, if there for example is a max priority
process which always is ready to run so that no normal priority processes
ever are scheduled. Then the evacuation flag will be set for the normal
priority queue for that scheduler.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Memory"><a class="link" href="#CH-Memory">12. The Memory Subsystem: Stacks, Heaps and Garbage Collection</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we dive into the memory subsystem of ERTS, we need to have some
basic vocabulary and understanding of the general memory layout of a
program in a modern operating system. In this review section I will
assume the program is compiled to an ELF executable and running on
Linux on something like an IA-32/AMD64 architecture. The layout and
terminology is basically the same for all operating systems that ERTS
compile on.</p>
</div>
<div class="paragraph">
<p>A program&#8217;s memory layout looks something like this:</p>
</div>
<div id="program_memory_layout" class="imageblock">
<div class="content">
<img src="images/diag-8d21d004b7e635fa28f4115deebe1a60.png" alt="diag 8d21d004b7e635fa28f4115deebe1a60" width="690" height="700">
</div>
<div class="title">Figure 24. Program Memory Layout</div>
</div>
<div class="paragraph">
<p>Even though this picture might look daunting it is still a
simplification. (For a full understanding of the memory subsystem read
a book like "Understanding the Linux Kernel" or "Linux System
Programming") What I want you to take away from this is that there are
two types of dynamically allocatable memory: the heap and memory
mapped segments. I will try to call this heap the <em>C-heap</em> from now
on, to distinguish it from an Erlang process heap. I will call a
memory mapped segment for just a <em>segment</em>, and any of the stacks in
this picture for the <em>C-stack</em>.</p>
</div>
<div class="paragraph">
<p>The C-heap is allocated through malloc and a segment is allocated with
mmap.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A note on pictures of memory</p>
</li>
</ol>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Note</strong> When drawing overview pictures of system memory and stacks we
will follow the convention that memory addresses grows upward. That is
low memory addresses on the bottom of the page and high memory
addresses on the top of the page. (Stacks most often grow downward
starting at high addresses, so that new elements are pushed at the
lowest address.)</p>
</div>
<div class="paragraph">
<p>However when we draw a c-structure we will draw the fields from the
top and down, even though the first field of the structure will be
at the lowest address and the following fields at higher addresses.
So pictures of structures have low address at the top of the page
and high address at the bottom of the page.</p>
</div>
<div class="paragraph">
<p>This means that a picture of a c-structure and a picture of a memory
area will have their address positions on the page mirrored. This becomes
somewhat confusing when we try to picture structures and heaps in the
same picture.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_memory_subsystem"><a class="link" href="#_the_memory_subsystem">12.1. The memory subsystem</a></h3>
<div class="paragraph">
<p>Now that we dive into the memory subsystem it will once again
be apparent that ERTS is more like an operating system than just a
programming language environment. Not only does ERTS provide a garbage
collector for Erlang terms on the Erlang process level, but it also
provides a plethora of low level memory allocators and memory
allocation strategies.</p>
</div>
<div class="paragraph">
<p>For an overview of memory allocators see the erts_alloc documentation
at: <a href="http://www.erlang.org/doc/man/erts_alloc.html" class="bare">http://www.erlang.org/doc/man/erts_alloc.html</a></p>
</div>
<div class="paragraph">
<p>All these allocators also comes with a number of parameters that
can be used to tweak their behavior, and this is probably one
of the most important areas from an operational point of view.
This is where we can configure the system behavior to fit anything
from a small embedded control system (like a Raspberry Pi) to an
Internet scale 2TB database server.</p>
</div>
<div class="paragraph">
<p>There are currently eleven different allocators, six different
allocation strategies, and more than 18 other different settings,
some of which are taking arbitrary numerical values. This
means that there basically is an infinite number of possible
configurations. (OK, strictly speaking it is not infinite, since
each number is bounded, but there are more configurations
than you can shake a stick at.)</p>
</div>
<div class="paragraph">
<p>In order to be able to use these settings in any meaningful way
we will have to understand how these allocators work and
how each setting impacts the performance of the allocator.</p>
</div>
<div class="paragraph">
<p>The erts_alloc manual goes as far as to give the following warning:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Only use these flags if you are absolutely sure what you are
doing. Unsuitable settings may cause serious performance degradation
and even a system crash at any time during operation.
</td>
</tr>
</table>
</div>
</blockquote>
<div class="attribution">
&#8212; Ericsson AB<br>
<cite>http://www.erlang.org/doc/man/erts_alloc.html</cite>
</div>
</div>
<div class="paragraph">
<p>Making you absolutely sure that you know what you are doing, that is
what this chapter is about.</p>
</div>
<div class="paragraph">
<p>Oh yes, we will also go into details of how the garbage collector
works.</p>
</div>
</div>
<div class="sect2">
<h3 id="SS-Memory_Allocators"><a class="link" href="#SS-Memory_Allocators">12.2. Different type of memory allocators</a></h3>
<div class="paragraph">
<p>The Erlang run-time system is trying its best to handle memory
in all situations and under all types of loads, but there are
always corner cases. In this chapter we will look at the details
of how memory is allocated and how the different allocators work.
With this knoweledge and some tools that we will look at later
you should be able to detect and fix problems if your system
ends up in one of these corner cases.</p>
</div>
<div class="paragraph">
<p>For a nice story about the troubles the system might get into
and how to analyze and correct the behavior read
Fred Hberts essay <a href="https://blog.heroku.com/archives/2013/11/7/logplex-down-the-rabbit-hole">"Troubleshooting Down the Logplex Rabbit Hole"</a>.</p>
</div>
<div class="paragraph">
<p>When we are talking about a memory allocator in this book we
have a specific meaning in mind. Each memory allocator manage
allocations and deallocations of memory of a certain type.
Each allocator is intended for a specific type of data and is
often specialized for one size of data.</p>
</div>
<div class="paragraph">
<p>Each memory allocator implements the allocator interface that
can use different algorithms and settings for the actual
memory allocation.</p>
</div>
<div class="paragraph">
<p>The goal with having different allocators is to reduce
fragmentation, by grouping allocations of the same size,
and to increase performance, by making frequent allocations
cheap.</p>
</div>
<div class="paragraph">
<p>There are two special, fundamental or generic, memory allocator types
<em>sys_alloc</em> and <em>mseg_alloc</em>, and nine specific allocators implemented
through the <em>alloc_util</em> framework.</p>
</div>
<div class="paragraph">
<p>In the following sections we will go though the different allocators,
with a little detour into the general framework for allocators
(alloc_util).</p>
</div>
<div class="paragraph">
<p>Each allocator has several names used in the documentation and in the
C code. See <a href="#table-allocators">Table 1</a> for a short list of all allocators
and their names. The C-name is used in the C-code to refer to the
allocator. The Type-name is used in erl_alloc.types to bind allocation
types to an allocator. The Flag is the letter used for setting
parameters of that allocator when starting Erlang.</p>
</div>
<table id="table-allocators" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. List of memory allocators.</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">C-name</th>
<th class="tableblock halign-left valign-top">Type-name</th>
<th class="tableblock halign-left valign-top">Flag</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">malloc interface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sys_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SYSTEM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Y</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Memory segment allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mmap interface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mseg_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">M</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Temporary allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Temporary allocations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">temp_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TEMPORARY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heap allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Erlang heap data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">eheap_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EHEAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">H</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">binary_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BINARY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ETS allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ETS data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ets_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ETS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Driver allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Driver data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">driver_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DRIVER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">R</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Short lived allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Short lived memory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sl_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SHORT_LIVED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">S</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long lived allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long lived memory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ll_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LONG_LIVED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fixed allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fixed size data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fix_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FIXED_SIZE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For most other data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">std_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STANDARD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">D</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_the_basic_allocator_sys_alloc"><a class="link" href="#_the_basic_allocator_sys_alloc">12.2.1. The basic allocator: sys_alloc</a></h4>
<div class="paragraph">
<p>The allocator sys_alloc can not be disabled, and is basically a
straight mapping to the underlying OS malloc implementation in
libc.</p>
</div>
<div class="paragraph">
<p>If a specific allocator is disabled then sys_alloc is used instead.</p>
</div>
<div class="paragraph">
<p>All specific allocators uses either sys_alloc or mseg_alloc to
allocate memory from the operating system as needed.</p>
</div>
<div class="paragraph">
<p>When memory is allocated from the OS sys_alloc can add (pad) a fixed
number of kilobytes to the requested number. This can reduce the
number of system calls by over allocating memory. The default padding
is zero.</p>
</div>
<div class="paragraph">
<p>When memory is freed, sys_alloc will keep some free memory allocated
in the process. The size of this free memory is called the trim
threshold, and the default is 128 kilobytes. This also reduces the
number of system calls at the cost of a higher memory footprint.
This means that if you are running the system with the default
settings you can experience that the Beam process does not give
memory back to the OS directly as memory is freed up.</p>
</div>
<div class="paragraph">
<p>Memory areas allocated by sys_alloc are stored in the C-heap of the
beam process which will grow as needed through system calls to brk.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_memory_segment_allocator_mseg_alloc"><a class="link" href="#_the_memory_segment_allocator_mseg_alloc">12.2.2. The memory segment allocator: mseg_alloc</a></h4>
<div class="paragraph">
<p>If the underlying operating system supports mmap a specific memory
allocator can use mseg_alloc instead of sys_alloc to allocate
memory from the operating system.</p>
</div>
<div class="paragraph">
<p>Memory areas allocated through mseg_alloc are called segments. When a
segment is freed it is not immediately returned to the OS, instead it
is kept in a segment cache.</p>
</div>
<div class="paragraph">
<p>When a new segment is allocated a cached segment is reused if
possible, i.e. if it is the same size or larger than the requested
size but not too large. The value of <em>absolute max cache bad fit</em>
determines the number of kilobytes of extra size which is considered
not too large. The default is 4096 kilobytes.</p>
</div>
<div class="paragraph">
<p>In order not to reuse a 4096 kilobyte segment for really small
allocations there is also a <em>relative_max_cache_bad_fit</em> value which
states that a cached segment may not be used if it is more than
that many percent larger. The default value is 20 percent. That
is a 12 KB segment may be used when asked for a 10 KB segment.</p>
</div>
<div class="paragraph">
<p>The number of entries in the cache defaults to 10 but can be
set to any value from zero to thirty.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_memory_allocator_framework_alloc_util"><a class="link" href="#_the_memory_allocator_framework_alloc_util">12.2.3. The memory allocator framework: alloc_util</a></h4>
<div class="paragraph">
<p>Building on top of the two generic allocators (sys_alloc and mseg_alloc)
is a framework called <em>alloc_util</em> which is used to implement specific
memory allocators for different types of usage and data.</p>
</div>
<div class="paragraph">
<p>The framework is implemented in <em>erl_alloc_util.[ch]</em> and the different
allocators used by ERTS are defined in erl_alloc.types in
the directory "erts/emulator/beam/".</p>
</div>
<div class="paragraph">
<p>In a SMP system there is usually one allocator of each type per
scheduler thread.</p>
</div>
<div class="paragraph">
<p>The smallest unit of memory that an allocator can work with is called a
<em>block</em>. When you call an allocator to allocate a certain amount of
memory what you get back is a block. It is also blocks that you give
as an argument to the allocator when you want to deallocate memory.</p>
</div>
<div class="paragraph">
<p>The allocator does not allocate blocks from the operating system
directly though. Instead the allocator allocates a <em>carrier</em> from the
operating system, either through sys_alloc or through mseg_alloc,
which in turn uses malloc or mmap. If sys_alloc is used the carrier
is placed on the C-heap and if mseg_alloc is used the carrier
is placed in a segment.</p>
</div>
<div class="paragraph">
<p>Small blocks are placed in a multiblock carrier. A multiblock carrier
can as the name suggests contain many blocks. Larger blocks are placed
in a singleblock carrier, which as the name implies on contains one
block.</p>
</div>
<div class="paragraph">
<p>What&#8217;s considered a small and a large block is determined by the
parameter <em>singleblock carrier threshold</em> (sbct), see the list
of system flags below.</p>
</div>
<div class="paragraph">
<p>Most allocators also have one "main multiblock carrier" which is never
deallocated.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-95b349af82fb7686593bb43498201092.png" alt="diag 95b349af82fb7686593bb43498201092" width="620" height="476">
</div>
</div>
<div class="sect4">
<h5 id="_memory_allocation_strategies"><a class="link" href="#_memory_allocation_strategies">Memory allocation strategies</a></h5>
<!--
Are you intending for readers to take advantage of these allocation strategies in their code? If so, this section needs to be much more prominent, and not a subheading in a reference section.  - bmacdonald
-->
<div class="paragraph">
<p>To find a free block of memory in a multi block carrier an
allocation strategy is used. Each type of allocator has
a default allocation strategy, but you can also set the
allocation strategy with the as flag.</p>
</div>
<div class="paragraph">
<p>The Erlang Run-Time System Application Reference Manual lists
the following allocation strategies:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><em>Best fit</em>: Find the smallest block that satisfies the requested block size.
(bf)</p>
</div>
<div class="paragraph">
<p><em>Address order best fit</em>: Find the smallest block that satisfies the
requested block size. If multiple blocks are found, choose the one
with the lowest address.
(aobf)</p>
</div>
<div class="paragraph">
<p><em>Address order first fit</em>: Find the block with the lowest address that
satisfies the requested block size.
(aoff)</p>
</div>
<div class="paragraph">
<p><em>Address order first fit carrier best fit</em> :
Find the carrier with the lowest address that can satisfy the
requested block size, then find a block within that carrier using the
"best fit" strategy.  (aoffcbf)</p>
</div>
<div class="paragraph">
<p><em>Address order first fit carrier address order best fit</em>: Find the
carrier with the lowest address that can satisfy the requested block
size, then find a block within that carrier using the "address order
best fit" strategy.
 aoffcaobf (address order first fit carrier address order best fit)</p>
</div>
<div class="paragraph">
<p><em>Good fit</em>: Try to find the best fit, but settle for the best fit found
during a limited search.
(gf)</p>
</div>
<div class="paragraph">
<p><em>A fit</em>: Do not search for a fit, inspect only one free block to see if
it satisfies the request. This strategy is only intended to be used
for temporary allocations.
(af)</p>
</div>
</blockquote>
<div class="attribution">
&#8212; <a href="http://www.erlang.org/doc/man/erts_alloc.html">erts_alloc</a>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_temporary_allocator_temp_alloc"><a class="link" href="#_the_temporary_allocator_temp_alloc">12.2.4. The temporary allocator: temp_alloc</a></h4>
<div class="paragraph">
<p>The allocator <em>temp_alloc</em>, is used for temporary
allocations. That is very short lived allocations. Memory allocated
by temp_alloc may not be allocated over a Erlang process context
switch.</p>
</div>
<div class="paragraph">
<p>You can use temp_alloc as a small scratch or working area while doing
some work within a function. Look at it as an extension of the C-stack
and free it in the same way. That is, to be on the safe side, free
memory allocated by temp_alloc before returning from the function that
did the allocation. There is a note in erl_alloc.types saying that
you should free a temp_alloc block before the emulator starts
executing Erlang code.</p>
</div>
<div class="paragraph">
<p>Note that no Erlang process running on the same scheduler as the
allocator may start executing Erlang code before the block is freed.
This means that you can not use a temporary allocation over a BIF
or NIF trap (yield).</p>
</div>
<div class="paragraph">
<p>In a default R16 SMP system there is N+1 temp_alloc allocators where N
is the number of schedulers. The temp_alloc uses the "A fit" (af)
strategy. Since the allocation pattern of the temp_alloc basically is
that of a stack (mostly of size 0 or 1), this strategy works fine.</p>
</div>
<div class="paragraph">
<p>The temporary allocator is, in R16, used by the following types of
data: TMP_HEAP, MSG_ROOTS, ROOTSET, LOADER_TEMP, NC_TMP, TMP,
DCTRL_BUF, TMP_DIST_BUF, ESTACK, DB_TMP, DB_MC_STK, DB_MS_CMPL_HEAP,
LOGGER_DSBUF, TMP_DSBUF, DDLL_TMP_BUF, TEMP_TERM, SYS_READ_BUF,
ENVIRONMENT, CON_VPRINT_BUF.</p>
</div>
<div class="paragraph">
<p>For an up to date list of allocation types allocated with each
allocator, see erl_alloc.types
(e.g. grep TEMPORARY erts/emulator/beam/erl_alloc.types).</p>
</div>
<div class="paragraph">
<p>I will not go through each of these different types, but in
general as you can guess by their names, they are temporary
buffers or work stacks.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_heap_allocator_eheap_alloc"><a class="link" href="#_the_heap_allocator_eheap_alloc">12.2.5. The heap allocator: eheap_alloc</a></h4>
<div class="paragraph">
<p>The heap allocator, is used for allocating memory blocks
where tagged Erlang terms are stored, such as Erlang process heaps
(all generations), heap fragments, and the beam_registers.</p>
</div>
<div class="paragraph">
<p>This is probably the memory areas you are most interested in as an
Erlang developer or when tuning an Erlang system. We will talk more
about how these areas are managed in the upcoming sections on garbage
collection and process memory. There we will also cover what a heap
fragment is.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_binary_allocator_binary_alloc"><a class="link" href="#_the_binary_allocator_binary_alloc">12.2.6. The binary allocator: binary_alloc</a></h4>
<div class="paragraph">
<p>The binary allocator is used for, yes you guessed it, binaries.
Binaries can be of quite varying sizes and have varying life spans.
This allocator uses the <em>best fit</em> allocation strategy by default.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_ets_allocator_ets_alloc"><a class="link" href="#_the_ets_allocator_ets_alloc">12.2.7. The ETS allocator: ets_alloc</a></h4>
<div class="paragraph">
<p>The ETS allocator is used for most ETS related data,
except for some short lived or temporary data used by ETS tables-</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_driver_allocator_driver_alloc"><a class="link" href="#_the_driver_allocator_driver_alloc">12.2.8. The driver allocator: driver_alloc</a></h4>
<div class="paragraph">
<p>The driver allocator is used for ports, linked in drivers and NIFs.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_short_lived_allocator_sl_alloc"><a class="link" href="#_the_short_lived_allocator_sl_alloc">12.2.9. The short lived allocator: sl_alloc</a></h4>
<div class="paragraph">
<p>The short lived allocator is used for lists and buffers that are
expected to be short lived. Short lived data can live longer than
temporary data.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_long_lived_allocator_ll_alloc"><a class="link" href="#_the_long_lived_allocator_ll_alloc">12.2.10. The long lived allocator: ll_alloc</a></h4>
<div class="paragraph">
<p>The long lived allocator is used for long lived data, such
as atoms, modules, funs and long lived tables</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_fixed_size_allocator_fix_alloc"><a class="link" href="#_the_fixed_size_allocator_fix_alloc">12.2.11. The fixed size allocator: fix_alloc</a></h4>
<div class="paragraph">
<p>The fixed allocator is used for objects of a fixed size, such as PCBs,
message refs and a few others. The fixed size allocator uses the
<em>address order best fit</em> allocation strategy by default.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_standard_allocator_std_alloc"><a class="link" href="#_the_standard_allocator_std_alloc">12.2.12. The standard allocator: std_alloc</a></h4>
<div class="paragraph">
<p>The standard allocator is used by the other types of data.
(active_procs alloc_info_request arg_reg bif_timer_ll bits_buf bpd
calls_buf db_heir_data db_heir_data db_named_table_entry dcache
ddll_handle ddll_processes ddll_processes dist_entry dist_tab
driver_lock ethread_standard fd_entry_buf fun_tab gc_info_request
io_queue line_buf link_lh module_refs monitor_lh monitor_lh monitor_sh
nlink_lh nlink_lh nlink_sh node_entry node_tab nodes_monitor
port_data_heap port_lock port_report_exit port_specific_data proc_dict
process_specific_data ptimer_ll re_heap reg_proc reg_tab
sched_wall_time_request stack suspend_monitor thr_q_element thr_queue
zlib )</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_todo_system_flags_for_memory"><a class="link" href="#_todo_system_flags_for_memory">12.3. TODO: system flags for memory</a></h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect2">
<h3 id="_process_memory"><a class="link" href="#_process_memory">12.4. Process Memory</a></h3>
<div class="paragraph">
<p>As we saw in <a href="#CH-Processes">Chapter 3</a> a process is really just a number
of memory areas, in this chapter we will look a bit closer at how
the stack, the heap and the mailbox are managed.</p>
</div>
<div class="paragraph">
<p>The default size of the stack and heap is 233 words. This default
size can be changed globally when starting Erlang through the
+h flag. You can also set the minimum heap size when starting
a process with spawn_opt by setting min_heap_size.</p>
</div>
<div class="paragraph">
<p>Erlang terms are tagged as we saw in <a href="#CH-TypeSystem">Chapter 4</a>, and when
they are stored on the heap they are either cons cells or boxed
objects.</p>
</div>
<div class="sect3">
<h4 id="_term_sharing"><a class="link" href="#_term_sharing">12.4.1. Term sharing</a></h4>
<div class="paragraph">
<p>Objects on the heap are passed by references within the context of one
process. If you call one function with a tuple as an argument, then
only a tagged reference to that tuple is passed to the called
function. When you build new terms you will also only use references
to sub terms.</p>
</div>
<div class="paragraph">
<p>For example if you have the string "hello" (which is the same as this
list of integers: [104,101,108,108,111]) you would get a stack layout
similar to:</p>
</div>
<div id="fig-list_layout" class="imageblock">
<div class="content">
<img src="images/diag-604753f34b1042606c7c77fa3d257f74.png" alt="diag 604753f34b1042606c7c77fa3d257f74" width="990" height="336">
</div>
</div>
<div class="paragraph">
<p>If you then create a tuple with two instances of the list, all that is repeated is
the tagged pointer to the list: 00000000000000000000000001000001. The code</p>
</div>
<div class="listingblock">
<div class="content">
<pre>L = [104, 101, 108, 108, 111],
T = {L, L}.</pre>
</div>
</div>
<div class="paragraph">
<p>would result in a memory layout as seen below. That is,
a boxed header saying that this is a tuple of size 2 and then two
pointers to the same list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ADR VALUE                            DESCRIPTION
144 00000000000000000000000001000001 128+CONS
140 00000000000000000000000001000001 128+CONS
136 00000000000000000000000010000000 2+ARITYVAL</pre>
</div>
</div>
<div class="paragraph">
<p>This is nice, since it is cheap to do and uses very little space. But if
you send the tuple to another process or do any other type of IO, or any
operations which results in something called a <em>deep copy</em>, then the
data structure is expanded. So if we send out tuple T to another process
P2 (P2 ! T) then the heap of T2 will look like in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> ..</pre>
</div>
</div>
<div class="paragraph">
<p>You can quickly bring down your Erlang node by expanding a highly shared term,
see <a href="#listing-share">share.erl</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">share</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">share</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nb">size</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">share</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">Y</span><span class="p">,</span><span class="nv">Y</span><span class="p">};</span>
<span class="nf">share</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nf">share</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="nv">N</span><span class="p">|</span><span class="nv">Y</span><span class="p">])</span> <span class="p">||</span> <span class="p">_</span> <span class="o">&lt;-</span> <span class="nv">Y</span><span class="p">].</span>

<span class="nb">size</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nv">T</span> <span class="o">=</span> <span class="nn">share</span><span class="p">:</span><span class="nf">share</span><span class="p">(</span><span class="mi">5</span><span class="p">,[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]),</span>
    <span class="p">{{</span><span class="nb">size</span><span class="p">,</span> <span class="nn">erts_debug</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="nv">T</span><span class="p">)},</span>
     <span class="p">{</span><span class="n">flat_size</span><span class="p">,</span> <span class="nn">erts_debug</span><span class="p">:</span><span class="nf">flat_size</span><span class="p">(</span><span class="nv">T</span><span class="p">)}}.</span>



 <span class="mi">1</span><span class="o">&gt;</span> <span class="nn">timer</span><span class="p">:</span><span class="nf">tc</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">share</span><span class="p">:</span><span class="nf">share</span><span class="p">(</span><span class="mi">10</span><span class="p">,[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]),</span> <span class="n">ok</span> <span class="k">end</span><span class="p">).</span>
 <span class="p">{</span><span class="mi">1131</span><span class="p">,</span><span class="n">ok</span><span class="p">}</span>

 <span class="mi">2</span><span class="o">&gt;</span> <span class="nn">share</span><span class="p">:</span><span class="nf">share</span><span class="p">(</span><span class="mi">10</span><span class="p">,[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]),</span> <span class="n">ok</span><span class="p">.</span>
 <span class="n">ok</span>

 <span class="mi">3</span><span class="o">&gt;</span> <span class="nb">byte_size</span><span class="p">(</span><span class="nb">list_to_binary</span><span class="p">(</span><span class="nn">test</span><span class="p">:</span><span class="nf">share</span><span class="p">(</span><span class="mi">10</span><span class="p">,[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]))),</span> <span class="n">ok</span><span class="p">.</span>
 <span class="nv">HUGE</span> <span class="nb">size</span> <span class="p">(</span><span class="mi">13695500364</span><span class="p">)</span>
 <span class="nv">Abort</span> <span class="nn">trap</span><span class="p">:</span> <span class="mi">6</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can calculate the memory size of a shared term and the size of the
expanded size of the term with the functions erts_debug:size/1 and
erts_debug:flat_size/1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="o">&gt;</span> <span class="nn">share</span><span class="p">:</span><span class="nb">size</span><span class="p">().</span>
<span class="p">{{</span><span class="nb">size</span><span class="p">,</span><span class="mi">19386</span><span class="p">},{</span><span class="n">flat_size</span><span class="p">,</span><span class="mi">94110</span><span class="p">}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For most applications this is not a problem, but you should be aware
of the problem, which can come up in many situations. A deep copy is
used for IO, ETS tables, binary_to_term, and message passing.</p>
</div>
<div class="paragraph">
<p>Let us look in more detail how message passing works.</p>
</div>
</div>
<div class="sect3">
<h4 id="_message_passing_2"><a class="link" href="#_message_passing_2">12.4.2. Message passing</a></h4>
<div class="paragraph">
<p>When a process P1 sends a message M to another (local) process P2, the
process P1 first calculates the flat size of M. Then it allocates a
new message buffer of that size by doing a heap_alloc of a heap_frag in
the local scheduler context.</p>
</div>
<div class="paragraph">
<p>Given the code in <a href="#listing-send">send.erl</a> the state of the system could
look like this just before the send in p1/1:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-a03c2c8e06a1d35b4979f4789552a939.png" alt="diag a03c2c8e06a1d35b4979f4789552a939" width="990" height="476">
</div>
</div>
<div class="paragraph">
<p>Then P1 start sending the message M to P2. It (through the code in
erl_message.c) first calculates the flat size of M (which in our example is
23 words)<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>.
Then (in a SMP system) if it can take a lock on P2 and there is enough
room on the heap of P2 it will copy the message to the heap of P2.</p>
</div>
<div class="paragraph">
<p>If P2 is running (or exiting) or there isn&#8217;t enough space on the heap,
then a new heap fragment is allocated
(of sizeof ErlHeapFragment - sizeof(Eterm) + 23*sizeof(Eterm))
<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup> which after initialization will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>erl_heap_fragment:
    ErlHeapFragment* next;	  NULL
    ErlOffHeap off_heap:
      erl_off_heap_header* first; NULL
      Uint64 overhead;               0
    unsigned alloc_size;	    23
    unsigned used_size;             23
    Eterm mem[1];		     ?
      ... 22 free words</pre>
</div>
</div>
<div class="paragraph">
<p>Then the message is copied into the heap fragment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>erl_heap_fragment:
    ErlHeapFragment* next;	  NULL
    ErlOffHeap off_heap:
      erl_off_heap_header* first; Boxed tag+&amp;amp;mem+2*WS-+
      Uint64 overhead;               0                |
    unsigned alloc_size;	    23                |
    unsigned used_size;             23                |
    Eterm mem:                    2+ARITYVAL   &lt;------+
                                  &amp;amp;mem+3*WS+1  ---+
                                  &amp;amp;mem+13*WS+1 ------+
                                  (H*16)+15    &lt;--+  |
                                  &amp;amp;mem+5*WS+1  --+   |
                                  (e*16)+15    &lt;-+   |
                                  &amp;amp;mem+7*WS+1  ----| |
                                  (l*16)+15    &lt;---+ |
                                  &amp;amp;mem+9*WS+1  ---+  |
                                  (l*16)+15    &lt;--+  |
                                  &amp;amp;mem+11*WS+1 ----+ |
                                  (o*16)+15    &lt;---+ |
                                  NIL                |
                                  (H*16)+15    &lt;-----+
                                  &amp;amp;mem+15*WS+1 --+
                                  (e*16)+15    &lt;-+
                                  &amp;amp;mem+17*WS+1 ----|
                                  (l*16)+15    &lt;---+
                                  &amp;amp;mem+19*WS+1 ---+
                                  (l*16)+15    &lt;--+
                                  &amp;amp;mem+21*WS+1 ----+
                                  (o*16)+15    &lt;---+
                                  NIL&lt;/pre&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>In either case a new mbox (ErlMessage) is allocated, a lock
 (ERTS_PROC_LOCK_MSGQ) is taken on the receiver and the message
 on the heap or in the new heap fragment is linked into the mbox.</p>
</div>
<div class="listingblock">
<div class="content">
<pre> erl_mesg {
    struct erl_mesg* next = NULL;
    data:  ErlHeapFragment *heap_frag = bp;
    Eterm m[0]            = message;
 } ErlMessage;</pre>
</div>
</div>
<div class="paragraph">
<p>Then the mbox is linked into the in message queue (msg_inq) of the
receiver, and the lock is released. Note that msg_inq.last points to
the next field of the last message in the queue. When a new mbox is
linked in this next pointer is updated to point to the new mbox, and
the last pointer is updated to point to the next field of the new
mbox.</p>
</div>
</div>
<div class="sect3">
<h4 id="SS-Binaries"><a class="link" href="#SS-Binaries">12.4.3. Binaries</a></h4>
<div class="paragraph">
<p>As we saw in <a href="#CH-TypeSystem">Chapter 4</a> there are four types of binaries
internally. Three of these types, <em>heap binaries</em>, <em>sub binaries</em> and
<em>match contexts</em> are stored on the local heap and handled by the
garbage collector and message passing as any other object, copied as
needed.</p>
</div>
<div class="sect4">
<h5 id="_reference_counting"><a class="link" href="#_reference_counting">Reference Counting</a></h5>
<div class="paragraph">
<p>The fourth type.  large binaries or <em>refc binaries</em> on the other hand
are partially stored outside of the process heap and they are
reference counted.</p>
</div>
<div class="paragraph">
<p>The payload of a refc binary is stored in memory allocated by the
binary allocator. There is also a small reference to the payload call
a ProcBin which is stored on the process heap. This reference is
copied by message passing and by the GC, but the payload is
untouched. This makes it relatively cheap to send large binaries to
other processes since the whole binary doesn&#8217;t need to be copied.</p>
</div>
<div class="paragraph">
<p>All references through a ProcBin to a refc binary increases the
reference count of the binary by one. All ProcBin objects on a
process heap are linked together in a linked list. After a
GC pass this linked list is traversed and the reference count
of the binary is decreased with one for each ProcBin that
has deceased. If the reference count of the refc binary
reaches zero that binary is deallocated.</p>
</div>
<div class="paragraph">
<p>Having large binaries reference counted and not copied by send or
garbage collection is a big win, but there is one problem
with having a mixed environment of garbage collection and
reference counting. In a pure reference counted implementation
the reference count would be reduced as soon as a reference to
the object dies, and when the reference count reaches zero the
object is freed. In the ERTS mixed environment a reference to a
reference counted object does not die until a garbage collection
detects that the reference is dead.</p>
</div>
<div class="paragraph">
<p>This means that binaries, which has a tendency to be large or even
huge, can hang around for a long time after all references to the
binary are dead. Note that since binaries are allocated globally,
all references from all processes need to be dead, that is all
processes that has seen a binary need to do a GC.</p>
</div>
<div class="paragraph">
<p>Unfortunately it is not always easy, as a developer, to see which
processes have seen a binary in the GC sense of the word seen. Imagine
for example that you have a load balancer that receives work items
and dispatches them to workers.</p>
</div>
<div class="paragraph">
<p>In <a href="#load_balancer">this code</a> there is an example of a loop which
doesn&#8217;t need to do GC. (See <a href="#listing-lb">listing lb</a> for a full example.)</p>
</div>
<div id="load_balancer" class="listingblock">
<div class="content">
<pre>loop(Workers, N) -&gt;
  receive
    WorkItem -&gt;
       Worker = lists:nth(N+1, Workers),
       Worker ! WorkItem,
       loop(Workers, (N+1) rem length(Workers))
  end.</pre>
</div>
</div>
<div class="paragraph">
<p>This server will just keep on grabbing references to binaries and
never free them, eventually using up all system memory.</p>
</div>
<div class="paragraph">
<p>When one is aware of the problem it is easy to fix, one can either do
a garbage_collect on each iteration of <em>loop</em> or one could do it every
five seconds or so by adding an after clause to the receive. (<em>after
5000 &#8594; garbage_collect(), loop(Workers, N)</em> ).</p>
</div>
</div>
<div class="sect4">
<h5 id="_sub_binaries_and_matching"><a class="link" href="#_sub_binaries_and_matching">Sub Binaries and Matching</a></h5>
<div class="paragraph">
<p>When you match out a part of a binary you get a sub binary.
This sub binary will be a small structure just containing
pointers into the real binary. This increases the reference
count for the binary but uses very little extra space.</p>
</div>
<div class="paragraph">
<p>If a match would create a new copy of the matched part of the binary
it would cost both space and time. So in most cases just doing a
pattern match on a binary and getting a sub binary to work on is just
what you want.</p>
</div>
<div class="paragraph">
<p>There are some degenerate cases, imagine for example that you load
huge file like a book into memory and then you match out a small part
like a chapter to work on. The problem is then that the whole of the
rest of the book is still kept in memory until you are done with
processing the chapter. If you do this for many books, perhaps you
want to get the introduction of every book in your file system, then
you will keep the whole of each book in memory and not just the
introductory chapter. This might lead to huge memory usage.</p>
</div>
<div class="paragraph">
<p>The solution in this case, when you know you only want one small
part of a large binary and you want to have the small part hanging
around for some time, is to use binary:copy/1. This function
is only used for its side effect, which is to actually copy
the sub binary out of the real binary removing the reference to
the larger binary and therefore hopefully letting it be garbage
collected.</p>
</div>
<div class="paragraph">
<p>There is a pretty thorough explanation of how binary construction
and matching is done in the Erlang documentation:
<a href="http://www.erlang.org/doc/efficiency_guide/binaryhandling.html" class="bare">http://www.erlang.org/doc/efficiency_guide/binaryhandling.html</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_garbage_collection"><a class="link" href="#_garbage_collection">12.4.4. Garbage Collection</a></h4>
<!--
This part of the content seems to be good, and probably worthy of being a top-level heading. It might be a bit long, though. - bmacdonald
-->
<div class="paragraph">
<p>When a process runs out of space on the stack and heap the process
will try to reclaim space by doing a minor garbage collection. The
code for this can be found in
<a href="https://github.com/erlang/otp/blob/maint/erts/emulator/beam/erl_gc.c">erl_gc.c</a>.</p>
</div>
<div class="paragraph">
<p>ERTS uses a generational copying garbage collector. A copying
collector means that during garbage collection all live young terms
are copied from the old heap to a new heap. Then the old heap is
discarded. A generational collector works on the principle that
most terms die young, they are temporary terms created, used,
and thrown away. Older terms are promoted to the old generation
which is collected more seldom, with the rational that once
a term has become old it will probably live for a long time.</p>
</div>
<div class="paragraph">
<p>Conceptually a garbage collection cycle works as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First you collect all roots (e.g. the stack).</p>
</li>
<li>
<p>Then for each root, if the root points to a heap allocated object
which doesn&#8217;t have a forwarding pointer you copy the object to the new
heap. For each copied object update the original with a forwarding
pointer to the new copy.</p>
</li>
<li>
<p>Now go through the new heap and do the same as for the roots.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will go through an example to see how this is done in
detail. We will go through a minor collection without an
old generation, and we will only use the stack as the root set.
In reality the process dictionary, trace data and probe data
among other things are also included in the rootset.</p>
</div>
<div class="paragraph">
<p>Let us look at how the call to garbage_collect in the gc_example
behaves. The code will generate a string which is shared by two
elements of a cons and a tuple, the tuple will the be eliminated
resulting in garbage. After the GC there should only be one string on
the heap. That is, first we generate the term
{["Hello","Hello"], "Hello"} (sharing the same string "Hello" in
all instances. Then we just keep the term ["Hello","Hello"] when
triggering a GC.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We will take the opportunity to go through how you, on a
linux system, can use gdb to examine the behavior of ERTS.
You can of course use the debugger of your choice. If you already know
how to use gdb or if you have no interest in going into the debugger
you can just ignore the meta text about how to inspect the system and
just look at the diagrams and the explanations of how the GC works.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">gc_example</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">example</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">example</span><span class="p">()</span> <span class="o">-&gt;</span>
  <span class="nv">T</span> <span class="o">=</span> <span class="nf">gen_data</span><span class="p">(),</span>
  <span class="nv">S</span> <span class="o">=</span> <span class="nb">element</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">T</span><span class="p">),</span>
  <span class="nn">erlang</span><span class="p">:</span><span class="nb">garbage_collect</span><span class="p">(),</span>
  <span class="nv">S</span><span class="p">.</span>

<span class="nf">gen_data</span><span class="p">()</span> <span class="o">-&gt;</span>
 <span class="nv">S</span> <span class="o">=</span> <span class="nf">gen_string</span><span class="p">(</span><span class="sc">$H</span><span class="p">,</span> <span class="sc">$e</span><span class="p">,</span> <span class="sc">$l</span><span class="p">,</span> <span class="sc">$l</span><span class="p">,</span> <span class="sc">$o</span><span class="p">),</span>
 <span class="nv">T</span> <span class="o">=</span> <span class="nf">gen_tuple</span><span class="p">([</span><span class="nv">S</span><span class="p">,</span><span class="nv">S</span><span class="p">],</span><span class="nv">S</span><span class="p">),</span>
 <span class="nv">T</span><span class="p">.</span>

<span class="nf">gen_string</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">C</span><span class="p">,</span><span class="nv">D</span><span class="p">,</span><span class="nv">E</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="p">[</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">C</span><span class="p">,</span><span class="nv">D</span><span class="p">,</span><span class="nv">E</span><span class="p">].</span>

<span class="nf">gen_tuple</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">)</span> <span class="o">-&gt;</span>
 <span class="p">{</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">}.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After compiling the example I start an erlang shell, test the call
and prepare for a new call to the example (without hitting return):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1&gt; gc_example:example().
["Hello","Hello"]
2&gt; spawn(gc_example,example,[]).</pre>
</div>
</div>
<div class="paragraph">
<p>Then I use gdb to attach to my erlang node (OS PID: 2955 in this case)</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ gdb /home/happi/otp/lib/erlang/erts-6.0/bin/beam.smp 2955</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Depending on your settings for ptrace_scope you might have to
precede the gdb invocation with 'sudo'.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then in gdb I set a breakpoint at the start of the main GC function and
let the node continue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(gdb) break garbage_collect_0
(gdb) cont
Continuing.</pre>
</div>
</div>
<div class="paragraph">
<p>Now I hit enter in the Erlang shell and execution stops at the breakpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Breakpoint 1, garbage_collect_0 (A__p=0x7f673d085f88, BIF__ARGS=0x7f673da90340) at beam/bif.c:3771
3771	    FLAGS(BIF_P) |= F_NEED_FULLSWEEP;</pre>
</div>
</div>
<div class="paragraph">
<p>Now we can inspect the PCB of the process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(gdb) p *(Process *) A__p
$1 = {common = {id = 1408749273747, refc = {counter = 1}, tracer_proc = 18446744073709551611, trace_flags = 0, u = {alive = {
        started_interval = 0, reg = 0x0, links = 0x0, monitors = 0x0, ptimer = 0x0}, release = {later = 0, func = 0x0, data = 0x0,
        next = 0x0}}}, htop = 0x7f6737145950, stop = 0x7f6737146000, heap = 0x7f67371458c8, hend = 0x7f6737146010, heap_sz = 233,
  min_heap_size = 233, min_vheap_size = 46422, fp_exception = 0, hipe = {nsp = 0x0, nstack = 0x0, nstend = 0x0, ncallee = 0x7f673d080000,
    closure = 0, nstgraylim = 0x0, nstblacklim = 0x0, ngra = 0x0, ncsp = 0x7f673d0863e8, narity = 0, float_result = 0}, arity = 0,
  arg_reg = 0x7f673d086080, max_arg_reg = 6, def_arg_reg = {393227, 457419, 18446744073709551611, 233, 46422, 2000}, cp = 0x7f673686ac40,
  i = 0x7f673be17748, catches = 0, fcalls = 1994, rcount = 0, schedule_count = 0, reds = 0, group_leader = 893353197987, flags = 0,
  fvalue = 18446744073709551611, freason = 0, ftrace = 18446744073709551611, next = 0x7f673d084cc0, nodes_monitors = 0x0,
  suspend_monitors = 0x0, msg = {first = 0x0, last = 0x7f673d086120, save = 0x7f673d086120, len = 0, mark = 0x0, saved_last = 0x7d0}, u = {
    bif_timers = 0x0, terminate = 0x0}, dictionary = 0x0, seq_trace_clock = 0, seq_trace_lastcnt = 0,
  seq_trace_token = 18446744073709551611, initial = {393227, 457419, 0}, current = 0x7f673be17730, parent = 1133871366675,
  approx_started = 1407857804, high_water = 0x7f67371458c8, old_hend = 0x0, old_htop = 0x0, old_heap = 0x0, gen_gcs = 0,
  max_gen_gcs = 65535, off_heap = {first = 0x0, overhead = 0}, mbuf = 0x0, mbuf_sz = 0, psd = 0x0, bin_vheap_sz = 46422,
  bin_vheap_mature = 0, bin_old_vheap_sz = 46422, bin_old_vheap = 0, sys_task_qs = 0x0, state = {counter = 41002}, msg_inq = {first = 0x0,
    last = 0x7f673d086228, len = 0}, pending_exit = {reason = 0, bp = 0x0}, lock = {flags = {counter = 1}, queue = {0x0, 0x0, 0x0, 0x0},
    refc = {counter = 1}}, scheduler_data = 0x7f673bd6c080, suspendee = 18446744073709551611, pending_suspenders = 0x0, run_queue = {
    counter = 140081362118912}, hipe_smp = {have_receive_locks = 0}}</pre>
</div>
</div>
<div class="paragraph">
<p>Wow, that was a lot of information. The interesting part is about the stack and the heap:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>hend = 0x7f6737146010,
stop = 0x7f6737146000,
htop = 0x7f6737145950,
heap = 0x7f67371458c8,</pre>
</div>
</div>
<div class="paragraph">
<p>By using some helper scripts we can inspect the stack and the heap in a meaningful
way. (see <a href="#AP-listings">Appendix C</a> for the definitions of the scripts in gdb_script.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(gdb) source gdb_scripts
(gdb) print_p_stack A__p
0x00007f6737146008 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
(gdb) print_p_heap A__p
0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f6737145919] cons -&gt; 0x00007f6737145918
0x00007f6737145928 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145920 [0xfffffffffffffffb] NIL
0x00007f6737145918 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145910 [0x00007f67371458f9] cons -&gt; 0x00007f67371458f8
0x00007f6737145908 [0x000000000000048f] 72
0x00007f6737145900 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
0x00007f67371458f8 [0x000000000000065f] 101
0x00007f67371458f0 [0x00007f67371458d9] cons -&gt; 0x00007f67371458d8
0x00007f67371458e8 [0x00000000000006cf] 108
0x00007f67371458e0 [0x00007f67371458c9] cons -&gt; 0x00007f67371458c8
0x00007f67371458d8 [0x00000000000006cf] 108
0x00007f67371458d0 [0xfffffffffffffffb] NIL
0x00007f67371458c8 [0x00000000000006ff] 111</pre>
</div>
</div>
<div class="paragraph">
<p>Here we can see the heap of the process after it has allocated the
list "Hello" on the heap and the cons containing that list twice, and
the tuple containing the cons and the list. The <em>root set</em>, in this
case the stack, contains a pointer to the cons containing two copies
of the list. The tuple is dead, that is, there are no references to
it.</p>
</div>
<div class="paragraph">
<p>The garbage collection starts by calculating the root set and by
allocating a new heap (<em>to space</em>). By stepping into the GC code in the
debugger you can see how this is done. I will not go through the
details here. After a number of steps the execution will reach the
point where all terms in the root set are copied to the new heap. This
starts around (depending on version) line 1272 with a while loop in
erl_gc.c.</p>
</div>
<div class="paragraph">
<p>In our case the root is a cons pointing to address 0x00007f95666597f0
containing the letter (integer) 'H'. When a cons cell is moved from
the current heap, called <em>from space</em>, to <em>to space</em> the value in the
head (or car) is overwritten with a <em>moved cons</em> tag (the value 0).</p>
</div>
<div class="paragraph">
<p>After the first step where the root set is moved, the <em>from space</em>
and the <em>to space</em> looks like this:</p>
</div>
<div class="paragraph">
<p>from space:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(gdb) print_p_heap p
0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f67371445b1] cons -&gt; 0x00007f67371445b0
0x00007f6737145928 [0x0000000000000000] Tuple size 0
0x00007f6737145920 [0xfffffffffffffffb] NIL
0x00007f6737145918 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145910 [0x00007f67371458f9] cons -&gt; 0x00007f67371458f8
0x00007f6737145908 [0x000000000000048f] 72
0x00007f6737145900 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
0x00007f67371458f8 [0x000000000000065f] 101
0x00007f67371458f0 [0x00007f67371458d9] cons -&gt; 0x00007f67371458d8
0x00007f67371458e8 [0x00000000000006cf] 108
0x00007f67371458e0 [0x00007f67371458c9] cons -&gt; 0x00007f67371458c8
0x00007f67371458d8 [0x00000000000006cf] 108
0x00007f67371458d0 [0xfffffffffffffffb] NIL
0x00007f67371458c8 [0x00000000000006ff] 111</pre>
</div>
</div>
<div class="paragraph">
<p>to space:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(gdb) print_heap n_htop-1 n_htop-2
0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f6737145918
0x00007f67371445b0 [0x00007f6737145909] cons -&gt; 0x00007f6737145908</pre>
</div>
</div>
<div class="paragraph">
<p>In <em>from space</em> the head of the first cons cell has been overwritten
with 0 (looks like a tuple of size 0) and the tail has been overwritten
with a forwarding pointer pointing to the new cons cell in the <em>to space</em>.
In <em>to space</em> we now have the first cons cell with two
backward pointers to the head and the tail of the cons in the <em>from space</em>.</p>
</div>
<div class="paragraph">
<p>When the collector is done with the root set the <em>to space</em> contains
backward pointers to all still live terms. At this point the collector
starts sweeping the <em>to space</em>. It uses two pointers n_hp pointing to
the bottom of the unseen heap and n_htop pointing to the top of the heap.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>n_htop:
        0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f6737145918
n_hp    0x00007f67371445b0 [0x00007f6737145909] cons -&gt; 0x00007f6737145908</pre>
</div>
</div>
<div class="paragraph">
<p>The GC will then look at the value pointed to by n_hp, in this case a
cons pointing back to the <em>from space</em>. So it moves that cons to the to
space, incrementing n_htop to make room for the new cons, and
incrementing n_hp to indicate that the first cons is seen.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>from space:

0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f67371445b1] cons -&gt; 0x00007f67371445b0
0x00007f6737145928 [0x0000000000000000] Tuple size 0
0x00007f6737145920 [0xfffffffffffffffb] NIL
0x00007f6737145918 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145910 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
0x00007f6737145908 [0x0000000000000000] Tuple size 0
0x00007f6737145900 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
0x00007f67371458f8 [0x000000000000065f] 101
0x00007f67371458f0 [0x00007f67371458d9] cons -&gt; 0x00007f67371458d8
0x00007f67371458e8 [0x00000000000006cf] 108
0x00007f67371458e0 [0x00007f67371458c9] cons -&gt; 0x00007f67371458c8
0x00007f67371458d8 [0x00000000000006cf] 108
0x00007f67371458d0 [0xfffffffffffffffb] NIL
0x00007f67371458c8 [0x00000000000006ff] 111

to space:

n_htop:
        0x00007f67371445c8 [0x00007f67371458f9] cons -&gt; 0x00007f67371458f8
        0x00007f67371445c0 [0x000000000000048f] 72
n_hp    0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f6737145918
SEEN    0x00007f67371445b0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0</pre>
</div>
</div>
<div class="paragraph">
<p>The same thing then happens with the second cons.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>from space:

0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f67371445b1] cons -&gt; 0x00007f67371445b0
0x00007f6737145928 [0x0000000000000000] Tuple size 0
0x00007f6737145920 [0x00007f67371445d1] cons -&gt; 0x00007f67371445d0
0x00007f6737145918 [0x0000000000000000] Tuple size 0
0x00007f6737145910 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
0x00007f6737145908 [0x0000000000000000] Tuple size 0
0x00007f6737145900 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
0x00007f67371458f8 [0x000000000000065f] 101
0x00007f67371458f0 [0x00007f67371458d9] cons -&gt; 0x00007f67371458d8
0x00007f67371458e8 [0x00000000000006cf] 108
0x00007f67371458e0 [0x00007f67371458c9] cons -&gt; 0x00007f67371458c8
0x00007f67371458d8 [0x00000000000006cf] 108
0x00007f67371458d0 [0xfffffffffffffffb] NIL
0x00007f67371458c8 [0x00000000000006ff] 111

to space:

n_htop:
        0x00007f67371445d8 [0xfffffffffffffffb] NIL
        0x00007f67371445d0 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
        0x00007f67371445c8 [0x00007f67371458f9] cons -&gt; 0x00007f67371458f8
n_hp    0x00007f67371445c0 [0x000000000000048f] 72
SEEN    0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f67371445d0
SEEN    0x00007f67371445b0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0</pre>
</div>
</div>
<div class="paragraph">
<p>The next element in <em>to space</em> is the immediate 72, which is only
stepped over (with <code>n_hp++</code>). Then there is another cons which is moved.</p>
</div>
<div class="paragraph">
<p>The same thing then happens with the second cons.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>from space:

0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f67371445b1] cons -&gt; 0x00007f67371445b0
0x00007f6737145928 [0x0000000000000000] Tuple size 0
0x00007f6737145920 [0x00007f67371445d1] cons -&gt; 0x00007f67371445d0
0x00007f6737145918 [0x0000000000000000] Tuple size 0
0x00007f6737145910 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
0x00007f6737145908 [0x0000000000000000] Tuple size 0
0x00007f6737145900 [0x00007f67371445e1] cons -&gt; 0x00007f67371445e0
0x00007f67371458f8 [0x0000000000000000] Tuple size 0
0x00007f67371458f0 [0x00007f67371458d9] cons -&gt; 0x00007f67371458d8
0x00007f67371458e8 [0x00000000000006cf] 108
0x00007f67371458e0 [0x00007f67371458c9] cons -&gt; 0x00007f67371458c8
0x00007f67371458d8 [0x00000000000006cf] 108
0x00007f67371458d0 [0xfffffffffffffffb] NIL
0x00007f67371458c8 [0x00000000000006ff] 111

to space:

n_htop:
        0x00007f67371445e8 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
        0x00007f67371445e0 [0x000000000000065f] 101
        0x00007f67371445d8 [0xfffffffffffffffb] NIL
n_hp    0x00007f67371445d0 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
SEEN    0x00007f67371445c8 [0x00007f67371458f9] cons -&gt; 0x00007f67371445e0
SEEN    0x00007f67371445c0 [0x000000000000048f] 72
SEEN    0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f67371445d0
SEEN    0x00007f67371445b0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0</pre>
</div>
</div>
<div class="paragraph">
<p>Now we come to a cons that points to a cell that has already been moved.
The GC sees the IS_MOVED_CONS tag at 0x00007f6737145908 and copies the
destination of the moved cell from the tail (<code>*n_hp++ = ptr[1];</code>). This
way sharing is preserved during GC. This step does not affect <em>from space</em>,
but the backward pointer in to space is rewritten.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>to space:

n_htop:
        0x00007f67371445e8 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
        0x00007f67371445e0 [0x000000000000065f] 101
n_hp    0x00007f67371445d8 [0xfffffffffffffffb] NIL
SEEN    0x00007f67371445d0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
SEEN    0x00007f67371445c8 [0x00007f67371458f9] cons -&gt; 0x00007f67371445e0
SEEN    0x00007f67371445c0 [0x000000000000048f] 72
SEEN    0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f67371445d0
SEEN    0x00007f67371445b0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0</pre>
</div>
</div>
<div class="paragraph">
<p>Then the rest of the list (the string) is moved.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>from space:

0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f67371445b1] cons -&gt; 0x00007f67371445b0
0x00007f6737145928 [0x0000000000000000] Tuple size 0
0x00007f6737145920 [0x00007f67371445d1] cons -&gt; 0x00007f67371445d0
0x00007f6737145918 [0x0000000000000000] Tuple size 0
0x00007f6737145910 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
0x00007f6737145908 [0x0000000000000000] Tuple size 0
0x00007f6737145900 [0x00007f67371445e1] cons -&gt; 0x00007f67371445e0
0x00007f67371458f8 [0x0000000000000000] Tuple size 0
0x00007f67371458f0 [0x00007f67371445f1] cons -&gt; 0x00007f67371445f0
0x00007f67371458e8 [0x0000000000000000] Tuple size 0
0x00007f67371458e0 [0x00007f6737144601] cons -&gt; 0x00007f6737144600
0x00007f67371458d8 [0x0000000000000000] Tuple size 0
0x00007f67371458d0 [0x00007f6737144611] cons -&gt; 0x00007f6737144610
0x00007f67371458c8 [0x0000000000000000] Tuple size 0

to space:

n_htop:
n_hp
SEEN    0x00007f6737144618 [0xfffffffffffffffb] NIL
SEEN    0x00007f6737144610 [0x00000000000006ff] 111
SEEN    0x00007f6737144608 [0x00007f6737144611] cons -&gt; 0x00007f6737144610
SEEN    0x00007f6737144600 [0x00000000000006cf] 108
SEEN    0x00007f67371445f8 [0x00007f6737144601] cons -&gt; 0x00007f6737144600
SEEN    0x00007f67371445f0 [0x00000000000006cf] 108
SEEN    0x00007f67371445e8 [0x00007f67371445f1] cons -&gt; 0x00007f67371445f0
SEEN    0x00007f67371445e0 [0x000000000000065f] 101
SEEN    0x00007f67371445d8 [0xfffffffffffffffb] NIL
SEEN    0x00007f67371445d0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
SEEN    0x00007f67371445c8 [0x00007f67371445e1] cons -&gt; 0x00007f67371445e0
SEEN    0x00007f67371445c0 [0x000000000000048f] 72
SEEN    0x00007f67371445b8 [0x00007f67371445d1] cons -&gt; 0x00007f67371445d0
SEEN    0x00007f67371445b0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0</pre>
</div>
</div>
<div class="paragraph">
<p>There are some things to note from this example. When terms are
created in Erlang they are created bottom up, starting with the
elements. The garbage collector works top down, starting with the
top level structure and then copying the elements. This means that
the direction of the pointers change after the first GC. This has
no real implications but it is good to know when looking at actual
heaps. You can not assume that structures should be bottom up.</p>
</div>
<div class="paragraph">
<p>Also note that the GC does a breath first traversal. This means that
locality for one term most often is worse after a GC. With the size of
modern caches this should not be a problem. You could of course create
a pathological example where it becomes a problem, but you can also
create a pathological example where a depth first approach would cause
problems.</p>
</div>
<div class="paragraph">
<p>The third thing to note is that sharing is preserved which is really
important otherwise we might end up using more space after a GC than
before.</p>
</div>
<div class="paragraph">
<p>Generations..</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-8e1c55fdd225142b65683329f9146cb9.png" alt="diag 8e1c55fdd225142b65683329f9146cb9" width="400" height="196">
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>+high_water, old_hend, old_htop, old_heap,
gen_gcs, max_gen_gcs, off_heap,  mbuf, mbuf_sz, psd, bin_vheap_sz,
bin_vheap_mature, bin_old_vheap_sz, bin_old_vheap+.</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_other_interesting_memory_areas"><a class="link" href="#_other_interesting_memory_areas">12.5. Other interesting memory areas</a></h3>
<div class="sect3">
<h4 id="_the_atom_table"><a class="link" href="#_the_atom_table">12.5.1. The atom table.</a></h4>
<div class="paragraph">
<p>TODO
==== Code
TODO
==== Constants
TODO</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-DataStructures"><a class="link" href="#CH-DataStructures">13. Advanced data structures (ETS, DETS, Mnesia)</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="CH-IO"><a class="link" href="#CH-IO">14. IO, Ports and Networking (10p)</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Within Erlang, all communication is done by asynchronous signaling.
The communication between an Erlang node and the outside world is done
through a <em>port</em>. A port is an interface between Erlang processes and
an external resource. In early versions of Erlang a port behaved very
much in the same way as a process and you communicated by sending and
receiving signals. You can still communicate with ports this way but
there are also a number of BIFs to communicate directly with a port.</p>
</div>
<div class="paragraph">
<p>In this chapter we will look at how ports are used as a common
interface for all IO, how ports communicate with the outside world and
how Erlang processes communicate with ports. But first we will look
at how standard IO works on a higher level.</p>
</div>
<div class="sect2">
<h3 id="_standard_io"><a class="link" href="#_standard_io">14.1. Standard IO</a></h3>
<div class="ulist">
<ul>
<li>
<p>IO protocol</p>
</li>
<li>
<p>group leader</p>
</li>
<li>
<p>erlang:display&#8201;&#8212;&#8201;a BIF that sends directly to node&#8217;s std out</p>
</li>
<li>
<p>io:format&#8201;&#8212;&#8201;sends through io protocol and the group leader</p>
</li>
<li>
<p>Redirecting standard IO at startup (detached mode)</p>
</li>
<li>
<p>Standard in and out</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_ports_2"><a class="link" href="#_ports_2">14.2. Ports</a></h3>
<div class="paragraph">
<p>A port is the process like interface between Erlang processes and
everything that is not Erlang processes. The programmer can to
a large extent pretend that everything in the world behaves like
an Erlang process and communicate through message passing.</p>
</div>
<div class="paragraph">
<p>Each port has an owner, more on this later, but all processes
who know about the port can send messages to the port.
In figure REF we see how a process can communicate with the
port and how the port is communicating to the world outside the
Erlang node.</p>
</div>
<div id="port_communication" class="imageblock">
<div class="content">
<img src="images/diag-b2fba46b64229b4d62adef15206b3442.png" alt="diag b2fba46b64229b4d62adef15206b3442" width="480" height="252">
</div>
<div class="title">Figure 25. Port Communication</div>
</div>
<div class="paragraph">
<p>Process P1 has opened a port (Port1) to a file, and is the owner of
the port and can receive messages from the port. Process P2 also has a
handle to the port and can send messages to the port. The processes
and the port reside in an Erlang node. The file lives in the file and
operating system on the outside of the Erlang node.</p>
</div>
<div class="paragraph">
<p>If the port owner dies or is terminated the port is also killed.
When a port terminates all external resources should also be cleaned
up. This is true for all ports that come with Erlang and if you
implement your own port you should make sure it does this cleanup.</p>
</div>
<div class="sect3">
<h4 id="_different_types_of_ports"><a class="link" href="#_different_types_of_ports">14.2.1. Different types of Ports</a></h4>
<div class="paragraph">
<p>There are three different classes of ports: file descriptors, external
programs and drivers. A file descriptor port makes it possible for a
process to access an already opened file descriptor. A port to an
external program invokes the external program as a separate OS
process. A driver port requires a driver to be loaded in the Erlang
node.</p>
</div>
<div class="paragraph">
<p>All ports are created by a call to erlang:open_port(PortName,
PortSettings).</p>
</div>
<div class="paragraph">
<p>A file descriptor port is opened with {fd, In, Out} as the
PortName. This class of ports is used by some internal ERTS servers
like the old shell. They are considered to not be very efficient and
hence seldom used.</p>
</div>
<div class="paragraph">
<p>An external program port can be used to execute any program in the
native OS of the Erlang node. To open an external program port you
give either the argument {spawn, Command} or {spawn_executable,
FileName} with the name of the external program. This is the easiest
and one of the safest way to interact with code written in other
programming languages. Since the external program is executed in its
own OS process it will not bring down the Erlang node if it
crashes. (It can of course use up all CPU or memory or do a number of
other things to bring down the whole OS, but it is much safer than a
linked in driver or a NIF).</p>
</div>
<div class="paragraph">
<p>A driver port requires that a driver program has been loaded with
ERTS. Such a port is started with either {spawn, Command} or
{spawn_driver, Command}. Writing your own linked in driver can be an
efficient way to interface for example some C library code that you
would like to use. Note that a linked in driver executes in the same
OS process as the Erlang node and a crash in the driver will bring
down the whole node. Details about how to write an Erlang driver in
general can be found in <a href="#CH-C">Chapter 16</a>.</p>
</div>
<div class="paragraph">
<p>Erlang/OTP comes with a number port drivers implementing the
predefined port types. There are the common drivers available on all
platforms: <code>tcp_inet</code>, <code>udp_inet</code>, <code>sctp_inet</code>, <code>efile</code>, <code>zlib_drv</code>,
<code>ram_file_drv</code>, <code>binary_filer</code>, <code>tty_sl</code>. These drivers are used to
implement e.g. file handling and sockets in Erlang. On Windows there
is also a driver to access the registry: <code>registry_drv</code>. And on most
platforms there are example drivers to use when implementing your own
driver like: <code>multi_drv</code> and <code>sig_drv</code>.</p>
</div>
<div id="entities_on_node" class="imageblock">
<div class="content">
<img src="images/diag-63026105c92ef56632ac6394439e157e.png" alt="diag 63026105c92ef56632ac6394439e157e" width="1080" height="182">
</div>
<div class="title">Figure 26. Entities on an Erlang Node</div>
</div>
<div class="sect4">
<h5 id="_ports_to_file_descriptors"><a class="link" href="#_ports_to_file_descriptors">Ports to file descriptors</a></h5>
<div class="paragraph">
<p>Creating</p>
</div>
<div class="paragraph">
<p>Commands</p>
</div>
<div class="paragraph">
<p>Examples</p>
</div>
<div class="paragraph">
<p>Implementation</p>
</div>
</div>
<div class="sect4">
<h5 id="_ports_to_spawned_os_processes"><a class="link" href="#_ports_to_spawned_os_processes">Ports to Spawned OS Processes</a></h5>
<div class="paragraph">
<p>Creating</p>
</div>
<div class="paragraph">
<p>Commands</p>
</div>
<div class="paragraph">
<p>Implementation</p>
</div>
<div class="paragraph">
<p>Windows</p>
</div>
</div>
<div class="sect4">
<h5 id="_ports_to_linked_in_drivers"><a class="link" href="#_ports_to_linked_in_drivers">Ports to Linked in Drivers</a></h5>
<div class="paragraph">
<p>Creating</p>
</div>
<div class="paragraph">
<p>Commands</p>
</div>
<div class="paragraph">
<p>Implementation</p>
</div>
<div class="paragraph">
<p>See chapter <a href="#CH-C">Chapter 16</a> for details of how to implement your own
linked in driver.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_distributed_erlang"><a class="link" href="#_distributed_erlang">14.3. Distributed Erlang</a></h3>

</div>
<div class="sect2">
<h3 id="_sockets_udp_and_tcp"><a class="link" href="#_sockets_udp_and_tcp">14.4. Sockets, UDP and TCP</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Distribution"><a class="link" href="#CH-Distribution">15. Distribution</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="CH-C"><a class="link" href="#CH-C">16. Interfacing C&#8201;&#8212;&#8201;BIFs NIFs and Linked in Drivers</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="CH-Native"><a class="link" href="#CH-Native">17. Native Code</a></h2>
<div class="sectionbody">

</div>
</div>
<h1 id="P-Running" class="sect0"><a class="link" href="#P-Running">II: Running ERTS</a></h1>
<div class="sect1">
<h2 id="CH-Tracing"><a class="link" href="#CH-Tracing">18. Tracing</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="CH-Debugging"><a class="link" href="#CH-Debugging">19. Debugging</a></h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This chapter is still a stub and it&#8217;s being heavily worked
on. If planning a major addition to this chapter, please synchronize
with the authors to avoid conflicts or duplicated efforts. You are
still welcome to submit your feedback using a GitHub Issue. You can
use the same mechanism to suggest sections that you believe should be
included in this chapter, too.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_preliminary_outline"><a class="link" href="#_preliminary_outline">19.1. Preliminary Outline</a></h3>
<div class="ulist">
<ul>
<li>
<p>Introduction</p>
</li>
<li>
<p>debugger</p>
</li>
<li>
<p>dbg</p>
</li>
<li>
<p>redbug</p>
</li>
<li>
<p>Crash dumps</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_introduction"><a class="link" href="#_introduction">19.2. Introduction</a></h3>
<div class="paragraph">
<p>Debugging is the <em>art</em> of identifying and removing errors
(i.e. <em>bugs</em>) from software. This section covers the most common
Erlang debugging tools and techniques. Even if step-by-step debugging
tools such as the
<a href="http://erlang.org/doc/apps/debugger/debugger_chapter.html"><em>Debugger</em></a>
exist in Erlang, the most effective debugging techniques in Erlang are
the ones based on the so-called Erlang <em>tracing facilities</em>, which
will be discussed in detail in chapter <a href="#CH-Tracing">Chapter 18</a>. This chapter
also covers the concept of <em>Crash Dump</em>, a readable text file
generated by the Erlang Runtime System when an unrecoverable error is
detected, for example when the system runs out of memory or when an
emulator limit is reached. <em>Crash Dumps</em> can are extremely precious
for post-mortem analysis of Erlang nodes and you will learn how to
read and interpret them.</p>
</div>
</div>
<div class="sect2">
<h3 id="_debugger"><a class="link" href="#_debugger">19.3. debugger</a></h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect2">
<h3 id="_dbg"><a class="link" href="#_dbg">19.4. dbg</a></h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect2">
<h3 id="_redbug"><a class="link" href="#_redbug">19.5. Redbug</a></h3>
<div class="paragraph">
<p><em>Redbug</em> is a debugging utility which allows you to easily interact
with the Erlang <em>tracing facilities</em>. It is an external library and
therefore it has to be installed separately. One of the best Redbug
features is its ability to shut itself down in case of overload.</p>
</div>
<div class="sect3">
<h4 id="_installing_redbug"><a class="link" href="#_installing_redbug">19.5.1. Installing Redbug</a></h4>
<div class="paragraph">
<p>You can clone redbug via:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git clone https://github.com/massemanet/redbug</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then compile it with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>redbug
<span class="nv">$ </span>make</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ensure <code>redbug</code> is included in your path when starting an Erlang shell
and you are set to go. This can be done by explicitely adding the path
to the redbug <em>beam</em> files when invoking <code>erl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>erl <span class="nt">-pa</span> /path/to/redbug/ebin</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, the following line can be added to the <code>~/.erlang</code>
file. This will ensure that the path to redbug gets included
automatically at every startup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nn">code</span><span class="p">:</span><span class="nf">add_patha</span><span class="p">(</span><span class="s">"/path/to/redbug/ebin"</span><span class="p">).</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_redbug"><a class="link" href="#_using_redbug">19.5.2. Using Redbug</a></h4>
<div class="paragraph">
<p>Redbug is safe to be used in production, thanks to a self-protecting
mechanism against overload, which kills the tool in case too many
tracing messages are sent, preventing the Erlang node to become
overloaded. Let&#8217;s see it in action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="sc">$ </span><span class="n">erl</span>
<span class="nv">Erlang</span><span class="o">/</span><span class="nv">OTP</span> <span class="mi">19</span> <span class="p">[</span><span class="n">erts</span><span class="o">-</span><span class="mi">8</span><span class="p">.</span><span class="mi">2</span><span class="p">]</span> <span class="p">[...]</span>

<span class="nv">Eshell</span> <span class="nv">V8</span><span class="p">.</span><span class="mi">2</span> <span class="p">(</span><span class="n">abort</span> <span class="n">with</span> <span class="err">^</span><span class="nv">G</span><span class="p">)</span>
<span class="mi">1</span><span class="o">&gt;</span> <span class="nf">l</span><span class="p">(</span><span class="n">redbug</span><span class="p">).</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="p">{</span><span class="n">module</span><span class="p">,</span><span class="n">redbug</span><span class="p">}</span>
<span class="mi">2</span><span class="o">&gt;</span> <span class="nn">redbug</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="s">"lists:sort/1"</span><span class="p">).</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="p">{</span><span class="mi">30</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span>
<span class="mi">3</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]).</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>

<span class="c">% 15:20:20 &lt;0.31.0&gt;({erlang,apply,2}) <i class="conum" data-value="3"></i><b>(3)</b>
% lists:sort([3,2,1])
</span><span class="n">redbug</span> <span class="n">done</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">-</span> <span class="mi">1</span> <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First, we ensure that the <code>redbug</code> module is available and loaded.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We then start <code>redbug</code>. We are interested in the function
named <code>sort</code> with arity <code>1</code>, exported by the module <code>lists</code>.
Remember that, in Erlang lingo, the <em>arity</em> represents the number
of input arguments that a given function takes.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Finally, we invoke the <code>lists:sort/1</code> function  and we verify that
a message is produced by <em>redbug</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>After the default timeout (15 seconds) is reached, redbug stops and
displays the message "redbug done". Redbug is also kind enough to
tell us the reason why it stopped (<em>timeout</em>) and the number
of messages that collected until that point (<em>1</em>).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lets now look at the actual message produced by redbug. By default
messages are printed to the standard output, but its also possible to
dump them to file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="c">% 15:20:20 &lt;0.31.0&gt;({erlang,apply,2})
</span><span class="err">%</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Depending on the version of redbug you are using, you may get a
slightly different message. In this case, the message is split across
two lines. The first line contains a <strong>timestamp</strong>, the <strong>Process Identifier</strong>
(or <em>PID</em>) of the Erlang process which invoked the function and the
<strong>caller</strong> function. The second line contains the function called,
including the input arguments. Both lines are prepended with a <code>%</code>,
which reminds us of the syntax for Erlang comments.</p>
</div>
<div class="paragraph">
<p>We can also ask Redbug to produce an extra message for the return
value. This is achieved using the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">4</span><span class="o">&gt;</span> <span class="nn">redbug</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="s">"lists:sort/1-&gt;return"</span><span class="p">).</span>
<span class="p">{</span><span class="mi">30</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s invoke the <code>lists:sort/1</code> function again. This time the output
from redbug is slightly different.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">5</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]).</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>

<span class="c">% 15:35:52 &lt;0.31.0&gt;({erlang,apply,2})
% lists:sort([3,2,1])
</span>
<span class="c">% 15:35:52 &lt;0.31.0&gt;({erlang,apply,2})
% lists:sort/1 -&gt; [1,2,3]
</span><span class="n">redbug</span> <span class="n">done</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">-</span> <span class="mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case two messages are produced, one when entering the function
and one when leaving the same function.</p>
</div>
<div class="paragraph">
<p>When dealing with real code, trace messages can be complex and
therefore hardly readable. Lets see what happens if we try to trace
the sorting of a list containing 10.000 elements.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">6</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">(</span><span class="nn">lists</span><span class="p">:</span><span class="nf">seq</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)).</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span>
<span class="mi">23</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">29</span><span class="p">|...]</span>

<span class="c">% 15:48:42.208 &lt;0.77.0&gt;({erlang,apply,2})
% lists:sort([10000,9999,9998,9997,9996,9995,9994,9993,9992,9991,9990,9989,9988,9987,9986,
% 9985,9984,9983,9982,9981,9980,9979,9978,9977,9976,9975,9974,9973,9972,9971,
% 9970,9969,9968,9967,9966,9965,9964,9963,9962,9961,9960,9959,9958,9957,9956,
% 9955,9954,9953,9952,9951,9950,9949,9948,9947,9946,9945,9944,9943,9942,9941,
% 9940,9939,9938,9937,9936,9935,9934,9933,9932,9931,9930,9929,9928,9927,9926,
% 9925,9924,9923,9922,9921,9920,9919,9918,9917,9916,9915,9914,9913,9912,9911,
% [...]
% 84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,
% 59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,
% 34,33,32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,
% 8,7,6,5,4,3,2,1])
</span>
<span class="c">% 15:48:42.210 &lt;0.77.0&gt;({erlang,apply,2}) lists:sort/1 -&gt;
% [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,
% 23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,
% 42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,
% 61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,
% 80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,
% 99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,
% [...]
% 9951,9952,9953,9954,9955,9956,9957,9958,9959,9960,9961,
% 9962,9963,9964,9965,9966,9967,9968,9969,9970,9971,9972,
% 9973,9974,9975,9976,9977,9978,9979,9980,9981,9982,9983,
% 9984,9985,9986,9987,9988,9989,9990,9991,9992,9993,9994,
% 9995,9996,9997,9998,9999,10000]
</span><span class="n">redbug</span> <span class="n">done</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">-</span> <span class="mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Most of the output has been truncated here, but you should get the
idea. To improve things, we can use a couple of redbug options.  The
option <code>{arity, true}</code> instructs redbug to only display the number of
input arguments for the given function, instead of their actual
value. The <code>{print_return, false}</code> option tells Redbug not to display
the return value of the function call, and to display a <code>&#8230;&#8203;</code>  symbol,
instead. Lets see these options in action.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">7</span><span class="o">&gt;</span> <span class="nn">redbug</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="s">"lists:sort/1-&gt;return"</span><span class="p">,</span> <span class="p">[{</span><span class="n">arity</span><span class="p">,</span> <span class="n">true</span><span class="p">},</span> <span class="p">{</span><span class="n">print_return</span><span class="p">,</span> <span class="n">false</span><span class="p">}]).</span>
<span class="p">{</span><span class="mi">30</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span>

<span class="mi">8</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">(</span><span class="nn">lists</span><span class="p">:</span><span class="nf">seq</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)).</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span>
<span class="mi">23</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">29</span><span class="p">|...]</span>

<span class="c">% 15:55:32 &lt;0.77.0&gt;({erlang,apply,2})
% lists:sort/1
</span>
<span class="c">% 15:55:32 &lt;0.77.0&gt;({erlang,apply,2})
% lists:sort/1 -&gt; '...'
</span><span class="n">redbug</span> <span class="n">done</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">-</span> <span class="mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, redbug stops after 15 seconds or after 10 messages are
received. Those values are a safe default, but they are rarely
enough. You can bump those limits by using the <code>time</code> and <code>msgs</code>
options. <code>time</code> is expressed in milliseconds.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">9</span><span class="o">&gt;</span> <span class="nn">redbug</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="s">"lists:sort/1-&gt;return"</span><span class="p">,</span> <span class="p">[{</span><span class="n">arity</span><span class="p">,</span> <span class="n">true</span><span class="p">},</span> <span class="p">{</span><span class="n">print_return</span><span class="p">,</span> <span class="n">false</span><span class="p">},</span> <span class="p">{</span><span class="n">time</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">},</span> <span class="p">{</span><span class="n">msgs</span><span class="p">,</span> <span class="mi">100</span><span class="p">}]).</span>
<span class="p">{</span><span class="mi">30</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also activate redbug for several function calls
simultaneously. Let&#8217;s enable tracing for both functions <code>lists:sort/1</code>
and <code>lists:sort_1/3</code> (an internal function used by the former):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">10</span><span class="o">&gt;</span> <span class="nn">redbug</span><span class="p">:</span><span class="nf">start</span><span class="p">([</span><span class="s">"lists:sort/1-&gt;return"</span><span class="p">,</span> <span class="s">"lists:sort_1/3-&gt;return"</span><span class="p">]).</span>
<span class="p">{</span><span class="mi">30</span><span class="p">,</span><span class="mi">2</span><span class="p">}</span>

<span class="mi">11</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]).</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>

<span class="c">% 18:39:26 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort([4,4,2,1])
</span>
<span class="c">% 18:39:26 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort_1(4, [2,1], [4])
</span>
<span class="c">% 18:39:26 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort_1/3 -&gt; [1,2,4,4]
</span>
<span class="c">% 18:39:26 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort/1 -&gt; [1,2,4,4]
</span><span class="n">redbug</span> <span class="n">done</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">-</span> <span class="mi">2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Last but not least, redbug offers the ability to only display results
for matching input arguments. This is when the syntax looks a bit like
magic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">12</span><span class="o">&gt;</span> <span class="nn">redbug</span><span class="p">:</span><span class="nf">start</span><span class="p">([</span><span class="s">"lists:sort([1,2,5])-&gt;return"</span><span class="p">]).</span>
<span class="p">{</span><span class="mi">30</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span>

<span class="mi">13</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]).</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>

<span class="mi">14</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">]).</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>

<span class="c">% 18:45:27 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort([1,2,5])
</span>
<span class="c">% 18:45:27 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort/1 -&gt; [1,2,5]
</span><span class="n">redbug</span> <span class="n">done</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">-</span> <span class="mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, we are telling redbug that we are only
interested in function calls to the <code>lists:sort/1</code> function when the
input arguments is the list <code>[1,2,5]</code>. This allows us to remove a huge
amount of noise in the case our target function is used by many actors
at the same time and we are only interested in a specific use case.
Oh, and dont forget that you can use the underscore as a wildcard:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">15</span><span class="o">&gt;</span> <span class="nn">redbug</span><span class="p">:</span><span class="nf">start</span><span class="p">([</span><span class="s">"lists:sort([1,_,5])-&gt;return"</span><span class="p">]).</span>  <span class="p">{</span><span class="mi">30</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span>

<span class="mi">16</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">]).</span>  <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>

<span class="c">% 18:49:07 &lt;0.32.0&gt;({erlang,apply,2}) lists:sort([1,2,5])
</span>
<span class="c">% 18:49:07 &lt;0.32.0&gt;({erlang,apply,2}) lists:sort/1 -&gt; [1,2,5]
</span>
<span class="mi">17</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]).</span>  <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>

<span class="c">% 18:49:09 &lt;0.32.0&gt;({erlang,apply,2}) lists:sort([1,4,5])
</span>
<span class="c">% 18:49:09 &lt;0.32.0&gt;({erlang,apply,2}) lists:sort/1 -&gt; [1,4,5] redbug
</span><span class="err">%</span> <span class="n">done</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">-</span> <span class="mi">2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This section does not pretend to be a comprehensive guide to redbug,
but it should be enough to get you going. To get a full list of the
available options for redbug, you can ask the tool itself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">18</span><span class="o">&gt;</span> <span class="nn">redbug</span><span class="p">:</span><span class="nf">help</span><span class="p">().</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_crash_dumps"><a class="link" href="#_crash_dumps">19.6. Crash Dumps</a></h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Ops"><a class="link" href="#CH-Ops">20. Operation and Maintenance</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>One guiding principle behind the design of
the runtime system is that bugs are more or less
inevitable. Even if through an enormous
effort you manage to build a bug free application
you will soon learn that the world or your user
changes and your application will need to be "fixed."</p>
</div>
<div class="paragraph">
<p>The Erlang runtime system is designed to facilitate
change and to minimize the impact of bugs.</p>
</div>
<div class="paragraph">
<p>The impact of bugs is minimized by compartmentalization. This is done
from the lowest level where each data structure is separate and
immutable to the highest level where running systems are dived into
separate nodes. Change is facilitated by making it easy to upgrade code
and interacting and examining a running system.</p>
</div>
<div class="sect2">
<h3 id="_connecting_to_the_system"><a class="link" href="#_connecting_to_the_system">20.1. Connecting to the System</a></h3>
<div class="paragraph">
<p>We will look at many different ways to monitor and
maintain a running system. There are many tools and
techniques available but we must not forget the
most basic tool, the shell and the ability to connect
a shell to node.</p>
</div>
<div class="paragraph">
<p>In order to connect two nodes they need to share or
know a secret pass phrase, called a cookie. As long
as you are running both nodes on the same machine
and the same user starts them they will automatically
share the cookie (in the file <code>$HOME/.erlang.cookie</code>).</p>
</div>
<div class="paragraph">
<p>We can see this in action by starting two nodes, one Erlang node
and one Elixir node. First we start an Erlang node called
<code>node1</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="sc">$ </span><span class="n">erl</span> <span class="o">-</span><span class="n">sname</span> <span class="n">node1</span>
<span class="nv">Erlang</span><span class="o">/</span><span class="nv">OTP</span> <span class="mi">19</span> <span class="p">[</span><span class="n">erts</span><span class="o">-</span><span class="mi">8</span><span class="p">.</span><span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="n">source</span><span class="o">-</span><span class="mi">0567896</span><span class="p">]</span> <span class="p">[</span><span class="mi">64</span><span class="o">-</span><span class="n">bit</span><span class="p">]</span> <span class="p">[</span><span class="nn">smp</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
              <span class="p">[</span><span class="n">async</span><span class="o">-</span><span class="nn">threads</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="p">[</span><span class="n">hipe</span><span class="p">]</span> <span class="p">[</span><span class="n">kernel</span><span class="o">-</span><span class="nn">poll</span><span class="p">:</span><span class="n">false</span><span class="p">]</span>

<span class="nv">Eshell</span> <span class="nv">V8</span><span class="p">.</span><span class="mi">1</span>  <span class="p">(</span><span class="n">abort</span> <span class="n">with</span> <span class="err">^</span><span class="nv">G</span><span class="p">)</span>
<span class="p">(</span><span class="n">node1</span><span class="p">@</span><span class="nv">GDC08</span><span class="p">)</span><span class="mi">1</span><span class="o">&gt;</span> <span class="nb">nodes</span><span class="p">().</span>
<span class="p">[]</span>
<span class="p">(</span><span class="n">node1</span><span class="p">@</span><span class="nv">GDC08</span><span class="p">)</span><span class="mi">2</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we start an Elixir node called <code>node2</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>iex <span class="nt">--sname</span> node2
Erlang/OTP 19 <span class="o">[</span>erts-8.1] <span class="o">[</span>source-0567896] <span class="o">[</span>64-bit] <span class="o">[</span>smp:4:4]
              <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

Interactive Elixir <span class="o">(</span>1.4.0<span class="o">)</span> - press Ctrl+C to <span class="nb">exit</span> <span class="o">(</span><span class="nb">type </span>h<span class="o">()</span> ENTER <span class="k">for </span><span class="nb">help</span><span class="o">)</span>
iex<span class="o">(</span>node2@GDC08<span class="o">)</span>1&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In Elixir we can connect the nodes by running the command <code>Node.connect</code>
name. In Erlang you do this with <code>net_kernel:connect(Name)</code>.
The node connection is bidirectional so you only
need to run the command on one of the nodes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>iex(node2@GDC08)1&gt; Node.connect :node1@GDC08
true
iex(node2@GDC08)2&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>In the distributed case this is somewhat more complicated since we
need to make sure that all nodes know or share the cookie.  This can
be done in three ways. You can set the cookie used when talking to a
specific node, you can set the same cookie for all systems at start up
with the <code>-set_cookie</code> parameter, or you can copy the file
<code>.erlang.cookie</code> to the home directory of the user running the system
on each machine.</p>
</div>
<div class="paragraph">
<p>The last alternative, to have the same cookie
in the cookie file of each machine in the system is usually the best
option since it makes it easy to connect to the nodes from a local OS
shell. Just set up some secure way of logging in to the machine either
through VPN or ssh. In the next section we will see how to then
connect a shell to a running node.</p>
</div>
<div class="paragraph">
<p>Using the second option it might look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">happi@GDC08:~<span class="nv">$ </span><span class="nb">cat</span> ~/.erlang.cookie
pepparkaka
happi@GDC08:~<span class="nv">$ </span>ssh gds01

happi@gds01:~<span class="nv">$ </span>erl <span class="nt">-sname</span> node3 <span class="nt">-setcookie</span> pepparkaka
Erlang/OTP 18 <span class="o">[</span>erts-7.3] <span class="o">[</span>source-d2a6d81] <span class="o">[</span>64-bit] <span class="o">[</span>smp:8:8]
              <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

Eshell V7.3  <span class="o">(</span>abort with ^G<span class="o">)</span>
<span class="o">(</span>node3@gds01<span class="o">)</span>1&gt; net_kernel:connect<span class="o">(</span><span class="s1">'node1@GDC08'</span><span class="o">)</span><span class="nb">.</span>
<span class="nb">true</span>
<span class="o">(</span>node3@gds01<span class="o">)</span>2&gt; nodes<span class="o">()</span><span class="nb">.</span>
<span class="o">[</span>node1@GDC08,node2@GDC08]
<span class="o">(</span>node3@gds01<span class="o">)</span>3&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A Potential Problem with Different Cookies
  Note that the default for the Erlang distribution is to create a
  fully connected network. That is, all nodes are connected to all
  other nodes in the network. In the example, once node3 connects to
  node1 it also is connected to node2.
  If each node has its own cookie you will have to tell each node the
  cookies of each other node before you try to connect them.  You can
  start up a node with the flag <code>-connect_all false</code> in order to
  prevent the system from trying to make a fully connected network.
  Alternatively, you can start a node as hidden with the flag
  <code>-hidden</code>, which makes node connections to that node non transitive.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that we know how to connect nodes, even on different machines,
to each other, we can look at how to connect a shell to a node.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_shell"><a class="link" href="#_the_shell">20.2. The Shell</a></h3>
<div class="paragraph">
<p>The Elixir and the Erlang shells works much the same way as a shell or
a terminal window on your computer, except that they give you a
terminal window directly into your runtime system. This gives you an
extremely powerful tool, a basically CLI with full access to the runtime.
This is fantastic for operation and maintenance.</p>
</div>
<div class="paragraph">
<p>In this section we will look at different ways of connecting to
a node through the shell and some of the shell&#8217;s perhaps
less known but more powerful features.</p>
</div>
<div class="sect3">
<h4 id="_configuring_your_shell"><a class="link" href="#_configuring_your_shell">20.2.1. Configuring Your Shell</a></h4>
<div class="paragraph">
<p>Both the Elixir shell and the Erlang shell can be configured
to provide you with shortcuts for functions that you often use.</p>
</div>
<div class="paragraph">
<p>The Elixir shell will look for the file <code>.iex.exs</code> first in
the local directory and then in the users home directory.
The code in this file is executed in the shell process
and all variable bindings will be available in the shell.</p>
</div>
<div class="paragraph">
<p>In this file you can configure aspects such as the syntax
coloring and the size of the history. [See hexdocs
for a full
documentation.](<a href="https://hexdocs.pm/iex/IEx.html#module-the-iex-exs-file" class="bare">https://hexdocs.pm/iex/IEx.html#module-the-iex-exs-file</a>)</p>
</div>
<div class="paragraph">
<p>You can also execute arbitrary code in the shell context.</p>
</div>
<div class="paragraph">
<p>When the Erlang runtime system starts, it first interprets the
code in the Erlang configuration file. The default location
of this file is in the users home directory <code>~/.erlang</code>.</p>
</div>
<div class="paragraph">
<p>This file is usually used to load the user default settings for
the shell by adding the line</p>
</div>
<div class="listingblock">
<div class="content">
<pre>code:load_abs("/home/happi/.config/erlang/user_default").</pre>
</div>
</div>
<div class="paragraph">
<p>Replace "/home/happi/.config/erlang/" with the absolute path
you want to use.</p>
</div>
<div class="paragraph">
<p>If you call a local function from the shell it will try to
call this function first in the module <code>user_default</code> and
then in the module <code>shell_default</code> (located in <code>stdlib</code>).
This is how command such as <code>ls()</code> and <code>help()</code> are implemented.</p>
</div>
</div>
<div class="sect3">
<h4 id="_connecting_a_shell_to_a_node"><a class="link" href="#_connecting_a_shell_to_a_node">20.2.2. Connecting a Shell to a Node</a></h4>
<div class="paragraph">
<p>When running a production system you will want to start the nodes in
daemon mode through <code>run_erl</code>. We will go through how to start a node
and some of the best practices for deployment and running in
production in [xxx](#ch.live). Fortunately, even when you have started
a system in daemon mode, without a shell, you can connect a shell to
the system. There are actually several ways to do that. Most of these
methods rely on the normal distribution mechnaisms and hence require
that you have the same Erlang cookie on both machines as described
in the previous section.</p>
</div>
<div class="sect4">
<h5 id="_remote_shell_remsh"><a class="link" href="#_remote_shell_remsh">Remote shell (Remsh)</a></h5>
<div class="paragraph">
<p>The easiest and probably the most common way to connect to an Erlang
node is by starting a named node that connects to the system node
through a remote shell. This is done with the <code>erl</code> command line flag
<code>-remsh Name</code>.  Note that you need to start a named node in order to
be able to connect to another node, so you also need the <code>-name</code> or
<code>-sname</code> flag. Also, note that these are arguments to the Erlang
runtime so if you are starting an Elixir shell you need to add an
extra <code>-</code> to the flags, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>iex <span class="nt">--sname</span> node4 <span class="nt">--remsh</span> node2@GDC08
Erlang/OTP 19 <span class="o">[</span>erts-8.1] <span class="o">[</span>source-0567896] <span class="o">[</span>64-bit] <span class="o">[</span>smp:4:4]
              <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

Interactive Elixir <span class="o">(</span>1.4.0<span class="o">)</span> - press Ctrl+C to <span class="nb">exit</span> <span class="o">(</span><span class="nb">type </span>h<span class="o">()</span> ENTER <span class="k">for </span><span class="nb">help</span><span class="o">)</span>
iex<span class="o">(</span>node2@GDC08<span class="o">)</span>1&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another thing to note here is that in order to start a remote Elixir shell
you need to have IEx running on that node. There is no problem to connect
Elixr and Erlang nodes to each other as we saw in the previous section,
but you need to have the code of the shell you want to run loaded on the
node you connect to.</p>
</div>
<div class="paragraph">
<p>It is also worth noting that there is no security built into either
the normal Erlang distribution or to the remote shell implementation.
You do not want to have your system node exposed to the internet and
you do not want to connect from your local machine to a node. The safest
way is probably to have a VPN tunnel to your live environment and use ssh
to connect a machine running one of your live nodes. Then you can connect
to one of the nodes using <code>remsh</code>.</p>
</div>
<div class="paragraph">
<p>It is important to understand that there are actually two nodes
involved when you start a remote shell. The local node, named <code>node4</code>
in the previous example and the remote node <code>node2</code>. These nodes can
be on the same machine or on different machines. The local node is
always running on the machine on which you gave the <code>iex</code> or <code>erl</code>
command. On the local node there is a process running the <code>tty</code>
program which interacts with the terminal window. The actual shell
process runs on the remote node. This means, first of all, that the
code for the shell you want to run (i.e. iex or the Erlang shell) has
to exist at the remote node. It also means that code is executed on
the remote node. And it also means that any shell default settings are
taken from the settings of the remote machine.</p>
</div>
<div class="paragraph">
<p>Imagine that we have the following <code>.erlang</code> file in our home directory
on the machine GDC08.</p>
</div>
<div class="paragraph">
<p>code:load_abs("/home/happi/.config/erlang/user_default").</p>
</div>
<div class="paragraph">
<p>io:format("ERTS is starting in <sub>s</sub>n",[os:cmd("pwd")]).</p>
</div>
<div class="paragraph">
<p>And the &lt;filename&gt;user_default.erl&lt;/filename&gt;
file looks like this:</p>
</div>
<div class="paragraph">
<p>-module(user_default).</p>
</div>
<div class="paragraph">
<p>-export([tt/0]).</p>
</div>
<div class="paragraph">
<p>tt() &#8594;
  test.</p>
</div>
<div class="paragraph">
<p>Then we create two directories <code>~/example/dir1</code> and <code>~/example/dir2</code>
and we put two different <code>.iex.exs</code> files in those directories.</p>
</div>
<div class="paragraph">
<p>IO.puts "iEx starting in "
pwd()
IO.puts "iEx starting on "
IO.puts Node.self</p>
</div>
<div class="paragraph">
<p>IEx.configure(
  colors: [enabled: true],
  alive_prompt: [
    "\e[G",
    "(%node)",
    "%prefix",
    "&lt;d1&gt;",
  ] |&gt; IO.ANSI.format |&gt; IO.chardata_to_string
)</p>
</div>
<div class="paragraph">
<p>IO.puts "iEx starting in "
pwd()
IO.puts "iEx starting on "
IO.puts Node.self</p>
</div>
<div class="paragraph">
<p>IEx.configure(
  colors: [enabled: true],
  alive_prompt: [
    "\e[G",
    "(%node)",
    "%prefix",
    "&lt;d2&gt;",
  ] |&gt; IO.ANSI.format |&gt; IO.chardata_to_string
)</p>
</div>
<div class="paragraph">
<p>Now if we start four different nodes from these directories we
will see how the shell configurations are loaded.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">GDC08:~/example/dir1<span class="nv">$ </span>iex <span class="nt">--sname</span> node1
Erlang/OTP 19 <span class="o">[</span>erts-8.1] <span class="o">[</span>source-0567896] <span class="o">[</span>64-bit]
              <span class="o">[</span>smp:4:4] <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

ERTS is starting <span class="k">in</span> /home/happi/example/dir1
 on <span class="o">[</span>node1@GDC08]
Interactive Elixir <span class="o">(</span>1.4.0<span class="o">)</span> - press Ctrl+C to <span class="nb">exit</span> <span class="o">(</span><span class="nb">type </span>h<span class="o">()</span> ENTER <span class="k">for </span><span class="nb">help</span><span class="o">)</span>
iEx starting <span class="k">in</span>
/home/happi/example/dir1
iEx starting on
node1@GDC08
<span class="o">(</span>node1@GDC08<span class="o">)</span>iex&lt;d1&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">GDC08:~/example/dir2<span class="nv">$ </span>iex <span class="nt">--sname</span> node2
Erlang/OTP 19 <span class="o">[</span>erts-8.1] <span class="o">[</span>source-0567896] <span class="o">[</span>64-bit]
              <span class="o">[</span>smp:4:4] <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

ERTS is starting <span class="k">in</span> /home/happi/example/dir2
 on <span class="o">[</span>node2@GDC08]
Interactive Elixir <span class="o">(</span>1.4.0<span class="o">)</span> - press Ctrl+C to <span class="nb">exit</span> <span class="o">(</span><span class="nb">type </span>h<span class="o">()</span> ENTER <span class="k">for </span><span class="nb">help</span><span class="o">)</span>
iEx starting <span class="k">in</span>
/home/happi/example/dir2
iEx starting on
node2@GDC08
<span class="o">(</span>node2@GDC08<span class="o">)</span>iex&lt;d2&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">GDC08:~/example/dir1<span class="nv">$ </span>iex <span class="nt">--sname</span> node3 <span class="nt">--remsh</span> node2@GDC08
Erlang/OTP 19 <span class="o">[</span>erts-8.1] <span class="o">[</span>source-0567896] <span class="o">[</span>64-bit] <span class="o">[</span>smp:4:4]
              <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

ERTS is starting <span class="k">in</span> /home/happi/example/dir1
 on <span class="o">[</span>node3@GDC08]
Interactive Elixir <span class="o">(</span>1.4.0<span class="o">)</span> - press Ctrl+C to <span class="nb">exit</span> <span class="o">(</span><span class="nb">type </span>h<span class="o">()</span> ENTER <span class="k">for </span><span class="nb">help</span><span class="o">)</span>
iEx starting <span class="k">in</span>
/home/happi/example/dir2
iEx starting on
node2@GDC08
<span class="o">(</span>node2@GDC08<span class="o">)</span>iex&lt;d2&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">GDC08:~/example/dir2<span class="nv">$ </span>erl <span class="nt">-sname</span> node4
Erlang/OTP 19 <span class="o">[</span>erts-8.1] <span class="o">[</span>source-0567896] <span class="o">[</span>64-bit] <span class="o">[</span>smp:4:4]
              <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

ERTS is starting <span class="k">in</span> /home/happi/example/dir2
 on <span class="o">[</span>node4@GDC08]
Eshell V8.1  <span class="o">(</span>abort with ^G<span class="o">)</span>
<span class="o">(</span>node4@GDC08<span class="o">)</span>1&gt; tt<span class="o">()</span><span class="nb">.</span>
<span class="nb">test</span>
<span class="o">(</span>node4@GDC08<span class="o">)</span>2&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The shell configuration is loaded from the node running
the shell, as you can see from the previous examples.
If we were to connect to a node on a different machine,
these configurations would not be present.</p>
</div>
<div class="paragraph">
<p>You can actually change which node and shell you are connected to
by going into job control mode.</p>
</div>
</div>
<div class="sect4">
<h5 id="_job_control_mode"><a class="link" href="#_job_control_mode">Job Control Mode</a></h5>
<div class="paragraph">
<p>By pressing control+G (ctrl-G) you enter the job control mode (JCL).
You are then greeted by another prompt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>User switch command
 --&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>By typing <code>h</code>  (followed by enter)
you get a help text with the available commands in JCL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  c [nn]            - connect to job
  i [nn]            - interrupt job
  k [nn]            - kill job
  j                 - list all jobs
  s [shell]         - start local shell
  r [node [shell]]  - start remote shell
  q                 - quit erlang
  ? | h             - this message</pre>
</div>
</div>
<div class="paragraph">
<p>The interesting command here is the <code>r</code> command which
starts a remote shell. You can give it the name of the
shell you want to run, which is needed if you want to start
an Elixir shell, since the default is the standard Erlang shell.
Once you have started a new job (i.e. a new shell)
you need to connect to that job with the <code>c</code> command.
You can also list all jobs with <code>j</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(node2@GDC08)iex&lt;d2&gt;
User switch command
 --&gt; r node1@GDC08 'Elixir.IEx'
 --&gt; c
Interactive Elixir (1.4.0) - press Ctrl+C to exit (type h() ENTER for help)
iEx starting in
/home/happi/example/dir1
iEx starting on
node1@GDC08</pre>
</div>
</div>
<div class="paragraph">
<p>See the [Erlang Shell manual](<a href="http://erlang.org/doc/man/shell.html" class="bare">http://erlang.org/doc/man/shell.html</a>)
for a full description of JCL mode.</p>
</div>
<div class="paragraph">
<p>You can quit your session by typing <code>ctrl+G q [enter]</code>. This
shuts down the local node. You do <strong>not</strong> want to quit with
any of <code>q().</code>, <code>halt()</code>, <code>init:stop()</code>, or System.halt.
All of these will bring down the remote node which seldom
is what you want when you have connected to a live server.
Instead use <code>ctrl+\</code>, <code>ctrl+c ctrl+c</code>, <code>ctrl+g q [enter]</code>
or <code>ctrl+c a [enter]</code>.</p>
</div>
<div class="paragraph">
<p>If you do not want to use a remote shell, which requires you to have
two instances of the Erlang runtime system running, there are actually
two other ways to connect to a node.  You can also connect either
through a Unix pipe or directly through ssh, but both of these methods
require that you have prepared the node you want to connect to by
starting it in a special way or by starting an ssh server.</p>
</div>
</div>
<div class="sect4">
<h5 id="_connecting_through_a_pipe"><a class="link" href="#_connecting_through_a_pipe">Connecting through a Pipe</a></h5>
<div class="paragraph">
<p>By starting the node through the command <code>run_erl</code> you will
get a named pipe for IO and you can attach a shell to that
pipe without the need to start a whole new node. As we shall
see in the next chapter there are some advantages to using
<code>run_erl</code> instead of just starting Erlang in daemon mode,
such as not losing standard IO and standard error output.</p>
</div>
<div class="paragraph">
<p>The run_erl command is only available on Unix-like operating
systems that implement pipes.
If you start your system with run_erl, something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> run_erl <span class="nt">-daemon</span> log/erl_pipe log <span class="s2">"erl -sname node1"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> run_erl <span class="nt">-daemon</span> log/iex_pipe log <span class="s2">"iex --sname node2"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then attach to the system through the
named pipe (the first argument to run_erl).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> to_erl dir1/iex_pipe

iex<span class="o">(</span>node2@GDC08<span class="o">)</span>1&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can exit the shell by sending EOF (<code>ctrl+d</code>) and leave the system
running in the background.  Note that with <code>to_erl</code> the terminal is
connected directly to the live node so if you exit with <code>ctrl-G q
[enter]</code> you will bring down that node, probably not what you want.</p>
</div>
<div class="paragraph">
<p>The last method for connecting to the node is through ssh.</p>
</div>
</div>
<div class="sect4">
<h5 id="_connecting_through_ssh"><a class="link" href="#_connecting_through_ssh">Connecting through SSH</a></h5>
<div class="paragraph">
<p>Erlang comes with a built in ssh server which you can start
on your node and then connect to directly. The
[documentation for the ssh module](<a href="http://erlang.org/doc/man/ssh.html" class="bare">http://erlang.org/doc/man/ssh.html</a>) explains
all the details. For a quick test all you need is a server key which you
can generate with ssh-keygen:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> <span class="nb">mkdir</span> ~/ssh-test/
<span class="o">&gt;</span> ssh-keygen <span class="nt">-t</span> rsa <span class="nt">-f</span> ~/ssh-test/ssh_host_rsa_key</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you start the ssh daemon on the Erlang node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">gds01&gt; erl
Erlang/OTP 18 <span class="o">[</span>erts-7.3] <span class="o">[</span>source-d2a6d81] <span class="o">[</span>64-bit] <span class="o">[</span>smp:8:8]
              <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

Eshell V7.3  <span class="o">(</span>abort with ^G<span class="o">)</span>
1&gt; ssh:start<span class="o">()</span><span class="nb">.</span>
<span class="o">{</span>ok,&lt;0.47.0&gt;<span class="o">}</span>
2&gt; ssh:daemon<span class="o">(</span>8021, <span class="o">[{</span>system_dir, <span class="s2">"/home/happi/.ssh/ehost/"</span><span class="o">}</span>,
                     <span class="o">{</span>auth_methods, <span class="s2">"password"</span><span class="o">}</span>,
                     <span class="o">{</span>password, <span class="s2">"pwd"</span><span class="o">}])</span>.</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now connect from another machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">happi@GDC08:~&gt; ssh <span class="nt">-p</span> 8021 happi@gds01
happi@gds01<span class="s1">'s password: [pwd]
Eshell V7.3  (abort with ^G)
1&gt;
</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In a real world setting you would want to set up your
server and user ssh keys as described in the documentation.
At least you would want to have a better password.</p>
</div>
<div class="paragraph">
<p>To disconnect from the shell you need to shut down your terminal
window. Using <code>q()</code> or <code>init:stop()</code> would bring down the node.
In this shell you do not have access to neither JCL mode (<code>ctrl+g</code>)
nor the BREAK mode (<code>ctrl+c</code>).</p>
</div>
<div class="paragraph">
<p>The break mode is really powerful when developing,
profiling and debugging. We will take a look at it next.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_breaking_out_or_in"><a class="link" href="#_breaking_out_or_in">20.2.3. Breaking (out or in).</a></h4>
<div class="paragraph">
<p>When you press <code>ctrl+c</code> you enter BREAK mode. This is most
often used just to break out of the shell by either tying
<code>a [enter]</code> for abort or by hitting <code>ctrl+c</code> once more.
But you can actually use this mode to break in to the
internals of the Erlang runtime system.</p>
</div>
<div class="paragraph">
<p>When you enter BREAK mode you get a short menu:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>BREAK: (a)bort (c)ontinue (p)roc info (i)nfo (l)oaded
       (v)ersion (k)ill (D)b-tables (d)istribution</pre>
</div>
</div>
<div class="paragraph">
<p>Abort exits the node and continue takes you back in to
the shell. Hitting <code>p [enter]</code> will give you internal
information about all processes in the system. We
will look closer at what this information means
in the next chapter (See [xxx](#ch.processes)).</p>
</div>
<div class="paragraph">
<p>You can also get information about the memory and
the memory allocators in the node through the
info choice (<code>i [enter]</code>). In [xxx](#ch.memory)
we will look at how to decipher this information.</p>
</div>
<div class="paragraph">
<p>You can see all loaded modules and their sizes with
<code>l [enter]</code> and the system version with <code>v [enter]</code>,
while <code>k [enter]</code> will let you step through all processes
and inspect them and kill them. Capital <code>D [enter]</code> will
show you information about all the ETS tables in the
system and lower case <code>d [enter]</code> will show you
information about the distribution. That is basically
just the node name.</p>
</div>
<div class="paragraph">
<p>If you have built your runtime with OPPROF or DEBUG you will be able
to get even more information.  We will look at how to do this in
<a href="#AP-BuildingERTS">Appendix A</a>. The code for the break mode can be found in
&lt;filename&gt;[OTP_SOURCE]/erts/emulator/beam/break.c&lt;/filename&gt;.</p>
</div>
<div class="paragraph">
<p>Note that going into break mode freezes the node. This is
not something you want to do on a production system.
But when debugging or profiling in a test system, this mode
can help us find bugs and bottlenecks, as we will see later
in this book.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Tweak"><a class="link" href="#CH-Tweak">21. Tweaking the Runtime System</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="AP-BuildingERTS"><a class="link" href="#AP-BuildingERTS">Appendix A: Building the Erlang Runtime System</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter we will look at different way to configure and build
Erlang/OTP to suite your needs. We will use an Ubuntu Linux for most
of the examples. If you are using a different OS you can find detailed
instructions on how to build for that OS in the documentation in the
source code (in HOWTO/INSTALL.md), or on the web
<a href="http://www.erlang.org/doc/installation_guide/INSTALL.html">INSTALL.html</a>.</p>
</div>
<div class="paragraph">
<p>There are basically two ways to build the runtime system, the traditional
way with autoconf, configure and make or with the help of
<a href="https://github.com/spawngrid/kerl">kerl</a>.</p>
</div>
<div class="paragraph">
<p>I recommend that you first give the traditional way a try, that way
you will get a better understanding of what happens when you
build and what settings you can change. Then go over to using kerl
for your day to day job of managing configurations and builds.</p>
</div>
<div class="sect2">
<h3 id="_first_time_build"><a class="link" href="#_first_time_build">A.1. First Time Build</a></h3>
<div class="paragraph">
<p>To get you started we will go though a step by step process of
building the system from scratch and then we will look at
how you can configure your system for different purposes.</p>
</div>
<div class="paragraph">
<p>This step by step guide assumes that you have a modern Ubuntu
installation. We will look at how to build on OS X and Windows
later in this chapter.</p>
</div>
<div class="sect3">
<h4 id="_prerequisites"><a class="link" href="#_prerequisites">A.1.1. Prerequisites</a></h4>
<div class="paragraph">
<p>You will need a number of tools in order to fetch, unpack and
build from source. The file Install.md lists some of the most
important ones.</p>
</div>
<div class="paragraph">
<p>Gven that we have a recent Ubuntu installation to start with
many of the needed tools such as tar, make, perl and gcc should
already be installed. But some tools like git, m4 and ncurses
will probably need to be installed.</p>
</div>
<div class="paragraph">
<p>If you add a source URI to your apt configuration you will
be able to use the build-dep command to get the needed sources
to build erlang. You can do this by uncommenting the deb-src
line for your distribution in /etc/apt/sources.list.</p>
</div>
<div class="paragraph">
<p>For the Yakkety Yak release you could add the line by:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="o">&gt;</span> <span class="nb">sudo cat</span> <span class="s2">"deb-src http://se.archive.ubuntu.com/ubuntu/ </span><span class="se">\</span><span class="s2">
yakkety main restricted"</span> <span class="o">&gt;&gt;</span> /etc/apt/sources.list</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the following commands will get almost all the tools you need:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="o">&gt;</span> <span class="nb">sudo </span>apt-get <span class="nb">install </span>git autoconf m4
<span class="o">&gt;</span> <span class="nb">sudo </span>apt-get build-dep erlang</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have a slightly older version of Ubuntu like Saucy and you
want to build with wx support, you need to get the wx libraries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="o">&gt;</span> <span class="nb">sudo </span>apt-key adv <span class="nt">--fetch-keys</span> http://repos.codelite.org/CodeLite.asc
<span class="o">&gt;</span> <span class="nb">sudo </span>apt-add-repository <span class="s1">'deb http://repos.codelite.org/wx3.0/ubuntu/ saucy universe'</span>
<span class="o">&gt;</span> <span class="nb">sudo </span>apt-get update
<span class="o">&gt;</span> <span class="nb">sudo </span>apt-get <span class="nb">install </span>libwxbase3.0-0-unofficial libwxbase3.0-dev libwxgtk3.0-0-unofficial <span class="se">\</span>
libwxgtk3.0-dev wx3.0-headers wx-common libwxbase3.0-dbg libwxgtk3.0-dbg wx3.0-i18n <span class="se">\</span>
wx3.0-examples wx3.0-doc</code></pre>
</div>
</div>
<div class="paragraph">
<p>You might also want to create a directory where you keep the
source code and also install your home built version without
interfering with any pre built and system wide installations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="o">&gt;</span> <span class="nb">cd</span>
<span class="o">&gt;</span> <span class="nb">mkdir </span>otp</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_getting_the_source"><a class="link" href="#_getting_the_source">A.2. Getting the source</a></h3>
<div class="paragraph">
<p>There are two main ways of getting the source. You can download a
tarball from <a href="http://www.erlang.org/download.html">erlang.org</a> or you
can check out the source code directly from Github.</p>
</div>
<div class="paragraph">
<p>If you want to quickly download a stable version of the source try:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="o">&gt;</span> <span class="nb">cd</span> ~/otp
<span class="o">&gt;</span> wget http://erlang.org/download/otp_src_19.1.tar.gz
<span class="o">&gt;</span> <span class="nb">tar</span> <span class="nt">-xzf</span> otp_src_19.1.tar.gz
<span class="o">&gt;</span> <span class="nb">cd </span>otp_src_19.1
<span class="o">&gt;</span> <span class="nb">export </span><span class="nv">ERL_TOP</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or if you want to be able to easilly update to the latest bleeding
edge or you want to contribute fixes back to the comunity you can
check out the source through git:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="o">&gt;</span> <span class="nb">cd</span> ~/otp
<span class="o">&gt;</span> git clone https://github.com/erlang/otp.git <span class="nb">source</span>
<span class="o">&gt;</span> <span class="nb">cd source</span>
<span class="o">&gt;</span> <span class="nb">export </span><span class="nv">ERL_TOP</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>
<span class="o">&gt;</span> ./otp_build autoconf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you are ready to build and install Erlang:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="o">&gt;</span> <span class="nb">export </span><span class="nv">LANG</span><span class="o">=</span>C
<span class="o">&gt;</span> ./configure <span class="nt">--prefix</span><span class="o">=</span><span class="nv">$HOME</span>/otp/install
<span class="o">&gt;</span> make
<span class="o">&gt;</span> make <span class="nb">install</span>
<span class="o">&gt;</span> <span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$HOME</span>/otp/install/bin/:<span class="nv">$PATH</span>
<span class="o">&gt;</span> <span class="nb">export </span><span class="nv">ROOTDIR</span><span class="o">=</span><span class="nv">$HOME</span>/otp/install/</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_with_kerl"><a class="link" href="#_building_with_kerl">A.3. Building with Kerl</a></h3>
<div class="paragraph">
<p>An easier way to build especially if you want to have
several different builds available to experiment with
is to build with Kerl.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="AP-Instructions"><a class="link" href="#AP-Instructions">Appendix B: BEAM Instructions</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here we will go through most of the instructions in the BEAM generic instruction set in detail. In the next section we list all instructions with a brief explanation generated from the documentaion in the code (see <code>lib/compiler/src/genop.tab</code>).</p>
</div>
<div class="sect2">
<h3 id="_functions_and_labels"><a class="link" href="#_functions_and_labels">B.1. Functions and Labels</a></h3>
<div class="sect3">
<h4 id="_label_lbl"><a class="link" href="#_label_lbl">B.1.1. label Lbl</a></h4>
<div class="paragraph">
<p>Instruction number 1 in the generic instruction set is not really an instruction at all. It is just a module local label giving a name, or actually a number to the current position in the code.</p>
</div>
<div class="paragraph">
<p>Each label potentially marks the beginning of a basic block since it is a potential destination of a jump.</p>
</div>
</div>
<div class="sect3">
<h4 id="_func_info_module_function_arity"><a class="link" href="#_func_info_module_function_arity">B.1.2. func_info Module Function Arity</a></h4>
<div class="paragraph">
<p>The code for each function starts with a <code>func_info</code> instruction. This instruction is used for generating a function clause error, and the execution of the code in the function actually starts at the label following the func_info instruction.</p>
</div>
<div class="paragraph">
<p>Imagine a function with a guard:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">id</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">I</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Beam code for this function might look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">3</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">test1</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">id</span><span class="p">},</span><span class="mi">1</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">4</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">test</span><span class="p">,</span><span class="nb">is_integer</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">},[{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}.</span>
    <span class="n">return</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here the meta information <code>{function, id, 1, 4}</code> tells us that execution of the id/1 function will start at label 4. At label 4 we do an <code>is_integer</code> on x0 and if we fail we jump to label 3 (f3) which points to the func_info instruction, which will generate a <em>function clause</em> exception. Otherwise we just fall through and return the argument (x0).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Function info instruction points to an <code>Export</code> record (defined in <code>erts/emulator/beam/export.h</code>) and located somewhere else in memory. The few dedicated words of memory inside that record are used by the tracing mechanism to place a special trace instruction which will trigger for each entry/return from the function by all processes.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_test_instructions"><a class="link" href="#_test_instructions">B.2. Test instructions</a></h3>
<div class="sect3">
<h4 id="_type_tests"><a class="link" href="#_type_tests">B.2.1. Type tests</a></h4>
<div class="paragraph">
<p>The type test instructions (<code>is_\* Lbl Argument</code>) checks whether the argument is of the given type and if not jumps to the label Lbl. The beam disassembler wraps all these instructions in a  <code>test</code> instruction. E.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang">    <span class="p">{</span><span class="n">test</span><span class="p">,</span><span class="nb">is_integer</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">},[{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The current type test instructions are <code>is_integer</code>, <code>is_float</code>, <code>is_number</code>, <code>is_atom</code>, <code>is_pid</code>, <code>is_reference</code>, <code>is_port</code>, <code>is_nil</code>, <code>is_binary</code>, <code>is_list</code>, <code>is_nonempty_list</code>, <code>is_function</code>, <code>is_function2</code>, <code>is_boolean</code>, <code>is_bitstr</code>, and <code>is_tuple</code>.</p>
</div>
<div class="paragraph">
<p>And then there is also one type test instruction of Arity 3: <code>test_arity Lbl Arg Arity</code>. This instruction tests that the arity of the argument (assumed to be a tuple) is of <code>Arity</code>. This instruction is usually preceded by an <code>is_tuple</code> instruction.</p>
</div>
</div>
<div class="sect3">
<h4 id="_comparisons"><a class="link" href="#_comparisons">B.2.2. Comparisons</a></h4>
<div class="paragraph">
<p>The comparison instructions (<code>is_\* Lbl Arg1 Arg2</code>) compares the two arguments according to the instructions and jumps to <code>Lbl</code> if the comparison fails.</p>
</div>
<div class="paragraph">
<p>The comparison instructions are: <code>is_lt</code>,  <code>is_ge</code>,  <code>is_eq</code>,  <code>is_ne</code>, <code>is_eq_exact</code>, and <code>is_ne_exact</code>.</p>
</div>
<div class="paragraph">
<p>Remember that all Erlang terms are ordered so these instructions can compare any two terms. You can for example test if the atom <code>self</code> is less than the pid  returned by <code>self()</code>. (It is.)</p>
</div>
<div class="paragraph">
<p>Note that for numbers the comparison is done on the Erlang type <em>number</em>, see <a href="#CH-TypeSystem">Chapter 4</a>. That is, for a mixed float and integer comparison the number of lower precision is converted to the other type before comparison. For example on my system 1 and 1.0 compares as equal, as well as 9999999999999999 and 1.0e16. Comparing floating point numbers is always risk and best avoided, the result may wary depending on the underlying hardware.</p>
</div>
<div class="paragraph">
<p>If you want to make sure that the integer 1 and the floating point number 1.0 are compared different you can use is_eq_exact and is_ne_exact. This corresponds to the Erlang operators <code>=:=</code> and <code>=/=</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_function_calls"><a class="link" href="#_function_calls">B.3. Function Calls</a></h3>
<div class="paragraph">
<p>In this chapter we will summarize what the different call instructions does. For a thorough description of how function calls work see <a href="#CH-Calls">Chapter 8</a>.</p>
</div>
<div class="sect3">
<h4 id="_call_arity_label"><a class="link" href="#_call_arity_label">B.3.1. call Arity Label</a></h4>
<div class="paragraph">
<p>Does a call to the function of arity <code>Arity</code> in the same module at label <code>Label</code>. First count down the reductions and if needed do a context switch. Current code address after the call is saved into CP.</p>
</div>
<div class="paragraph">
<p>For all local calls the label is the second label of the function where the code starts. It is assumed that the preceding instruction at that label is <code>func_info</code> in order to get the MFA if a context switch is needed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_call_only_arity_label"><a class="link" href="#_call_only_arity_label">B.3.2. call_only Arity Label</a></h4>
<div class="paragraph">
<p>Do a tail recursive call the function of arity <code>Arity</code> in the same module at label <code>Label</code>. First count down the reductions and if needed do a context switch. The CP is not updated with the return address.</p>
</div>
</div>
<div class="sect3">
<h4 id="_call_last_arity_label_deallocate"><a class="link" href="#_call_last_arity_label_deallocate">B.3.3. call_last Arity Label Deallocate</a></h4>
<div class="paragraph">
<p>Deallocate <code>Deallocate</code> words of stack, then do a tail recursive call to the function of arity <code>Arity</code> in the same module at label <code>Label</code> First count down the reductions and if needed do a context switch. The CP is not updated with the return address.</p>
</div>
</div>
<div class="sect3">
<h4 id="_call_ext_arity_destination"><a class="link" href="#_call_ext_arity_destination">B.3.4. call_ext Arity Destination</a></h4>
<div class="paragraph">
<p>Does an external call to the function of arity <code>Arity</code> given by Destination. Destination in assembly is usually written as <code>{extfunc, Module, Function, Arity}</code>, this is then added to imports section of the module. First count down the reductions and if needed do a context switch. CP will be updated with the return address.</p>
</div>
</div>
<div class="sect3">
<h4 id="_call_ext_only_arity_destination"><a class="link" href="#_call_ext_only_arity_destination">B.3.5. call_ext_only Arity Destination</a></h4>
<div class="paragraph">
<p>Does a tail recursive external call to the function of arity <code>Arity</code> given by Destination. Destination in assembly is usually written as <code>{extfunc, Module, Function, Arity}</code>. First count down the reductions and if needed do a context switch. The CP is not updated with the return address.</p>
</div>
</div>
<div class="sect3">
<h4 id="_call_ext_last_arity_destination_deallocate"><a class="link" href="#_call_ext_last_arity_destination_deallocate">B.3.6. call_ext_last Arity Destination Deallocate</a></h4>
<div class="paragraph">
<p>Deallocate <code>Deallocate</code> words of stack, then do a tail recursive external call to the function of arity <code>Arity</code> given by Destination. Destination in assembly is usually written as <code>{extfunc, Module, Function, Arity}</code>. First count down the reductions and if needed do a context switch. The CP is not updated with the return address.</p>
</div>
</div>
<div class="sect3">
<h4 id="_bif0_bif_reg_bif12_lbl_bif_arg_reg"><a class="link" href="#_bif0_bif_reg_bif12_lbl_bif_arg_reg">B.3.7. bif0 Bif Reg, bif[1,2] Lbl Bif [Arg,&#8230;&#8203;] Reg</a></h4>
<div class="paragraph">
<p>Call the bif <code>Bif</code> with the given arguments, and store the result in <code>Reg</code>. If the bif fails, jump to <code>Lbl</code>. Zero arity bif cannot fail and thus <code>bif0</code> doesn&#8217;t take a fail label.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Bif called by these instructions may not allocate on the heap nor trigger a garbage collection. Otherwise see: <code>gc_bif</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_gc_bif1_3_lbl_live_bif_arg_reg"><a class="link" href="#_gc_bif1_3_lbl_live_bif_arg_reg">B.3.8. gc_bif[1-3] Lbl Live Bif [Arg, &#8230;&#8203;] Reg</a></h4>
<div class="paragraph">
<p>Call the bif <code>Bif</code> with the given arguments, and store the result in <code>Reg</code>. If the bif fails, jump to <code>Lbl</code>. Arguments will be stored in <code>x(Live)</code>,  <code>x(Live+1)</code> and <code>x(Live+2)</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Because this instruction has argument <code>Live</code>, it gives us enough information to be able to trigger the garbage collection.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_call_fun_arity"><a class="link" href="#_call_fun_arity">B.3.9. call_fun Arity</a></h4>
<div class="paragraph">
<p>The instruction <code>call_fun</code> assumes that the arguments are placed in the first <code>Arity</code> argument registers and that the fun (the pointer to the closure) is placed in the register following the last argument <code>x[Arity+1]</code>.</p>
</div>
<div class="paragraph">
<p>That is, for a zero arity call, the closure is placed in <code>x[0]</code>. For a arity 1 call <code>x[0]</code> contains the argument and <code>x[1]</code> contains the closure and so on.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Raises <code>badarity</code> if the arity doesn&#8217;t match the function object. Raises <code>badfun</code> if a non-function is passed.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_apply_arity"><a class="link" href="#_apply_arity">B.3.10. apply Arity</a></h4>
<div class="paragraph">
<p>Applies function call with <code>Arity</code> arguments stored in X registers. The module atom is stored in <code>x[Arity]</code> and the function atom is stored in <code>x[Arity+1]</code>. Module can also be represented by a tuple.</p>
</div>
</div>
<div class="sect3">
<h4 id="_apply_last_arity_dealloc"><a class="link" href="#_apply_last_arity_dealloc">B.3.11. apply_last Arity Dealloc</a></h4>
<div class="paragraph">
<p>Deallocates <code>Dealloc</code> elements on stack by popping CP, freeing the elements and pushing CP again. Then performs a tail-recursive call with <code>Arity</code> arguments stored in X registers, by jumping to the new location. The module and function atoms are stored in <code>x[Arity]</code> and <code>x[Arity+1]</code>. Module can also be represented by a tuple.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stack_and_heap_management_2"><a class="link" href="#_stack_and_heap_management_2">B.4. Stack (and Heap) Management</a></h3>
<div class="paragraph">
<p>The stack and the heap of an Erlang process on Beam share the same memory area see <a href="#CH-Processes">Chapter 3</a> and <a href="#CH-Memory">Chapter 12</a> for a full discussion. The stack grows toward lower addresses and the heap toward higher addresses. Beam will do a garbage collection if more space than what is available is needed on either the stack or the heap.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>A leaf function</strong></dt>
<dd>
<p>A leaf function is a function which doesn&#8217;t call
any other function.</p>
</dd>
<dt class="hdlist1"><strong>A non leaf function</strong></dt>
<dd>
<p>A non leaf function is a function which may call
another function.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>These instructions are also used by non leaf functions for setting up and tearing down the stack frame for the current instruction. That is, on entry to the function the <em>continuation pointer</em> (CP) is saved on the stack, and on exit it is read back from the stack.</p>
</div>
<div class="paragraph">
<p>A function skeleton for a leaf function looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{function, Name, Arity, StartLabel}.
  {label,L1}.
    {func_info,{atom,Module},{atom,Name},Arity}.
  {label,L2}.
    ...
    return.</pre>
</div>
</div>
<div class="paragraph">
<p>A function skeleton for a non leaf function looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{function, Name, Arity, StartLabel}.
  {label,L1}.
    {func_info,{atom,Module},{atom,Name},Arity}.
  {label,L2}.
    {allocate,Need,Live}.

    ...
    call ...
    ...

    {deallocate,Need}.
    return.</pre>
</div>
</div>
<div class="sect3">
<h4 id="_allocate_stackneed_live"><a class="link" href="#_allocate_stackneed_live">B.4.1. allocate StackNeed Live</a></h4>
<div class="paragraph">
<p>Save the continuation pointer (CP) and allocate space for <code>StackNeed</code> extra words on the stack. If during allocation we run out of memory, call the GC and then first <code>Live</code> x registers will form a part of the root set. E.g. if <code>Live</code> is 2 then GC will save registers X0 and X1, rest are unused and will be freed.</p>
</div>
<div class="paragraph">
<p>When allocating on the stack, the stack pointer (E) is decreased.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Allocate 1 0</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>       Before           After
         | xxx |            | xxx |
    E -&gt; | xxx |            | xxx |
         |     |            | ??? | caller save slot
           ...         E -&gt; | CP  |
           ...                ...
 HTOP -&gt; |     |    HTOP -&gt; |     |
         | xxx |            | xxx |</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_allocate_heap_stackneed_heapneed_live"><a class="link" href="#_allocate_heap_stackneed_heapneed_live">B.4.2. allocate_heap StackNeed HeapNeed Live</a></h4>
<div class="paragraph">
<p>Save the continuation pointer (CP) and allocate space for <code>StackNeed</code> extra words on the stack. Ensure that there also is space for <code>HeapNeed</code> words on the heap. If during allocation we run out of memory, call the GC with <code>Live</code> amount of X registers to preserve.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The heap pointer (HTOP) is not changed until the actual heap allocation takes place.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_allocate_zero_stackneed_live"><a class="link" href="#_allocate_zero_stackneed_live">B.4.3. allocate_zero StackNeed Live</a></h4>
<div class="paragraph">
<p>This instruction works the same way as allocate, but it also clears
out the allocated stack slots with <code>NIL</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. allocate_zero 1 0</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>       Before           After
         | xxx |            | xxx |
    E -&gt; | xxx |            | xxx |
         |     |            | NIL | caller save slot
           ...         E -&gt; | CP  |
           ...                ...
 HTOP -&gt; |     |    HTOP -&gt; |     |
         | xxx |            | xxx |</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_allocate_heap_zero_stackneed_heapneed_live"><a class="link" href="#_allocate_heap_zero_stackneed_heapneed_live">B.4.4. allocate_heap_zero StackNeed HeapNeed Live</a></h4>
<div class="paragraph">
<p>The allocate_heap_zero instruction works as the <code>allocate_heap</code> instruction, but it also clears out the allocated stack slots with <code>NIL</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_test_heap_heapneed_live"><a class="link" href="#_test_heap_heapneed_live">B.4.5. test_heap HeapNeed Live</a></h4>
<div class="paragraph">
<p>The test_heap instruction ensures there is space for <code>HeapNeed</code> words on the heap. If during allocation we run out of memory, call the GC with <code>Live</code> amount of X registers to preserve.</p>
</div>
</div>
<div class="sect3">
<h4 id="_init_n"><a class="link" href="#_init_n">B.4.6. init N</a></h4>
<div class="paragraph">
<p>The init instruction clears N stack words above the CP pointer by writing <code>NIL</code> to them.</p>
</div>
</div>
<div class="sect3">
<h4 id="_deallocate_n"><a class="link" href="#_deallocate_n">B.4.7. deallocate N</a></h4>
<div class="paragraph">
<p>The <code>deallocate</code> instruction is the opposite of the <code>allocate</code>. It restores the CP (continuation pointer) and deallocates <code>N+1</code> stack words.</p>
</div>
</div>
<div class="sect3">
<h4 id="_return"><a class="link" href="#_return">B.4.8. return</a></h4>
<div class="paragraph">
<p>The return instructions jumps to the address in the continuation pointer (CP). The value of CP is set to <code>0</code> in C.</p>
</div>
</div>
<div class="sect3">
<h4 id="_trim_n_remaining"><a class="link" href="#_trim_n_remaining">B.4.9. trim N Remaining</a></h4>
<div class="paragraph">
<p>Pops the CP into a temporary variable, frees <code>N</code> words of stack, and places the CP back onto the top of the stack. (The argument <code>Remaining</code> is to the best of my knowledge unused.)</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. Trim 2</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>       Before           After
         | ??? |            | ??? |
         | xxx |       E -&gt; | CP  |
         | xxx |            | ... |
    E -&gt; | CP  |            | ... |
         |     |            | ... |
           ...                ...
 HTOP -&gt; |     |    HTOP -&gt; |     |
         | xxx |            | xxx |</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_moving_extracting_modifying_data"><a class="link" href="#_moving_extracting_modifying_data">B.5. Moving, extracting, modifying data</a></h3>
<div class="sect3">
<h4 id="_move_source_destination"><a class="link" href="#_move_source_destination">B.5.1. move Source Destination</a></h4>
<div class="paragraph">
<p>Moves the value of the source <code>Source</code> (this can be a literal or a register) to the destination register <code>Destination</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_get_list_source_head_tail"><a class="link" href="#_get_list_source_head_tail">B.5.2. get_list Source Head Tail</a></h4>
<div class="paragraph">
<p>This is a deconstruct operation for a list cell. Get the head and tail (or car and cdr) parts of a list (a cons cell), specified by <code>Source</code> and place them into the registers <code>Head</code> and <code>Tail</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_get_tuple_element_source_element_destination"><a class="link" href="#_get_tuple_element_source_element_destination">B.5.3. get_tuple_element Source Element Destination</a></h4>
<div class="paragraph">
<p>This is an array indexed read operation. Get element with position <code>Element</code> from the <code>Source</code> tuple and place it into the <code>Destination</code> register.</p>
</div>
</div>
<div class="sect3">
<h4 id="_set_tuple_element_newelement_tuple_position"><a class="link" href="#_set_tuple_element_newelement_tuple_position">B.5.4. set_tuple_element NewElement Tuple Position</a></h4>
<div class="paragraph">
<p>This is a destructive array indexed update operation. Update the element of the <code>Tuple</code> at <code>Position</code> with the new <code>NewElement</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_terms"><a class="link" href="#_building_terms">B.6. Building terms.</a></h3>
<div class="sect3">
<h4 id="_put_list_head_tail_destination"><a class="link" href="#_put_list_head_tail_destination">B.6.1. put_list Head Tail Destination</a></h4>
<div class="paragraph">
<p>Constructs a new list (cons) cell on the heap (2 words) and places its address into the <code>Destination</code> register. First element of list cell is set to the value of <code>Head</code>, second element is set to the value of <code>Tail</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_put_tuple_size_destination"><a class="link" href="#_put_tuple_size_destination">B.6.2. put_tuple Size Destination</a></h4>
<div class="paragraph">
<p>Constructs an empty tuple on the heap (<code>Size+1</code> words) and places its address into the <code>Destination</code> register. No elements are set at this moment. <code>Put_tuple</code> instruction is always followed by multiple <code>put</code> instructions which destructively set its elements one by one.</p>
</div>
</div>
<div class="sect3">
<h4 id="_put_value"><a class="link" href="#_put_value">B.6.3. put Value</a></h4>
<div class="paragraph">
<p>Places destructively a <code>Value</code> into the next element of a tuple, which was created by a preceding <code>put_tuple</code> instruction. Write address is maintained and incremented internally by the VM. Multiple <code>put</code> instructions are used to set contents for any new tuple.</p>
</div>
</div>
<div class="sect3">
<h4 id="_make_fun2_lambdaindex"><a class="link" href="#_make_fun2_lambdaindex">B.6.4. make_fun2 LambdaIndex</a></h4>
<div class="paragraph">
<p>Creates a function object defined by an index in the Lambda table of the module. A lambda table defines the entry point (a label or export entry), arity and how many frozen variables to take. Frozen variable values are copied from the current execution context (X registers) and stored into the function object.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_binary_syntax"><a class="link" href="#_binary_syntax">B.7. Binary Syntax</a></h3>
<div class="sect3">
<h4 id="_bs_put_integer5"><a class="link" href="#_bs_put_integer5">B.7.1. bs_put_integer/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_put_binary5"><a class="link" href="#_bs_put_binary5">B.7.2. bs_put_binary/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_put_float5"><a class="link" href="#_bs_put_float5">B.7.3. bs_put_float/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_put_string2"><a class="link" href="#_bs_put_string2">B.7.4. bs_put_string/2</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_init26"><a class="link" href="#_bs_init26">B.7.5. bs_init2/6</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_add5"><a class="link" href="#_bs_add5">B.7.6. bs_add/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_start_match25"><a class="link" href="#_bs_start_match25">B.7.7. bs_start_match2/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_get_integer27"><a class="link" href="#_bs_get_integer27">B.7.8. bs_get_integer2/7</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_get_float27"><a class="link" href="#_bs_get_float27">B.7.9. bs_get_float2/7</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_get_binary27"><a class="link" href="#_bs_get_binary27">B.7.10. bs_get_binary2/7</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_skip_bits25"><a class="link" href="#_bs_skip_bits25">B.7.11. bs_skip_bits2/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_test_tail23"><a class="link" href="#_bs_test_tail23">B.7.12. bs_test_tail2/3</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_save22"><a class="link" href="#_bs_save22">B.7.13. bs_save2/2</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_restore22"><a class="link" href="#_bs_restore22">B.7.14. bs_restore2/2</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_context_to_binary1"><a class="link" href="#_bs_context_to_binary1">B.7.15. bs_context_to_binary/1</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_test_unit3"><a class="link" href="#_bs_test_unit3">B.7.16. bs_test_unit/3</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_match_string4"><a class="link" href="#_bs_match_string4">B.7.17. bs_match_string/4</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_init_writable0"><a class="link" href="#_bs_init_writable0">B.7.18. bs_init_writable/0</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_append8"><a class="link" href="#_bs_append8">B.7.19. bs_append/8</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_private_append6"><a class="link" href="#_bs_private_append6">B.7.20. bs_private_append/6</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_init_bits6"><a class="link" href="#_bs_init_bits6">B.7.21. bs_init_bits/6</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_get_utf85"><a class="link" href="#_bs_get_utf85">B.7.22. bs_get_utf8/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_skip_utf84"><a class="link" href="#_bs_skip_utf84">B.7.23. bs_skip_utf8/4</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_get_utf165"><a class="link" href="#_bs_get_utf165">B.7.24. bs_get_utf16/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_skip_utf164"><a class="link" href="#_bs_skip_utf164">B.7.25. bs_skip_utf16/4</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_get_utf325"><a class="link" href="#_bs_get_utf325">B.7.26. bs_get_utf32/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_skip_utf324"><a class="link" href="#_bs_skip_utf324">B.7.27. bs_skip_utf32/4</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_utf8_size3"><a class="link" href="#_bs_utf8_size3">B.7.28. bs_utf8_size/3</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_put_utf83"><a class="link" href="#_bs_put_utf83">B.7.29. bs_put_utf8/3</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_utf16_size3"><a class="link" href="#_bs_utf16_size3">B.7.30. bs_utf16_size/3</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_put_utf163"><a class="link" href="#_bs_put_utf163">B.7.31. bs_put_utf16/3</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_put_utf323"><a class="link" href="#_bs_put_utf323">B.7.32. bs_put_utf32/3</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_floating_point_arithmetic"><a class="link" href="#_floating_point_arithmetic">B.8. Floating Point Arithmetic</a></h3>
<div class="sect3">
<h4 id="_fclearerror0"><a class="link" href="#_fclearerror0">B.8.1. fclearerror/0</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_fcheckerror1"><a class="link" href="#_fcheckerror1">B.8.2. fcheckerror/1</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_fmove2"><a class="link" href="#_fmove2">B.8.3. fmove/2</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_fconv2"><a class="link" href="#_fconv2">B.8.4. fconv/2</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_fadd4"><a class="link" href="#_fadd4">B.8.5. fadd/4</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_fsub4"><a class="link" href="#_fsub4">B.8.6. fsub/4</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_fmul4"><a class="link" href="#_fmul4">B.8.7. fmul/4</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_fdiv4"><a class="link" href="#_fdiv4">B.8.8. fdiv/4</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_fnegate3"><a class="link" href="#_fnegate3">B.8.9. fnegate/3</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pattern_matching"><a class="link" href="#_pattern_matching">B.9. Pattern Matching</a></h3>
<div class="sect3">
<h4 id="_select_val"><a class="link" href="#_select_val">B.9.1. select_val</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_select_arity_val"><a class="link" href="#_select_arity_val">B.9.2. select_arity_val</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_jump"><a class="link" href="#_jump">B.9.3. jump</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exception_handling"><a class="link" href="#_exception_handling">B.10. Exception handling</a></h3>
<div class="sect3">
<h4 id="_catch2"><a class="link" href="#_catch2">B.10.1. catch/2</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_catch_end1"><a class="link" href="#_catch_end1">B.10.2. catch_end/1</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_badmatch1"><a class="link" href="#_badmatch1">B.10.3. badmatch/1</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_if_end0"><a class="link" href="#_if_end0">B.10.4. if_end/0</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_case_end1"><a class="link" href="#_case_end1">B.10.5. case_end/1</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_meta_instructions"><a class="link" href="#_meta_instructions">B.11. Meta instructions</a></h3>
<div class="sect3">
<h4 id="_on_load"><a class="link" href="#_on_load">B.11.1. on_load</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_line"><a class="link" href="#_line">B.11.2. line</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_generic_instructions"><a class="link" href="#_generic_instructions">B.12. Generic Instructions</a></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Arity</th>
<th class="tableblock halign-left valign-top">Op Code</th>
<th class="tableblock halign-left valign-top">Spec</th>
<th class="tableblock halign-left valign-top">Documentation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>allocate</strong> <em>StackNeed</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocate space for StackNeed words on the stack. If a GC is needed       during allocation there are Live number of live X registers.       Also save the continuation pointer (CP) on the stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>allocate_heap</strong> <em>StackNeed</em>, <em>HeapNeed</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocate space for StackNeed words on the stack and ensure there is       space for HeapNeed words on the heap. If a GC is needed       save Live number of X registers.       Also save the continuation pointer (CP) on the stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate_heap_zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>allocate_heap_zero</strong> <em>StackNeed</em>, <em>HeapNeed</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocate space for StackNeed words on the stack and HeapNeed words       on the heap. If a GC is needed       during allocation there are Live number of live X registers.       Clear the new stack words. (By writing NIL.)       Also save the continuation pointer (CP) on the stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate_zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>allocate_zero</strong> <em>StackNeed</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocate space for StackNeed words on the stack. If a GC is needed       during allocation there are Live number of live X registers.       Clear the new stack words. (By writing NIL.)       Also save the continuation pointer (CP) on the stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">apply</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">112</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">apply_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">113</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">badmatch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">72</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bif0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>bif0</strong> <em>Bif</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the bif Bif and store the result in Reg.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bif1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>bif1</strong> <em>Lbl</em>, <em>Bif</em>, <em>Arg</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the bif Bif with the argument Arg, and store the result in Reg.       On failure jump to Lbl.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bif2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>bif2</strong> <em>Lbl</em>, <em>Bif</em>, <em>Arg1</em>, <em>Arg2</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the bif Bif with the arguments Arg1 and Arg2,       and store the result in Reg.       On failure jump to Lbl.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_add</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">111</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_append</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">134</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_bits_to_bytes</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(110)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_bits_to_bytes2</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(127)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_context_to_binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">130</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_final</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(88)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_final2</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(126)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_get_binary</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(82)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_get_binary2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">119</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_get_float</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(81)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_get_float2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">118</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_get_integer</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(80)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_get_integer2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">117</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_get_position</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">167</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>bs_get_position</strong> <em>Ctx</em>, <em>Dst</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets Dst to the current position of Ctx</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_get_tail</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">165</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>bs_get_tail</strong> <em>Ctx</em>, <em>Dst</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets Dst to the tail of Ctx at the current position</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_get_utf16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">140</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_get_utf32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">142</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_get_utf8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">138</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_init</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(87)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_init2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">109</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_init_bits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">137</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_init_writable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">133</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_match_string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">132</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_need_buf</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(93)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_private_append</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">135</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_put_binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">90</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_put_float</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">91</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_put_integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">89</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_put_string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">92</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_put_utf16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">147</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_put_utf32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">148</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_put_utf8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">145</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_restore</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(86)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_restore2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_save</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(85)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_save2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">122</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_set_position</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">168</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>bs_set_positon</strong> <em>Ctx</em>, <em>Pos</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the current position of Ctx to Pos</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_skip_bits</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(83)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_skip_bits2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">120</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_skip_utf16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">141</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_skip_utf32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">143</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_skip_utf8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">139</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_start_match</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(79)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_start_match2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">116</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_start_match3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">166</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>bs_start_match3</strong> <em>Fail</em>, <em>Bin</em>, <em>Live</em>, <em>Dst</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starts a binary match sequence</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_start_match4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">170</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>bs_start_match4</strong> <em>Fail</em>, <em>Bin</em>, <em>Live</em>, <em>Dst</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">As bs_start_match3, but the fail label can be 'no_fail' when we know        it will never fail at runtime, or 'resume' when we know the input is        a match context.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_test_tail</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(84)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_test_tail2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">121</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_test_unit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">131</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_utf16_size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">146</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_utf8_size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">144</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">build_stacktrace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">160</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>build_stacktrace</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Given the raw stacktrace in x(0), build a cooked stacktrace suitable        for human consumption. Store it in x(0). Destroys all other registers.        Do a garbage collection if necessary to allocate space on the heap        for the result.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>call</strong> <em>Arity</em>, <em>Label</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the function at Label.       Save the next instruction as the return address in the CP register.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_ext</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>call_ext</strong> <em>Arity</em>, <em>Destination</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the function of arity Arity pointed to by Destination.       Save the next instruction as the return address in the CP register.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_ext_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>call_ext_last</strong> <em>Arity</em>, <em>Destination</em>, <em>Deallocate</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deallocate and do a tail call to function of arity Arity       pointed to by Destination.       Do not update the CP register.       Deallocate Deallocate words from the stack before the call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_ext_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">78</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>call_ext_only</strong> <em>Arity</em>, <em>Label</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do a tail recursive call to the function at Label.       Do not update the CP register.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_fun</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">75</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>call_fun</strong> <em>Arity</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call a fun of arity Arity. Assume arguments in       registers x(0) to x(Arity-1) and that the fun is in x(Arity).       Save the next instruction as the return address in the CP register.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>call_last</strong> <em>Arity</em>, <em>Label</em>, <em>Deallocate</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deallocate and do a tail recursive call to the function at Label.       Do not update the CP register.       Before the call deallocate Deallocate words of stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>call_only</strong> <em>Arity</em>, <em>Label</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do a tail recursive call to the function at Label.       Do not update the CP register.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">case_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">74</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">catch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">62</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">catch_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">63</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deallocate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>deallocate</strong> <em>N</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Restore the continuation pointer (CP) from the stack and deallocate        N+1 words from the stack (the + 1 is for the CP).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fadd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">98</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fcheckerror</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">95</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fclearerror</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">94</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fconv</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">97</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fdiv</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">101</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fmove</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">96</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fmul</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fnegate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">102</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fsub</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">99</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">func_info</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>func_info</strong> <em>M</em>, <em>F</em>, <em>A</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a function M:F/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gc_bif1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">124</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>gc_bif1</strong> <em>Lbl</em>, <em>Live</em>, <em>Bif</em>, <em>Arg</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the bif Bif with the argument Arg, and store the result in Reg.       On failure jump to Lbl.       Do a garbage collection if necessary to allocate space on the heap       for the result (saving Live number of X registers).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gc_bif2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">125</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>gc_bif2</strong> <em>Lbl</em>, <em>Live</em>, <em>Bif</em>, <em>Arg1</em>, <em>Arg2</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the bif Bif with the arguments Arg1 and Arg2,       and store the result in Reg.       On failure jump to Lbl.       Do a garbage collection if necessary to allocate space on the heap       for the result (saving Live number of X registers).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gc_bif3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">152</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>gc_bif3</strong> <em>Lbl</em>, <em>Live</em>, <em>Bif</em>, <em>Arg1</em>, <em>Arg2</em>, <em>Arg3</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the bif Bif with the arguments Arg1, Arg2 and Arg3,       and store the result in Reg.       On failure jump to Lbl.       Do a garbage collection if necessary to allocate space on the heap       for the result (saving Live number of X registers).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">get_hd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">162</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>get_hd</strong> <em>Source</em>, <em>Head</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the head (or car) part of a list (a cons cell) from Source and        put it into the register Head.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">get_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">65</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>get_list</strong> <em>Source</em>, <em>Head</em>, <em>Tail</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the head and tail (or car and cdr) parts of a list        (a cons cell) from Source and put them into the registers        Head and Tail.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">get_map_elements</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">158</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">get_tl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">163</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>get_tl</strong> <em>Source</em>, <em>Tail</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the tail (or cdr) part of a list (a cons cell) from Source and        put it into the register Tail.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">get_tuple_element</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">66</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>get_tuple_element</strong> <em>Source</em>, <em>Element</em>, <em>Destination</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get element number Element from the tuple in Source and put        it in the destination register Destination.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">has_map_fields</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">157</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">if_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">73</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">init</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>init</strong> <em>N</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clear the Nth stack word. (By writing NIL.)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">int_band</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(33)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">int_bnot</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(38)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">int_bor</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(34)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">int_bsl</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(36)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">int_bsr</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(37)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">int_bxor</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(35)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">int_code_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">int_div</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(31)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">int_rem</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(32)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_atom</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">48</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_atom</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not an atom.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">53</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_binary</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a binary.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_bitstr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">129</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_bitstr</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a bit string.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">114</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_boolean</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a Boolean.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">is_constant</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(54)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_eq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">41</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_eq</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is not (numerically) equal to Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_eq_exact</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">43</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_eq_exact</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is not exactly equal to Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_float</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">46</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_float</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a float.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">77</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_function</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a       function (i.e. fun or closure).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_function2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">115</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_function2</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arity</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a       function of arity Arity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_ge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_ge</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is less than Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">45</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_integer</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not an integer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">55</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_list</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a cons or nil.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_lt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">39</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_lt</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is not less than Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_map</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">156</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_ne</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">42</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_ne</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is (numerically) equal to Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_ne_exact</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">44</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_ne_exact</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is exactly equal to Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_nil</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">52</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_nil</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not nil.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_nonempty_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">56</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_nonempty_list</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a cons.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">47</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_number</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a number.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_pid</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">49</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_pid</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a pid.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">51</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_port</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a port.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_reference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_reference</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a reference.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_tagged_tuple</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">159</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_tagged_tuple</strong> <em>Lbl</em>, <em>Reg</em>, <em>N</em>, <em>Atom</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Reg and jumps to Lbl if it is not a tuple.       Test the arity of Reg and jumps to Lbl if it is not N.       Test the first element of the tuple and jumps to Lbl if it is not Atom.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_tuple</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">57</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_tuple</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a tuple.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jump</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">61</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>jump</strong> <em>Label</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to Label.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">label</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>label</strong> <em>Lbl</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify a module local label.       Label gives this code address a name (Lbl) and marks the start of       a basic block.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">line</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">153</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">loop_rec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">23</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>loop_rec</strong> <em>Label</em>, <em>Source</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Loop over the message queue, if it is empty jump to Label.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">loop_rec_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>loop_rec_end</strong> <em>Label</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Advance the save pointer to the next message and jump back to Label.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">m_div</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(30)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">m_minus</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(28)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">m_plus</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(27)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">m_times</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(29)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">make_fun</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(76)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">make_fun2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">103</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>move</strong> <em>Source</em>, <em>Destination</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Move the source Source (a literal or a register) to       the destination register Destination.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">on_load</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">149</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">put</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">71</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">put_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">69</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">put_literal</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(128)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">put_map_assoc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">154</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">put_map_exact</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">155</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">put_string</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(68)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">put_tuple</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">70</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">put_tuple2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">164</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>put_tuple2</strong> <em>Destination</em>, <em>Elements</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Build a tuple with the elements in the list Elements and put it        put into register Destination.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">raise</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">108</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">raw_raise</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">161</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>raw_raise</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This instruction works like the erlang:raise/3 BIF, except that the        stacktrace in x(2) must be a raw stacktrace.        x(0) is the class of the exception (error, exit, or throw),        x(1) is the exception term, and x(2) is the raw stackframe.        If x(0) is not a valid class, the instruction will not throw an        exception, but store the atom 'badarg' in x(0) and execute the        next instruction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">recv_mark</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">150</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>recv_mark</strong> <em>Label</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Save the end of the message queue and the address of        the label Label so that a recv_set instruction can start        scanning the inbox from this position.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">recv_set</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">151</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>recv_set</strong> <em>Label</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check that the saved mark points to Label and set the       save pointer in the message queue to the last position       of the message queue saved by the recv_mark instruction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">remove_message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>remove_message</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unlink the current message from the message queue. Remove any timeout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">return</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>return</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return to the address in the continuation pointer (CP).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">select_tuple_arity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">60</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>select_tuple_arity</strong> <em>Tuple</em>, <em>FailLabel</em>, <em>Destinations</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check the arity of the tuple Tuple and jump to the corresponding       destination label, if no arity matches, jump to FailLabel.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">select_val</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">59</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>select_val</strong> <em>Arg</em>, <em>FailLabel</em>, <em>Destinations</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to the destination label corresponding to Arg       in the Destinations list, if no arity matches, jump to FailLabel.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">send</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>send</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send argument in x(1) as a message to the destination process in x(0).        The message in x(1) ends up as the result of the send in x(0).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">set_tuple_element</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">67</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>set_tuple_element</strong> <em>NewElement</em>, <em>Tuple</em>, <em>Position</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update the element at position Position of the tuple Tuple        with the new element NewElement.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">swap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">169</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>swap</strong> <em>Register1</em>, <em>Register2</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Swaps the contents of two registers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">test_arity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>test_arity</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arity</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the arity of (the tuple in) Arg1 and jump  to Lbl if it is not equal to Arity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">test_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>test_heap</strong> <em>HeapNeed</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ensure there is space for HeapNeed words on the heap. If a GC is needed       save Live number of X registers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">22</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>timeout</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reset the save point of the mailbox and clear the timeout flag.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">trim</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">136</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>trim</strong> <em>N</em>, <em>Remaining</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reduce the stack usage by N words,       keeping the CP on the top of the stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">try</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">104</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">try_case</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">106</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">try_case_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">107</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">try_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">105</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wait</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>wait</strong> <em>Label</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Suspend the processes and set the entry point to the beginning of the        receive loop at Label.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wait_timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">26</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>wait_timeout</strong> <em>Lable</em>, <em>Time</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets up a timeout of Time milliseconds and saves the address of the        following instruction as the entry point if the timeout triggers.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_specific_instructions"><a class="link" href="#_specific_instructions">B.13. Specific Instructions</a></h3>
<div class="paragraph">
<p>Argument types</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An immediate atom value, e.g. 'foo'</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">c</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An immediate constant value (atom, nil, small int) // Pid?</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">d</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Either a register or a stack slot</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A reference to an export table entry</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A label, i.e. a code address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An integer e.g. <code>42</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">j</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An optional code label</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">l</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A floating-point register</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">P</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A positive (unsigned) integer literal</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">r</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A register R0 (<code>x[0]</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Either a literal, a register or a stack slot</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">t</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A term, e.g. <code>[{foo, bar}]</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A register, e.g. <code>5</code> for <code>{x, 5}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A stack slot, e.g. <code>1</code> for <code>{y, 1}</code></p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_list_of_all_beam_instructions"><a class="link" href="#_list_of_all_beam_instructions">B.13.1. List of all BEAM Instructions</a></h4>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Instruction</th>
<th class="tableblock halign-left valign-top">Arguments</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">t t</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocate some words on stack</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">t I t</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocate some words on the heap</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate_heap_zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">t I t</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocate some heap and set the words to NIL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate_init</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">t I y</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate_zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">t t</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocate some stack and set the words to 0?</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">apply</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apply args in <code>x[0..Arity-1]</code> to module in <code>x[Arity]</code> and function in <code>x[Arity+1]</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">apply_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I P</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as <code>apply</code> but does not save the CP and <code>deallocates</code> P words</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">badarg</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a <code>badarg</code> error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">badmatch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a <code>badmatch</code> error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bif1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f b s d</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Calls a bif with 1 argument, on fail jumps to <code>f</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bif1_body</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">b s d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_context_to_binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_put_string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_test_tail_imm2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_test_unit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_test_unit8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_test_zero_tail2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_bif0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_bif1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_bif2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_bif3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">case_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a <code>case_clause</code> error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">catch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">catch_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deallocate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Free some words from stack and pop CP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deallocate_return</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Q</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Combines <code>deallocate</code> and <code>return</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extract_next_element</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xy</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extract_next_element2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xy</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extract_next_element3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xy</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fclearerror</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fconv</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">d l</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fmove</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">qdl ld</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">get_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy rxy rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deconstruct a list cell into the head and the tail</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_apply</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the code for function <code>x0:x1</code> with args <code>x2</code> saving the CP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_apply_fun</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the code for function object <code>x0</code> with args <code>x1</code> saving the CP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_apply_fun_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to the code for function object <code>x0</code> with args <code>x1</code>, restoring the CP and deallocating <code>P</code> stack cells</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_apply_fun_only</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to the code for function object <code>x0</code> with args <code>x1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_apply_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to the code for function <code>x0:x1</code> with args <code>x2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_apply_only</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to the code for function <code>x0:x1</code> with args <code>x2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_band</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bif2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f b d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bif2_body</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">b d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_add</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_append</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_binary2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I s I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_binary_all2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_binary_all_reuse</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx f I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_binary_imm2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_float2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I s I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_integer_16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx f d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_integer_32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx f I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_integer_8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx f d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_integer_imm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx I I f I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_integer_small_imm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx I f I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_utf16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx f I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_utf8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx f d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_bits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_bits_fail</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_bits_fail_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_bits_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_fail</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_fail_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_heap_bin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_heap_bin_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_writable</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_match_string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx f I I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_private_append</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_put_utf16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_put_utf8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_restore2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_save2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_skip_bits2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx rxy I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_skip_bits2_imm2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_skip_bits_all2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_start_match2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy f I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_utf16_size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_utf8_size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_validate_unicode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_validate_unicode_retract</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bsl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bsr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bxor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_call</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_call_ext</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_call_ext_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e P</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_call_ext_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_call_fun</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_call_fun_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I P</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_call_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f P</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_call_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_element</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy j s d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_fadd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">l l l</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_fast_element</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_fcheckerror</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_fdiv</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">l l l</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_fetch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_fmul</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">l l l</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_fnegate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">l l l</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_fsub</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">l l l</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_func_info</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I a a I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a <code>function_clause</code> error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_gc_bif1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I s I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_gc_bif2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_gc_bif3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I s I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_get</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_get_tuple_element</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy P rxy</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_hibernate</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_increment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_int_bnot</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j s I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_int_div</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_eq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_eq_exact</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_eq_exact_immed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy c</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_eq_exact_literal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy c</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_ge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_lt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_ne</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_ne_exact</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_ne_exact_immed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy c</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_ne_exact_literal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy c</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_jump_on_val</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy f I I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_jump_on_val_zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy f I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_loop_rec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f r</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_m_div</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_make_fun</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I t</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_minus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_move_call</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">c r f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_move_call_ext</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">c r e</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_move_call_ext_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e P c r</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_move_call_ext_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e c r</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_move_call_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f P c r</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_move_call_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f c r</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_new_bs_put_binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j s I s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_new_bs_put_binary_all</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j s I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_new_bs_put_binary_imm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_new_bs_put_float</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j s I s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_new_bs_put_float_imm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I I s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_new_bs_put_integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j s I s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_new_bs_put_integer_imm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I I s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_plus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_put_tuple</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create tuple of arity <code>I</code> and place result in <code>rxy</code>, elements follow as <code>put</code> instructions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_recv_set</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_rem</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_tuple_arity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">r f I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_tuple_arity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x f I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_tuple_arity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y f I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_tuple_arity2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">r f A f A f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_tuple_arity2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x f A f A f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_tuple_arity2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y f A f A f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_val</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">r f I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compare value to a list of pairs <code>{Value, Label}</code> and jump when a match is found, otherwise jump to <code>f</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_val</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x f I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as above but for x register</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_val</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y f I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as above but for y register</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_val2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">r f c f c f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compare value to two pairs <code>{c1, f1}</code>, or <code>{c2, f2}</code> and jump, on fail jump to <code>f</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_val2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x f c f c f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as above but for x register</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_val2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y f c f c f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as above but for y register</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_times</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_trim</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cut stack by <code>I</code> elements, preserving CP on top</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_wait_error</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_wait_error_locked</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_wait_timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_wait_timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_wait_timeout_locked</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_wait_timeout_locked</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">if_end</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create an <code>if_clause</code> error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">init</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set a word on stack to NIL []</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">init2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set two words on stack to NIL []</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">init3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y y y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set three words on stack to NIL []</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">int_code_end</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">End of the program (same as return with no stack)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_atom</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is an atom and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_bitstring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a bit string and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is atom 'true' or 'false' and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_float</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a floating point number and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a function and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_function2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f s s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a function and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a big or small integer and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_integer_allocate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a list or NIL and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_nil</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is an empty list [] and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_nonempty_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a nonempty list (cons pointer) and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_nonempty_list_allocate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I t</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_nonempty_list_test_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f r I t</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a big or small integer or a float and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_pid</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a pid and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a port and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_reference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a reference and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_tuple</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a tuple and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_tuple_of_arity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a tuple of arity <code>A</code> and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jump</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to location (label) <code>f</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">label</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Marks a location in code, removed at the load time</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">line</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Marks a location in source file, removed at the load time</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">loop_rec_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Advances receive pointer in the process and jumps to the <code>loop_rec</code> instruction</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxync rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Moves a value or a register into another register</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x x x x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Move a pair of values to a pair of destinations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x y x y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Move a pair of values to a pair of destinations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y x y x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Move a pair of values to a pair of destinations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move_call</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xy r f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move_call_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xy r f Q</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move_call_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x r f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move_deallocate_return</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xycn r Q</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move_jump</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f ncxy</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move_return</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xcn r</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move_x1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">c</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store value in <code>x1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move_x2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">c</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store value in <code>x2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">node</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get <code>rxy</code> to the atom, current node name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">put</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequence of these is placed after <code>i_put_tuple</code> and is used to initialize tuple elements (starting from 0)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">put_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s s d</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Construct a list cell from a head and a tail and the cons pointer is placed into destination <code>d</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">raise</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Raise an exception of given type, the exception type has to be extracted from the second stacktrace argument due to legacy/compatibility reasons.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">recv_mark</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mark a known restart position for messages retrieval (reference optimization)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">remove_message</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Removes current message from the process inbox (was received)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">return</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to the address in CP, set CP to 0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">self</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>rxy</code> to the pid of the current process</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">send</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send message <code>x1</code> to the inbox of process <code>x0</code>, there is no error if process did not exist</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">set_tuple_element</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s d P</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Destructively update a tuple element by index</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">system_limit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">test_arity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether function object (closure or export) in <code>rxy</code> has arity <code>A</code> and jump to <code>f</code> otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">test_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I t</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check the heap space availability</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">test_heap_1_put_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I y</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timeout</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets up a timer and yields the execution of the process waiting for an incoming message, or a timer event whichever comes first</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timeout_locked</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">try</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Writes a special catch value to stack cell <code>y</code> which marks an active try block, the VM will jump to the label <code>f</code> if an exception happens. Code which runs after this becomes guarded against exceptions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">try_case</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Similar to <code>try_end</code> marks an end of the guarded section, clears the catch value on stack and begins the code section of exception matching</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">try_case_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">try_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clears the catch value from the stack cell <code>y</code> marking an end of the guarded section</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wait</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Schedules the process out waiting for an incoming message (yields)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wait_locked</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wait_unlocked</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="AP-listings"><a class="link" href="#AP-listings">Appendix C: Full Code Listings</a></h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">beamfile</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">read</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="nf">read</span><span class="p">(</span><span class="nv">Filename</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">File</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p">(</span><span class="nv">Filename</span><span class="p">),</span>
    <span class="o">&lt;&lt;</span><span class="s">"FOR1"</span><span class="p">,</span>
      <span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
      <span class="s">"BEAM"</span><span class="p">,</span>
      <span class="nv">Chunks</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">File</span><span class="p">,</span>
    <span class="p">{</span><span class="nv">Size</span><span class="p">,</span> <span class="nf">parse_chunks</span><span class="p">(</span><span class="nf">read_chunks</span><span class="p">(</span><span class="nv">Chunks</span><span class="p">,</span> <span class="p">[]),[])}.</span>

<span class="nf">read_chunks</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">N</span><span class="p">,</span><span class="nv">A</span><span class="p">,</span><span class="nv">M</span><span class="p">,</span><span class="nv">E</span><span class="p">,</span> <span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Tail</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="c">%% Align each chunk on even 4 bytes
</span>    <span class="nv">ChunkLength</span> <span class="o">=</span> <span class="nf">align_by_four</span><span class="p">(</span><span class="nv">Size</span><span class="p">),</span>
    <span class="o">&lt;&lt;</span><span class="nv">Chunk</span><span class="p">:</span><span class="nv">ChunkLength</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Tail</span><span class="p">,</span>
    <span class="nf">read_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="p">[{[</span><span class="nv">N</span><span class="p">,</span><span class="nv">A</span><span class="p">,</span><span class="nv">M</span><span class="p">,</span><span class="nv">E</span><span class="p">],</span> <span class="nv">Size</span><span class="p">,</span> <span class="nv">Chunk</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">read_chunks</span><span class="p">(</span><span class="o">&lt;&lt;&gt;&gt;</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">reverse</span><span class="p">(</span><span class="nv">Acc</span><span class="p">).</span>

<span class="nf">align_by_four</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">((</span><span class="nv">N</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="ow">div</span> <span class="mi">4</span><span class="p">)).</span>

<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Atom"</span><span class="p">,</span> <span class="p">_</span><span class="nv">Size</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">Numberofatoms</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Atoms</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">atoms</span><span class="p">,</span><span class="nf">parse_atoms</span><span class="p">(</span><span class="nv">Atoms</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"ExpT"</span><span class="p">,</span> <span class="p">_</span><span class="nv">Size</span><span class="p">,</span>
              <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">Numberofentries</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Exports</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span>
             <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">exports</span><span class="p">,</span><span class="nf">parse_table</span><span class="p">(</span><span class="nv">Exports</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"ImpT"</span><span class="p">,</span> <span class="p">_</span><span class="nv">Size</span><span class="p">,</span>
              <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">Numberofentries</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Imports</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span>
             <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">imports</span><span class="p">,</span><span class="nf">parse_table</span><span class="p">(</span><span class="nv">Imports</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Code"</span><span class="p">,</span> <span class="nv">Size</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">SubSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Chunk</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="nv">Info</span><span class="p">:</span><span class="nv">SubSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="nv">Code</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Chunk</span><span class="p">,</span>
    <span class="nv">OpcodeSize</span> <span class="o">=</span> <span class="nv">Size</span> <span class="o">-</span> <span class="nv">SubSize</span> <span class="o">-</span> <span class="mi">8</span><span class="p">,</span> <span class="c">%% 8 is size of CunkSize &amp; SubSize
</span>    <span class="o">&lt;&lt;</span><span class="nv">OpCodes</span><span class="p">:</span><span class="nv">OpcodeSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="p">_</span><span class="nv">Align</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Code</span><span class="p">,</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">code</span><span class="p">,</span><span class="nf">parse_code_info</span><span class="p">(</span><span class="nv">Info</span><span class="p">),</span> <span class="nv">OpCodes</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"StrT"</span><span class="p">,</span> <span class="p">_</span><span class="nv">Size</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">Strings</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">strings</span><span class="p">,</span><span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">Strings</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Attr"</span><span class="p">,</span> <span class="nv">Size</span><span class="p">,</span> <span class="nv">Chunk</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="nv">Bin</span><span class="p">:</span><span class="nv">Size</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="p">_</span><span class="nv">Pad</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Chunk</span><span class="p">,</span>
    <span class="nv">Attribs</span> <span class="o">=</span> <span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Bin</span><span class="p">),</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">attributes</span><span class="p">,</span><span class="nv">Attribs</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"CInf"</span><span class="p">,</span> <span class="nv">Size</span><span class="p">,</span> <span class="nv">Chunk</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="nv">Bin</span><span class="p">:</span><span class="nv">Size</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="p">_</span><span class="nv">Pad</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Chunk</span><span class="p">,</span>
    <span class="nv">CInfo</span> <span class="o">=</span> <span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Bin</span><span class="p">),</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">compile_info</span><span class="p">,</span><span class="nv">CInfo</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"LocT"</span><span class="p">,</span> <span class="p">_</span><span class="nv">Size</span><span class="p">,</span>
              <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">Numberofentries</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Locals</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span>
             <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">locals</span><span class="p">,</span><span class="nf">parse_table</span><span class="p">(</span><span class="nv">Locals</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"LitT"</span><span class="p">,</span> <span class="p">_</span><span class="nv">ChunkSize</span><span class="p">,</span>
              <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">CompressedTableSize</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span> <span class="nv">Compressed</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span>
             <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">NumLiterals</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nv">Table</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nn">zlib</span><span class="p">:</span><span class="nf">uncompress</span><span class="p">(</span><span class="nv">Compressed</span><span class="p">),</span>
    <span class="nv">Literals</span> <span class="o">=</span> <span class="nf">parse_literals</span><span class="p">(</span><span class="nv">Table</span><span class="p">),</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">literals</span><span class="p">,</span><span class="nv">Literals</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Abst"</span><span class="p">,</span> <span class="p">_</span><span class="nv">ChunkSize</span><span class="p">,</span> <span class="o">&lt;&lt;&gt;&gt;</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span><span class="nv">Acc</span><span class="p">);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Abst"</span><span class="p">,</span> <span class="p">_</span><span class="nv">ChunkSize</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">AbstractCode</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">abstract_code</span><span class="p">,</span><span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">AbstractCode</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Line"</span><span class="p">,</span> <span class="p">_</span><span class="nv">ChunkSize</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">LineTable</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="nv">Ver</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nv">Bits</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nv">NumLineInstrs</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nv">NumLines</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nv">NumFnames</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span>
      <span class="nv">Lines</span><span class="p">:</span><span class="nv">NumLines</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span><span class="nv">Fnames</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">LineTable</span><span class="p">,</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">line</span><span class="p">,</span>
			<span class="p">[{</span><span class="n">version</span><span class="p">,</span><span class="nv">Ver</span><span class="p">},</span>
			 <span class="p">{</span><span class="n">bits</span><span class="p">,</span><span class="nv">Bits</span><span class="p">},</span>
			 <span class="p">{</span><span class="n">num_line_instrunctions</span><span class="p">,</span><span class="nv">NumLineInstrs</span><span class="p">},</span>
			 <span class="p">{</span><span class="n">lines</span><span class="p">,</span><span class="nf">decode_lineinfo</span><span class="p">(</span><span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">Lines</span><span class="p">),</span><span class="mi">0</span><span class="p">)},</span>
			 <span class="p">{</span><span class="n">function_names</span><span class="p">,</span><span class="nv">Fnames</span><span class="p">}]}|</span><span class="nv">Acc</span><span class="p">]);</span>


<span class="nf">parse_chunks</span><span class="p">([</span><span class="nv">Chunk</span><span class="p">|</span><span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c">%% Not yet implemented chunk
</span>    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="p">[</span><span class="nv">Chunk</span><span class="p">|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([],</span><span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Acc</span><span class="p">.</span>

<span class="nf">parse_atoms</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Atomlength</span><span class="p">,</span> <span class="nv">Atom</span><span class="p">:</span><span class="nv">Atomlength</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="k">when</span> <span class="nv">Atomlength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">-&gt;</span>
    <span class="p">[</span><span class="nb">list_to_atom</span><span class="p">(</span><span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">Atom</span><span class="p">))</span> <span class="p">|</span> <span class="nf">parse_atoms</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">parse_atoms</span><span class="p">(_</span><span class="nv">Alignment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[].</span>

<span class="nf">parse_table</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Function</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
                <span class="nv">Arity</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
                <span class="nv">Label</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
                <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[{</span><span class="nv">Function</span><span class="p">,</span> <span class="nv">Arity</span><span class="p">,</span> <span class="nv">Label</span><span class="p">}</span> <span class="p">|</span> <span class="nf">parse_table</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">parse_table</span><span class="p">(</span><span class="o">&lt;&lt;&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[].</span>


<span class="nf">parse_code_info</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Instructionset</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
		  <span class="nv">OpcodeMax</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
		  <span class="nv">NumberOfLabels</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
		  <span class="nv">NumberOfFunctions</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
		  <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[{</span><span class="n">instructionset</span><span class="p">,</span> <span class="nv">Instructionset</span><span class="p">},</span>
     <span class="p">{</span><span class="n">opcodemax</span><span class="p">,</span> <span class="nv">OpcodeMax</span><span class="p">},</span>
     <span class="p">{</span><span class="n">numberoflabels</span><span class="p">,</span> <span class="nv">NumberOfLabels</span><span class="p">},</span>
     <span class="p">{</span><span class="n">numberofFunctions</span><span class="p">,</span> <span class="nv">NumberOfFunctions</span><span class="p">}</span> <span class="p">|</span>
     <span class="k">case</span> <span class="nv">Rest</span> <span class="k">of</span>
	 <span class="o">&lt;&lt;&gt;&gt;</span> <span class="o">-&gt;</span> <span class="p">[];</span>
	 <span class="p">_</span> <span class="o">-&gt;</span> <span class="p">[{</span><span class="n">newinfo</span><span class="p">,</span> <span class="nv">Rest</span><span class="p">}]</span>
     <span class="k">end</span><span class="p">].</span>

<span class="nf">parse_literals</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nv">Literal</span><span class="p">:</span><span class="nv">Size</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span><span class="nv">Tail</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Literal</span><span class="p">)</span> <span class="p">|</span> <span class="nf">parse_literals</span><span class="p">(</span><span class="nv">Tail</span><span class="p">)];</span>
<span class="nf">parse_literals</span><span class="p">(</span><span class="o">&lt;&lt;&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[].</span>



<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">tag_i</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span>
<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">tag_a</span><span class="p">,</span> <span class="mi">2</span><span class="p">).</span>

<span class="nf">decode_tag</span><span class="p">(</span><span class="o">?</span><span class="n">tag_i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">;</span>
<span class="nf">decode_tag</span><span class="p">(</span><span class="o">?</span><span class="n">tag_a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">.</span>

<span class="nf">decode_int</span><span class="p">(</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">Bs</span><span class="p">)</span> <span class="k">when</span> <span class="p">(</span><span class="nv">B</span> <span class="ow">band</span> <span class="mi">16#08</span><span class="p">)</span> <span class="o">=:=</span> <span class="mi">0</span> <span class="o">-&gt;</span>
    <span class="c">%% N &lt; 16 = 4 bits, NNNN:0:TTT
</span>    <span class="nv">N</span> <span class="o">=</span> <span class="nv">B</span> <span class="ow">bsr</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">{{</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">N</span><span class="p">},</span><span class="nv">Bs</span><span class="p">};</span>
<span class="nf">decode_int</span><span class="p">(</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">B</span><span class="p">,[])</span> <span class="k">when</span> <span class="p">(</span><span class="nv">B</span> <span class="ow">band</span> <span class="mi">16#10</span><span class="p">)</span> <span class="o">=:=</span> <span class="mi">0</span> <span class="o">-&gt;</span>
    <span class="c">%% N &lt; 2048 = 11 bits = 3:8 bits, NNN:01:TTT, NNNNNNNN
</span>    <span class="nv">Val0</span> <span class="o">=</span> <span class="nv">B</span> <span class="ow">band</span> <span class="mi">2#11100000</span><span class="p">,</span>
    <span class="nv">N</span> <span class="o">=</span> <span class="p">(</span><span class="nv">Val0</span> <span class="ow">bsl</span> <span class="mi">3</span><span class="p">),</span>
    <span class="p">{{</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">N</span><span class="p">},[]};</span>
<span class="nf">decode_int</span><span class="p">(</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">Bs</span><span class="p">)</span> <span class="k">when</span> <span class="p">(</span><span class="nv">B</span> <span class="ow">band</span> <span class="mi">16#10</span><span class="p">)</span> <span class="o">=:=</span> <span class="mi">0</span> <span class="o">-&gt;</span>
    <span class="c">%% N &lt; 2048 = 11 bits = 3:8 bits, NNN:01:TTT, NNNNNNNN
</span>    <span class="p">[</span><span class="nv">B1</span><span class="p">|</span><span class="nv">Bs1</span><span class="p">]</span> <span class="o">=</span> <span class="nv">Bs</span><span class="p">,</span>
    <span class="nv">Val0</span> <span class="o">=</span> <span class="nv">B</span> <span class="ow">band</span> <span class="mi">2#11100000</span><span class="p">,</span>
    <span class="nv">N</span> <span class="o">=</span> <span class="p">(</span><span class="nv">Val0</span> <span class="ow">bsl</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">bor</span> <span class="nv">B1</span><span class="p">,</span>
    <span class="p">{{</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">N</span><span class="p">},</span><span class="nv">Bs1</span><span class="p">};</span>
<span class="nf">decode_int</span><span class="p">(</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">Bs</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">Len</span><span class="p">,</span><span class="nv">Bs1</span><span class="p">}</span> <span class="o">=</span> <span class="nf">decode_int_length</span><span class="p">(</span><span class="nv">B</span><span class="p">,</span><span class="nv">Bs</span><span class="p">),</span>
    <span class="p">{</span><span class="nv">IntBs</span><span class="p">,</span><span class="nv">RemBs</span><span class="p">}</span> <span class="o">=</span> <span class="nf">take_bytes</span><span class="p">(</span><span class="nv">Len</span><span class="p">,</span><span class="nv">Bs1</span><span class="p">),</span>
    <span class="nv">N</span> <span class="o">=</span> <span class="nf">build_arg</span><span class="p">(</span><span class="nv">IntBs</span><span class="p">),</span>
    <span class="p">{{</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">N</span><span class="p">},</span><span class="nv">RemBs</span><span class="p">}.</span>

<span class="nf">decode_lineinfo</span><span class="p">([</span><span class="nv">B</span><span class="p">|</span><span class="nv">Bs</span><span class="p">],</span> <span class="nv">F</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">Tag</span> <span class="o">=</span> <span class="nf">decode_tag</span><span class="p">(</span><span class="nv">B</span> <span class="ow">band</span> <span class="mi">2#111</span><span class="p">),</span>
    <span class="p">{{</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">Num</span><span class="p">},</span><span class="nv">RemBs</span><span class="p">}</span> <span class="o">=</span> <span class="nf">decode_int</span><span class="p">(</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">Bs</span><span class="p">),</span>
    <span class="k">case</span> <span class="nv">Tag</span> <span class="k">of</span>
	<span class="n">i</span> <span class="o">-&gt;</span>
	    <span class="p">[{</span><span class="nv">F</span><span class="p">,</span> <span class="nv">Num</span><span class="p">}</span> <span class="p">|</span> <span class="nf">decode_lineinfo</span><span class="p">(</span><span class="nv">RemBs</span><span class="p">,</span> <span class="nv">F</span><span class="p">)];</span>
	<span class="n">a</span> <span class="o">-&gt;</span>
	    <span class="p">[</span><span class="nv">B2</span><span class="p">|</span><span class="nv">Bs2</span><span class="p">]</span> <span class="o">=</span> <span class="nv">RemBs</span><span class="p">,</span>
	    <span class="nv">Tag2</span> <span class="o">=</span> <span class="nf">decode_tag</span><span class="p">(</span><span class="nv">B2</span> <span class="ow">band</span> <span class="mi">2#111</span><span class="p">),</span>
	    <span class="p">{{</span><span class="nv">Tag2</span><span class="p">,</span><span class="nv">Num2</span><span class="p">},</span><span class="nv">RemBs2</span><span class="p">}</span> <span class="o">=</span> <span class="nf">decode_int</span><span class="p">(</span><span class="nv">Tag2</span><span class="p">,</span><span class="nv">B2</span><span class="p">,</span><span class="nv">Bs2</span><span class="p">),</span>
	    <span class="p">[{</span><span class="nv">Num</span><span class="p">,</span> <span class="nv">Num2</span><span class="p">}</span> <span class="p">|</span> <span class="nf">decode_lineinfo</span><span class="p">(</span><span class="nv">RemBs2</span><span class="p">,</span> <span class="nv">Num2</span><span class="p">)]</span>
    <span class="k">end</span><span class="p">;</span>
<span class="nf">decode_lineinfo</span><span class="p">([],_)</span> <span class="o">-&gt;</span> <span class="p">[].</span>

<span class="nf">decode_int_length</span><span class="p">(</span><span class="nv">B</span><span class="p">,</span> <span class="nv">Bs</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">B</span> <span class="ow">bsr</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nv">Bs</span><span class="p">}.</span>


<span class="nf">take_bytes</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Bs</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">take_bytes</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Bs</span><span class="p">,</span> <span class="p">[]).</span>

<span class="nf">take_bytes</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="p">[</span><span class="nv">B</span><span class="p">|</span><span class="nv">Bs</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="k">when</span> <span class="nv">N</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">-&gt;</span>
    <span class="nf">take_bytes</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nv">Bs</span><span class="p">,</span> <span class="p">[</span><span class="nv">B</span><span class="p">|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">take_bytes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">Bs</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nn">lists</span><span class="p">:</span><span class="nf">reverse</span><span class="p">(</span><span class="nv">Acc</span><span class="p">),</span> <span class="nv">Bs</span><span class="p">}.</span>


<span class="nf">build_arg</span><span class="p">(</span><span class="nv">Bs</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">build_arg</span><span class="p">(</span><span class="nv">Bs</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span>

<span class="nf">build_arg</span><span class="p">([</span><span class="nv">B</span><span class="p">|</span><span class="nv">Bs</span><span class="p">],</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">build_arg</span><span class="p">(</span><span class="nv">Bs</span><span class="p">,</span> <span class="p">(</span><span class="nv">N</span> <span class="ow">bsl</span> <span class="mi">8</span><span class="p">)</span> <span class="ow">bor</span> <span class="nv">B</span><span class="p">);</span>
<span class="nf">build_arg</span><span class="p">([],</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">N</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">world</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">hello</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">include</span><span class="p">(</span><span class="s">"world.hrl"</span><span class="p">).</span>

<span class="nf">hello</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="o">?</span><span class="nv">GREETING</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">json_parser</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">parse_transform</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>

<span class="nf">parse_transform</span><span class="p">(</span><span class="nv">AST</span><span class="p">,</span> <span class="p">_</span><span class="nv">Options</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">json</span><span class="p">(</span><span class="nv">AST</span><span class="p">,</span> <span class="p">[]).</span>

<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">FUNCTION</span><span class="p">(</span><span class="nv">Clauses</span><span class="p">),</span> <span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="nv">Label</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">Arity</span><span class="p">,</span> <span class="nv">Clauses</span><span class="p">}).</span>

<span class="c">%% We are only interested in code inside functions.
</span><span class="nf">json</span><span class="p">([</span><span class="o">?</span><span class="nv">FUNCTION</span><span class="p">(</span><span class="nv">Clauses</span><span class="p">)</span> <span class="p">|</span> <span class="nv">Elements</span><span class="p">],</span> <span class="nv">Res</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">json</span><span class="p">(</span><span class="nv">Elements</span><span class="p">,</span> <span class="p">[</span><span class="o">?</span><span class="nv">FUNCTION</span><span class="p">(</span><span class="nf">json_clauses</span><span class="p">(</span><span class="nv">Clauses</span><span class="p">))</span> <span class="p">|</span> <span class="nv">Res</span><span class="p">]);</span>
<span class="nf">json</span><span class="p">([</span><span class="nv">Other</span><span class="p">|</span><span class="nv">Elements</span><span class="p">],</span> <span class="nv">Res</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nf">json</span><span class="p">(</span><span class="nv">Elements</span><span class="p">,</span> <span class="p">[</span><span class="nv">Other</span> <span class="p">|</span> <span class="nv">Res</span><span class="p">]);</span>
<span class="nf">json</span><span class="p">([],</span> <span class="nv">Res</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">reverse</span><span class="p">(</span><span class="nv">Res</span><span class="p">).</span>

<span class="c">%% We are interested in the code in the body of a function.
</span><span class="nf">json_clauses</span><span class="p">([{</span><span class="n">clause</span><span class="p">,</span> <span class="nv">CLine</span><span class="p">,</span> <span class="nv">A1</span><span class="p">,</span> <span class="nv">A2</span><span class="p">,</span> <span class="nv">Code</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Clauses</span><span class="p">])</span> <span class="o">-&gt;</span>
    <span class="p">[{</span><span class="n">clause</span><span class="p">,</span> <span class="nv">CLine</span><span class="p">,</span> <span class="nv">A1</span><span class="p">,</span> <span class="nv">A2</span><span class="p">,</span> <span class="nf">json_code</span><span class="p">(</span><span class="nv">Code</span><span class="p">)}</span> <span class="p">|</span> <span class="nf">json_clauses</span><span class="p">(</span><span class="nv">Clauses</span><span class="p">)];</span>
<span class="nf">json_clauses</span><span class="p">([])</span> <span class="o">-&gt;</span> <span class="p">[].</span>


<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">JSON</span><span class="p">(</span><span class="nv">Json</span><span class="p">),</span> <span class="p">{</span><span class="n">bin</span><span class="p">,</span> <span class="p">_,</span> <span class="p">[{</span><span class="n">bin_element</span>
                                          <span class="p">,</span> <span class="p">_</span>
                                          <span class="p">,</span> <span class="p">{</span><span class="n">tuple</span><span class="p">,</span> <span class="p">_,</span> <span class="p">[</span><span class="nv">Json</span><span class="p">]}</span>
                                          <span class="p">,</span> <span class="p">_</span>
                                          <span class="p">,</span> <span class="p">_}]}).</span>

<span class="c">%% We look for: &lt;&lt;"json"&gt;&gt; = Json-Term
</span><span class="nf">json_code</span><span class="p">([])</span>                     <span class="o">-&gt;</span> <span class="p">[];</span>
<span class="nf">json_code</span><span class="p">([</span><span class="o">?</span><span class="nv">JSON</span><span class="p">(</span><span class="nv">Json</span><span class="p">)|</span><span class="nv">MoreCode</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nf">parse_json</span><span class="p">(</span><span class="nv">Json</span><span class="p">)</span> <span class="p">|</span> <span class="nf">json_code</span><span class="p">(</span><span class="nv">MoreCode</span><span class="p">)];</span>
<span class="nf">json_code</span><span class="p">(</span><span class="nv">Code</span><span class="p">)</span>                   <span class="o">-&gt;</span> <span class="nv">Code</span><span class="p">.</span>

<span class="c">%% Json Object -&gt; [{}] | [{Label, Term}]
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">tuple</span><span class="p">,</span><span class="nv">Line</span><span class="p">,[]})</span>            <span class="o">-&gt;</span> <span class="p">{</span><span class="n">cons</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="p">{</span><span class="n">tuple</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="p">[]}};</span>
<span class="nf">parse_json</span><span class="p">({</span><span class="n">tuple</span><span class="p">,</span><span class="nv">Line</span><span class="p">,</span><span class="nv">Fields</span><span class="p">})</span>        <span class="o">-&gt;</span> <span class="nf">parse_json_fields</span><span class="p">(</span><span class="nv">Fields</span><span class="p">,</span><span class="nv">Line</span><span class="p">);</span>
<span class="c">%% Json Array -&gt; List
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">cons</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Head</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">})</span>   <span class="o">-&gt;</span> <span class="p">{</span><span class="n">cons</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nf">parse_json</span><span class="p">(</span><span class="nv">Head</span><span class="p">),</span>
                                                       <span class="nf">parse_json</span><span class="p">(</span><span class="nv">Tail</span><span class="p">)};</span>
<span class="nf">parse_json</span><span class="p">({</span><span class="n">nil</span><span class="p">,</span> <span class="nv">Line</span><span class="p">})</span>                <span class="o">-&gt;</span> <span class="p">{</span><span class="n">nil</span><span class="p">,</span> <span class="nv">Line</span><span class="p">};</span>
<span class="c">%% Json String -&gt; &lt;&lt;String&gt;&gt;
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">string</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">String</span><span class="p">})</span>     <span class="o">-&gt;</span> <span class="nf">str_to_bin</span><span class="p">(</span><span class="nv">String</span><span class="p">,</span> <span class="nv">Line</span><span class="p">);</span>
<span class="c">%% Json Integer -&gt; Intger
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Integer</span><span class="p">})</span>   <span class="o">-&gt;</span> <span class="p">{</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Integer</span><span class="p">};</span>
<span class="c">%% Json Float -&gt; Float
</span><span class="nf">parse_json</span><span class="p">({</span><span class="nb">float</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Float</span><span class="p">})</span>       <span class="o">-&gt;</span> <span class="p">{</span><span class="nb">float</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Float</span><span class="p">};</span>
<span class="c">%% Json Constant -&gt; true | false | null
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">true</span><span class="p">})</span>         <span class="o">-&gt;</span> <span class="p">{</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">true</span><span class="p">};</span>
<span class="nf">parse_json</span><span class="p">({</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">false</span><span class="p">})</span>        <span class="o">-&gt;</span> <span class="p">{</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">false</span><span class="p">};</span>
<span class="nf">parse_json</span><span class="p">({</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">null</span><span class="p">})</span>         <span class="o">-&gt;</span> <span class="p">{</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">null</span><span class="p">};</span>

<span class="c">%% Variables, should contain Erlang encoded Json
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Var</span><span class="p">})</span>         <span class="o">-&gt;</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Var</span><span class="p">};</span>
<span class="c">%% Json Negative Integer or Float
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">op</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">'-'</span><span class="p">,</span> <span class="p">{</span><span class="nv">Type</span><span class="p">,</span> <span class="p">_,</span> <span class="nv">N</span><span class="p">}})</span> <span class="k">when</span> <span class="nv">Type</span> <span class="o">=:=</span> <span class="n">integer</span>
                                               <span class="p">;</span> <span class="nv">Type</span> <span class="o">=:=</span> <span class="nb">float</span> <span class="o">-&gt;</span>
                                          <span class="p">{</span><span class="nv">Type</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="o">-</span><span class="nv">N</span><span class="p">}.</span>
<span class="c">%% parse_json(Code)                  -&gt; io:format("Code: ~p~n",[Code]), Code.
</span>
<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">FIELD</span><span class="p">(</span><span class="nv">Label</span><span class="p">,</span> <span class="nv">Code</span><span class="p">),</span> <span class="p">{</span><span class="n">remote</span><span class="p">,</span> <span class="nv">L</span><span class="p">,</span> <span class="p">{</span><span class="n">string</span><span class="p">,</span> <span class="p">_,</span> <span class="nv">Label</span><span class="p">},</span> <span class="nv">Code</span><span class="p">}).</span>

<span class="nf">parse_json_fields</span><span class="p">([],</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">nil</span><span class="p">,</span> <span class="nv">L</span><span class="p">};</span>
<span class="c">%% Label : Json-Term  --&gt; [{&lt;&lt;Label&gt;&gt;, Term} | Rest]
</span><span class="nf">parse_json_fields</span><span class="p">([</span><span class="o">?</span><span class="nv">FIELD</span><span class="p">(</span><span class="nv">Label</span><span class="p">,</span> <span class="nv">Code</span><span class="p">)</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="p">_)</span> <span class="o">-&gt;</span>
    <span class="nf">cons</span><span class="p">(</span><span class="nf">tuple</span><span class="p">(</span><span class="nf">str_to_bin</span><span class="p">(</span><span class="nv">Label</span><span class="p">,</span> <span class="nv">L</span><span class="p">),</span> <span class="nf">parse_json</span><span class="p">(</span><span class="nv">Code</span><span class="p">),</span> <span class="nv">L</span><span class="p">)</span>
         <span class="p">,</span> <span class="nf">parse_json_fields</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span>
         <span class="p">,</span> <span class="nv">L</span><span class="p">).</span>


<span class="nf">tuple</span><span class="p">(</span><span class="nv">E1</span><span class="p">,</span> <span class="nv">E2</span><span class="p">,</span> <span class="nv">Line</span><span class="p">)</span>    <span class="o">-&gt;</span> <span class="p">{</span><span class="n">tuple</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="p">[</span><span class="nv">E1</span><span class="p">,</span> <span class="nv">E2</span><span class="p">]}.</span>
<span class="nf">cons</span><span class="p">(</span><span class="nv">Head</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">,</span> <span class="nv">Line</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">cons</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Head</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">}.</span>

<span class="nf">str_to_bin</span><span class="p">(</span><span class="nv">String</span><span class="p">,</span> <span class="nv">Line</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">bin</span>
     <span class="p">,</span> <span class="nv">Line</span>
     <span class="p">,</span> <span class="p">[{</span><span class="n">bin_element</span>
         <span class="p">,</span> <span class="nv">Line</span>
         <span class="p">,</span> <span class="p">{</span><span class="n">string</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">String</span><span class="p">}</span>
         <span class="p">,</span> <span class="n">default</span>
         <span class="p">,</span> <span class="n">default</span>
        <span class="p">}</span>
       <span class="p">]</span>
    <span class="p">}.</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">json_test</span><span class="p">).</span>
<span class="p">-</span><span class="ni">compile</span><span class="p">({</span><span class="n">parse_transform</span><span class="p">,</span> <span class="n">json_parser</span><span class="p">}).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">test</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="nf">test</span><span class="p">(</span><span class="nv">V</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="p">{{</span>
      <span class="s">"name"</span>  <span class="p">:</span> <span class="s">"Jack (</span><span class="se">\"</span><span class="s">Bee</span><span class="se">\"</span><span class="s">) Nimble"</span><span class="p">,</span>
      <span class="s">"format"</span><span class="p">:</span> <span class="p">{</span>
                  <span class="s">"type"</span>      <span class="p">:</span> <span class="s">"rect"</span><span class="p">,</span>
                  <span class="s">"widths"</span>     <span class="p">:</span> <span class="p">[</span><span class="mi">1920</span><span class="p">,</span><span class="mi">1600</span><span class="p">],</span>
                  <span class="s">"height"</span>    <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1080</span><span class="p">),</span>
                  <span class="s">"interlace"</span> <span class="p">:</span> <span class="n">false</span><span class="p">,</span>
                  <span class="s">"frame rate"</span><span class="p">:</span> <span class="nv">V</span>
                <span class="p">}</span>
     <span class="p">}}</span><span class="o">&gt;&gt;</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">msg</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">send_on_heap</span><span class="o">/</span><span class="mi">0</span>
        <span class="p">,</span><span class="n">send_off_heap</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">send_on_heap</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">send</span><span class="p">(</span><span class="n">on_heap</span><span class="p">).</span>
<span class="nf">send_off_heap</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">send</span><span class="p">(</span><span class="n">off_heap</span><span class="p">).</span>

<span class="nb">send</span><span class="p">(</span><span class="nv">How</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="c">%% Spawn a function that loops for a while
</span>  <span class="nv">P2</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="nf">receiver</span><span class="p">(</span><span class="nv">How</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
  <span class="c">%% spawn a sending process
</span>  <span class="nv">P1</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="nf">sender</span><span class="p">(</span><span class="nv">P2</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
  <span class="nv">P1</span><span class="p">.</span>

<span class="nf">sender</span><span class="p">(</span><span class="nv">P2</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="c">%% Send a message that ends up on the heap
</span>  <span class="c">%%  {_,S} = erlang:process_info(P2, heap_size),
</span>  <span class="nv">M</span> <span class="o">=</span> <span class="nf">loop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
  <span class="nv">P2</span> <span class="o">!</span> <span class="nf">self</span><span class="p">(),</span>
  <span class="k">receive</span> <span class="n">ready</span> <span class="o">-&gt;</span> <span class="n">ok</span> <span class="k">end</span><span class="p">,</span>
  <span class="nv">P2</span> <span class="o">!</span> <span class="nv">M</span><span class="p">,</span>
  <span class="c">%% Print the PCB of P2
</span>  <span class="nn">hipe_bifs</span><span class="p">:</span><span class="nf">show_pcb</span><span class="p">(</span><span class="nv">P2</span><span class="p">),</span>
  <span class="n">ok</span><span class="p">.</span>

<span class="nf">receiver</span><span class="p">(</span><span class="nv">How</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nn">erlang</span><span class="p">:</span><span class="nb">process_flag</span><span class="p">(</span><span class="n">message_queue_data</span><span class="p">,</span><span class="nv">How</span><span class="p">),</span>
  <span class="k">receive</span> <span class="nv">P</span> <span class="o">-&gt;</span> <span class="nv">P</span> <span class="o">!</span> <span class="n">ready</span> <span class="k">end</span><span class="p">,</span>
  <span class="c">%%  loop(100000),
</span>  <span class="k">receive</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">ok</span> <span class="k">end</span><span class="p">,</span>
  <span class="nv">P</span><span class="p">.</span>


<span class="nf">loop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">done</span><span class="p">];</span>
<span class="nf">loop</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nf">loop</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)].</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">stack_machine_compiler</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">compile</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>

<span class="nf">compile</span><span class="p">(</span><span class="nv">Expression</span><span class="p">,</span> <span class="nv">FileName</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nv">ParseTree</span><span class="p">]</span> <span class="o">=</span> <span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
			  <span class="nn">erl_parse</span><span class="p">:</span><span class="nf">parse_exprs</span><span class="p">(</span>
			    <span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				    <span class="nn">erl_scan</span><span class="p">:</span><span class="nf">string</span><span class="p">(</span><span class="nv">Expression</span><span class="p">)))),</span>
    <span class="nn">file</span><span class="p">:</span><span class="nf">write_file</span><span class="p">(</span><span class="nv">FileName</span><span class="p">,</span> <span class="nf">generate_code</span><span class="p">(</span><span class="nv">ParseTree</span><span class="p">)</span> <span class="o">++</span> <span class="p">[</span><span class="nf">stop</span><span class="p">()]).</span>

<span class="nf">generate_code</span><span class="p">({</span><span class="n">op</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="n">'+'</span><span class="p">,</span> <span class="nv">Arg1</span><span class="p">,</span> <span class="nv">Arg2</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg1</span><span class="p">)</span> <span class="o">++</span> <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg2</span><span class="p">)</span> <span class="o">++</span> <span class="p">[</span><span class="nf">add</span><span class="p">()];</span>
<span class="nf">generate_code</span><span class="p">({</span><span class="n">op</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="n">'*'</span><span class="p">,</span> <span class="nv">Arg1</span><span class="p">,</span> <span class="nv">Arg2</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg1</span><span class="p">)</span> <span class="o">++</span> <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg2</span><span class="p">)</span> <span class="o">++</span> <span class="p">[</span><span class="nf">multiply</span><span class="p">()];</span>
<span class="nf">generate_code</span><span class="p">({</span><span class="n">integer</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="nv">I</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nf">push</span><span class="p">(),</span> <span class="nf">integer</span><span class="p">(</span><span class="nv">I</span><span class="p">)].</span>

<span class="nf">stop</span><span class="p">()</span>     <span class="o">-&gt;</span> <span class="mi">0</span><span class="p">.</span>
<span class="nf">add</span><span class="p">()</span>      <span class="o">-&gt;</span> <span class="mi">1</span><span class="p">.</span>
<span class="nf">multiply</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="p">.</span>
<span class="nf">push</span><span class="p">()</span>     <span class="o">-&gt;</span> <span class="mi">3</span><span class="p">.</span>
<span class="nf">integer</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">L</span> <span class="o">=</span> <span class="nb">binary_to_list</span><span class="p">(</span><span class="nn">binary</span><span class="p">:</span><span class="nf">encode_unsigned</span><span class="p">(</span><span class="nv">I</span><span class="p">)),</span>
    <span class="p">[</span><span class="nb">length</span><span class="p">(</span><span class="nv">L</span><span class="p">)</span> <span class="p">|</span> <span class="nv">L</span><span class="p">].</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">read_file</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">code</span><span class="p">;</span>
  <span class="kt">long</span>  <span class="n">size</span><span class="p">;</span>

  <span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
  <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
  <span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>

  <span class="n">fread</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span> <span class="n">size</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">code</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define STOP 0
#define ADD  1
#define MUL  2
#define PUSH 3
</span>
<span class="cp">#define pop()   (stack[--sp])
#define push(X) (stack[sp++] = X)
</span>
<span class="kt">int</span> <span class="nf">run</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">stack</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">sp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">ip</span> <span class="o">!=</span> <span class="n">STOP</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">ip</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ADD</span><span class="p">:</span> <span class="n">push</span><span class="p">(</span><span class="n">pop</span><span class="p">()</span> <span class="o">+</span> <span class="n">pop</span><span class="p">());</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">MUL</span><span class="p">:</span> <span class="n">push</span><span class="p">(</span><span class="n">pop</span><span class="p">()</span> <span class="o">*</span> <span class="n">pop</span><span class="p">());</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PUSH</span><span class="p">:</span>
      <span class="n">size</span> <span class="o">=</span> <span class="o">*</span><span class="n">ip</span><span class="o">++</span><span class="p">;</span>
      <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span> <span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="o">*</span><span class="n">ip</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
      <span class="n">push</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">pop</span><span class="p">();</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">code</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"The value is: %i</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Give the file name of a byte code program as argument</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="cp">#define STOP 0
#define ADD  1
#define MUL  2
#define PUSH 3
</span>
<span class="cp">#define pop() (stack[--sp])
#define push(X) (stack[sp++] = (X))
</span>
<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">instructionp_t</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">stack</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">sp</span><span class="p">;</span>
<span class="n">instructionp_t</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">running</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">add</span><span class="p">()</span>  <span class="p">{</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span> <span class="n">push</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">);</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">mul</span><span class="p">()</span>  <span class="p">{</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span> <span class="n">push</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">);</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">pushi</span><span class="p">(){</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>   <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="n">ip</span><span class="o">++</span><span class="p">;</span>       <span class="n">push</span><span class="p">(</span><span class="n">x</span><span class="p">);</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">stop</span><span class="p">()</span> <span class="p">{</span> <span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

<span class="n">instructionp_t</span> <span class="o">*</span><span class="nf">read_file</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
  <span class="n">instructionp_t</span> <span class="o">*</span><span class="n">code</span><span class="p">;</span>
  <span class="n">instructionp_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
  <span class="kt">long</span>  <span class="n">size</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

  <span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
  <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
  <span class="n">code</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">instructionp_t</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">cp</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>

  <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span> <span class="p">(</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">fgetc</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">)</span> <span class="o">!=</span> <span class="n">EOF</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">ADD</span><span class="p">:</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">add</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">MUL</span><span class="p">:</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mul</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">PUSH</span><span class="p">:</span>
	<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pushi</span><span class="p">;</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">fgetc</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ch</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span> <span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">fgetc</span><span class="p">(</span><span class="n">file</span><span class="p">);</span> <span class="p">}</span>
	<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">instructionp_t</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stop</span><span class="p">;</span>

  <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">code</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">sp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">running</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">ip</span><span class="o">++</span><span class="p">)();</span>

  <span class="k">return</span> <span class="n">pop</span><span class="p">();</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"The value is: %i</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">run</span><span class="p">());</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Give the file name of a byte code program as argument</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div id="listing-share" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">share</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">share</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nb">size</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">share</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">Y</span><span class="p">,</span><span class="nv">Y</span><span class="p">};</span>
<span class="nf">share</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nf">share</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="nv">N</span><span class="p">|</span><span class="nv">Y</span><span class="p">])</span> <span class="p">||</span> <span class="p">_</span> <span class="o">&lt;-</span> <span class="nv">Y</span><span class="p">].</span>

<span class="nb">size</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nv">T</span> <span class="o">=</span> <span class="nn">share</span><span class="p">:</span><span class="nf">share</span><span class="p">(</span><span class="mi">5</span><span class="p">,[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]),</span>
    <span class="p">{{</span><span class="nb">size</span><span class="p">,</span> <span class="nn">erts_debug</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="nv">T</span><span class="p">)},</span>
     <span class="p">{</span><span class="n">flat_size</span><span class="p">,</span> <span class="nn">erts_debug</span><span class="p">:</span><span class="nf">flat_size</span><span class="p">(</span><span class="nv">T</span><span class="p">)}}.</span></code></pre>
</div>
</div>
<div id="listing-send" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="nb">send</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">test</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">test</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nv">P2</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nf">p2</span><span class="p">()</span> <span class="k">end</span><span class="p">),</span>
    <span class="nv">P1</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nf">p1</span><span class="p">(</span><span class="nv">P2</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
    <span class="p">{</span><span class="nv">P1</span><span class="p">,</span> <span class="nv">P2</span><span class="p">}.</span>

<span class="nf">p2</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="k">receive</span>
        <span class="nv">M</span> <span class="o">-&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">"P2 got </span><span class="si">~p</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="nv">M</span><span class="p">])</span>
    <span class="k">end</span><span class="p">.</span>

<span class="nf">p1</span><span class="p">(</span><span class="nv">P2</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">L</span> <span class="o">=</span> <span class="s">"hello"</span><span class="p">,</span>
    <span class="nv">M</span> <span class="o">=</span> <span class="p">{</span><span class="nv">L</span><span class="p">,</span> <span class="nv">L</span><span class="p">},</span>
    <span class="nv">P2</span> <span class="o">!</span> <span class="nv">M</span><span class="p">,</span>
    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">"P1 sent </span><span class="si">~p</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="nv">M</span><span class="p">]).</span></code></pre>
</div>
</div>
<div id="listing-lb" class="paragraph">
<p>Load Balancer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">lb</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nv">Workers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span> <span class="n">worker</span><span class="o">/</span><span class="mi">0</span><span class="p">)</span> <span class="p">||</span> <span class="p">_</span> <span class="o">&lt;-</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)],</span>
    <span class="nv">LoadBalancer</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nf">loop</span><span class="p">(</span><span class="nv">Workers</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Files</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">list_dir</span><span class="p">(</span><span class="s">"."</span><span class="p">),</span>
    <span class="nv">Loaders</span> <span class="o">=</span> <span class="p">[</span><span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nf">loader</span><span class="p">(</span><span class="nv">LoadBalancer</span><span class="p">,</span> <span class="nv">F</span><span class="p">)</span> <span class="k">end</span><span class="p">)</span> <span class="p">||</span> <span class="nv">F</span> <span class="o">&lt;-</span> <span class="nv">Files</span><span class="p">],</span>
    <span class="p">{</span><span class="nv">Loaders</span><span class="p">,</span> <span class="nv">LoadBalancer</span><span class="p">,</span> <span class="nv">Workers</span><span class="p">}.</span>

<span class="nf">loader</span><span class="p">(</span><span class="nv">LB</span><span class="p">,</span> <span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span>  <span class="nn">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="k">of</span>
        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">}</span> <span class="o">-&gt;</span>  <span class="nv">LB</span> <span class="o">!</span> <span class="nv">Bin</span><span class="p">;</span>
        <span class="p">_</span><span class="nv">Dir</span> <span class="o">-&gt;</span> <span class="n">ok</span>
    <span class="k">end</span><span class="p">,</span>
    <span class="n">ok</span><span class="p">.</span>

<span class="nf">worker</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="k">receive</span>
        <span class="nv">Bin</span> <span class="o">-&gt;</span>
            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">"Byte Size: </span><span class="si">~w~n</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="nb">byte_size</span><span class="p">(</span><span class="nv">Bin</span><span class="p">)]),</span>
            <span class="nb">garbage_collect</span><span class="p">(),</span>
            <span class="nf">worker</span><span class="p">()</span>
    <span class="k">end</span><span class="p">.</span>


<span class="nf">loop</span><span class="p">(</span><span class="nv">Workers</span><span class="p">,</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">receive</span>
    <span class="nv">WorkItem</span> <span class="o">-&gt;</span>
       <span class="nv">Worker</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">nth</span><span class="p">(</span><span class="nv">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nv">Workers</span><span class="p">),</span>
       <span class="nv">Worker</span> <span class="o">!</span> <span class="nv">WorkItem</span><span class="p">,</span>
       <span class="nf">loop</span><span class="p">(</span><span class="nv">Workers</span><span class="p">,</span> <span class="p">(</span><span class="nv">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="ow">rem</span> <span class="nb">length</span><span class="p">(</span><span class="nv">Workers</span><span class="p">))</span>
  <span class="k">end</span><span class="p">.</span></code></pre>
</div>
</div>
<div id="listing-show" class="paragraph">
<p>show.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">show</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span> <span class="n">hex_tag</span><span class="o">/</span><span class="mi">1</span>
        <span class="p">,</span> <span class="n">tag</span><span class="o">/</span><span class="mi">1</span>
        <span class="p">,</span> <span class="n">tag_to_type</span><span class="o">/</span><span class="mi">1</span>
        <span class="p">]).</span>


<span class="nf">tag</span><span class="p">(</span><span class="nv">Term</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nv">Bits</span> <span class="o">=</span> <span class="nb">integer_to_list</span><span class="p">(</span><span class="nn">erlang</span><span class="p">:</span><span class="nb">system_info</span><span class="p">(</span><span class="n">wordsize</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span>
  <span class="nv">FormatString</span> <span class="o">=</span> <span class="s">"~"</span> <span class="o">++</span> <span class="nv">Bits</span> <span class="o">++</span> <span class="s">".2.0B"</span><span class="p">,</span>
  <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="nv">FormatString</span><span class="p">,[</span><span class="nn">hipe_bifs</span><span class="p">:</span><span class="nf">term_to_word</span><span class="p">(</span><span class="nv">Term</span><span class="p">)]).</span>

<span class="nf">hex_tag</span><span class="p">(</span><span class="nv">Term</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nv">Chars</span> <span class="o">=</span> <span class="nb">integer_to_list</span><span class="p">(</span><span class="nn">erlang</span><span class="p">:</span><span class="nb">system_info</span><span class="p">(</span><span class="n">wordsize</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span>
  <span class="nv">FormatString</span> <span class="o">=</span> <span class="s">"~"</span> <span class="o">++</span> <span class="nv">Chars</span> <span class="o">++</span> <span class="s">".16.0b"</span><span class="p">,</span>
  <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="nv">FormatString</span><span class="p">,[</span><span class="nn">hipe_bifs</span><span class="p">:</span><span class="nf">term_to_word</span><span class="p">(</span><span class="nv">Term</span><span class="p">)]).</span>


<span class="nf">tag_to_type</span><span class="p">(</span><span class="nv">Word</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">case</span> <span class="nv">Word</span> <span class="ow">band</span> <span class="mi">2#11</span> <span class="k">of</span>
    <span class="mi">2#00</span> <span class="o">-&gt;</span> <span class="n">header</span><span class="p">;</span>
    <span class="mi">2#01</span> <span class="o">-&gt;</span> <span class="n">cons</span><span class="p">;</span>
    <span class="mi">2#10</span> <span class="o">-&gt;</span> <span class="n">boxed</span><span class="p">;</span>
    <span class="mi">2#11</span> <span class="o">-&gt;</span>
      <span class="k">case</span> <span class="p">(</span><span class="nv">Word</span> <span class="ow">bsr</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">band</span> <span class="mi">2#11</span> <span class="k">of</span>
        <span class="mi">2#00</span> <span class="o">-&gt;</span> <span class="n">pid</span><span class="p">;</span>
        <span class="mi">2#01</span> <span class="o">-&gt;</span> <span class="n">port</span><span class="p">;</span>
        <span class="mi">2#10</span> <span class="o">-&gt;</span>
          <span class="k">case</span> <span class="p">(</span><span class="nv">Word</span> <span class="ow">bsr</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">band</span> <span class="mi">2#11</span> <span class="k">of</span>
            <span class="mi">00</span> <span class="o">-&gt;</span> <span class="n">atom</span><span class="p">;</span>
            <span class="mi">01</span> <span class="o">-&gt;</span> <span class="n">'catch'</span><span class="p">;</span>
            <span class="mi">10</span> <span class="o">-&gt;</span> <span class="n">'UNUSED'</span><span class="p">;</span>
            <span class="mi">11</span> <span class="o">-&gt;</span> <span class="n">nil</span>
          <span class="k">end</span><span class="p">;</span>
        <span class="mi">2#11</span> <span class="o">-&gt;</span> <span class="n">smallint</span>
      <span class="k">end</span>
  <span class="k">end</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">erts</span><span class="o">/</span><span class="n">emulator</span><span class="o">/</span><span class="n">hipe</span><span class="o">/</span><span class="n">hipe_debug</span><span class="p">.</span><span class="n">c</span> <span class="n">b</span><span class="o">/</span><span class="n">erts</span><span class="o">/</span><span class="n">emulator</span><span class="o">/</span><span class="n">hipe</span><span class="o">/</span><span class="n">hipe_debug</span><span class="p">.</span><span class="n">c</span>
<span class="n">index</span> <span class="n">ace4894</span><span class="p">..</span><span class="mi">7</span><span class="n">a888cc</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">erts</span><span class="o">/</span><span class="n">emulator</span><span class="o">/</span><span class="n">hipe</span><span class="o">/</span><span class="n">hipe_debug</span><span class="p">.</span><span class="n">c</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">erts</span><span class="o">/</span><span class="n">emulator</span><span class="o">/</span><span class="n">hipe</span><span class="o">/</span><span class="n">hipe_debug</span><span class="p">.</span><span class="n">c</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">39</span><span class="p">,</span><span class="mi">16</span> <span class="o">+</span><span class="mi">39</span><span class="p">,</span><span class="mi">16</span> <span class="err">@@</span>
 <span class="cp">#include "hipe_debug.h"
</span> <span class="cp">#include "erl_map.h"
</span>
<span class="o">-</span><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">dashes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="o">-</span>    <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'-'</span>
<span class="o">+</span><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">dashes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="o">+</span>    <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'-'</span>
 <span class="p">};</span>

<span class="o">-</span><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">dots</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="o">-</span>    <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'.'</span>
<span class="o">+</span><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">dots</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="o">+</span>    <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'.'</span>
 <span class="p">};</span>

<span class="o">-</span><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">stars</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="o">-</span>    <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'*'</span>
<span class="o">+</span><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">stars</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="o">+</span>    <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'*'</span>
 <span class="p">};</span>

 <span class="k">extern</span> <span class="n">Uint</span> <span class="n">beam_apply</span><span class="p">[];</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">56</span><span class="p">,</span><span class="mi">52</span> <span class="o">+</span><span class="mi">56</span><span class="p">,</span><span class="mi">56</span> <span class="err">@@</span> <span class="k">extern</span> <span class="n">Uint</span> <span class="n">beam_apply</span><span class="p">[];</span>
 <span class="k">static</span> <span class="kt">void</span> <span class="n">print_beam_pc</span><span class="p">(</span><span class="n">BeamInstr</span> <span class="o">*</span><span class="n">pc</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">pc</span> <span class="o">==</span> <span class="n">hipe_beam_pc_return</span><span class="p">)</span> <span class="p">{</span>
<span class="o">-</span>	<span class="n">printf</span><span class="p">(</span><span class="s">"return-to-native"</span><span class="p">);</span>
<span class="o">+</span>	<span class="n">erts_printf</span><span class="p">(</span><span class="s">"return-to-native"</span><span class="p">);</span>
     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pc</span> <span class="o">==</span> <span class="n">hipe_beam_pc_throw</span><span class="p">)</span> <span class="p">{</span>
<span class="o">-</span>	<span class="n">printf</span><span class="p">(</span><span class="s">"throw-to-native"</span><span class="p">);</span>
<span class="o">+</span>	<span class="n">erts_printf</span><span class="p">(</span><span class="s">"throw-to-native"</span><span class="p">);</span>
     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pc</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">beam_apply</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
<span class="o">-</span>	<span class="n">printf</span><span class="p">(</span><span class="s">"normal-process-exit"</span><span class="p">);</span>
<span class="o">+</span>	<span class="n">erts_printf</span><span class="p">(</span><span class="s">"normal-process-exit"</span><span class="p">);</span>
     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 	<span class="n">BeamInstr</span> <span class="o">*</span><span class="n">mfa</span> <span class="o">=</span> <span class="n">find_function_from_pc</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">mfa</span><span class="p">)</span>
 	    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"%T:%T/%bpu + 0x%bpx"</span><span class="p">,</span>
 			<span class="n">mfa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mfa</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mfa</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">pc</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">mfa</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
 	<span class="k">else</span>
<span class="o">-</span>	    <span class="n">printf</span><span class="p">(</span><span class="s">"?"</span><span class="p">);</span>
<span class="o">+</span>	    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"?"</span><span class="p">);</span>
     <span class="p">}</span>
 <span class="p">}</span>

 <span class="k">static</span> <span class="kt">void</span> <span class="n">catch_slot</span><span class="p">(</span><span class="n">Eterm</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">Eterm</span> <span class="n">val</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="n">BeamInstr</span> <span class="o">*</span><span class="n">pc</span> <span class="o">=</span> <span class="n">catch_pc</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | CATCH 0x%0*lx (BEAM "</span><span class="p">,</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | CATCH 0x%0*lx"</span><span class="p">,</span>
 	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
 	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">,</span>
 	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pc</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" |  %*s  |  %*s  |  (BEAM "</span><span class="p">,</span>
<span class="o">+</span>                <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">" "</span><span class="p">,</span>
<span class="o">+</span>                <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">" "</span><span class="p">);</span>
     <span class="n">print_beam_pc</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">")</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">")</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
 <span class="p">}</span>

 <span class="k">static</span> <span class="kt">void</span> <span class="n">print_beam_cp</span><span class="p">(</span><span class="n">Eterm</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">Eterm</span> <span class="n">val</span><span class="p">)</span>
 <span class="p">{</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" |%s|%s| BEAM ACTIVATION RECORD</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | BEAM PC "</span><span class="p">,</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" |%s|%s| BEAM ACTIVATION RECORD</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | BEAM PC "</span><span class="p">,</span>
 	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
 	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
     <span class="n">print_beam_pc</span><span class="p">(</span><span class="n">cp_val</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
 <span class="p">}</span>

 <span class="k">static</span> <span class="kt">void</span> <span class="n">print_catch</span><span class="p">(</span><span class="n">Eterm</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">Eterm</span> <span class="n">val</span><span class="p">)</span>
 <span class="p">{</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" |%s|%s| BEAM CATCH FRAME</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dots</span><span class="p">,</span> <span class="n">dots</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" |%s|%s| BEAM CATCH FRAME</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dots</span><span class="p">,</span> <span class="n">dots</span><span class="p">);</span>
     <span class="n">catch_slot</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" |%s|%s|</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">stars</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" |%s|%s|</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">stars</span><span class="p">);</span>
 <span class="p">}</span>

 <span class="k">static</span> <span class="kt">void</span> <span class="n">print_stack</span><span class="p">(</span><span class="n">Eterm</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="n">Eterm</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
 <span class="p">{</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" | %*s | %*s |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" | %*s | %*s |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span>
 	   <span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">"Address"</span><span class="p">,</span>
 	   <span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">"Contents"</span><span class="p">);</span>
     <span class="k">while</span> <span class="p">(</span><span class="n">sp</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">111</span><span class="p">,</span><span class="mi">56</span> <span class="o">+</span><span class="mi">115</span><span class="p">,</span><span class="mi">68</span> <span class="err">@@</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">print_stack</span><span class="p">(</span><span class="n">Eterm</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="n">Eterm</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
 	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_catch</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
 	    <span class="n">print_catch</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
 	<span class="k">else</span> <span class="p">{</span>
<span class="o">-</span>	    <span class="n">printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | "</span><span class="p">,</span>
<span class="o">+</span>	    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | "</span><span class="p">,</span>
 		   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sp</span><span class="p">,</span>
 		   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
 	    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"%.30T"</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="o">-</span>	    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">+</span>	    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
 	<span class="p">}</span>
 	<span class="n">sp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
     <span class="p">}</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" |%s|%s|</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" |%s|%s|</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
 <span class="p">}</span>

 <span class="kt">void</span> <span class="n">hipe_print_estack</span><span class="p">(</span><span class="n">Process</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
 <span class="p">{</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" |       BEAM  STACK       |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" |       BEAM  STACK       |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
     <span class="n">print_stack</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">,</span> <span class="n">STACK_START</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
 <span class="p">}</span>

 <span class="k">static</span> <span class="kt">void</span> <span class="n">print_heap</span><span class="p">(</span><span class="n">Eterm</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">Eterm</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
 <span class="p">{</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"From: 0x%0*lx to 0x%0*lx</span><span class="se">\n\r</span><span class="s">"</span><span class="p">,</span>
<span class="o">-</span>	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
<span class="o">-</span>	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">end</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" |         H E A P         |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" | %*s | %*s |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span>
<span class="o">-</span>	   <span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">"Address"</span><span class="p">,</span>
<span class="o">-</span>	   <span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">"Contents"</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" |%s|%s|</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"From: 0x%0*lx to 0x%0*lx</span><span class="se">\n\r</span><span class="s">"</span><span class="p">,</span>
<span class="o">+</span>	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
<span class="o">+</span>	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">end</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" | %*s%*s%*s%*s |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span>
<span class="o">+</span>           <span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">" "</span><span class="p">,</span>
<span class="o">+</span>	   <span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">"H E "</span><span class="p">,</span>
<span class="o">+</span>           <span class="mi">3</span><span class="p">,</span> <span class="s">"A P"</span><span class="p">,</span>
<span class="o">+</span>           <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">" "</span>
<span class="o">+</span>           <span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" | %*s | %*s |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span>
<span class="o">+</span>	   <span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="s">"Address"</span><span class="p">,</span>
<span class="o">+</span>	   <span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="s">"Contents"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" |%s|%s|</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span><span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
     <span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
 	<span class="n">Eterm</span> <span class="n">val</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="o">-</span>	<span class="n">printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | "</span><span class="p">,</span>
<span class="o">-</span>	       <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
<span class="o">-</span>	       <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
<span class="o">+</span>        <span class="k">if</span> <span class="p">((</span><span class="n">is_arity_value</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">is_thing</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span> <span class="p">{</span>
<span class="o">+</span>          <span class="n">erts_printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | "</span><span class="p">,</span>
<span class="o">+</span>                 <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
<span class="o">+</span>                 <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
<span class="o">+</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="o">+</span>          <span class="n">erts_printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | "</span><span class="p">,</span>
<span class="o">+</span>                 <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
<span class="o">+</span>                 <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
<span class="o">+</span>          <span class="n">erts_printf</span><span class="p">(</span><span class="s">"%-*.*T"</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="o">+</span>
<span class="o">+</span>        <span class="p">}</span>
 	<span class="o">++</span><span class="n">pos</span><span class="p">;</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">is_arity_value</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
<span class="o">-</span>	    <span class="n">printf</span><span class="p">(</span><span class="s">"Arity(%lu)"</span><span class="p">,</span> <span class="n">arityval</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
<span class="o">+</span>	    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"Arity(%lu)"</span><span class="p">,</span> <span class="n">arityval</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
 	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_thing</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
 	    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ari</span> <span class="o">=</span> <span class="n">thing_arityval</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="o">-</span>	    <span class="n">printf</span><span class="p">(</span><span class="s">"Thing Arity(%u) Tag(%lu)"</span><span class="p">,</span> <span class="n">ari</span><span class="p">,</span> <span class="n">thing_subtag</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
<span class="o">+</span>	    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"Thing Arity(%u) Tag(%lu)"</span><span class="p">,</span> <span class="n">ari</span><span class="p">,</span> <span class="n">thing_subtag</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
 	    <span class="k">while</span> <span class="p">(</span><span class="n">ari</span><span class="p">)</span> <span class="p">{</span>
<span class="o">-</span>		<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s"> | 0x%0*lx | 0x%0*lx | THING"</span><span class="p">,</span>
<span class="o">-</span>		       <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
<span class="o">-</span>		       <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">pos</span><span class="p">);</span>
<span class="o">+</span>		<span class="n">erts_printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s"> | 0x%0*lx | 0x%0*lx | THING"</span><span class="p">,</span>
<span class="o">+</span>		       <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
<span class="o">+</span>		       <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">pos</span><span class="p">);</span>
 		<span class="o">++</span><span class="n">pos</span><span class="p">;</span>
 		<span class="o">--</span><span class="n">ari</span><span class="p">;</span>
 	    <span class="p">}</span>
<span class="o">-</span>	<span class="p">}</span> <span class="k">else</span>
<span class="o">-</span>	    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"%.30T"</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="o">-</span>	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">+</span>	<span class="p">}</span>
<span class="o">+</span>	<span class="n">erts_printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
     <span class="p">}</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" |%s|%s|</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" |%s|%s|</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span><span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
 <span class="p">}</span>

 <span class="kt">void</span> <span class="n">hipe_print_heap</span><span class="p">(</span><span class="n">Process</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">170</span><span class="p">,</span><span class="mi">74</span> <span class="o">+</span><span class="mi">186</span><span class="p">,</span><span class="mi">85</span> <span class="err">@@</span> <span class="kt">void</span> <span class="n">hipe_print_heap</span><span class="p">(</span><span class="n">Process</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>

 <span class="kt">void</span> <span class="n">hipe_print_pcb</span><span class="p">(</span><span class="n">Process</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
 <span class="p">{</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"P: 0x%0*lx</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"-----------------------------------------------</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Offset| Name        | Value      | *Value     |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"P: 0x%0*lx</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"-------------------------%s%s</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"Offset| Name          |   %*s |   %*s |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span>
<span class="o">+</span>                <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="s">"Value"</span><span class="p">,</span>
<span class="o">+</span>                <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="s">"*Value"</span>
<span class="o">+</span>                <span class="p">);</span>
 <span class="cp">#undef U
</span> <span class="cp">#define U(n,x) \
-    printf(" % 4d | %s | 0x%0*lx |            |\r\n", (int)offsetof(Process,x), n, 2*(int)sizeof(long), (unsigned long)p-&gt;x)
</span><span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" % 4d | %s | 0x%0*lx |  %*s  |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">offsetof</span><span class="p">(</span><span class="n">Process</span><span class="p">,</span><span class="n">x</span><span class="p">),</span> <span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="s">" "</span><span class="p">)</span>
 <span class="cp">#undef P
</span> <span class="cp">#define P(n,x) \
-    printf(" % 4d | %s | 0x%0*lx | 0x%0*lx |\r\n", (int)offsetof(Process,x), n, 2*(int)sizeof(long), (unsigned long)p-&gt;x, 2*(int)sizeof(long), p-&gt;x ? (unsigned long)*(p-&gt;x) : -1UL)
</span><span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" % 4d | %s | 0x%0*lx | 0x%0*lx |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">offsetof</span><span class="p">(</span><span class="n">Process</span><span class="p">,</span><span class="n">x</span><span class="p">),</span> <span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">?</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">)</span>

<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"htop       "</span><span class="p">,</span> <span class="n">htop</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"hend       "</span><span class="p">,</span> <span class="n">hend</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"heap       "</span><span class="p">,</span> <span class="n">heap</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"heap_sz    "</span><span class="p">,</span> <span class="n">heap_sz</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"stop       "</span><span class="p">,</span> <span class="n">stop</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"gen_gcs    "</span><span class="p">,</span> <span class="n">gen_gcs</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"max_gen_gcs"</span><span class="p">,</span> <span class="n">max_gen_gcs</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"high_water "</span><span class="p">,</span> <span class="n">high_water</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"old_hend   "</span><span class="p">,</span> <span class="n">old_hend</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"old_htop   "</span><span class="p">,</span> <span class="n">old_htop</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"old_head   "</span><span class="p">,</span> <span class="n">old_heap</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"min_heap_.."</span><span class="p">,</span> <span class="n">min_heap_size</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"rcount     "</span><span class="p">,</span> <span class="n">rcount</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"id         "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"reds       "</span><span class="p">,</span> <span class="n">reds</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"tracer     "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">tracer</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"trace_fla.."</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">trace_flags</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"group_lea.."</span><span class="p">,</span> <span class="n">group_leader</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"flags      "</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"fvalue     "</span><span class="p">,</span> <span class="n">fvalue</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"freason    "</span><span class="p">,</span> <span class="n">freason</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"fcalls     "</span><span class="p">,</span> <span class="n">fcalls</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"id           "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"htop         "</span><span class="p">,</span> <span class="n">htop</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"hend         "</span><span class="p">,</span> <span class="n">hend</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"heap         "</span><span class="p">,</span> <span class="n">heap</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"heap_sz      "</span><span class="p">,</span> <span class="n">heap_sz</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"stop         "</span><span class="p">,</span> <span class="n">stop</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"gen_gcs      "</span><span class="p">,</span> <span class="n">gen_gcs</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"max_gen_gcs  "</span><span class="p">,</span> <span class="n">max_gen_gcs</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"high_water   "</span><span class="p">,</span> <span class="n">high_water</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"old_hend     "</span><span class="p">,</span> <span class="n">old_hend</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"old_htop     "</span><span class="p">,</span> <span class="n">old_htop</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"old_head     "</span><span class="p">,</span> <span class="n">old_heap</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"min_heap_size"</span><span class="p">,</span> <span class="n">min_heap_size</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"msg.first    "</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"msg.last     "</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">last</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"msg.save     "</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">save</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"msg.len      "</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
<span class="o">+</span><span class="err">#</span><span class="n">ifdef</span> <span class="n">ERTS_SMP</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"msg_inq.first"</span><span class="p">,</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"msg_inq.last "</span><span class="p">,</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">last</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"msg_inq.len  "</span><span class="p">,</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
<span class="o">+</span><span class="err">#</span><span class="n">endif</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"mbuf         "</span><span class="p">,</span> <span class="n">mbuf</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"mbuf_sz      "</span><span class="p">,</span> <span class="n">mbuf_sz</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"rcount       "</span><span class="p">,</span> <span class="n">rcount</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"reds         "</span><span class="p">,</span> <span class="n">reds</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"tracer       "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">tracer</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"trace_flags  "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">trace_flags</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"group_leader "</span><span class="p">,</span> <span class="n">group_leader</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"flags        "</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"fvalue       "</span><span class="p">,</span> <span class="n">fvalue</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"freason      "</span><span class="p">,</span> <span class="n">freason</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"fcalls       "</span><span class="p">,</span> <span class="n">fcalls</span><span class="p">);</span>
     <span class="cm">/*XXX: ErlTimer tm; */</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"next       "</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"next         "</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
     <span class="cm">/*XXX: ErlOffHeap off_heap; */</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"reg        "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">alive</span><span class="p">.</span><span class="n">reg</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"nlinks     "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">alive</span><span class="p">.</span><span class="n">links</span><span class="p">);</span>
<span class="o">-</span>    <span class="cm">/*XXX: ErlMessageQueue msg; */</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"mbuf       "</span><span class="p">,</span> <span class="n">mbuf</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"mbuf_sz    "</span><span class="p">,</span> <span class="n">mbuf_sz</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"dictionary "</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"seq..clock "</span><span class="p">,</span> <span class="n">seq_trace_clock</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"seq..astcnt"</span><span class="p">,</span> <span class="n">seq_trace_lastcnt</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"seq..token "</span><span class="p">,</span> <span class="n">seq_trace_token</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"intial[0]  "</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">initial</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"intial[1]  "</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">initial</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"intial[2]  "</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">initial</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="o">-</span>    <span class="n">P</span><span class="p">(</span><span class="s">"current    "</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">P</span><span class="p">(</span><span class="s">"cp         "</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">P</span><span class="p">(</span><span class="s">"i          "</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"catches    "</span><span class="p">,</span> <span class="n">catches</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"arity      "</span><span class="p">,</span> <span class="n">arity</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">P</span><span class="p">(</span><span class="s">"arg_reg    "</span><span class="p">,</span> <span class="n">arg_reg</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"max_arg_reg"</span><span class="p">,</span> <span class="n">max_arg_reg</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[0]"</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[1]"</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[2]"</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[3]"</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[4]"</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[5]"</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"reg          "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">alive</span><span class="p">.</span><span class="n">reg</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"nlinks       "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">alive</span><span class="p">.</span><span class="n">links</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"dictionary   "</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"seq...clock  "</span><span class="p">,</span> <span class="n">seq_trace_clock</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"seq...astcnt "</span><span class="p">,</span> <span class="n">seq_trace_lastcnt</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"seq...token  "</span><span class="p">,</span> <span class="n">seq_trace_token</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"intial[0]    "</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">initial</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"intial[1]    "</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">initial</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"intial[2]    "</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">initial</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">P</span><span class="p">(</span><span class="s">"current      "</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">P</span><span class="p">(</span><span class="s">"cp           "</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">P</span><span class="p">(</span><span class="s">"i            "</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"catches      "</span><span class="p">,</span> <span class="n">catches</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"arity        "</span><span class="p">,</span> <span class="n">arity</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">P</span><span class="p">(</span><span class="s">"arg_reg      "</span><span class="p">,</span> <span class="n">arg_reg</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"max_arg_reg  "</span><span class="p">,</span> <span class="n">max_arg_reg</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[0]  "</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[1]  "</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[2]  "</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[3]  "</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[4]  "</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[5]  "</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
 <span class="cp">#ifdef HIPE
</span><span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"nsp        "</span><span class="p">,</span> <span class="n">hipe</span><span class="p">.</span><span class="n">nsp</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"nstack     "</span><span class="p">,</span> <span class="n">hipe</span><span class="p">.</span><span class="n">nstack</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"nstend     "</span><span class="p">,</span> <span class="n">hipe</span><span class="p">.</span><span class="n">nstend</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"ncallee    "</span><span class="p">,</span> <span class="n">hipe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ncallee</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"nsp          "</span><span class="p">,</span> <span class="n">hipe</span><span class="p">.</span><span class="n">nsp</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"nstack       "</span><span class="p">,</span> <span class="n">hipe</span><span class="p">.</span><span class="n">nstack</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"nstend       "</span><span class="p">,</span> <span class="n">hipe</span><span class="p">.</span><span class="n">nstend</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"ncallee      "</span><span class="p">,</span> <span class="n">hipe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ncallee</span><span class="p">);</span>
     <span class="n">hipe_arch_print_pcb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">hipe</span><span class="p">);</span>
 <span class="cp">#endif	</span><span class="cm">/* HIPE */</span><span class="cp">
</span> <span class="cp">#undef U
</span> <span class="cp">#undef P
</span><span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"-----------------------------------------------</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"-------------------------%s%s</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
 <span class="p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="BIB-References"><a class="link" href="#BIB-References">References</a></h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="warren"></a>[warren] D. H. D. Warren. An Abstract Prolog Instruction Set:
Technical Note 309, Artificial Intelligence Center, SRI International, 333 Ravenswood Ave, Menlo Park, CA 94025, October 1983.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. The translation here is done in accordance with <a href="http://www.erlang.org/eeps/eep-0018.html">EEP 18</a> (Erlang Enhancement Proposal 18: "JSON bifs")
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. We ignore tracing here which will add a trace token to the size of the message, and always use a heap fragment.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. The -sizeof(Eterm) comes from mem in ErlHeapFragment already having the size of 1 Eterm
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-05-27 05:48:00 UTC
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</body>
</html>